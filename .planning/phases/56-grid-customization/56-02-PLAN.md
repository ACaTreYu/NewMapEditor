---
phase: 56-grid-customization
plan: 02
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - src/components/ToolBar/ToolBar.tsx
  - src/components/ToolBar/ToolBar.css
autonomous: true

must_haves:
  truths:
    - "User can adjust grid opacity from 0% to 100% via slider in grid dropdown"
    - "User can adjust grid line weight from 1px to 3px via slider in grid dropdown"
    - "User can choose grid line color via native color picker in grid dropdown"
    - "Grid dropdown closes when clicking outside"
    - "Grid toggle button still toggles grid visibility on click"
  artifacts:
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Grid settings dropdown with opacity slider, weight slider, color picker"
      contains: "gridOpacity|gridLineWeight|gridColor|grid-settings"
    - path: "src/components/ToolBar/ToolBar.css"
      provides: "Styling for grid settings dropdown and controls"
      contains: "grid-settings"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "useEditorStore selectors and setters for grid settings"
      pattern: "state\\.setGrid(Opacity|LineWeight|Color)"
---

<objective>
Add grid customization UI controls to the toolbar grid button as a dropdown panel with opacity slider, line weight slider, and color picker.

Purpose: Provides the user-facing controls for the grid customization settings wired in Plan 01.
Output: Grid button click toggles grid, grid button right-click (or small arrow) opens dropdown with settings controls.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-grid-customization/56-01-SUMMARY.md
@src/components/ToolBar/ToolBar.tsx
@src/components/ToolBar/ToolBar.css
@src/components/MapSettingsDialog/SettingInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add grid settings dropdown to toolbar grid button</name>
  <files>
    src/components/ToolBar/ToolBar.tsx
    src/components/ToolBar/ToolBar.css
  </files>
  <action>
**ToolBar.tsx — Convert grid button to button+dropdown with settings controls:**

1. **Add grid settings state subscriptions.** After the existing `toggleGrid` selector (line 148), add:
```typescript
const gridOpacity = useEditorStore(state => state.gridOpacity);
const gridLineWeight = useEditorStore(state => state.gridLineWeight);
const gridColor = useEditorStore(state => state.gridColor);
const setGridOpacity = useEditorStore(state => state.setGridOpacity);
const setGridLineWeight = useEditorStore(state => state.setGridLineWeight);
const setGridColor = useEditorStore(state => state.setGridColor);
```

2. **Add grid dropdown state.** Add a boolean state variable:
```typescript
const [showGridDropdown, setShowGridDropdown] = useState(false);
```

3. **Add click-outside handler for grid dropdown.** Add a useEffect similar to the existing openDropdown effect (lines 325-337):
```typescript
useEffect(() => {
  if (!showGridDropdown) return;
  const handleClickOutside = (e: MouseEvent) => {
    const target = e.target as HTMLElement;
    if (!target.closest('.grid-settings-wrapper')) {
      setShowGridDropdown(false);
    }
  };
  document.addEventListener('mousedown', handleClickOutside);
  return () => document.removeEventListener('mousedown', handleClickOutside);
}, [showGridDropdown]);
```

4. **Replace the grid button JSX** (currently lines 572-578). Replace the standalone `<button>` with a wrapper div containing the button + dropdown:

```tsx
<div className="grid-settings-wrapper">
  <button
    className={`toolbar-button ${showGrid ? 'active' : ''}`}
    onClick={toggleGrid}
    onContextMenu={(e) => {
      e.preventDefault();
      setShowGridDropdown(!showGridDropdown);
    }}
    title="Toggle Grid (right-click for settings)"
  >
    <LuGrid2X2 size={16} />
  </button>
  <button
    className="grid-settings-arrow"
    onClick={() => setShowGridDropdown(!showGridDropdown)}
    title="Grid Settings"
  >
    &#9660;
  </button>
  {showGridDropdown && (
    <div className="grid-settings-dropdown">
      <div className="grid-settings-row">
        <label className="grid-settings-label">Opacity</label>
        <input
          type="range"
          min={0}
          max={100}
          step={1}
          value={gridOpacity}
          onChange={(e) => setGridOpacity(parseInt(e.target.value, 10))}
          className="grid-settings-slider"
        />
        <span className="grid-settings-value">{gridOpacity}%</span>
      </div>
      <div className="grid-settings-row">
        <label className="grid-settings-label">Weight</label>
        <input
          type="range"
          min={1}
          max={3}
          step={1}
          value={gridLineWeight}
          onChange={(e) => setGridLineWeight(parseInt(e.target.value, 10))}
          className="grid-settings-slider"
        />
        <span className="grid-settings-value">{gridLineWeight}px</span>
      </div>
      <div className="grid-settings-row">
        <label className="grid-settings-label">Color</label>
        <input
          type="color"
          value={gridColor}
          onChange={(e) => setGridColor(e.target.value)}
          className="grid-settings-color"
        />
        <span className="grid-settings-value">{gridColor}</span>
      </div>
      <div className="grid-settings-row grid-settings-reset">
        <button
          className="grid-settings-reset-btn"
          onClick={() => {
            setGridOpacity(10);
            setGridLineWeight(1);
            setGridColor('#FFFFFF');
          }}
          title="Reset all grid settings to defaults"
        >
          &#8634; Reset
        </button>
      </div>
    </div>
  )}
</div>
```

Key UX decisions:
- Left-click toggles grid (preserves existing behavior)
- Small arrow button opens settings dropdown (discoverable without right-click)
- Right-click on grid icon also opens dropdown (power user shortcut)
- Inline sliders with value display (compact, no dialog needed)
- Native color picker (zero dependencies)
- Reset button restores all defaults

**ToolBar.css — Add grid settings dropdown styles:**

Add at the end of the file:

```css
/* Grid settings wrapper (button + arrow + dropdown) */
.grid-settings-wrapper {
  position: relative;
  display: inline-flex;
  align-items: center;
}

/* Small arrow button next to grid icon */
.grid-settings-arrow {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 10px;
  height: 22px;
  padding: 0;
  border: 1px solid transparent;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 6px;
  line-height: 1;
}

.grid-settings-arrow:hover {
  background: var(--bg-hover);
}

/* Grid settings dropdown panel */
.grid-settings-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  z-index: 200000;
  width: 200px;
  background: var(--surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  padding: var(--space-1_5);
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
}

/* Row: label + slider/input + value */
.grid-settings-row {
  display: flex;
  align-items: center;
  gap: var(--space-1);
}

.grid-settings-label {
  font-size: var(--font-size-2xs);
  color: var(--text-secondary);
  width: 46px;
  flex-shrink: 0;
}

.grid-settings-slider {
  flex: 1;
  height: 14px;
  cursor: pointer;
  accent-color: var(--accent-primary);
}

.grid-settings-value {
  font-size: var(--font-size-2xs);
  font-family: var(--font-mono);
  color: var(--text-secondary);
  width: 46px;
  text-align: right;
  flex-shrink: 0;
}

/* Native color picker input */
.grid-settings-color {
  width: 28px;
  height: 20px;
  padding: 0;
  border: 1px solid var(--border-default);
  border-radius: var(--radius-sm);
  cursor: pointer;
  background: transparent;
}

.grid-settings-color::-webkit-color-swatch-wrapper {
  padding: 1px;
}

.grid-settings-color::-webkit-color-swatch {
  border: none;
  border-radius: 2px;
}

/* Reset row */
.grid-settings-reset {
  justify-content: flex-end;
  border-top: 1px solid var(--border-subtle);
  padding-top: var(--space-1);
  margin-top: var(--space-0_5);
}

.grid-settings-reset-btn {
  font-size: var(--font-size-2xs);
  font-family: inherit;
  color: var(--text-secondary);
  background: transparent;
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  padding: var(--space-0_25) var(--space-1);
  cursor: pointer;
}

.grid-settings-reset-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` — zero new errors. Grep for `grid-settings-dropdown` in ToolBar.tsx and ToolBar.css to confirm both structure and styling exist. Grep for `setGridOpacity` in ToolBar.tsx to confirm wiring.
  </verify>
  <done>
Grid button has dropdown with opacity slider (0-100%), line weight slider (1-3px), color picker (hex), and reset button. Left-click toggles grid, arrow/right-click opens settings. Dropdown closes on click outside.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero new errors
2. Grid toggle still works (left-click on grid button)
3. Grid settings dropdown opens (arrow button or right-click)
4. Opacity slider range is 0-100, line weight slider is 1-3, color picker returns hex
5. Reset button restores defaults (10%, 1px, #FFFFFF)
6. Dropdown closes when clicking outside the wrapper
7. All CSS uses existing design tokens (--surface, --border-default, --radius-md, etc.)
</verification>

<success_criteria>
- User can adjust grid opacity via slider in dropdown
- User can adjust grid line weight via slider in dropdown
- User can choose grid color via native color picker in dropdown
- Grid settings take effect immediately on the canvas
- All three settings persist across restarts (via Plan 01 localStorage)
- TypeScript compilation passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/56-grid-customization/56-02-SUMMARY.md`
</output>
