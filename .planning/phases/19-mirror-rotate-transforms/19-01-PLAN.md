---
phase: 19-mirror-rotate-transforms
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/EditorState.ts
  - src/components/ToolBar/ToolBar.tsx
autonomous: true

must_haves:
  truths:
    - "User can mirror clipboard contents horizontally with Ctrl+H"
    - "User can mirror clipboard contents vertically with Ctrl+J"
    - "User can rotate clipboard contents 90 degrees clockwise with Ctrl+R"
    - "All transforms preserve full 16-bit tile values (animation flags bits 8-14, animation bit 15)"
    - "Transforms with no clipboard do nothing (no crash)"
    - "Paste preview updates in real-time when clipboard is transformed during active paste"
  artifacts:
    - path: "src/core/editor/EditorState.ts"
      provides: "mirrorHorizontal, mirrorVertical, rotateClipboard actions"
      contains: "mirrorHorizontal|mirrorVertical|rotateClipboard"
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Ctrl+H, Ctrl+J, Ctrl+R keyboard shortcuts"
      contains: "mirrorHorizontal|mirrorVertical|rotateClipboard"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "useEditorStore selectors for transform actions"
      pattern: "useEditorStore.*mirrorHorizontal|mirrorVertical|rotateClipboard"
---

<objective>
Add mirror horizontal, mirror vertical, and rotate 90° clockwise transform operations for clipboard contents with SEdit-style keyboard shortcuts.

Purpose: Users need to transform copied tile regions before pasting — essential for efficient map editing (e.g., copy one wall section, mirror it to build the opposite side).
Output: Three working transform actions callable via Ctrl+H, Ctrl+J, Ctrl+R keyboard shortcuts.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-mirror-rotate-transforms/19-RESEARCH.md
@src/core/editor/EditorState.ts
@src/components/ToolBar/ToolBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mirror/rotate transform actions to EditorState</name>
  <files>src/core/editor/EditorState.ts</files>
  <action>
Add three new actions to the EditorState interface and implementation:

1. **Interface additions** (add after `pasteAt` declaration around line 135):
   ```typescript
   mirrorHorizontal: () => void;
   mirrorVertical: () => void;
   rotateClipboard: () => void;
   ```

2. **mirrorHorizontal implementation** (add after `pasteAt` implementation, before `toggleGrid`):
   - Early return if `clipboard` is null
   - Create new `Uint16Array(width * height)`
   - For each (x, y): copy `tiles[y * width + x]` to `newTiles[y * width + (width - 1 - x)]`
   - `set({ clipboard: { ...clipboard, tiles: newTiles } })` — spread preserves width, height, originX, originY

3. **mirrorVertical implementation**:
   - Early return if `clipboard` is null
   - Create new `Uint16Array(width * height)`
   - For each (x, y): copy `tiles[y * width + x]` to `newTiles[(height - 1 - y) * width + x]`
   - `set({ clipboard: { ...clipboard, tiles: newTiles } })`

4. **rotateClipboard implementation** (90° clockwise):
   - Early return if `clipboard` is null
   - Destructure `{ width, height, tiles }` from clipboard
   - New dimensions: `newWidth = height`, `newHeight = width` (CRITICAL: dimensions swap on rotation)
   - Create new `Uint16Array(width * height)`
   - For each (x, y): copy `tiles[y * width + x]` to `newTiles[dstY * newWidth + dstX]` where `dstX = y` and `dstY = width - 1 - x`
   - Set with swapped dimensions: `set({ clipboard: { width: newWidth, height: newHeight, tiles: newTiles, originX: clipboard.originX, originY: clipboard.originY } })`

Key constraints:
- NEVER mutate clipboard in place — always create new Uint16Array
- Copy full 16-bit values (no bit masking) to preserve animation flags (bit 15) and frame offsets (bits 8-14)
- Rotation MUST swap width and height in the new clipboard object
- No need to update pastePreviewPosition — paste preview reads clipboard reactively and auto-updates
  </action>
  <verify>
Run `npm run typecheck` — should pass with no errors. Visually confirm the three new actions exist in EditorState interface and implementation.
  </verify>
  <done>
EditorState.ts has mirrorHorizontal, mirrorVertical, and rotateClipboard actions that correctly transform clipboard data while preserving all 16-bit tile values. rotateClipboard swaps width/height.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Ctrl+H/J/R keyboard shortcuts in ToolBar</name>
  <files>src/components/ToolBar/ToolBar.tsx</files>
  <action>
Add keyboard shortcuts and store selectors for the three transform actions:

1. **Add store selectors** (after the `deleteSelection` selector, around line 108):
   ```typescript
   const mirrorHorizontal = useEditorStore((state) => state.mirrorHorizontal);
   const mirrorVertical = useEditorStore((state) => state.mirrorVertical);
   const rotateClipboard = useEditorStore((state) => state.rotateClipboard);
   ```
   Use individual selectors (not useShallow) — this follows the established pattern for action selectors (1-3 fields = individual).

2. **Add keyboard shortcuts** in the existing `useEffect` `handleKeyDown` handler, inside the `if (e.ctrlKey || e.metaKey)` block. Add three new cases to the switch statement (after the existing `case 'insert':` block, before the closing `}` and `return`):
   ```typescript
   case 'h':
     e.preventDefault();
     mirrorHorizontal();
     break;
   case 'j':
     e.preventDefault();
     mirrorVertical();
     break;
   case 'r':
     e.preventDefault();
     rotateClipboard();
     break;
   ```

   IMPORTANT: The switch uses `e.key.toLowerCase()` so lowercase letters are correct.

   NOTE about Ctrl+R: In Electron, Ctrl+R triggers page reload by default. This must work because Electron's dev tools shortcut can be overridden by preventDefault in the renderer. If this causes issues, it will be caught during testing. The shortcut matches SEdit research recommendations.

3. **Update useEffect dependency array** (line 295): Add `mirrorHorizontal`, `mirrorVertical`, `rotateClipboard` to the dependency array.
  </action>
  <verify>
Run `npm run typecheck` — should pass with no errors. Open the app with `npm run electron:dev`, copy a selection (Ctrl+C), then press Ctrl+H, Ctrl+J, Ctrl+R to verify transforms work. If in paste preview mode, the preview should update in real-time.
  </verify>
  <done>
ToolBar.tsx has Ctrl+H (mirror horizontal), Ctrl+J (mirror vertical), and Ctrl+R (rotate 90° CW) keyboard shortcuts wired to the EditorState transform actions. Dependency array includes all three action references.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with no TypeScript errors
2. Copy a multi-tile region (drag select + Ctrl+C), then:
   - Ctrl+H mirrors the clipboard horizontally (left-right flip)
   - Ctrl+J mirrors the clipboard vertically (top-bottom flip)
   - Ctrl+R rotates the clipboard 90° clockwise (dimensions swap if non-square)
3. Animated tiles (bit 15 set) in clipboard retain animation after transforms
4. Pressing Ctrl+H/J/R with no clipboard content does NOT crash or error
5. During active paste preview (Ctrl+V then move mouse), pressing Ctrl+H/J/R updates the floating preview in real-time
6. Rotation of non-square clipboard (e.g., 5x3) produces correct 3x5 result
</verification>

<success_criteria>
- XFRM-01: Mirror horizontal works via Ctrl+H
- XFRM-02: Mirror vertical works via Ctrl+J
- XFRM-03: Rotate 90° CW works via Ctrl+R
- XFRM-04: All transforms use keyboard shortcuts (Ctrl+H, Ctrl+J, Ctrl+R)
- All transforms preserve full 16-bit tile encoding
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-mirror-rotate-transforms/19-01-SUMMARY.md`
</output>
