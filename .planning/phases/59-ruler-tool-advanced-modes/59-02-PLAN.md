---
phase: 59-ruler-tool-advanced-modes
plan: 02
type: execute
wave: 2
depends_on: ["59-01"]
files_modified:
  - src/components/MapCanvas/MapCanvas.tsx
  - src/components/StatusBar/StatusBar.tsx
  - src/components/StatusBar/StatusBar.css
autonomous: true

must_haves:
  truths:
    - "User can click waypoints in path mode to measure cumulative distance"
    - "User can double-click to finish a path measurement"
    - "User can press P to pin the current measurement so it persists"
    - "Pinned measurements render at 50% opacity with dashed lines"
    - "User can clear all pinned measurements"
    - "Mode selector buttons appear in status bar when ruler tool is active"
  artifacts:
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "Path mode click-to-add handler, pinned measurement rendering"
      contains: "RulerMode.PATH"
    - path: "src/components/StatusBar/StatusBar.tsx"
      provides: "Mode selector buttons, path measurement display, pin/clear controls"
      contains: "ruler-mode-selector"
    - path: "src/components/StatusBar/StatusBar.css"
      provides: "Mode selector button styling"
      contains: "ruler-mode-btn"
  key_links:
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "pinMeasurement action call on P key"
      pattern: "pinMeasurement"
    - from: "src/components/StatusBar/StatusBar.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "setRulerMode on button click"
      pattern: "setRulerMode"
---

<objective>
Implement path mode (multi-point waypoint measurement) and pin/lock feature with mode selector UI.

Purpose: Completes the ruler tool's advanced modes by adding the unique click-to-add-waypoint path interaction, the ability to pin measurements for persistence, and the mode selector UI that lets users switch between all four ruler modes.

Output: User can measure paths via waypoints, pin any measurement to persist on canvas, switch modes via status bar buttons, and clear pinned measurements.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-ruler-tool-advanced-modes/59-RESEARCH.md
@.planning/phases/59-ruler-tool-advanced-modes/59-01-SUMMARY.md

Key files to read before implementation:
@src/core/editor/slices/globalSlice.ts (RulerMode enum, pinnedMeasurements array, pin actions from Plan 01)
@src/components/MapCanvas/MapCanvas.tsx (rulerStateRef with waypoints field from Plan 01, drawUiLayer mode branches)
@src/components/StatusBar/StatusBar.tsx (mode-specific measurement display from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement path mode mouse handlers and pin/clear keyboard shortcuts</name>
  <files>src/components/MapCanvas/MapCanvas.tsx</files>
  <action>
**Path mode mouse handlers in MapCanvas.tsx:**

1. Subscribe to `pinMeasurement` and `clearAllPinnedMeasurements` from Zustand store. Also subscribe to `pinnedMeasurements` for rendering.

2. **handleMouseDown** — Add path mode branch before the existing drag-based ruler block (at ~line 994). When `currentTool === ToolType.RULER && rulerMode === RulerMode.PATH && e.button === 0`:
   - If `rulerStateRef.current.active === false`: Start a new path — set `active: true`, `startX: x`, `startY: y`, `endX: x`, `endY: y`, `waypoints: [{ x, y }]`
   - If `rulerStateRef.current.active === true`: Add waypoint — push `{ x, y }` to `waypoints` array, update `endX/endY`
   - Call `requestUiRedraw()`
   - `return` to prevent falling through to the drag-based modes

   The existing drag-based block stays for LINE, RECTANGLE, RADIUS modes (they use mousedown to start drag).

3. **handleMouseMove** — Add path mode branch. When `rulerStateRef.current.active && rulerMode === RulerMode.PATH`:
   - Update `endX/endY` for the preview segment (cursor position)
   - Calculate cumulative distance: sum Euclidean distances between consecutive waypoints, plus preview segment from last waypoint to cursor
   - Call `setRulerMeasurement` with path data:
     ```typescript
     setRulerMeasurement({
       mode: RulerMode.PATH,
       waypoints: [...rulerStateRef.current.waypoints],
       totalDistance: cumulativeDistance,
       startX: rulerStateRef.current.startX,
       startY: rulerStateRef.current.startY,
       endX: x, endY: y
     });
     ```
   - This branch should be checked BEFORE the general `rulerStateRef.current.active` block so it doesn't fall into line/rect/radius logic

4. **handleMouseDown double-click detection** — Use `e.detail === 2` to detect double-click in path mode. On double-click:
   - **Guard: if `rulerStateRef.current.waypoints.length < 2`, treat as no-op** — a path with only 1 waypoint has no meaningful distance, so ignore the double-click and let the user continue adding points:
     ```typescript
     if (e.detail === 2 && rulerMode === RulerMode.PATH && rulerStateRef.current.active) {
       if (rulerStateRef.current.waypoints.length >= 2) {
         // Finalize the path
         rulerStateRef.current.active = false;
         // Measurement persists in Zustand for status bar display
         requestUiRedraw();
       }
       return; // Always consume the double-click in path mode
     }
     ```
   - Finalize the path (don't add the double-click point as a new waypoint — it duplicates the single-click point already added by the preceding click event)
   - Set `rulerStateRef.current.active = false` but KEEP the waypoints and measurement visible (don't clear rulerMeasurement)
   - The path remains displayed until Escape or mode switch clears it

   **Completed path rendering:** When path is "completed" (double-click), `rulerStateRef.current.active === false` but `rulerMeasurement` persists in Zustand. In `drawUiLayer`, check if `rulerMeasurement?.mode === RulerMode.PATH && rulerMeasurement.waypoints?.length > 0` to render a completed path even when `rulerStateRef.current.active === false`. This way:
   - Active path: renders from ref (with preview segment to cursor)
   - Completed path: renders from Zustand measurement (no preview segment)

5. **Escape handler** (window keydown ~line 1549) — For path mode, Escape should:
   - If path is active (rulerStateRef.current.active && rulerMode === RulerMode.PATH): cancel the entire path, reset waypoints, clear measurement
   - This is already handled by the existing Escape block that clears rulerStateRef and setRulerMeasurement(null)
   - Just ensure the waypoints are reset (already done since Plan 01 adds waypoints: [] to reset)

6. **Pin shortcut (P key)** — Add to the window keydown handler:
   - When `key === 'p'` (lowercase) or `key === 'P'`, and `currentTool === ToolType.RULER`:
     - If `rulerMeasurement` is non-null: call `pinMeasurement()`
     - Then clear the active measurement: `rulerStateRef.current = { active: false, ... }`, `setRulerMeasurement(null)`, `requestUiRedraw()`
   - Guard: only when not typing in an input/textarea

7. **Clear all pins shortcut** — When `key === 'Escape'` and `currentTool === ToolType.RULER` and `rulerStateRef.current.active === false` (no active measurement):
   - Call `clearAllPinnedMeasurements()` and `requestUiRedraw()`
   - This means: first Escape cancels active measurement, second Escape clears all pins

**Pinned measurement rendering in drawUiLayer:**

8. After rendering the active measurement, render all pinned measurements. For each pinned measurement:
   - Use 50% global alpha: `ctx.globalAlpha = 0.5`
   - Use dashed line: `ctx.setLineDash([6, 4])`
   - Branch on `pinned.measurement.mode`:
     - LINE: draw yellow line between startX/Y and endX/Y (same as active line but faded/dashed)
     - RECTANGLE: draw yellow stroked rectangle
     - RADIUS: draw yellow stroked circle
     - PATH: draw yellow polyline through waypoints
   - For each pinned measurement, also draw a small floating label (same format as active, but no background to reduce clutter — just text with shadow)
   - Reset after: `ctx.globalAlpha = 1.0`, `ctx.setLineDash([])`

   Use `tileToScreen` with `overrideViewport` for all coordinate conversions (zoom stability).

9. Add `pinnedMeasurements` to the `drawUiLayer` useCallback dependency array (or use `useEditorStore.getState()` inside the callback to avoid re-creating it on every pin change — prefer getState() to avoid unnecessary re-renders).

**Important edge cases:**
- Path mode: if user has only 1 waypoint and double-clicks, treat as a no-op (need at least 2 points for a measurement)
- Pin action should work for all modes, not just path
- Don't allow typing 'p' in inputs to trigger pin
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Run `npm run electron:dev`:
1. Switch to path mode (via devtools or Plan 02 Task 2 UI)
2. Click 3-4 points: polyline renders with cumulative distance
3. Double-click: path finalizes, stays visible
4. Press P: measurement pins (faded dashed overlay), active clears
5. Start new measurement: pinned overlay persists
6. Escape with no active measurement: clears all pins
7. Pin works for line/rectangle/radius modes too</verify>
  <done>Path mode supports click-to-add waypoints with real-time cumulative distance, double-click to finish. P key pins current measurement. Pinned measurements render at 50% opacity with dashed lines. Escape clears pins when no active measurement.</done>
</task>

<task type="auto">
  <name>Task 2: Add mode selector buttons and path display to status bar</name>
  <files>src/components/StatusBar/StatusBar.tsx, src/components/StatusBar/StatusBar.css</files>
  <action>
**StatusBar.tsx changes:**

1. Import `RulerMode` from globalSlice. Import Lucide icons for mode buttons from `react-icons/lu`: `LuMinus` (line), `LuRectangleHorizontal` (rectangle), `LuRoute` (path), `LuCircle` (radius). All four icons are confirmed available in the installed `react-icons` package. `LuMinus` and `LuRectangleHorizontal` are already imported in ToolBar.tsx; StatusBar.tsx needs its own imports.

2. Subscribe to additional state:
```typescript
const { rulerMode, setRulerMode, pinnedMeasurements, clearAllPinnedMeasurements } = useEditorStore(
  useShallow((state) => ({
    rulerMode: state.rulerMode,
    setRulerMode: state.setRulerMode,
    pinnedMeasurements: state.pinnedMeasurements,
    clearAllPinnedMeasurements: state.clearAllPinnedMeasurements
  }))
);
```

3. Add mode selector buttons — render when `currentTool === ToolType.RULER` (contextual, only visible when ruler active). Place after the tool field and before the spacer:
```tsx
{currentTool === ToolType.RULER && (
  <div className="ruler-mode-selector">
    <button
      className={`ruler-mode-btn ${rulerMode === RulerMode.LINE ? 'active' : ''}`}
      onClick={() => setRulerMode(RulerMode.LINE)}
      title="Line (distance)"
    >
      <LuMinus size={12} />
    </button>
    <button
      className={`ruler-mode-btn ${rulerMode === RulerMode.RECTANGLE ? 'active' : ''}`}
      onClick={() => setRulerMode(RulerMode.RECTANGLE)}
      title="Rectangle (area)"
    >
      <LuRectangleHorizontal size={12} />
    </button>
    <button
      className={`ruler-mode-btn ${rulerMode === RulerMode.PATH ? 'active' : ''}`}
      onClick={() => setRulerMode(RulerMode.PATH)}
      title="Path (waypoints)"
    >
      <LuRoute size={12} />
    </button>
    <button
      className={`ruler-mode-btn ${rulerMode === RulerMode.RADIUS ? 'active' : ''}`}
      onClick={() => setRulerMode(RulerMode.RADIUS)}
      title="Radius (circle)"
    >
      <LuCircle size={12} />
    </button>
    {pinnedMeasurements.length > 0 && (
      <button
        className="ruler-mode-btn ruler-clear-btn"
        onClick={() => clearAllPinnedMeasurements()}
        title={`Clear ${pinnedMeasurements.length} pinned`}
      >
        Clear
      </button>
    )}
  </div>
)}
```

4. Add path mode measurement display to the ruler measurement section:
```tsx
{rulerMeasurement?.mode === RulerMode.PATH && (
  <>Path: {rulerMeasurement.waypoints?.length ?? 0}pts, {rulerMeasurement.totalDistance?.toFixed(2)}t</>
)}
```

5. Import `ToolType` if not already imported (it should be, check existing imports).

**StatusBar.css changes:**

6. Add styles for the mode selector:
```css
/* Ruler mode selector */
.ruler-mode-selector {
  display: flex;
  align-items: center;
  gap: 2px;
  margin: 0 var(--space-0_5);
  padding: 0 var(--space-0_25);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  background: var(--surface);
}

.ruler-mode-btn {
  width: 20px;
  height: 20px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  line-height: 1;
}

.ruler-mode-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.ruler-mode-btn.active {
  background: var(--accent-primary);
  color: var(--text-on-accent);
  border-color: var(--accent-primary);
}

.ruler-mode-btn.active:hover {
  background: var(--accent-hover);
}

.ruler-clear-btn {
  width: auto;
  padding: 0 var(--space-0_5);
  font-size: var(--font-size-2xs);
  margin-left: 2px;
  border-left: 1px solid var(--border-subtle);
}
```

**Note:** `LuMinus`, `LuRectangleHorizontal`, and `LuCircle` are already imported in ToolBar.tsx. `LuRoute` is confirmed available in the installed `react-icons/lu` package (verified). StatusBar.tsx imports its own copies of these icons.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Run `npm run electron:dev`:
1. Select ruler tool: mode selector buttons appear in status bar
2. Click each mode button: active state highlights correctly
3. Line mode button: existing line behavior works
4. Rectangle button: rectangle mode activates
5. Path button: path mode activates, status bar shows "Path: Npts, X.XXt"
6. Radius button: radius mode activates
7. Clear button appears when pinned measurements exist
8. Clear button removes all pinned overlays</verify>
  <done>Mode selector buttons render in status bar when ruler is active with active highlighting. Path mode shows waypoint count and cumulative distance. Clear button appears when pins exist and removes all pinned measurements.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Path mode: click adds waypoints, polyline renders between them with preview segment to cursor
3. Path mode: double-click finishes path, measurement stays visible
4. Path mode: Escape cancels active path
5. Path mode: status bar shows "Path: Npts, X.XXt"
6. Pin feature: P key pins current measurement for all modes
7. Pinned overlays render at 50% opacity with dashed lines
8. Pinned overlays are zoom-stable (tile coordinates, not screen)
9. Mode selector: 4 buttons in status bar with active highlighting
10. Mode selector: clicking button switches mode and clears active measurement
11. Clear button: removes all pinned overlays
12. All Phase 58 line mode behavior preserved
</verification>

<success_criteria>
- Path mode allows clicking waypoints with cumulative distance display (RULER-03)
- Double-click finishes path measurement
- P key pins any active measurement to persist on canvas (RULER-05)
- Pinned measurements render distinctly (50% opacity, dashed)
- Mode selector in status bar allows switching between all 4 modes
- Clear button removes all pinned measurements
- All 4 requirements covered: RULER-02 (Plan 01), RULER-03, RULER-04 (Plan 01), RULER-05
</success_criteria>

<output>
After completion, create `.planning/phases/59-ruler-tool-advanced-modes/59-02-SUMMARY.md`
</output>
