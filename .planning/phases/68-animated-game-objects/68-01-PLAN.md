---
phase: 68-animated-game-objects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/types.ts
  - src/core/editor/slices/globalSlice.ts
  - src/core/map/GameObjectData.ts
  - src/core/map/GameObjectSystem.ts
  - src/core/editor/slices/documentsSlice.ts
  - src/components/ToolBar/ToolBar.tsx
  - src/components/MapCanvas/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "Spawn tool dropdown shows Static/Animated variants"
    - "Selecting Animated spawn and clicking places a single animated tile for the selected team color"
    - "Warp tool dropdown shows Single/3x3 Animated variants"
    - "Selecting 3x3 Animated warp and clicking places a 3x3 animated block centered on cursor"
    - "Animated spawn tiles cycle through frames on the canvas"
    - "Animated warp 3x3 tiles cycle through 4 frames on the canvas"
    - "Center tile of animated warp 3x3 is the warp location (animation ID 0x9E)"
  artifacts:
    - path: "src/core/map/types.ts"
      provides: "spawnVariant and warpVariant fields on GameObjectToolState"
      contains: "spawnVariant"
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "setSpawnVariant and setWarpVariant actions with default values"
      contains: "setSpawnVariant"
    - path: "src/core/map/GameObjectData.ts"
      provides: "ANIMATED_WARP_PATTERN constant with 9 animation IDs"
      contains: "ANIMATED_WARP_PATTERN"
    - path: "src/core/map/GameObjectSystem.ts"
      provides: "placeAnimatedSpawn and placeAnimatedWarp methods"
      contains: "placeAnimatedSpawn"
    - path: "src/core/editor/slices/documentsSlice.ts"
      provides: "Variant-aware dispatch for SPAWN and WARP tool types"
      contains: "spawnVariant"
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Spawn and Warp variant dropdown configs"
      contains: "spawnVariant"
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "Animated warp uses x-1, y-1 offset for 3x3 centering"
      contains: "warpVariant"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "setSpawnVariant/setWarpVariant actions"
      pattern: "setSpawnVariant|setWarpVariant"
    - from: "src/core/editor/slices/documentsSlice.ts"
      to: "src/core/map/GameObjectSystem.ts"
      via: "placeAnimatedSpawn/placeAnimatedWarp calls"
      pattern: "placeAnimatedSpawn|placeAnimatedWarp"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "src/core/editor/slices/documentsSlice.ts"
      via: "placeGameObject call with variant-dependent offset"
      pattern: "warpVariant.*placeGameObject"
---

<objective>
Add animated spawn and animated warp variants to the game object tools. Spawn tool gets a Static/Animated dropdown; selecting Animated places a single animated tile (animation IDs 0xA3-0xA6 per team). Warp tool gets a Single/3x3 Animated dropdown; selecting 3x3 Animated places a 3x3 animated warp block (animation IDs 0x9A-0xA2) centered on cursor.

Purpose: Enables placement of animated game objects that match the original AC game's visual style.
Output: Working animated spawn and animated warp tool variants with correct tile encoding and canvas animation.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-animated-game-objects/68-RESEARCH.md

@src/core/map/types.ts
@src/core/editor/slices/globalSlice.ts
@src/core/map/GameObjectData.ts
@src/core/map/GameObjectSystem.ts
@src/core/editor/slices/documentsSlice.ts
@src/components/ToolBar/ToolBar.tsx
@src/components/MapCanvas/MapCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add animated game object state, data, and placement functions</name>
  <files>
    src/core/map/types.ts
    src/core/editor/slices/globalSlice.ts
    src/core/map/GameObjectData.ts
    src/core/map/GameObjectSystem.ts
  </files>
  <action>
**1. Extend GameObjectToolState (types.ts)**

Add two new fields to the `GameObjectToolState` interface (after `spawnType`):
```typescript
spawnVariant: number;  // 0 = static (3x3 cross), 1 = animated (single tile)
warpVariant: number;   // 0 = single encoded, 1 = 3x3 animated block
```

**2. Add defaults and setters (globalSlice.ts)**

In the initial `gameObjectToolState` object (~line 138), add:
```typescript
spawnVariant: 0,
warpVariant: 0,
```

Add action type signatures to the `GlobalSlice` interface (after `setConveyorDirection`):
```typescript
setSpawnVariant: (variant: number) => void;
setWarpVariant: (variant: number) => void;
```

Add action implementations (after `setConveyorDirection` implementation, ~line 276):
```typescript
setSpawnVariant: (variant) => set((state) => ({
  gameObjectToolState: { ...state.gameObjectToolState, spawnVariant: variant }
})),

setWarpVariant: (variant) => set((state) => ({
  gameObjectToolState: { ...state.gameObjectToolState, warpVariant: variant }
})),
```

**3. Add ANIMATED_WARP_PATTERN (GameObjectData.ts)**

Add this constant after the existing SPAWN_DATA array (~line 83):
```typescript
// Animated warp: 3x3 block of animated tiles (9 animation IDs)
// Animation IDs 0x9A-0xA2 map to BigWarp TL/TM/TR/ML/MM/MR/BL/BM/BR
export const ANIMATED_WARP_PATTERN: number[] = [
  0x8000 | 0x9A, 0x8000 | 0x9B, 0x8000 | 0x9C,  // Top row
  0x8000 | 0x9D, 0x8000 | 0x9E, 0x8000 | 0x9F,  // Middle row (0x9E = center warp)
  0x8000 | 0xA0, 0x8000 | 0xA1, 0x8000 | 0xA2,  // Bottom row
];
```

**4. Add placement methods (GameObjectSystem.ts)**

Add import of `ANIMATED_WARP_PATTERN` from `GameObjectData`:
```typescript
import {
  FLAG_DATA, POLE_DATA, BUNKER_DATA, HOLDING_PEN_DATA, SPAWN_DATA,
  ANIMATED_WARP_PATTERN, encodeWarpTile, switchData,
} from './GameObjectData';
```

Add two new methods to `GameObjectSystemClass` (after `placeSpawn`, ~line 115):

```typescript
// Place animated spawn (single animated tile)
// Animation IDs: 0xA3 (green), 0xA4 (red), 0xA5 (blue), 0xA6 (yellow)
placeAnimatedSpawn(map: MapData, x: number, y: number, team: Team): boolean {
  if (team === Team.NEUTRAL || team < 0 || team > 3) return false;
  if (x < 0 || x >= MAP_WIDTH || y < 0 || y >= MAP_HEIGHT) return false;

  const animId = 0xA3 + team;
  map.tiles[y * MAP_WIDTH + x] = 0x8000 | animId;
  map.modified = true;
  return true;
}

// Place animated warp (3x3 block of animated tiles)
// Uses ANIMATED_WARP_PATTERN with animation IDs 0x9A-0xA2
placeAnimatedWarp(map: MapData, x: number, y: number): boolean {
  return this.stamp3x3(map, x, y, ANIMATED_WARP_PATTERN);
}
```

NOTE: Animated spawn is a SINGLE tile (NOT 3x3 like static spawn). This is important for the click offset logic in Task 2.
  </action>
  <verify>
Run `npm run typecheck` — no TypeScript errors. Verify:
- `GameObjectToolState` has `spawnVariant` and `warpVariant` fields
- `GlobalSlice` has `setSpawnVariant` and `setWarpVariant` actions
- `ANIMATED_WARP_PATTERN` is exported from GameObjectData
- `placeAnimatedSpawn` and `placeAnimatedWarp` exist on GameObjectSystemClass
  </verify>
  <done>
All foundational state, data constants, and placement functions exist and type-check. GameObjectToolState has spawnVariant/warpVariant with defaults of 0. ANIMATED_WARP_PATTERN encodes 9 tiles with animation IDs 0x9A-0xA2. placeAnimatedSpawn places single tile with animation ID 0xA3+team. placeAnimatedWarp delegates to stamp3x3 with ANIMATED_WARP_PATTERN.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire variant dropdowns, dispatcher, and click offsets</name>
  <files>
    src/components/ToolBar/ToolBar.tsx
    src/core/editor/slices/documentsSlice.ts
    src/components/MapCanvas/MapCanvas.tsx
  </files>
  <action>
**1. Add variant dropdowns to ToolBar (ToolBar.tsx)**

Add store selectors for new actions (near line 164, after `setConveyorDirection`):
```typescript
const setSpawnVariant = useEditorStore((state) => state.setSpawnVariant);
const setWarpVariant = useEditorStore((state) => state.setWarpVariant);
```

Add two new entries to the `variantConfigs` array. Insert SPAWN variant config BEFORE the existing SWITCH entry (so spawn/warp tools appear with their dropdowns). Insert WARP variant config right after SPAWN:

```typescript
{
  tool: ToolType.SPAWN,
  settingName: 'Type',
  getCurrentValue: () => gameObjectToolState.spawnVariant,
  variants: [
    { label: 'Static', value: 0 },
    { label: 'Animated', value: 1 },
  ],
  setter: setSpawnVariant
},
{
  tool: ToolType.WARP,
  settingName: 'Type',
  getCurrentValue: () => gameObjectToolState.warpVariant,
  variants: [
    { label: 'Single', value: 0 },
    { label: '3x3 Animated', value: 1 },
  ],
  setter: setWarpVariant
},
```

**2. Update placement dispatcher (documentsSlice.ts)**

In `placeGameObjectForDocument` (~line 828), destructure the new variant fields:
```typescript
const { selectedTeam, warpSrc, warpDest, warpStyle, switchType, flagPadType, spawnVariant, warpVariant } = gameObjectToolState;
```

Update the WARP case (~line 842) to check warpVariant:
```typescript
case ToolType.WARP:
  if (warpVariant === 1) {
    success = gameObjectSystem.placeAnimatedWarp(doc.map, x, y);
  } else {
    success = gameObjectSystem.placeWarp(doc.map, x, y, warpStyle, warpSrc, warpDest);
  }
  break;
```

Update the SPAWN case (~line 845) to check spawnVariant:
```typescript
case ToolType.SPAWN:
  if (spawnVariant === 1) {
    success = gameObjectSystem.placeAnimatedSpawn(doc.map, x, y, selectedTeam);
  } else {
    success = gameObjectSystem.placeSpawn(doc.map, x, y, selectedTeam);
  }
  break;
```

**3. Fix click offset for animated variants (MapCanvas.tsx)**

The current MapCanvas has two placement code paths (~lines 1524-1534):
- Lines 1524-1529: FLAG, FLAG_POLE, SPAWN, SWITCH use `placeGameObject(x - 1, y - 1)` (3x3 centering)
- Lines 1530-1534: WARP uses `placeGameObject(x, y)` (single tile, no offset)

This needs updating because:
- Animated SPAWN is a SINGLE tile (no offset needed), but static SPAWN is 3x3 (offset needed)
- Animated WARP is 3x3 (offset needed), but static WARP is single tile (no offset)

Replace the SPAWN and WARP handling in the mouseDown handler. The current code has SPAWN grouped with FLAG/FLAG_POLE/SWITCH. Break SPAWN out into its own case, and modify the WARP case:

Change the condition at ~line 1524-1529 from:
```
} else if (currentTool === ToolType.FLAG || currentTool === ToolType.FLAG_POLE ||
           currentTool === ToolType.SPAWN || currentTool === ToolType.SWITCH) {
  pushUndo();
  placeGameObject(x - 1, y - 1);
  commitUndo('Place game object');
} else if (currentTool === ToolType.WARP) {
  pushUndo();
  placeGameObject(x, y);
  commitUndo('Place game object');
}
```

To:
```typescript
} else if (currentTool === ToolType.FLAG || currentTool === ToolType.FLAG_POLE ||
           currentTool === ToolType.SWITCH) {
  // Click-to-stamp game object tools (always 3x3) - center on cursor
  pushUndo();
  placeGameObject(x - 1, y - 1);
  commitUndo('Place game object');
} else if (currentTool === ToolType.SPAWN) {
  // Spawn: static is 3x3 (offset), animated is single tile (no offset)
  const { spawnVariant } = useEditorStore.getState().gameObjectToolState;
  pushUndo();
  if (spawnVariant === 1) {
    placeGameObject(x, y);  // Animated spawn = single tile
  } else {
    placeGameObject(x - 1, y - 1);  // Static spawn = 3x3, center on cursor
  }
  commitUndo('Place game object');
} else if (currentTool === ToolType.WARP) {
  // Warp: single is 1 tile (no offset), animated is 3x3 (offset)
  const { warpVariant } = useEditorStore.getState().gameObjectToolState;
  pushUndo();
  if (warpVariant === 1) {
    placeGameObject(x - 1, y - 1);  // Animated warp = 3x3, center on cursor
  } else {
    placeGameObject(x, y);  // Single warp = 1 tile, no offset
  }
  commitUndo('Place game object');
}
```

NOTE: `useEditorStore.getState()` is already used elsewhere in MapCanvas.tsx for direct state access during mouse handlers. This is the established pattern.
  </action>
  <verify>
Run `npm run typecheck` — no TypeScript errors. Then run `npm run electron:dev` and verify:
1. Select Spawn tool — dropdown appears with "Static" / "Animated" options
2. Select "Animated", pick a team color, click on map — single animated tile appears and animates
3. Select "Static", click on map — 3x3 cross pattern appears (existing behavior)
4. Select Warp tool — dropdown appears with "Single" / "3x3 Animated" options
5. Select "3x3 Animated", click on map — 3x3 animated warp block appears centered on cursor
6. Select "Single", click on map — single warp tile appears (existing behavior)
7. Animated tiles visually cycle through their animation frames on the canvas
  </verify>
  <done>
Spawn tool dropdown shows Static/Animated variants. Animated spawn places single animated tile at cursor position. Warp tool dropdown shows Single/3x3 Animated variants. Animated warp places 3x3 block centered on cursor. Static variants preserve existing behavior unchanged. All animated tiles render and cycle frames via CanvasEngine's existing animation system.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. Spawn tool shows variant dropdown with Static/Animated options
3. Animated spawn places correct animation ID per team (green=0xA3, red=0xA4, blue=0xA5, yellow=0xA6)
4. Animated spawn is single tile at cursor position (not offset)
5. Warp tool shows variant dropdown with Single/3x3 Animated options
6. Animated warp places 9 tiles in 3x3 pattern centered on cursor
7. Animated warp center tile is animation ID 0x9E (BigWarp MM)
8. All animated tiles cycle through frames on the canvas
9. Existing static spawn and single warp behavior unchanged
</verification>

<success_criteria>
- All 7 requirements traced: ASPAWN-01 (spawn dropdown), ASPAWN-02 (animated spawn placement), ASPAWN-03 (spawn animation cycling), AWARP-01 (warp dropdown), AWARP-02 (3x3 block placement), AWARP-03 (warp animation cycling), AWARP-04 (center tile is warp location)
- TypeScript compiles cleanly
- Both animated variants work in the running application
- Existing tool behavior is not broken
</success_criteria>

<output>
After completion, create `.planning/phases/68-animated-game-objects/68-01-SUMMARY.md`
</output>
