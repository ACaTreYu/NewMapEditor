---
phase: 101-canvas-background-mode-selector
plan: 02
type: execute
wave: 2
depends_on: ["101-01"]
files_modified:
  - src/components/ToolBar/ToolBar.tsx
  - src/components/ToolBar/ToolBar.css
  - src/App.tsx
  - src/components/Workspace/Workspace.tsx
  - src/components/Workspace/ChildWindow.tsx
autonomous: false

must_haves:
  truths:
    - "A toolbar dropdown lets the user select from five background modes and the selection takes effect immediately on the canvas"
    - "In farplane mode, the current patch's farplane image fills empty tile areas and scrolls correctly when the user pans the map"
    - "In custom color mode, the user can pick any solid color via a color picker and empty tile areas render in that color"
    - "In custom image mode, the user can load any image file from disk and it fills the canvas background behind empty tile areas"
    - "The chosen background mode and custom color value persist when the app is closed and reopened"
    - "Painting tiles, switching tools, or any animation tick never causes the background to flash or disappear"
  artifacts:
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "BG mode dropdown widget with 5 options, color picker, image browse button"
      contains: "canvasBackgroundMode"
    - path: "src/components/ToolBar/ToolBar.css"
      provides: "bg-settings CSS styles"
      contains: "bg-settings"
    - path: "src/App.tsx"
      provides: "customBgImage state, prop wiring for farplaneImage + customBgImage through Workspace → ChildWindow → MapCanvas"
      contains: "customBgImage"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "useEditorStore selectors for setCanvasBackgroundMode/setCanvasBackgroundColor"
      pattern: "setCanvasBackgroundMode"
    - from: "src/App.tsx"
      to: "src/components/Workspace/Workspace.tsx"
      via: "farplaneImage + customBgImage props"
      pattern: "farplaneImage.*customBgImage"
    - from: "src/components/Workspace/Workspace.tsx"
      to: "src/components/Workspace/ChildWindow.tsx"
      via: "farplaneImage + customBgImage props pass-through"
      pattern: "farplaneImage"
---

<objective>
Add the toolbar background mode dropdown UI, wire custom background image loading in App.tsx, and thread farplaneImage + customBgImage props from App → Workspace → ChildWindow → MapCanvas so the CanvasEngine receives the images it needs.

Purpose: Connects the rendering infrastructure from Plan 01 to user-facing controls. After this plan, all six success criteria for Phase 101 are satisfied.
Output: Working toolbar dropdown with 5 background modes, functional custom image loading, and complete prop wiring.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/101-canvas-background-mode-selector/101-RESEARCH.md
@.planning/phases/101-canvas-background-mode-selector/101-01-SUMMARY.md
@src/components/ToolBar/ToolBar.tsx
@src/components/ToolBar/ToolBar.css
@src/App.tsx
@src/components/Workspace/Workspace.tsx
@src/components/Workspace/ChildWindow.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Toolbar BG dropdown + prop wiring through component tree</name>
  <files>src/components/ToolBar/ToolBar.tsx, src/components/ToolBar/ToolBar.css, src/App.tsx, src/components/Workspace/Workspace.tsx, src/components/Workspace/ChildWindow.tsx</files>
  <action>
**ToolBar.tsx — BG mode dropdown:**

1. Add `LuImage` to the lucide icon imports (existing import line with LuGrid2X2, etc.).

2. Add a new `onLoadCustomBgImage` optional callback to the ToolBar Props interface:
   ```typescript
   onLoadCustomBgImage?: () => void;
   ```

3. Add Zustand selectors for bg state (alongside the existing grid selectors around line 230):
   ```typescript
   const canvasBackgroundMode = useEditorStore(state => state.canvasBackgroundMode);
   const canvasBackgroundColor = useEditorStore(state => state.canvasBackgroundColor);
   const setCanvasBackgroundMode = useEditorStore(state => state.setCanvasBackgroundMode);
   const setCanvasBackgroundColor = useEditorStore(state => state.setCanvasBackgroundColor);
   ```

4. Add `showBgDropdown` state (alongside existing `showGridDropdown` around line 263):
   ```typescript
   const [showBgDropdown, setShowBgDropdown] = useState(false);
   ```

5. Add outside-click handler for the BG dropdown (mirror the showGridDropdown handler, check for `.bg-settings-wrapper`):
   ```typescript
   useEffect(() => {
     if (!showBgDropdown) return;
     const handleClickOutside = (e: MouseEvent) => {
       const target = e.target as HTMLElement;
       if (!target.closest('.bg-settings-wrapper')) {
         setShowBgDropdown(false);
       }
     };
     document.addEventListener('mousedown', handleClickOutside);
     return () => document.removeEventListener('mousedown', handleClickOutside);
   }, [showBgDropdown]);
   ```

6. In the JSX, add the BG dropdown widget **immediately before** the grid-settings-wrapper div (both are canvas display settings, placed adjacent). Add a separator div before it:

   ```tsx
   <div className="floating-toolbar-separator" />

   <div className="bg-settings-wrapper">
     <button
       className="toolbar-button"
       onClick={() => setShowBgDropdown(!showBgDropdown)}
       title="Canvas Background"
     >
       <LuImage size={16} />
     </button>
     {showBgDropdown && (
       <div className="grid-settings-dropdown bg-settings-dropdown">
         <div className="grid-settings-row">
           <label className="grid-settings-label" style={{ width: 'auto', flex: 1 }}>Background</label>
         </div>
         <select
           className="bg-mode-select"
           value={canvasBackgroundMode}
           onChange={(e) => setCanvasBackgroundMode(e.target.value)}
         >
           <option value="transparent">Transparent</option>
           <option value="classic">SEdit Classic</option>
           <option value="farplane">Farplane</option>
           <option value="color">Custom Color</option>
           <option value="image">Custom Image</option>
         </select>
         {canvasBackgroundMode === 'color' && (
           <div className="grid-settings-row">
             <label className="grid-settings-label">Color</label>
             <input
               type="color"
               value={canvasBackgroundColor}
               onChange={(e) => setCanvasBackgroundColor(e.target.value)}
               className="grid-settings-color"
             />
             <span className="grid-settings-value">{canvasBackgroundColor}</span>
           </div>
         )}
         {canvasBackgroundMode === 'image' && (
           <div className="grid-settings-row">
             <button
               className="grid-settings-reset-btn"
               onClick={() => {
                 onLoadCustomBgImage?.();
               }}
               style={{ flex: 1 }}
             >
               Browse Image...
             </button>
           </div>
         )}
       </div>
     )}
   </div>
   ```

**ToolBar.css — BG dropdown styles:**

7. Add CSS rules after the existing grid-settings rules (around line 450):
   ```css
   /* Background settings wrapper (Phase 101) */
   .bg-settings-wrapper {
     position: relative;
     display: inline-flex;
     align-items: center;
   }

   .floating-toolbar .bg-settings-wrapper {
     display: flex;
   }

   .bg-settings-dropdown {
     width: 180px;
   }

   .bg-mode-select {
     width: 100%;
     padding: var(--space-0_5) var(--space-1);
     font-size: var(--font-size-2xs);
     font-family: inherit;
     background: var(--surface);
     color: var(--text-primary);
     border: 1px solid var(--border-default);
     border-radius: var(--radius-sm);
     cursor: pointer;
   }

   .bg-mode-select:focus {
     outline: 1px solid var(--accent-primary);
   }
   ```

**App.tsx — customBgImage state + prop wiring:**

8. Add `customBgImage` state near the existing `farplaneImage` state (around line 20):
   ```typescript
   const [customBgImage, setCustomBgImage] = useState<HTMLImageElement | null>(null);
   ```

9. Add a `handleLoadCustomBgImage` callback (can be placed near `handleImportTraceImage` around line 362). Reuse the same openImageDialog + readFile + data URL → Image pattern:
   ```typescript
   const handleLoadCustomBgImage = useCallback(async () => {
     const filePath = await window.electronAPI?.openImageDialog?.();
     if (!filePath) return;

     const res = await window.electronAPI.readFile(filePath);
     if (!res.success || !res.data) {
       console.warn('Failed to load custom background image');
       return;
     }

     const ext = filePath.split('.').pop()?.toLowerCase() || 'png';
     const mimeMap: Record<string, string> = {
       png: 'image/png', jpg: 'image/jpeg', jpeg: 'image/jpeg',
       bmp: 'image/bmp', gif: 'image/gif', webp: 'image/webp',
     };
     const mime = mimeMap[ext] || 'image/png';
     const dataSrc = `data:${mime};base64,${res.data}`;

     const img = new Image();
     img.onload = () => setCustomBgImage(img);
     img.onerror = () => console.warn('Failed to decode custom background image');
     img.src = dataSrc;
   }, []);
   ```

10. Pass `onLoadCustomBgImage` to ToolBar:
    ```tsx
    <ToolBar
      tilesetImage={tilesetImage}
      onNewMap={handleNewMap}
      onOpenMap={handleOpenMap}
      onSaveMap={handleSaveMap}
      onSaveAsMap={handleSaveAsMap}
      onExportOverview={() => overviewDialogRef.current?.open()}
      onCloseDocument={handleCloseDocument}
      onLoadCustomBgImage={handleLoadCustomBgImage}
    />
    ```

11. Pass `farplaneImage` and `customBgImage` through Workspace:
    ```tsx
    <Workspace
      tilesetImage={tilesetImage}
      farplaneImage={farplaneImage}
      customBgImage={customBgImage}
      onCloseDocument={handleCloseDocument}
      onCursorMove={handleCursorMove}
    />
    ```

**Workspace.tsx — prop threading:**

12. Add `farplaneImage` and `customBgImage` to Props interface and destructure:
    ```typescript
    interface Props {
      tilesetImage: HTMLImageElement | null;
      farplaneImage?: HTMLImageElement | null;
      customBgImage?: HTMLImageElement | null;
      onCloseDocument: (docId: string) => void;
      onCursorMove?: (x: number, y: number) => void;
    }
    ```

13. Pass through to ChildWindow:
    ```tsx
    <ChildWindow
      key={id}
      documentId={id}
      tilesetImage={tilesetImage}
      farplaneImage={farplaneImage}
      customBgImage={customBgImage}
      onClose={onCloseDocument}
      onCursorMove={onCursorMove}
    />
    ```

**ChildWindow.tsx — prop threading:**

14. Add `farplaneImage` and `customBgImage` to Props interface and destructure:
    ```typescript
    interface Props {
      documentId: string;
      tilesetImage: HTMLImageElement | null;
      farplaneImage?: HTMLImageElement | null;
      customBgImage?: HTMLImageElement | null;
      onClose: (docId: string) => void;
      onCursorMove?: (x: number, y: number) => void;
    }
    ```

15. Pass through to MapCanvas:
    ```tsx
    <MapCanvas
      tilesetImage={tilesetImage}
      farplaneImage={farplaneImage}
      customBgImage={customBgImage}
      onCursorMove={onCursorMove}
      documentId={documentId}
    />
    ```

**IMPORTANT notes:**
- Custom image state does NOT persist across sessions (per research recommendation). The mode 'image' persists via localStorage but the actual image does not — on re-launch, the user re-picks it. The canvas gracefully shows transparent when customBgImage is null.
- Patch switches (handleChangeTileset / handleSelectBundledPatch) must NOT clear customBgImage. Only farplaneImage is affected by patch changes. customBgImage is independent.
  </action>
  <verify>
Run `npm run typecheck` — no TypeScript errors. Run `npm run electron:dev` and verify:
1. The toolbar shows an image icon button before the grid button
2. Clicking it opens a dropdown with a select box (5 options)
3. Selecting "SEdit Classic" turns empty tile areas magenta
4. Selecting "Custom Color" shows a color picker; changing color updates canvas immediately
5. Selecting "Farplane" shows the farplane image behind empty tiles (if a patch is loaded)
6. Scrolling/panning keeps farplane aligned correctly
7. Animation ticks (animated tiles) don't cause flicker
8. Closing and reopening the app remembers the selected mode
  </verify>
  <done>
Toolbar BG dropdown works with all 5 modes. Custom image loading via browse button. farplaneImage and customBgImage flow from App → Workspace → ChildWindow → MapCanvas → CanvasEngine. Background persists via localStorage. No flicker during animation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete canvas background mode selector with 5 modes (transparent, SEdit classic, farplane, custom color, custom image), toolbar dropdown, localStorage persistence, and flicker-free animation rendering</what-built>
  <how-to-verify>
1. Run `npm run electron:dev`
2. Click the image icon (LuImage) in the floating toolbar, just before the grid button
3. Verify dropdown opens with a select box showing 5 options
4. **Transparent mode (default):** Empty tiles show no background (canvas is cleared/transparent)
5. **SEdit Classic mode:** Select "SEdit Classic" — empty tile areas fill with magenta (#FF00FF)
6. **Farplane mode:** Select "Farplane" — empty tiles show the current patch's farplane image. Pan the map — verify the farplane scrolls correctly with the viewport (no drift/jump)
7. **Custom Color mode:** Select "Custom Color" — a color picker appears. Pick a color — empty tiles fill with that color immediately
8. **Custom Image mode:** Select "Custom Image" — a "Browse Image..." button appears. Click it, choose an image file — that image fills the background behind empty tiles
9. **Animation flicker test:** With any non-transparent background active, place some animated tiles and observe for 5-10 seconds — the background should never flash or disappear during animation ticks
10. **Persistence:** Note your current mode and color, close the app, reopen — the same mode should be active on launch
11. **Patch switch:** In farplane mode, switch GFX patches — the farplane image should update. In custom image mode, switch patches — the custom image should remain unchanged
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. Toolbar shows BG mode dropdown with LuImage icon, positioned before grid settings
3. All 5 background modes work: transparent, classic (#FF00FF), farplane (scrolling), color (picker), image (browse)
4. Custom color picker appears only when color mode is selected
5. Browse button appears only when image mode is selected
6. Background renders correctly in blitDirtyRect (no flicker during animation ticks)
7. Background mode + color persist in localStorage across restarts
8. Custom image survives patch switches
9. Farplane image updates when switching patches
</verification>

<success_criteria>
- All 6 phase success criteria from ROADMAP are met
- BG-01 through BG-08 requirements are satisfied
- TypeScript compiles with no errors
- User has verified visual correctness
</success_criteria>

<output>
After completion, create `.planning/phases/101-canvas-background-mode-selector/101-02-SUMMARY.md`
</output>
