---
phase: 89-platform-polish
plan: 02
type: execute
wave: 2
depends_on: [89-01]
files_modified: [electron/platform.ts, electron/main.ts]
autonomous: true

must_haves:
  truths:
    - "On Linux AppImage, update-install IPC relaunches via execFile(process.env.APPIMAGE) instead of unreliable quitAndInstall"
    - "On Windows, update-install IPC still uses quitAndInstall(true, true) unchanged"
    - "The update-restart marker file directory is created defensively before writing"
    - "tryLinuxAppImageRelaunch() lives in electron/platform.ts (not scattered in main.ts)"
  artifacts:
    - path: "electron/platform.ts"
      provides: "tryLinuxAppImageRelaunch() function"
      exports: ["tryLinuxAppImageRelaunch"]
    - path: "electron/main.ts"
      provides: "Updated update-install IPC handler with Linux path"
      contains: "tryLinuxAppImageRelaunch"
  key_links:
    - from: "electron/main.ts"
      to: "electron/platform.ts"
      via: "import { tryLinuxAppImageRelaunch }"
      pattern: "tryLinuxAppImageRelaunch"
    - from: "electron/main.ts"
      to: "process.env.APPIMAGE"
      via: "tryLinuxAppImageRelaunch checks APPIMAGE env var"
      pattern: "APPIMAGE"
---

<objective>
Wire the Linux AppImage auto-updater relaunch path so updates install and relaunch correctly on Linux.

Purpose: Satisfy PLAT-02 (auto-updater works on Linux via AppImage). The existing auto-updater code works cross-platform for download and notification -- the only Linux-specific change needed is the relaunch mechanism. On AppImage, `quitAndInstall` installs correctly but relaunch fails because AppImages run from tmpfs mounts. The fix: use `execFile(process.env.APPIMAGE)` + `app.quit()` on Linux.

Output: `tryLinuxAppImageRelaunch()` in platform.ts, updated `update-install` IPC handler in main.ts, defensive mkdirSync for marker file.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/89-platform-polish/89-RESEARCH.md
@.planning/phases/89-platform-polish/89-01-SUMMARY.md
@electron/platform.ts
@electron/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tryLinuxAppImageRelaunch and update IPC handler</name>
  <files>electron/platform.ts, electron/main.ts</files>
  <action>
  **In electron/platform.ts:**

  1. Add import at top: `import { execFile } from 'child_process';` (Node.js built-in, no new dependency).
  2. Add export function `tryLinuxAppImageRelaunch()`:
     ```typescript
     /**
      * On Linux AppImage: relaunch the updated AppImage directly.
      * Returns true if Linux relaunch was handled, false if caller should use quitAndInstall.
      *
      * Why: quitAndInstall(true, true) installs correctly on AppImage but the relaunch
      * fails because AppImages run from a tmpfs mount that disappears after quit.
      * process.env.APPIMAGE contains the permanent disk path to the AppImage file.
      * See: electron-builder issues #5380, #4650
      */
     export function tryLinuxAppImageRelaunch(): boolean {
       if (isLinux && process.env.APPIMAGE) {
         execFile(process.env.APPIMAGE);
         app.quit();
         return true;
       }
       return false;
     }
     ```
     This function must use the existing `isLinux` constant (already exported from platform.ts) and the `app` import (added in plan 89-01).

  **In electron/main.ts:**

  3. Add `tryLinuxAppImageRelaunch` to the import from `'./platform'`:
     ```typescript
     import { registerWindowAllClosed, tryLinuxAppImageRelaunch } from './platform';
     ```

  4. Add defensive `mkdirSync` for the update marker path. Right before the existing `const updateMarkerPath = path.join(...)` line (line ~14), add:
     ```typescript
     // Ensure userData directory exists (defensive — Electron usually creates it, but
     // on first-run Linux the dir may not exist yet when we try to write the marker)
     try { fs.mkdirSync(app.getPath('userData'), { recursive: true }); } catch (_) {}
     ```

  5. Update the `update-install` IPC handler (inside `setupAutoUpdater()`). Replace:
     ```typescript
     ipcMain.on('update-install', () => {
       try { fs.writeFileSync(updateMarkerPath, ''); } catch (_) {}
       autoUpdater.quitAndInstall(true, true); // silent install, relaunch after
     });
     ```
     With:
     ```typescript
     ipcMain.on('update-install', () => {
       try { fs.writeFileSync(updateMarkerPath, ''); } catch (_) {}
       if (!tryLinuxAppImageRelaunch()) {
         autoUpdater.quitAndInstall(true, true); // Windows/macOS: silent install + relaunch
       }
     });
     ```
     The marker file is written BEFORE the relaunch attempt on all platforms (important: the Linux path must also write the marker so splash shows 2s on update restart).

  **Do NOT:**
  - Modify `autoUpdater.autoDownload`, `autoInstallOnAppQuit`, or any event listeners — the existing cross-platform auto-updater wiring is correct for all platforms
  - Add `process.env.APPIMAGE = ...` faking in dev mode
  - Disable the `if (!isDev)` guard on setupAutoUpdater
  - Change any other IPC handlers
  </action>
  <verify>
  Run `npm run typecheck` from the project root. Must pass with zero errors.
  Verify `tryLinuxAppImageRelaunch` is exported from platform.ts and imported in main.ts.
  Verify the update-install handler calls tryLinuxAppImageRelaunch() before quitAndInstall.
  Verify the marker file write (`fs.writeFileSync(updateMarkerPath, '')`) still happens before both relaunch paths.
  Verify the defensive mkdirSync exists before updateMarkerPath usage.
  </verify>
  <done>
  tryLinuxAppImageRelaunch() exists in platform.ts. update-install IPC handler calls it first, falling back to quitAndInstall for Windows/macOS. Defensive mkdirSync protects marker file writes. Typecheck passes. No changes to auto-updater event listeners or download behavior.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with no errors
2. Grep for `tryLinuxAppImageRelaunch` in electron/platform.ts confirms export
3. Grep for `tryLinuxAppImageRelaunch` in electron/main.ts confirms import and call
4. Grep for `execFile.*APPIMAGE` in electron/platform.ts confirms Linux relaunch mechanism
5. Grep for `mkdirSync.*userData` in electron/main.ts confirms defensive directory creation
6. The update-install handler writes marker BEFORE calling tryLinuxAppImageRelaunch
7. The quitAndInstall call is still present as Windows/macOS fallback
8. No new npm dependencies added (child_process is built-in)
</verification>

<success_criteria>
- PLAT-02 satisfied: Linux AppImage auto-update relaunch wired via execFile(APPIMAGE)
- Windows path unchanged: quitAndInstall(true, true) still used on Windows/macOS
- Marker file written on all platforms before relaunch (splash shows 2s after update)
- All platform logic in platform.ts (no process.platform checks in main.ts)
- Typecheck passes, no new dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/89-platform-polish/89-02-SUMMARY.md`
</output>
