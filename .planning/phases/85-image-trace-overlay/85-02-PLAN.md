---
phase: 85-image-trace-overlay
plan: 02
type: execute
wave: 2
depends_on: ["85-01"]
files_modified:
  - src/components/Workspace/TraceImageWindow.tsx
  - src/components/Workspace/TraceImageWindow.css
  - src/components/Workspace/Workspace.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User selects File > Import Trace Image and sees native file picker for image files"
    - "Imported image appears as MDI-style overlay window above all document windows"
    - "User can drag opacity slider (0-100%) and trace image transparency changes in real time"
    - "User can click through the trace image content to place tiles on the map below"
    - "User can move and resize the trace overlay window independently"
    - "User can close the trace overlay window via its close button"
    - "Trace overlay title bar and controls remain interactive (not click-through)"
  artifacts:
    - path: "src/components/Workspace/TraceImageWindow.tsx"
      provides: "Trace image overlay component with react-rnd, opacity slider, close button"
      min_lines: 80
    - path: "src/components/Workspace/TraceImageWindow.css"
      provides: "Trace window styling with pointer-events click-through on image area"
      contains: "pointer-events: none"
    - path: "src/components/Workspace/Workspace.tsx"
      provides: "Renders trace image windows alongside document windows"
      contains: "TraceImageWindow"
    - path: "src/App.tsx"
      provides: "Handles 'import-trace-image' menu action"
      contains: "import-trace-image"
  key_links:
    - from: "src/App.tsx"
      to: "src/core/editor/slices/windowSlice.ts"
      via: "createTraceImageWindow action"
      pattern: "createTraceImageWindow"
    - from: "src/components/Workspace/Workspace.tsx"
      to: "src/components/Workspace/TraceImageWindow.tsx"
      via: "renders TraceImageWindow for each trace window in store"
      pattern: "TraceImageWindow"
    - from: "src/components/Workspace/TraceImageWindow.tsx"
      to: "src/core/editor/slices/windowSlice.ts"
      via: "updateTraceImageWindow for opacity, position, size changes"
      pattern: "updateTraceImageWindow"
---

<objective>
Create the TraceImageWindow component and wire it into the Workspace and App menu action flow.

Purpose: Delivers the user-facing trace image overlay experience -- importing images, rendering them as always-on-top overlays with opacity control and click-through behavior for map tracing workflows.

Output: TraceImageWindow component + CSS, Workspace integration, App.tsx menu action handler.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/85-image-trace-overlay/85-01-SUMMARY.md

@src/components/Workspace/ChildWindow.tsx
@src/components/Workspace/Workspace.tsx
@src/components/Workspace/Workspace.css
@src/App.tsx
@src/core/editor/slices/windowSlice.ts
@src/core/editor/slices/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TraceImageWindow component and CSS</name>
  <files>src/components/Workspace/TraceImageWindow.tsx, src/components/Workspace/TraceImageWindow.css</files>
  <action>
  Create `src/components/Workspace/TraceImageWindow.tsx`:

  This component is a simplified version of ChildWindow.tsx, specialized for trace image overlays. Key differences from ChildWindow:
  - No MapCanvas content -- just an `<img>` tag
  - Opacity slider in the title bar
  - Image content area has `pointer-events: none` (click-through)
  - No minimize/maximize buttons (just close and opacity)
  - Title shows the image filename

  Implementation details:
  - Props: `{ traceId: string }` -- the trace image window ID
  - Use `react-rnd` `<Rnd>` component, same as ChildWindow
  - Subscribe to store via `useEditorStore` for the specific trace window state: `state.traceImageWindows.get(traceId)`
  - Use `useRef<Rnd>` for position sync (same pattern as ChildWindow)
  - Manual title bar drag (same mousedown/mousemove/mouseup pattern as ChildWindow lines 67-138) -- essential for 1:1 cursor tracking
  - On resize stop: call `updateTraceImageWindow(traceId, { x, y, width, height })`
  - On mousedown anywhere: call `raiseTraceImageWindow(traceId)` to bring to front
  - Title bar layout: [filename] [opacity slider] [close button]
  - Opacity slider: `<input type="range" min="0" max="100" value={opacity}>` that calls `updateTraceImageWindow(traceId, { opacity: Number(e.target.value) })`
  - The slider should have `pointer-events: auto` and a click handler with `e.stopPropagation()` to prevent starting a drag
  - Close button: calls `removeTraceImageWindow(traceId)`
  - Image display: `<img src={windowState.imageSrc} style={{ opacity: windowState.opacity / 100 }} className="trace-image-content" />` with `draggable={false}`
  - Rnd config: `bounds="parent"`, `minWidth={100}`, `minHeight={80}`, `disableDragging={true}` (manual drag), `style={{ zIndex: windowState.zIndex }}`
  - If windowState is undefined or isMinimized, return null

  Create `src/components/Workspace/TraceImageWindow.css`:

  Style the trace window with these key rules:
  - `.trace-image-window`: `display: flex; flex-direction: column; height: 100%; border: 1px solid var(--border-default); border-radius: var(--radius-sm); overflow: hidden; background: transparent;` -- note transparent background so only the image and title bar are visible
  - `.trace-image-title-bar`: Same styling as `.window-title-bar` (28px height, flex, user-select: none, cursor: default, gap: 8px, padding: 0 8px) but with `background: var(--bg-tertiary); pointer-events: auto;` -- MUST be interactive
  - `.trace-image-title`: Same as `.window-title` (flex: 1, overflow: hidden, ellipsis)
  - `.trace-opacity-slider`: Inline range input, `width: 60px; cursor: pointer; pointer-events: auto;` -- must stop propagation on mousedown to not trigger drag
  - `.trace-opacity-label`: Small text showing percentage, `font-size: 11px; min-width: 28px; text-align: right;`
  - `.trace-image-content`: `pointer-events: none; flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; background: transparent;`
  - `.trace-image-content img`: `width: 100%; height: 100%; object-fit: contain; user-select: none;` -- img inherits pointer-events: none from parent
  - `.trace-close-btn`: Reuse the `.window-btn .window-close-btn` pattern (same ::before/::after X icon)
  </action>
  <verify>Run `npm run typecheck` -- should pass. Verify TraceImageWindow.tsx imports compile correctly.</verify>
  <done>
  - TraceImageWindow.tsx renders a react-rnd window with image, opacity slider, and close button
  - Title bar is interactive (pointer-events: auto), image area is click-through (pointer-events: none)
  - Opacity slider changes image transparency in real-time (0-100% range)
  - Manual title bar drag follows ChildWindow pattern for 1:1 cursor tracking
  - Close button removes trace window from store
  - CSS uses transparent background so image blends over workspace
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate trace windows into Workspace and App menu action</name>
  <files>src/components/Workspace/Workspace.tsx, src/App.tsx</files>
  <action>
  In src/components/Workspace/Workspace.tsx:
  - Import `TraceImageWindow` from `./TraceImageWindow`
  - Add a new selector for trace window IDs: `const traceImageIds = useEditorStore(useShallow((state) => Array.from(state.traceImageWindows.keys())));`
  - Render trace windows AFTER document windows (so they appear on top in DOM order, plus their z-index is higher). Add after the `{documentIds.map(...)}` block:
    ```tsx
    {traceImageIds.map((id) => (
      <TraceImageWindow key={id} traceId={id} />
    ))}
    ```
  - Also render trace windows in the empty workspace state (when no documents are open), so users can have trace images even without documents. Wrap the trace rendering in a fragment that renders in BOTH branches (empty and non-empty).
  - IMPORTANT: Trace windows should render even when `documentIds.length === 0`. Restructure so the workspace div always renders, and the empty message only shows when no docs AND no trace images.

  In src/App.tsx:
  - Add `createTraceImageWindow` to the store selectors at top of component: `const createTraceImageWindow = useEditorStore((state) => state.createTraceImageWindow);`
  - Create a `handleImportTraceImage` callback:
    ```typescript
    const handleImportTraceImage = useCallback(async () => {
      const filePath = await window.electronAPI?.openImageDialog?.();
      if (!filePath) return;

      // Load image via existing readFile IPC (returns base64)
      const res = await window.electronAPI.readFile(filePath);
      if (!res.success || !res.data) {
        alert('Failed to load image file');
        return;
      }

      // Determine MIME type from extension
      const ext = filePath.split('.').pop()?.toLowerCase() || 'png';
      const mimeMap: Record<string, string> = {
        png: 'image/png', jpg: 'image/jpeg', jpeg: 'image/jpeg',
        bmp: 'image/bmp', gif: 'image/gif', webp: 'image/webp',
        svg: 'image/svg+xml'
      };
      const mime = mimeMap[ext] || 'image/png';
      const dataSrc = `data:${mime};base64,${res.data}`;

      // Extract filename from path
      const fileName = filePath.split(/[\\/]/).pop() || 'Trace Image';

      createTraceImageWindow(dataSrc, fileName);
    }, [createTraceImageWindow]);
    ```
  - In the menu-action handler (the `useEffect` with `menuActionRef`), add a case for `'import-trace-image'`:
    ```typescript
    case 'import-trace-image': handleImportTraceImage(); break;
    ```
  - NOTE: The `handleImportTraceImage` ref will be stale in the menuActionRef handler since it uses a ref guard. To fix this, use a ref to hold the latest handleImportTraceImage:
    - Add `const importTraceRef = useRef(handleImportTraceImage);` and update it: `importTraceRef.current = handleImportTraceImage;`
    - In the switch case, call `importTraceRef.current()` instead of `handleImportTraceImage()` directly
    - This follows the same pattern used by other handlers in this block that need fresh refs
  </action>
  <verify>
  1. Run `npm run typecheck` -- should pass
  2. Run `npm run electron:dev` -- app launches
  3. Click File > Import Trace Image -- file picker opens with image filters
  4. Select an image -- trace overlay window appears above workspace
  5. Drag opacity slider -- image transparency changes
  6. Click on map through the trace image -- tiles are placed normally
  7. Drag trace window title bar -- window moves
  8. Resize trace window -- window resizes, image scales
  9. Click close button on trace window -- window disappears
  </verify>
  <done>
  - Workspace.tsx renders TraceImageWindow for each trace window in store
  - App.tsx handles 'import-trace-image' menu action: opens dialog, loads image via IPC, creates trace window
  - Image loads as base64 data URL with correct MIME type (including webp and svg+xml)
  - Trace windows render above document windows in both empty and non-empty workspace states
  - Full round-trip works: menu click -> dialog -> image load -> window creation -> rendering
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. File > Import Trace Image opens native file picker with PNG, JPG, BMP, WebP, SVG, GIF filters
3. Selecting an image creates a trace overlay window above the editing canvas
4. Opacity slider (0-100%) changes trace image transparency in real time
5. Clicking on the map canvas through the trace image places tiles normally (click-through works)
6. Trace overlay can be moved by dragging its title bar
7. Trace overlay can be resized by dragging its edges
8. Trace overlay stays above document windows (z-index 5000+ vs 1000+)
9. Close button removes the trace overlay
10. Maximum 4 trace images enforced (5th attempt shows alert)
</verification>

<success_criteria>
- All 6 IMGT requirements satisfied (IMGT-01 through IMGT-06)
- All 5 phase success criteria from ROADMAP.md verified
- Trace windows are fully independent from document windows (separate state, separate z-index pool)
- Click-through works: pointer-events: none on image area, pointer-events: auto on title bar
- Opacity control is intuitive: slider in title bar, real-time feedback
- No regressions in existing MDI functionality
</success_criteria>

<output>
After completion, create `.planning/phases/85-image-trace-overlay/85-02-SUMMARY.md`
</output>
