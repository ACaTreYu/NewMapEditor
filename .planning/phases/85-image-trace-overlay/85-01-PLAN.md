---
phase: 85-image-trace-overlay
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron/main.ts
  - electron/preload.ts
  - src/core/editor/slices/types.ts
  - src/core/editor/slices/windowSlice.ts
  - src/core/editor/EditorState.ts
autonomous: true

must_haves:
  truths:
    - "Electron IPC handler 'dialog:openImageFile' opens native file picker with PNG, JPG, BMP, WebP, SVG, GIF filters"
    - "Renderer can call window.electronAPI.openImageDialog() and receive a file path or null"
    - "TraceImageWindowState type defines id, imageSrc, x, y, width, height, zIndex, opacity, isMinimized"
    - "WindowSlice stores trace image windows in a Map, separate from document windows"
    - "WindowSlice exposes createTraceImageWindow, removeTraceImageWindow, updateTraceImageWindow actions"
    - "Trace windows use z-index base 5000+ to always sit above document windows (base 1000)"
    - "Maximum 4 trace images enforced by createTraceImageWindow"
  artifacts:
    - path: "electron/main.ts"
      provides: "IPC handler for image file dialog"
      contains: "dialog:openImageFile"
    - path: "electron/preload.ts"
      provides: "openImageDialog API exposed to renderer"
      contains: "openImageDialog"
    - path: "src/core/editor/slices/types.ts"
      provides: "TraceImageWindowState interface and MAX_TRACE_IMAGES constant"
      contains: "TraceImageWindowState"
    - path: "src/core/editor/slices/windowSlice.ts"
      provides: "Trace window state management actions"
      contains: "traceImageWindows"
    - path: "src/core/editor/EditorState.ts"
      provides: "Trace window actions composed into store"
      contains: "traceImageWindows"
  key_links:
    - from: "electron/preload.ts"
      to: "electron/main.ts"
      via: "ipcRenderer.invoke('dialog:openImageFile')"
      pattern: "dialog:openImageFile"
    - from: "src/core/editor/EditorState.ts"
      to: "src/core/editor/slices/windowSlice.ts"
      via: "createWindowSlice composition"
      pattern: "createWindowSlice"
---

<objective>
Add Electron IPC for image file dialogs and Zustand state management for trace image overlay windows.

Purpose: Creates the data layer and IPC plumbing needed for trace image overlay windows -- a separate window type from documents, with its own z-index pool, opacity control, and lifecycle management.

Output: IPC handler + preload API for image file picker, TraceImageWindowState type, WindowSlice extensions for trace window CRUD.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@electron/main.ts
@electron/preload.ts
@src/core/editor/slices/types.ts
@src/core/editor/slices/windowSlice.ts
@src/core/editor/EditorState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image file dialog IPC and preload API</name>
  <files>electron/main.ts, electron/preload.ts</files>
  <action>
  In electron/main.ts, add a new IPC handler `dialog:openImageFile` (place it after the existing `dialog:openFile` handler around line 253). It should:
  - Call `dialog.showOpenDialog(mainWindow!, { ... })` with `properties: ['openFile']`
  - Use filters: `{ name: 'Images', extensions: ['png', 'jpg', 'jpeg', 'bmp', 'webp', 'svg', 'gif'] }` and `{ name: 'All Files', extensions: ['*'] }`
  - Return `null` if canceled, otherwise return `result.filePaths[0]`
  - Follow the exact same pattern as the existing `dialog:openFile` handler

  In electron/main.ts, add a new menu item in the File submenu. Insert it BEFORE the separator+Exit items (before the `{ type: 'separator' }` at line ~132). Add:
  - A separator first
  - Then `{ label: 'Import Trace Image...', click: () => { mainWindow?.webContents.send('menu-action', 'import-trace-image'); } }`

  In electron/preload.ts, add the new API:
  - In the `contextBridge.exposeInMainWorld` object, add: `openImageDialog: () => ipcRenderer.invoke('dialog:openImageFile')`
  - In the `ElectronAPI` interface, add: `openImageDialog: () => Promise<string | null>`
  </action>
  <verify>Run `npm run typecheck` -- should pass with no errors related to the new IPC handler or preload API.</verify>
  <done>
  - `dialog:openImageFile` IPC handler exists in main.ts with correct image format filters
  - `openImageDialog` method exposed in preload.ts contextBridge and typed in ElectronAPI interface
  - "Import Trace Image..." menu item exists in File menu, sends 'menu-action' with 'import-trace-image'
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TraceImageWindowState type and WindowSlice trace window management</name>
  <files>src/core/editor/slices/types.ts, src/core/editor/slices/windowSlice.ts, src/core/editor/EditorState.ts</files>
  <action>
  In src/core/editor/slices/types.ts, add:
  - `export const MAX_TRACE_IMAGES = 4;`
  - A new interface `TraceImageWindowState`:
    ```typescript
    export interface TraceImageWindowState {
      id: string;
      imageSrc: string;        // base64 data URL
      fileName: string;        // Original filename for title bar
      x: number;
      y: number;
      width: number;
      height: number;
      zIndex: number;
      opacity: number;         // 0-100 (convert to 0-1 for CSS)
      isMinimized: boolean;
    }
    ```

  In src/core/editor/slices/windowSlice.ts:
  - Add constants: `const TRACE_BASE_Z_INDEX = 5000;` and `const TRACE_Z_INDEX_NORMALIZE_THRESHOLD = 100000;`
  - Import `TraceImageWindowState` and `MAX_TRACE_IMAGES` from types
  - Extend the `WindowSlice` interface with:
    ```typescript
    traceImageWindows: Map<string, TraceImageWindowState>;
    nextTraceZIndex: number;
    createTraceImageWindow: (imageSrc: string, fileName: string) => string | null;
    removeTraceImageWindow: (id: string) => void;
    updateTraceImageWindow: (id: string, updates: Partial<TraceImageWindowState>) => void;
    raiseTraceImageWindow: (id: string) => void;
    ```
  - Add initial state: `traceImageWindows: new Map()` and `nextTraceZIndex: TRACE_BASE_Z_INDEX`
  - Implement `createTraceImageWindow`: Check `MAX_TRACE_IMAGES` limit (return null with alert if exceeded). Generate id with `trace-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`. Create state with `imageSrc`, `fileName`, cascade positioning (similar to document windows but with 30px offset), default 400x300 size, `zIndex: state.nextTraceZIndex`, `opacity: 50` (default 50% for immediate visibility of both image and tiles beneath), `isMinimized: false`. Return the id.
  - Implement `removeTraceImageWindow`: Delete from Map.
  - Implement `updateTraceImageWindow`: Spread updates into existing state (same pattern as `updateWindowState`).
  - Implement `raiseTraceImageWindow`: Set `zIndex: state.nextTraceZIndex`, increment `nextTraceZIndex`. Include normalization check against `TRACE_Z_INDEX_NORMALIZE_THRESHOLD` (same pattern as `raiseWindow` but for trace windows).

  In src/core/editor/EditorState.ts:
  - No changes needed -- `createWindowSlice` is already composed into the store, so the new trace window fields and actions will be automatically available. The `WindowSlice` type already participates in the `EditorState` union type.
  - VERIFY: The `EditorState` type is `DocumentsSlice & GlobalSlice & WindowSlice & BackwardCompatLayer`. Since WindowSlice is being extended, the new fields flow automatically. No explicit wiring needed.
  </action>
  <verify>Run `npm run typecheck` -- should pass. Verify that `useEditorStore.getState().traceImageWindows` is accessible (check by grepping types).</verify>
  <done>
  - TraceImageWindowState type defined with all required fields (id, imageSrc, fileName, x, y, width, height, zIndex, opacity, isMinimized)
  - MAX_TRACE_IMAGES = 4 exported from types
  - WindowSlice interface extended with trace window state and 4 actions
  - Trace windows use TRACE_BASE_Z_INDEX (5000) -- always above document windows (1000)
  - createTraceImageWindow enforces 4-window limit, returns id or null
  - Default opacity is 50 for immediate usability
  - All actions follow existing WindowSlice patterns
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `TraceImageWindowState` interface is exported from `src/core/editor/slices/types.ts`
3. `MAX_TRACE_IMAGES` constant equals 4
4. `WindowSlice` interface includes all four trace window actions
5. `dialog:openImageFile` handler exists in `electron/main.ts`
6. `openImageDialog` is typed and exposed in `electron/preload.ts`
7. "Import Trace Image..." menu item exists in File menu
</verification>

<success_criteria>
- IPC handler for image file dialog correctly filters PNG, JPG, BMP, WebP, SVG, GIF
- Preload API exposes openImageDialog with correct TypeScript typing
- File menu has "Import Trace Image..." item that sends 'import-trace-image' menu action
- TraceImageWindowState type is complete with all fields
- WindowSlice CRUD operations for trace windows work with separate z-index pool (5000+)
- Maximum 4 trace images enforced
- Typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/85-image-trace-overlay/85-01-SUMMARY.md`
</output>
