---
phase: 77-warp-tool-expansion
plan: 02
type: execute
wave: 2
depends_on: ["77-01"]
files_modified:
  - src/components/ToolBar/ToolBar.tsx
  - src/components/ToolBar/ToolBar.css
autonomous: true

must_haves:
  truths:
    - "User can select any of 6 warp types from warp tool dropdown"
    - "Each warp type shows tile image preview in dropdown list"
    - "Dropdown defaults to Warp FA (index 4) on session start"
  artifacts:
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Warp variant dropdown with 6 types and tile previews"
      contains: "warpPreviewUrls"
    - path: "src/components/ToolBar/ToolBar.css"
      provides: "Warp preview and dropdown styling"
      contains: "warp-preview"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/map/GameObjectData.ts"
      via: "WARP_STYLES array for preview generation"
      pattern: "WARP_STYLES"
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/map/AnimationDefinitions.ts"
      via: "ANIMATION_DEFINITIONS for frame lookup"
      pattern: "ANIMATION_DEFINITIONS"
---

<objective>
Add warp type tile previews to the toolbar dropdown and expand the variant list from 2 options to all 6 warp types, following the established wall tool preview pattern.

Purpose: Users can visually identify and select any of the 6 warp types from the dropdown.
Output: Complete warp tool dropdown with tile image previews.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-warp-tool-expansion/77-RESEARCH.md
@.planning/phases/77-warp-tool-expansion/77-01-SUMMARY.md
@src/components/ToolBar/ToolBar.tsx
@src/components/ToolBar/ToolBar.css
@src/core/map/AnimationDefinitions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate warp tile previews and expand dropdown</name>
  <files>
    src/components/ToolBar/ToolBar.tsx
    src/components/ToolBar/ToolBar.css
  </files>
  <action>
**ToolBar.tsx — Imports:**
- Add import: `import { WARP_STYLES } from '@core/map/GameObjectData';` (switchData import already exists on this line, extend it)
- Add import: `import { ANIMATION_DEFINITIONS } from '@core/map/AnimationDefinitions';`
- Remove `setWarpVariant` from store selector (it was removed in Plan 01). Add `setWarpType` instead.

**ToolBar.tsx — Preview generation (after wallPreviewUrls useMemo, ~line 244):**
Create `warpPreviewUrls` useMemo following the wall preview pattern:
```typescript
const warpPreviewUrls = useMemo(() => {
  const map = new Map<number, string>();
  if (!tilesetImage) return map;

  const TILES_PER_ROW = 40;

  for (let warpType = 0; warpType < WARP_STYLES.length; warpType++) {
    const animId = WARP_STYLES[warpType];
    const anim = ANIMATION_DEFINITIONS[animId];
    if (!anim || anim.frames.length === 0) continue;

    const canvas = document.createElement('canvas');
    canvas.width = TILE_SIZE;
    canvas.height = TILE_SIZE;
    const ctx = canvas.getContext('2d');
    if (!ctx) continue;
    ctx.imageSmoothingEnabled = false;

    // Draw first frame of animation
    const frame = anim.frames[0];
    const srcX = (frame % TILES_PER_ROW) * TILE_SIZE;
    const srcY = Math.floor(frame / TILES_PER_ROW) * TILE_SIZE;
    ctx.drawImage(
      tilesetImage,
      srcX, srcY, TILE_SIZE, TILE_SIZE,
      0, 0, TILE_SIZE, TILE_SIZE
    );

    map.set(warpType, canvas.toDataURL());
  }

  return map;
}, [tilesetImage]);
```

**ToolBar.tsx — Variant config (warp entry, ~line 303-312):**
Replace existing warp variant config:
```typescript
{
  tool: ToolType.WARP,
  settingName: 'Type',
  getCurrentValue: () => gameObjectToolState.warpType,
  variants: [
    { label: 'Warp F6', value: 0 },
    { label: 'Warp F7', value: 1 },
    { label: 'Warp F8', value: 2 },
    { label: 'Warp F9', value: 3 },
    { label: 'Warp FA', value: 4 },
    { label: 'Animated 3x3', value: 5 },
  ],
  setter: setWarpType
},
```

**ToolBar.tsx — Dropdown rendering (~line 544-586):**
- Add `isWarpTool` detection alongside `isWallTool`: `const isWarpTool = tool.tool === ToolType.WARP;`
- Add warp-dropdown CSS class: update the dropdown div className to include `isWarpTool ? 'warp-dropdown' : ''` alongside the existing wall-dropdown conditional
- Add warp preview rendering after the wall preview conditional (~line 580):
  ```tsx
  {isWarpTool && warpPreviewUrls.get(v.value) !== undefined && (
    <img
      src={warpPreviewUrls.get(v.value)}
      className="warp-preview"
      alt={v.label}
      draggable={false}
    />
  )}
  ```

**ToolBar.css — Warp preview styles (after .wall-dropdown styles, ~line 281):**
```css
/* Warp type preview image (single tile) */
.warp-preview {
  display: block;
  width: 16px;
  height: 16px;
  image-rendering: pixelated;
  flex-shrink: 0;
}

/* Warp dropdown items: horizontal layout with preview + label */
.warp-dropdown {
  min-width: 140px;
}

.warp-dropdown .toolbar-dropdown-item {
  display: flex;
  align-items: center;
  gap: var(--space-1);
}
```
  </action>
  <verify>
Run `npm run typecheck` — should pass with zero errors. Run `npm run electron:dev` and verify:
1. Select Warp tool in toolbar
2. Click dropdown arrow — 6 warp types listed (Warp F6 through Animated 3x3)
3. Each item shows a 16x16 tile preview image to the left of the label
4. Default selection is Warp FA (index 4)
5. Selecting each type updates the dropdown display
  </verify>
  <done>Warp dropdown shows all 6 warp types with tile image previews. Default is Warp FA. Each type is selectable and visually identifiable by its tile preview.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. Warp tool dropdown shows 6 items: Warp F6, Warp F7, Warp F8, Warp F9, Warp FA, Animated 3x3
3. Each dropdown item has a tile preview image (16x16, pixelated rendering)
4. Warp FA is selected by default
5. Selecting a warp type changes the cursor preview appropriately (single tile for types 0-4, 3x3 for type 5)
6. Place a warp with each type, then pick it — dropdown should show the correct type, Src/Dest should match
</verification>

<success_criteria>
- All 6 warp types visible in dropdown with labels
- Tile preview images render for all 6 types (correct colors from tileset)
- Selection changes toolbar state
- No TypeScript errors
- Dropdown styling matches wall tool dropdown pattern (horizontal layout with preview + label)
</success_criteria>

<output>
After completion, create `.planning/phases/77-warp-tool-expansion/77-02-SUMMARY.md`
</output>
