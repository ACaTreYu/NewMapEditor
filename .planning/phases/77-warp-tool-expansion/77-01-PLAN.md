---
phase: 77-warp-tool-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/types.ts
  - src/core/map/GameObjectData.ts
  - src/core/map/GameObjectSystem.ts
  - src/core/editor/slices/globalSlice.ts
  - src/core/editor/slices/documentsSlice.ts
  - src/components/MapCanvas/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "encodeWarpTile accepts animId parameter and encodes it into tile value (not hardcoded 0xFA)"
    - "placeWarp passes animId from WARP_STYLES[warpType] to encodeWarpTile"
    - "warpType (0-5 index) replaces binary warpVariant in state and dispatch"
    - "Picker decodes routing from all 6 warp animation IDs (F6-FA, 9E) and syncs warpType"
  artifacts:
    - path: "src/core/map/GameObjectData.ts"
      provides: "encodeWarpTile(animId, src, dest) with animId parameter"
      contains: "encodeWarpTile(animId"
    - path: "src/core/map/types.ts"
      provides: "GameObjectToolState with warpType field"
      contains: "warpType"
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "setWarpType action and warpType in initial state"
      contains: "setWarpType"
    - path: "src/core/editor/slices/documentsSlice.ts"
      provides: "placeGameObject dispatch using warpType index"
      contains: "WARP_STYLES"
  key_links:
    - from: "src/core/editor/slices/documentsSlice.ts"
      to: "src/core/map/GameObjectData.ts"
      via: "WARP_STYLES[warpType] passed to placeWarp as animId"
      pattern: "WARP_STYLES\\[warpType\\]"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "src/core/map/GameObjectData.ts"
      via: "WARP_STYLES.includes(animId) in picker decode"
      pattern: "WARP_STYLES\\.includes"
---

<objective>
Replace the binary warp variant toggle (0/1) with an indexed warp type selector (0-5) backed by WARP_STYLES array, parameterize encodeWarpTile to accept animId, and extend picker decoding to all 6 warp types.

Purpose: Foundation for all 6 warp types to encode correct routing and for picker to round-trip any warp type.
Output: Core logic and state ready for UI dropdown (Plan 02).
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-warp-tool-expansion/77-RESEARCH.md
@src/core/map/GameObjectData.ts
@src/core/map/GameObjectSystem.ts
@src/core/map/types.ts
@src/core/editor/slices/globalSlice.ts
@src/core/editor/slices/documentsSlice.ts
@src/components/MapCanvas/MapCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parameterize encodeWarpTile and update state model</name>
  <files>
    src/core/map/GameObjectData.ts
    src/core/map/GameObjectSystem.ts
    src/core/map/types.ts
    src/core/editor/slices/globalSlice.ts
  </files>
  <action>
**GameObjectData.ts (line 122-125):**
- Change `encodeWarpTile(_style: number, src: number, dest: number)` to `encodeWarpTile(animId: number, src: number, dest: number)`
- Replace hardcoded `0xFA` in the return with `animId`: `return animId | 0x8000 | (((dest * 10) + src) << 8);`
- Update comment to remove "Only 0xFA works" caveat

**GameObjectSystem.ts (line 102-110):**
- Rename `placeWarp` parameter `style` to `animId`
- Update validation: change `if (style < 0 || style >= 6)` to validate animId is in WARP_STYLES: `if (!WARP_STYLES.includes(animId))` (import WARP_STYLES from GameObjectData)
- Pass `animId` to `encodeWarpTile(animId, src, dest)` instead of `encodeWarpTile(style, src, dest)`

**types.ts (GameObjectToolState interface, ~line 130-145):**
- Replace `warpVariant: number;` with `warpType: number;` and update comment: `// 0-5 index into WARP_STYLES (F6, F7, F8, F9, FA, 9E)`
- Keep `warpStyle: number;` field for now (used by setWarpSettings signature, will be repurposed as warpType sync target)

**globalSlice.ts:**
- In initial `gameObjectToolState`: change `warpVariant: 0` to `warpType: 4` (default to 0xFA for backward compat)
- Add `setWarpType` action to `GlobalSlice` interface: `setWarpType: (type: number) => void;`
- Implement `setWarpType`: `set((state) => ({ gameObjectToolState: { ...state.gameObjectToolState, warpType: type } }))`
- Update `setWarpSettings` to also set `warpType`: `setWarpSettings: (src, dest, type) => set((state) => ({ gameObjectToolState: { ...state.gameObjectToolState, warpSrc: src, warpDest: dest, warpStyle: type, warpType: type } }))`
- Remove `setWarpVariant` action (replaced by `setWarpType`). Remove from interface and implementation.
  </action>
  <verify>Run `npm run typecheck` — should pass with zero errors. Verify encodeWarpTile signature accepts animId, warpType exists in state, setWarpVariant is removed.</verify>
  <done>encodeWarpTile takes animId parameter, GameObjectToolState has warpType field (default 4), setWarpType action exists, setWarpVariant removed.</done>
</task>

<task type="auto">
  <name>Task 2: Update dispatcher and picker for all 6 warp types</name>
  <files>
    src/core/editor/slices/documentsSlice.ts
    src/components/MapCanvas/MapCanvas.tsx
  </files>
  <action>
**documentsSlice.ts (placeGameObject, ~line 828-848):**
- Update destructuring: replace `warpVariant` with `warpType` in the destructure of `gameObjectToolState`
- Import `WARP_STYLES` from `'../../map/GameObjectData'`
- Replace warp case logic:
  ```typescript
  case ToolType.WARP:
    if (warpType === 5) {
      // 0x9E (warpType 5) is 3x3 animated block, requires different placement logic
      success = gameObjectSystem.placeAnimatedWarp(doc.map, x, y, warpSrc, warpDest);
    } else {
      const animId = WARP_STYLES[warpType];
      success = gameObjectSystem.placeWarp(doc.map, x, y, animId, warpSrc, warpDest);
    }
    break;
  ```

**MapCanvas.tsx — Picker decode (~line 2178-2185):**
- Import `WARP_STYLES` from `'@core/map/GameObjectData'`
- Replace `if (animId === 0xFA || animId === 0x9E)` with `if (WARP_STYLES.includes(animId))`
- Map animId back to warpType: `const warpType = WARP_STYLES.indexOf(animId);`
- Handle corrupted data: `const safeWarpType = warpType >= 0 ? warpType : 4;` (fallback to FA)
- Update setWarpSettings call: `setWarpSettings(warpSrc, warpDest, safeWarpType);`
- Remove the `currentWarpStyle` variable that was reading from state (no longer needed)

**MapCanvas.tsx — Warp cursor preview (~line 431-444):**
- Replace `gameObjectToolState.warpVariant === 0` with `gameObjectToolState.warpType !== 5`
- Replace `gameObjectToolState.warpVariant === 1` with `gameObjectToolState.warpType === 5`

**MapCanvas.tsx — Mouse handler (~line 1758-1766):**
- Replace `const { warpVariant } = useEditorStore.getState().gameObjectToolState;` with `const { warpType } = useEditorStore.getState().gameObjectToolState;`
- Replace `if (warpVariant === 1)` with `if (warpType === 5)`
  </action>
  <verify>Run `npm run typecheck` — should pass. Search codebase for any remaining references to `warpVariant` using grep — should find zero results (in .ts/.tsx files).</verify>
  <done>placeGameObject dispatches to correct warp placement for all 6 types, picker decodes routing from all 6 warp animation IDs and syncs warpType, cursor preview uses warpType check, zero remaining warpVariant references.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `grep -r "warpVariant" src/` returns no results (fully replaced)
3. `grep -r "WARP_STYLES" src/` shows usage in GameObjectData.ts, documentsSlice.ts, and MapCanvas.tsx
4. `grep "encodeWarpTile" src/` shows animId parameter in signature and call site
</verification>

<success_criteria>
- encodeWarpTile accepts animId parameter (not hardcoded 0xFA)
- GameObjectToolState has warpType: number (0-5 index, default 4)
- setWarpType action exists in GlobalSlice
- setWarpVariant removed (replaced by setWarpType)
- placeGameObject uses WARP_STYLES[warpType] for animId
- Picker decodes all 6 warp animation IDs and syncs warpType
- All warpVariant references removed from codebase
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/77-warp-tool-expansion/77-01-SUMMARY.md`
</output>
