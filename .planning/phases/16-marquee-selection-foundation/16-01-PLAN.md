---
phase: 16-marquee-selection-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/MapCanvas/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag on map canvas to define rectangular selection when SELECT tool is active"
    - "Active selection displays animated marching ants border (dashed line cycling)"
    - "User can cancel selection with Escape key"
    - "Selection coordinates remain accurate at all zoom levels (0.25x-4x)"
    - "Selection state persists across tool switches (stored in Zustand, not local state)"
  artifacts:
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "SELECT tool drag handling, marching ants rendering, Escape cancellation"
      contains: "ToolType.SELECT"
  key_links:
    - from: "MapCanvas handleMouseDown"
      to: "selectionDrag local state"
      via: "screenToTile conversion on mousedown when currentTool === ToolType.SELECT"
      pattern: "currentTool === ToolType\\.SELECT"
    - from: "MapCanvas handleMouseUp"
      to: "useEditorStore setSelection"
      via: "commit selectionDrag to Zustand store on mouseup"
      pattern: "setSelection.*active.*true"
    - from: "MapCanvas draw()"
      to: "selection state (Zustand) or selectionDrag (local)"
      via: "strokeRect with setLineDash and lineDashOffset from animationFrame"
      pattern: "setLineDash.*lineDashOffset"
    - from: "Escape keydown listener"
      to: "clearSelection"
      via: "useEffect with selection.active dependency"
      pattern: "clearSelection"
---

<objective>
Implement the SELECT tool's marquee selection behavior in MapCanvas: drag-to-select with marching ants visual feedback, Escape cancellation, and zoom-accurate coordinates.

Purpose: This is the foundation for all clipboard operations (copy/cut/paste/delete) in phases 17-19. Without a working selection, no region operations are possible.

Output: Working SELECT tool that creates visible rectangular selections on the map canvas with animated marching ants border.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-marquee-selection-foundation/16-RESEARCH.md
@src/components/MapCanvas/MapCanvas.tsx
@src/core/editor/EditorState.ts
@src/core/map/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire SELECT tool drag handling in MapCanvas mouse handlers</name>
  <files>src/components/MapCanvas/MapCanvas.tsx</files>
  <action>
Add selection drag handling to MapCanvas.tsx following the existing `rectDragState` pattern (lines 332-429, 595-599, 633-635, 681-685).

1. **Add local state for selection drag** (near line 45, alongside other useState):
```typescript
const [selectionDrag, setSelectionDrag] = useState<{
  active: boolean;
  startX: number;
  startY: number;
  endX: number;
  endY: number;
}>({ active: false, startX: 0, startY: 0, endX: 0, endY: 0 });
```

2. **Destructure selection state from store** (add to the useEditorStore destructure near line 48):
Add `selection`, `setSelection`, and `clearSelection` to the destructured store values.

3. **Handle mousedown for SELECT tool** (in handleMouseDown, around line 606 in the else-if chain):
Add a branch BEFORE the generic `pushUndo('Edit tiles') / handleToolAction` fallback:
```typescript
} else if (currentTool === ToolType.SELECT) {
  // Clear any existing selection and start new drag
  clearSelection();
  setSelectionDrag({ active: true, startX: x, startY: y, endX: x, endY: y });
}
```

4. **Handle mousemove for selection drag** (in handleMouseMove, add after the rectDragState.active check around line 633):
```typescript
} else if (selectionDrag.active) {
  setSelectionDrag(prev => ({ ...prev, endX: x, endY: y }));
}
```
This must come BEFORE the `isDrawingWallPencil` check and BEFORE the generic `e.buttons === 1` drawing check.

5. **Handle mouseup for selection drag** (in handleMouseUp, add near the top alongside the lineState.active and rectDragState.active checks):
```typescript
if (selectionDrag.active) {
  // Only create selection if user actually dragged (not just clicked)
  const minX = Math.min(selectionDrag.startX, selectionDrag.endX);
  const minY = Math.min(selectionDrag.startY, selectionDrag.endY);
  const maxX = Math.max(selectionDrag.startX, selectionDrag.endX);
  const maxY = Math.max(selectionDrag.startY, selectionDrag.endY);

  if (minX !== maxX || minY !== maxY) {
    // Commit normalized coordinates to Zustand store
    setSelection({ startX: minX, startY: minY, endX: maxX, endY: maxY, active: true });
  }
  setSelectionDrag({ active: false, startX: 0, startY: 0, endX: 0, endY: 0 });
}
```

6. **Handle mouse leave for selection drag** (in handleMouseLeave, add alongside the other cancellations):
```typescript
if (selectionDrag.active) {
  setSelectionDrag({ active: false, startX: 0, startY: 0, endX: 0, endY: 0 });
}
```

7. **Exclude SELECT from continuous drawing** (in handleMouseMove, around line 642):
Add `currentTool !== ToolType.SELECT` to the exclusion list in the `e.buttons === 1` continuous drawing check so SELECT doesn't trigger tile editing while dragging.

IMPORTANT: Store selection as tile coordinates (integers via screenToTile which already uses Math.floor). Never store pixel coordinates - this ensures zoom accuracy per research Pitfall 1.
  </action>
  <verify>
Run `npm run typecheck` to verify no TypeScript errors. The SELECT tool should be wirable in the mouse handler chain without breaking existing tools.
  </verify>
  <done>
SELECT tool creates selectionDrag local state on mousedown, updates on mousemove, commits normalized tile coordinates to Zustand setSelection() on mouseup. No pixel coordinates stored. Existing tool behaviors unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Render marching ants border and add Escape cancellation</name>
  <files>src/components/MapCanvas/MapCanvas.tsx</files>
  <action>
Add marching ants rendering and Escape key cancellation for the selection.

1. **Render marching ants in draw() function** (add after the rect drag preview section, around line 429, but BEFORE the cursor highlight section):

Render BOTH the committed Zustand selection AND the active selectionDrag (during drag). Use the existing `animationFrame` counter for animation (already in scope, already advancing at ~60fps):

```typescript
// Draw selection / marching ants
const activeSelection = selectionDrag.active
  ? selectionDrag  // During drag: use local state
  : selection.active
    ? selection    // After drag: use committed Zustand state
    : null;

if (activeSelection) {
  const minX = Math.min(activeSelection.startX, activeSelection.endX);
  const minY = Math.min(activeSelection.startY, activeSelection.endY);
  const maxX = Math.max(activeSelection.startX, activeSelection.endX);
  const maxY = Math.max(activeSelection.startY, activeSelection.endY);
  const w = maxX - minX + 1;
  const h = maxY - minY + 1;

  const selScreen = tileToScreen(minX, minY);

  // Marching ants: animated dash offset
  const dashOffset = -(animationFrame * 0.5) % 12;

  // Black background stroke (for contrast on light tiles)
  ctx.setLineDash([6, 6]);
  ctx.lineDashOffset = dashOffset;
  ctx.strokeStyle = '#000000';
  ctx.lineWidth = 1;
  ctx.strokeRect(selScreen.x, selScreen.y, w * tilePixels, h * tilePixels);

  // White foreground stroke (offset by half dash for alternating black/white)
  ctx.lineDashOffset = dashOffset + 6;
  ctx.strokeStyle = '#ffffff';
  ctx.strokeRect(selScreen.x, selScreen.y, w * tilePixels, h * tilePixels);

  ctx.setLineDash([]); // Reset for other drawing
}
```

The dual black+white stroke with offset creates the classic Photoshop/SEdit marching ants look (alternating black and white dashes that appear to march). This is superior to a single white stroke which disappears on light backgrounds.

2. **Add draw() dependency on selection and selectionDrag** (in the useCallback dependency array for draw, around line 430):
Add `selection` and `selectionDrag` to the dependency array.

3. **Add Escape key cancellation for committed selection** (add a new useEffect after the existing Escape handlers, around line 866):
```typescript
// Escape key cancellation for selection
useEffect(() => {
  if (!selection.active) return;
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      clearSelection();
    }
  };
  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [selection.active, clearSelection]);
```

This mirrors the exact pattern from rectDragState Escape (lines 842-853) and lineState Escape (lines 855-866).

4. **Also cancel selectionDrag on Escape** (extend the above or add separate handler):
If selectionDrag is active when Escape is pressed, cancel the drag too:
```typescript
// Escape key cancellation for selection drag (during active drag)
useEffect(() => {
  if (!selectionDrag.active) return;
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      setSelectionDrag({ active: false, startX: 0, startY: 0, endX: 0, endY: 0 });
    }
  };
  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [selectionDrag.active]);
```

IMPORTANT: Use existing `animationFrame` counter for dash offset animation (research recommendation). Do NOT create a separate requestAnimationFrame loop - the animationFrame counter is already advancing and driving redraws. This is zero additional overhead.
  </action>
  <verify>
Run `npm run typecheck` to verify no TypeScript errors. Then run `npm run electron:dev` and:
1. Select the SELECT tool (V key or click toolbar icon)
2. Drag on canvas - should see marching ants rectangle following drag
3. Release - marching ants should persist on committed selection
4. Press Escape - selection should clear
5. Zoom to 0.25x and 4x - selection border should align with tile grid
6. Switch to PENCIL tool and back - selection should persist (Zustand state)
  </verify>
  <done>
Marching ants border renders with alternating black/white dashed animation during drag and after commit. Escape clears selection at any time. Selection visible at all zoom levels. Animation driven by existing animationFrame counter with zero additional overhead.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify all 5 success criteria:

1. **Drag to select**: Switch to SELECT (V), drag on canvas, see rectangle forming
2. **Marching ants**: Selection border shows animated black/white dashed pattern
3. **Escape cancels**: Press Escape, selection disappears
4. **Zoom accuracy**: Zoom to 0.25x and 4x, create selection, verify border aligns with tile grid edges perfectly
5. **Persists across tools**: Create selection with SELECT, switch to PENCIL (B), switch back to SELECT (V) - selection still visible

Run `npm run typecheck` to ensure no type errors.
</verification>

<success_criteria>
- SELECT tool creates rectangular selection via drag on map canvas (SEL-01)
- Selection displays animated marching ants border with alternating black/white dashes (SEL-02)
- Escape key clears active selection (SEL-03)
- Selection coordinates are integer tile coordinates, accurate at 0.25x through 4x zoom (SEL-04)
- Selection state lives in Zustand store, persists across tool switches
- No performance regression (uses existing animationFrame counter, no new RAF loops)
- Existing tools (PENCIL, WALL, FILL, etc.) continue to work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/16-marquee-selection-foundation/16-01-SUMMARY.md`
</output>
