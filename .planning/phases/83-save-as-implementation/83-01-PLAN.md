---
phase: 83-save-as-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron/main.ts
  - electron/preload.ts
  - src/vite-env.d.ts
  - src/adapters/electron/ElectronFileService.ts
  - src/core/services/MapService.ts
  - src/core/services/FileService.ts
  - src/core/editor/slices/documentsSlice.ts
  - src/core/editor/EditorState.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "File > Save As... menu item visible in File menu between Save and separator"
    - "Ctrl+Shift+S keyboard shortcut triggers Save As dialog"
    - "Save As dialog pre-fills current filename from active document"
    - "After Save As, subsequent File > Save writes to new filename"
    - "Window title updates to show new filename after Save As"
    - "Document modified indicator clears after Save As"
  artifacts:
    - path: "electron/main.ts"
      provides: "Save As menu item with CmdOrCtrl+Shift+S accelerator, defaultPath parameter on dialog:saveFile IPC handler"
      contains: "Save As..."
    - path: "electron/preload.ts"
      provides: "saveFileDialog accepts optional defaultPath string"
      contains: "saveFileDialog"
    - path: "src/vite-env.d.ts"
      provides: "Updated ElectronAPI type with defaultPath parameter"
      contains: "saveFileDialog"
    - path: "src/adapters/electron/ElectronFileService.ts"
      provides: "Passes defaultPath to IPC saveFileDialog call"
    - path: "src/core/services/MapService.ts"
      provides: "saveMapAs method that always shows dialog with defaultPath"
    - path: "src/core/editor/slices/documentsSlice.ts"
      provides: "updateFilePathForDocument action"
      contains: "updateFilePathForDocument"
    - path: "src/core/editor/EditorState.ts"
      provides: "Backward-compat updateFilePath wrapper"
    - path: "src/App.tsx"
      provides: "handleSaveAsMap callback wired to save-as menu-action"
      contains: "handleSaveAsMap"
  key_links:
    - from: "electron/main.ts"
      to: "src/App.tsx"
      via: "menu-action IPC sends 'save-as' string"
      pattern: "send\\('menu-action', 'save-as'\\)"
    - from: "src/App.tsx"
      to: "src/core/services/MapService.ts"
      via: "handleSaveAsMap calls mapService.saveMapAs"
      pattern: "mapService\\.saveMapAs"
    - from: "src/App.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "updateFilePath updates document filePath and window title"
      pattern: "updateFilePath"
    - from: "src/adapters/electron/ElectronFileService.ts"
      to: "electron/preload.ts"
      via: "saveFileDialog passes defaultPath to IPC bridge"
      pattern: "saveFileDialog\\(defaultPath\\)"
---

<objective>
Implement Save As functionality end-to-end: IPC layer accepts defaultPath for pre-filling the save dialog, MapService exposes a saveMapAs method, Zustand state updates document filePath and window title atomically, and App.tsx orchestrates the full workflow triggered by File > Save As menu item or Ctrl+Shift+S.

Purpose: Users need to save maps under different filenames -- a fundamental desktop app feature. Without Save As, users must manually copy files externally.
Output: Working Save As flow from menu/shortcut through dialog to state synchronization.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/83-save-as-implementation/83-RESEARCH.md

@electron/main.ts
@electron/preload.ts
@src/vite-env.d.ts
@src/adapters/electron/ElectronFileService.ts
@src/core/services/FileService.ts
@src/core/services/MapService.ts
@src/core/editor/slices/documentsSlice.ts
@src/core/editor/slices/windowSlice.ts
@src/core/editor/EditorState.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend IPC and service layers to support defaultPath in save dialog</name>
  <files>
    electron/main.ts
    electron/preload.ts
    src/vite-env.d.ts
    src/adapters/electron/ElectronFileService.ts
    src/core/services/FileService.ts
    src/core/services/MapService.ts
  </files>
  <action>
    **1. electron/main.ts -- dialog:saveFile IPC handler (line ~248):**
    Add `defaultPath?: string` parameter to the handler. Pass it to `dialog.showSaveDialog`:
    ```typescript
    ipcMain.handle('dialog:saveFile', async (_, defaultPath?: string) => {
      const result = await dialog.showSaveDialog(mainWindow!, {
        defaultPath,
        filters: [
          { name: 'Map Files', extensions: ['map'] },
          { name: 'All Files', extensions: ['*'] }
        ]
      });
      if (result.canceled || !result.filePath) return null;
      return result.filePath;
    });
    ```

    **2. electron/main.ts -- File menu (line ~103):**
    Add "Save As..." menu item between "Save" and the separator. Use `CmdOrCtrl+Shift+S` accelerator:
    ```typescript
    {
      label: 'Save As...',
      accelerator: 'CmdOrCtrl+Shift+S',
      click: () => {
        mainWindow?.webContents.send('menu-action', 'save-as');
      }
    },
    ```

    **3. electron/preload.ts -- saveFileDialog (line ~7):**
    Change `saveFileDialog` to accept and pass `defaultPath` parameter:
    ```typescript
    saveFileDialog: (defaultPath?: string) => ipcRenderer.invoke('dialog:saveFile', defaultPath),
    ```
    Update the `ElectronAPI` interface (line ~51) accordingly:
    ```typescript
    saveFileDialog: (defaultPath?: string) => Promise<string | null>;
    ```

    **4. src/vite-env.d.ts -- ElectronAPI interface (line ~5):**
    Update `saveFileDialog` type to accept optional defaultPath:
    ```typescript
    saveFileDialog: (defaultPath?: string) => Promise<string | null>;
    ```

    **5. src/core/services/FileService.ts -- saveMapDialog (line ~70):**
    The interface already has `defaultName?: string` parameter. Rename it to `defaultPath?: string` for clarity (it's a full path, not just a name):
    ```typescript
    saveMapDialog(defaultPath?: string): Promise<FileDialogResult>;
    ```

    **6. src/adapters/electron/ElectronFileService.ts -- saveMapDialog (line ~49):**
    Update parameter name and pass it through to the IPC call:
    ```typescript
    async saveMapDialog(defaultPath?: string): Promise<FileDialogResult> {
      const filePath = await window.electronAPI.saveFileDialog(defaultPath);
      return {
        filePath,
        canceled: !filePath,
      };
    }
    ```

    **7. src/core/services/MapService.ts -- add saveMapAs method:**
    Add a new `saveMapAs` method that ALWAYS shows the dialog (unlike `saveMap` which skips dialog when filePath is provided). It accepts `defaultPath` to pre-fill the dialog:
    ```typescript
    async saveMapAs(map: MapData, defaultPath?: string): Promise<MapSaveResult> {
      // Always show dialog, pre-filled with defaultPath
      const dialogResult = await this.fileService.saveMapDialog(defaultPath);
      if (dialogResult.canceled || !dialogResult.filePath) {
        return { success: false, error: 'canceled' };
      }
      const filePath = dialogResult.filePath;

      // Serialize, compress, write (same as saveMap)
      const headerBuffer = mapParser.serialize(map);
      const tileBytes = new Uint8Array(map.tiles.buffer);
      const tileBuffer = tileBytes.buffer.slice(0) as ArrayBuffer;
      const compResult = await this.fileService.compress(tileBuffer);
      if (!compResult.success) {
        return { success: false, error: `Compression failed: ${compResult.error}` };
      }
      const headerBytes = new Uint8Array(headerBuffer);
      const compressedBytes = new Uint8Array(compResult.data!);
      const fullBuffer = new Uint8Array(headerBytes.length + compressedBytes.length);
      fullBuffer.set(headerBytes);
      fullBuffer.set(compressedBytes, headerBytes.length);
      const fullBufferCopy = fullBuffer.buffer.slice(0) as ArrayBuffer;
      const writeResult = await this.fileService.writeFile(filePath, fullBufferCopy);
      if (!writeResult.success) {
        return { success: false, error: writeResult.error };
      }

      return { success: true, filePath };
    }
    ```
    Note: The serialization/write logic is duplicated from saveMap. This is acceptable for a 2-method service. Do NOT refactor saveMap to avoid changing existing working code.
  </action>
  <verify>
    Run `npm run typecheck` -- should pass with no errors related to saveFileDialog, saveMapDialog, or saveMapAs signatures.
  </verify>
  <done>
    IPC handler accepts defaultPath and passes it to Electron's showSaveDialog. Preload bridge and type definitions updated. ElectronFileService passes defaultPath through. MapService has saveMapAs method that always shows dialog. File menu has "Save As..." item with Ctrl+Shift+S accelerator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Save As through Zustand state and App.tsx handler</name>
  <files>
    src/core/editor/slices/documentsSlice.ts
    src/core/editor/EditorState.ts
    src/App.tsx
  </files>
  <action>
    **1. src/core/editor/slices/documentsSlice.ts -- add updateFilePathForDocument:**
    Add to the `DocumentsSlice` interface (after markSavedForDocument, ~line 71):
    ```typescript
    updateFilePathForDocument: (id: DocumentId, filePath: string) => void;
    ```

    Implement in the slice creator (after markSavedForDocument implementation, ~line 820):
    ```typescript
    updateFilePathForDocument: (id, filePath) => {
      const doc = get().documents.get(id);
      if (!doc) return;

      set((state) => {
        const newDocs = new Map(state.documents);
        newDocs.set(id, { ...doc, filePath });

        // Also update window title to reflect new filename
        const newWindowStates = new Map(state.windowStates);
        const windowState = newWindowStates.get(id);
        if (windowState) {
          const filename = filePath.split(/[\\/]/).pop() || 'Untitled';
          newWindowStates.set(id, { ...windowState, title: filename });
        }

        return { documents: newDocs, windowStates: newWindowStates };
      });
    },
    ```
    Key: This action updates BOTH DocumentState.filePath AND WindowState.title atomically in a single set() call. Uses `/[\\/]/` regex for cross-platform path splitting.

    **2. src/core/editor/EditorState.ts -- add updateFilePath backward-compat wrapper:**
    Add to the BackwardCompatLayer interface (~line 58, after markSaved):
    ```typescript
    updateFilePath: (filePath: string) => void;
    ```

    Add implementation (~line 432, after markSaved wrapper):
    ```typescript
    updateFilePath: (filePath) => {
      const id = get().activeDocumentId;
      if (!id) return;
      get().updateFilePathForDocument(id, filePath);
      // Sync filePath field (granular update)
      set({ filePath });
    },
    ```

    **3. src/App.tsx -- add handleSaveAsMap and wire it:**

    Add `updateFilePath` to the Zustand selectors at the top of the component (near line 29, alongside markSaved):
    ```typescript
    const updateFilePath = useEditorStore((state) => state.updateFilePath);
    ```

    Add the handleSaveAsMap callback (after handleSaveMap, ~line 190):
    ```typescript
    // Save map as new file
    const handleSaveAsMap = useCallback(async () => {
      const state = useEditorStore.getState();
      const { activeDocumentId, documents } = state;
      if (!activeDocumentId) return;

      const doc = documents.get(activeDocumentId);
      if (!doc?.map) return;

      // Pre-fill dialog with current filename (or undefined for new maps)
      const defaultPath = doc.filePath || undefined;

      const result = await mapService.saveMapAs(doc.map, defaultPath);
      if (!result.success) {
        if (result.error !== 'canceled') {
          alert(`Failed to save map: ${result.error}`);
        }
        return;
      }

      // Update document filePath and window title, then mark saved
      updateFilePath(result.filePath!);
      markSaved();

      alert('Map saved successfully!');
    }, [markSaved, updateFilePath, mapService]);
    ```

    Wire to menu-action handler (~line 288, after the 'save' case):
    ```typescript
    case 'save-as': handleSaveAsMap(); break;
    ```
    Note: The menu-action listener uses a ref-based handler pattern (menuActionRef) that captures handlers at registration time. Since handleSaveAsMap is called inside the handler closure that accesses the function through the outer scope, it needs to be defined BEFORE the useEffect. The existing pattern with the `// eslint-disable-next-line react-hooks/exhaustive-deps` on the empty deps array means the handler captures the initial function reference. This is fine because handleSaveAsMap uses useEditorStore.getState() internally (not stale closure state) and mapService is a stable ref.

    Also add handleSaveAsMap to the dependencies of handleCloseDocument if you want "Save As" behavior on close -- but DO NOT do this. Close should use regular Save, matching standard apps. Leave handleCloseDocument unchanged.
  </action>
  <verify>
    Run `npm run typecheck` -- should pass with no errors.
    Run `npm run electron:dev` -- verify:
    1. File menu shows "Save As..." between "Save" and the separator
    2. Open a map, then File > Save As... shows dialog with current filename pre-filled
    3. Save to new filename -- window title updates to new filename
    4. Make an edit, File > Save writes to the NEW filename (not original)
    5. Ctrl+Shift+S opens the Save As dialog
    6. New (unsaved) map -- Save As shows dialog without pre-filled path
    7. Cancel Save As dialog -- no state changes, no errors
  </verify>
  <done>
    updateFilePathForDocument updates both document filePath and window title atomically. handleSaveAsMap in App.tsx orchestrates the full Save As workflow: shows dialog with current filename, saves file, updates state, marks saved. Menu-action 'save-as' dispatches to handleSaveAsMap. All 4 success criteria met: menu item visible, Ctrl+Shift+S works, dialog pre-fills filename, subsequent Save uses new path, window title updates.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. File > Save As... menu item visible between Save and separator
3. Ctrl+Shift+S keyboard shortcut opens Save As dialog
4. Save As dialog pre-fills current filename for existing maps
5. Save As dialog has no pre-filled path for new/untitled maps
6. After Save As to "newmap.map", window title shows "newmap.map"
7. After Save As, File > Save writes to the new filename (not original)
8. After Save As, modified indicator (*) clears from window title
9. Cancel in Save As dialog produces no side effects
10. MDI child window title bar also reflects the new filename
</verification>

<success_criteria>
- FILE-01: User can select File > Save As from menu to save under different filename
- FILE-02: After Save As, subsequent File > Save writes to new filename
- FILE-03: Window title updates to reflect new filename after Save As
- Ctrl+Shift+S keyboard shortcut triggers Save As
- No regressions in existing Save, Open, New, or Close workflows
</success_criteria>

<output>
After completion, create `.planning/phases/83-save-as-implementation/83-01-SUMMARY.md`
</output>
