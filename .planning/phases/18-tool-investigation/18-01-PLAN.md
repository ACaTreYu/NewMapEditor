---
phase: 18-tool-investigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/EditorState.ts
  - src/components/MapCanvas/MapCanvas.tsx
  - src/components/ToolBar/ToolBar.tsx
autonomous: true

must_haves:
  truths:
    - "User can paste clipboard as floating preview with Ctrl+V"
    - "Floating paste preview renders semi-transparently (70% opacity) and follows cursor"
    - "User can commit floating paste with left click"
    - "User can cancel floating paste with Escape key"
    - "Paste preview works correctly at all zoom levels (0.25x-4x)"
  artifacts:
    - path: "src/core/editor/EditorState.ts"
      provides: "Paste preview state (isPasting, pastePreviewPosition) and pasteAt action"
      contains: "isPasting"
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "Paste preview rendering in overlay layer"
      contains: "isPasting"
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Ctrl+V triggers paste preview mode"
      contains: "isPasting"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "EditorState.startPasting"
      via: "Ctrl+V keyboard shortcut"
      pattern: "startPasting|isPasting"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "EditorState.isPasting"
      via: "selector subscription"
      pattern: "isPasting.*useEditorStore"
    - from: "src/components/MapCanvas/MapCanvas.tsx overlay"
      to: "clipboard.tiles"
      via: "drawImage with globalAlpha = 0.7"
      pattern: "globalAlpha.*0\\.7"
---

<objective>
Implement floating paste preview for clipboard operations, completing SEdit parity for the paste workflow.

Purpose: Users can paste clipboard contents with visual preview before committing, matching SEdit's paste behavior. The preview follows the cursor and renders semi-transparently, allowing precise placement.

Output: Working floating paste preview with Ctrl+V trigger, cursor following, click-to-commit, and Escape-to-cancel.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-clipboard-operations/17-01-SUMMARY.md
@.planning/phases/18-tool-investigation/18-RESEARCH.md

Key existing patterns to reuse:
- Conveyor preview (Phase 15): 70% opacity live preview with `ctx.globalAlpha = 0.7`
- Selection drag pattern: Local useState for active state, Zustand for committed state
- Escape cancellation: useEffect with `.active` dependency, window keydown listener
- Tile coordinate storage: Store as integers for zoom accuracy (like selection)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add paste preview state and pasteAt action to EditorState</name>
  <files>src/core/editor/EditorState.ts</files>
  <action>
Add paste preview state and actions to EditorState:

1. Add state fields to EditorState interface:
```typescript
// Paste preview state
isPasting: boolean;
pastePreviewPosition: { x: number; y: number } | null;
```

2. Add to initial state (after clipboard):
```typescript
isPasting: false,
pastePreviewPosition: null,
```

3. Add actions to interface:
```typescript
startPasting: () => void;
cancelPasting: () => void;
setPastePreviewPosition: (x: number, y: number) => void;
pasteAt: (x: number, y: number) => void;
```

4. Implement actions:
```typescript
startPasting: () => {
  const { clipboard } = get();
  if (!clipboard) return;
  set({ isPasting: true, pastePreviewPosition: null });
},

cancelPasting: () => set({
  isPasting: false,
  pastePreviewPosition: null
}),

setPastePreviewPosition: (x, y) => set({
  pastePreviewPosition: { x, y }
}),

pasteAt: (x, y) => {
  const { map, clipboard } = get();
  if (!map || !clipboard) return;

  get().pushUndo('Paste');

  const tiles: Array<{ x: number; y: number; tile: number }> = [];
  for (let dy = 0; dy < clipboard.height; dy++) {
    for (let dx = 0; dx < clipboard.width; dx++) {
      const mapX = x + dx;
      const mapY = y + dy;

      // Silently discard out-of-bounds tiles
      if (mapX >= 0 && mapX < MAP_WIDTH && mapY >= 0 && mapY < MAP_HEIGHT) {
        tiles.push({ x: mapX, y: mapY, tile: clipboard.tiles[dy * clipboard.width + dx] });
      }
    }
  }
  get().setTiles(tiles);

  // Pasted region becomes active selection
  set({
    isPasting: false,
    pastePreviewPosition: null,
    selection: {
      startX: x,
      startY: y,
      endX: Math.min(MAP_WIDTH - 1, x + clipboard.width - 1),
      endY: Math.min(MAP_HEIGHT - 1, y + clipboard.height - 1),
      active: true
    }
  });
},
```

5. Update existing pasteClipboard to delegate to startPasting (change behavior):
```typescript
pasteClipboard: () => {
  // Trigger paste preview mode instead of immediate paste
  get().startPasting();
},
```

Note: Keep the old pasteClipboard method but change it to start paste preview mode. The immediate paste at origin behavior is replaced by floating preview workflow.
  </action>
  <verify>
Run `npm run typecheck` - should pass with no errors.
Verify EditorState exports isPasting, pastePreviewPosition, startPasting, cancelPasting, setPastePreviewPosition, pasteAt.
  </verify>
  <done>
EditorState has paste preview state (isPasting, pastePreviewPosition) and actions (startPasting, cancelPasting, setPastePreviewPosition, pasteAt). Type check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add paste preview rendering and interactions to MapCanvas and ToolBar</name>
  <files>src/components/MapCanvas/MapCanvas.tsx, src/components/ToolBar/ToolBar.tsx</files>
  <action>
**Part A: Update ToolBar.tsx Ctrl+V handler**

In the global keyboard handler (useEffect with keydown listener), update the Ctrl+V handler:

```typescript
// Change from calling pasteClipboard directly to startPasting
if ((e.key === 'v' || e.key === 'V') && clipboard) {
  e.preventDefault();
  startPasting();  // Instead of pasteClipboard()
}
```

Update the useShallow selector to include startPasting:
```typescript
const { clipboard, startPasting, ... } = useEditorStore(
  useShallow((state) => ({
    clipboard: state.clipboard,
    startPasting: state.startPasting,
    // ... other existing fields
  }))
);
```

**Part B: Update MapCanvas.tsx**

1. Add isPasting and related actions to subscriptions:
```typescript
// Add to tool/interaction state selector
const { ..., isPasting, clipboard, pastePreviewPosition } = useEditorStore(
  useShallow((state) => ({
    ...
    isPasting: state.isPasting,
    clipboard: state.clipboard,
    pastePreviewPosition: state.pastePreviewPosition
  }))
);

// Add to action subscriptions
const { ..., cancelPasting, setPastePreviewPosition, pasteAt } = useEditorStore(
  useShallow((state) => ({
    ...
    cancelPasting: state.cancelPasting,
    setPastePreviewPosition: state.setPastePreviewPosition,
    pasteAt: state.pasteAt
  }))
);
```

2. In handleMouseMove, update paste preview position when isPasting:
```typescript
// After setCursorTile({ x, y });
if (isPasting) {
  setPastePreviewPosition(x, y);
}
```

3. In handleMouseDown, commit paste on left click when isPasting:
```typescript
// Add at the start of the left-click handler (before other tool handling)
if (isPasting && e.button === 0 && !e.altKey) {
  pasteAt(x, y);
  return;  // Don't process other tool actions
}
```

4. In drawOverlayLayer, add paste preview rendering (after line preview, before cursor highlight):
```typescript
// Draw floating paste preview
if (isPasting && clipboard && pastePreviewPosition && tilesetImage) {
  const previewX = pastePreviewPosition.x;
  const previewY = pastePreviewPosition.y;

  ctx.globalAlpha = 0.7;  // Semi-transparent like conveyor preview

  for (let dy = 0; dy < clipboard.height; dy++) {
    for (let dx = 0; dx < clipboard.width; dx++) {
      const mapX = previewX + dx;
      const mapY = previewY + dy;

      // Skip out-of-bounds tiles
      if (mapX < 0 || mapX >= MAP_WIDTH || mapY < 0 || mapY >= MAP_HEIGHT) continue;

      const tile = clipboard.tiles[dy * clipboard.width + dx];
      const screenX = Math.floor((mapX - viewport.x) * tilePixels);
      const screenY = Math.floor((mapY - viewport.y) * tilePixels);
      const destSize = Math.ceil(tilePixels);

      const isAnimated = (tile & 0x8000) !== 0;
      if (isAnimated) {
        const animId = tile & 0xFF;
        const frameOffset = (tile >> 8) & 0x7F;
        const anim = ANIMATION_DEFINITIONS[animId];
        if (anim && anim.frames.length > 0) {
          const frameIdx = (animationFrame + frameOffset) % anim.frameCount;
          const displayTile = anim.frames[frameIdx] || 0;
          const srcX = (displayTile % TILES_PER_ROW) * TILE_SIZE;
          const srcY = Math.floor(displayTile / TILES_PER_ROW) * TILE_SIZE;
          ctx.drawImage(tilesetImage, srcX, srcY, TILE_SIZE, TILE_SIZE,
            screenX, screenY, destSize, destSize);
        }
      } else {
        const srcX = (tile % TILES_PER_ROW) * TILE_SIZE;
        const srcY = Math.floor(tile / TILES_PER_ROW) * TILE_SIZE;
        ctx.drawImage(tilesetImage, srcX, srcY, TILE_SIZE, TILE_SIZE,
          screenX, screenY, destSize, destSize);
      }
    }
  }

  ctx.globalAlpha = 1.0;

  // Draw outline around paste preview region
  const topLeft = tileToScreen(previewX, previewY);
  ctx.strokeStyle = 'rgba(0, 200, 255, 0.8)';
  ctx.lineWidth = 2;
  ctx.setLineDash([4, 4]);
  ctx.strokeRect(topLeft.x + 1, topLeft.y + 1,
    clipboard.width * tilePixels - 2, clipboard.height * tilePixels - 2);
  ctx.setLineDash([]);
}
```

5. Add Escape key cancellation for paste preview:
```typescript
// Add useEffect for Escape cancellation (similar to selection, lineState, etc.)
useEffect(() => {
  if (!isPasting) return;
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      cancelPasting();
    }
  };
  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [isPasting, cancelPasting]);
```

6. Update dependencies in drawOverlayLayer useCallback:
Add isPasting, clipboard, pastePreviewPosition to the dependency array.

7. Cancel pasting on mouse leave (optional but good UX):
In handleMouseLeave, add:
```typescript
if (isPasting) {
  cancelPasting();
}
```
  </action>
  <verify>
1. Run `npm run typecheck` - should pass with no errors
2. Run `npm run electron:dev` and test:
   - Create a selection, Ctrl+C to copy
   - Ctrl+V should show semi-transparent preview following cursor
   - Move cursor around - preview should follow smoothly
   - Left click should commit paste at cursor position
   - Ctrl+C to copy, Ctrl+V, then Escape should cancel (no paste)
   - Test at zoom levels 0.25x, 1x, and 4x - preview should render correctly
   - Test at map boundaries (near x=0, y=0, x=255, y=255) - out-of-bounds tiles clipped
  </verify>
  <done>
Floating paste preview renders at 70% opacity following cursor. Ctrl+V triggers preview mode. Click commits paste at cursor position. Escape cancels. Works at all zoom levels.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run typecheck` passes
2. `npm run electron:dev` runs without errors
3. Full paste preview workflow:
   - SELECT tool, drag to create selection
   - Ctrl+C copies selection
   - Ctrl+V shows floating preview (70% opacity)
   - Move mouse - preview follows cursor aligned to tile grid
   - Click commits paste, selection appears around pasted region
   - Ctrl+V again, move, Escape cancels without pasting
4. Zoom test: Preview renders correctly at 0.25x, 0.5x, 1x, 2x, 4x
5. Boundary test: Paste near edges clips out-of-bounds tiles
</verification>

<success_criteria>
- [ ] CLIP-03: User can paste clipboard as floating preview (Ctrl+V)
- [ ] CLIP-05: Floating paste preview renders semi-transparently (70%) and follows cursor
- [ ] CLIP-06: User can commit floating paste with click, or cancel with Escape
- [ ] Preview works at all zoom levels (0.25x-4x)
- [ ] Type check passes
- [ ] No console errors during paste operations
</success_criteria>

<output>
After completion, create `.planning/phases/18-tool-investigation/18-01-SUMMARY.md`
</output>
