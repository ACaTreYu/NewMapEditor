---
phase: 88-build-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - electron/platform.ts
  - electron/main.ts
autonomous: false

must_haves:
  truths:
    - "Running `npm run electron:build:win` produces a Windows NSIS installer in `release/`"
    - "Running `npm run electron:build:linux` (from WSL/Linux) produces a `.AppImage` file in `release/`"
    - "All process.platform checks live in `electron/platform.ts`, not scattered across files"
    - "electron-builder config has per-platform override blocks (win/linux sections) with shared base"
  artifacts:
    - path: "electron/platform.ts"
      provides: "Centralized platform detection constants and helpers"
      contains: "isMac.*isLinux.*isWindows"
    - path: "package.json"
      provides: "Platform-specific build scripts"
      contains: "electron:build:win.*electron:build:linux"
  key_links:
    - from: "electron/main.ts"
      to: "electron/platform.ts"
      via: "import { registerWindowAllClosed } from './platform'"
      pattern: "import.*platform"
    - from: "package.json scripts"
      to: "electron-builder CLI"
      via: "--win and --linux flags"
      pattern: "electron-builder --win|electron-builder --linux"
---

<objective>
Configure electron-builder for cross-platform builds and consolidate platform-conditional code.

Purpose: Enable the project to build both Windows NSIS installers and Linux AppImage artifacts from platform-specific npm scripts, while establishing `electron/platform.ts` as the single home for all `process.platform` logic — preparing the codebase for Phase 89's Linux-specific platform polish.

Output: Updated `package.json` with build scripts, new `electron/platform.ts`, refactored `electron/main.ts`.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/88-build-architecture/88-RESEARCH.md
@electron/main.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cross-platform build scripts and create platform.ts</name>
  <files>
    package.json
    electron/platform.ts
    electron/main.ts
  </files>
  <action>
    **Step 1: Add platform-specific npm scripts to `package.json`**

    Add two new scripts to the `scripts` block in `package.json`:
    ```json
    "electron:build:win": "vite build && electron-builder --win",
    "electron:build:linux": "vite build && electron-builder --linux"
    ```

    Place them after the existing `"electron:build"` script. Keep `"electron:build"` unchanged (it builds for the current host platform).

    Do NOT modify the `build` config block — it is already correctly structured with per-platform overrides (`win`, `linux`, `mac` sections with shared base).

    **Step 2: Create `electron/platform.ts`**

    Create a new file `electron/platform.ts` with the following exact content:

    ```typescript
    import type { App } from 'electron';

    // ── Platform Detection ─────────────────────────────────────────────
    // Single location for all process.platform checks.
    // Never add platform checks in renderer (src/) code.
    // Phase 89 will add XDG paths and menu adjustments here.

    export const isMac     = process.platform === 'darwin';
    export const isLinux   = process.platform === 'linux';
    export const isWindows = process.platform === 'win32';

    /**
     * Standard Electron: quit when all windows close.
     * On macOS, apps stay running until explicitly quit (Cmd+Q).
     */
    export function registerWindowAllClosed(app: App): void {
      app.on('window-all-closed', () => {
        if (!isMac) {
          app.quit();
        }
      });
    }
    ```

    **Step 3: Refactor `electron/main.ts` to use `platform.ts`**

    In `electron/main.ts`:

    1. Add import at the top of the file (after existing imports):
       ```typescript
       import { registerWindowAllClosed } from './platform';
       ```

    2. Remove the inline `window-all-closed` handler (lines 380-384):
       ```typescript
       // REMOVE THIS BLOCK:
       app.on('window-all-closed', () => {
         if (process.platform !== 'darwin') {
           app.quit();
         }
       });
       ```

    3. Replace it with a call to the platform helper. Place it right after the `app.whenReady().then(...)` block:
       ```typescript
       registerWindowAllClosed(app);
       ```

    **Important:** Do NOT change any other part of `main.ts`. The `app.on('activate', ...)` handler stays as-is (it does not contain `process.platform` checks). The `isDev` check (`process.env.NODE_ENV`) is NOT a platform check and stays in `main.ts`.
  </action>
  <verify>
    1. Run `npm run typecheck` — must pass with no errors (confirms platform.ts types are correct and main.ts import resolves)
    2. Verify `package.json` has both new scripts: `grep "electron:build:win" package.json && grep "electron:build:linux" package.json`
    3. Verify `electron/platform.ts` exists and exports the three constants: `grep "export const isMac" electron/platform.ts && grep "export const isLinux" electron/platform.ts && grep "export const isWindows" electron/platform.ts`
    4. Verify no `process.platform` in `main.ts`: `grep "process.platform" electron/main.ts` — should return NO matches
    5. Verify `main.ts` imports from platform: `grep "import.*platform" electron/main.ts`
    6. Run `npm run electron:build:win` and confirm it produces a `.exe` installer in `release/` (this runs on Windows, should work from the current environment)
  </verify>
  <done>
    - `package.json` has `electron:build:win` and `electron:build:linux` scripts using `--win` and `--linux` flags respectively
    - `electron/platform.ts` exists with `isMac`, `isLinux`, `isWindows` constants and `registerWindowAllClosed()` helper
    - `electron/main.ts` has zero `process.platform` references — imports and calls `registerWindowAllClosed(app)` from `platform.ts`
    - `npm run typecheck` passes
    - `npm run electron:build:win` produces a working Windows installer in `release/` (no regression)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Linux AppImage build in WSL</name>
  <what-built>
    Cross-platform build scripts and platform isolation module. The Windows build has been verified automatically. The Linux build requires WSL or a Linux environment because electron-builder cannot produce a real AppImage from a Windows host.
  </what-built>
  <how-to-verify>
    1. Open WSL2 terminal
    2. Navigate to the project: `cd /mnt/e/NewMapEditor`
    3. Run `npm install` inside WSL (rebuilds native modules for Linux if needed)
    4. Run `npm run electron:build:linux`
    5. Check that `release/` contains a `.AppImage` file (e.g., `AC Map Editor-1.1.2.AppImage`)
    6. Check that `release/` contains `latest-linux.yml` (needed by Phase 89 for auto-updater)
    7. (Optional) Run the AppImage on a Linux desktop or in WSLg to verify it launches

    **If WSL build fails with node_modules errors:**
    - Run `rm -rf node_modules && npm install` inside WSL to get Linux-compatible modules
    - Retry the build

    **If icon warnings appear:**
    - Check `atom.png` dimensions — if under 512x512, this is a known cosmetic issue (Phase 89 can address)
    - The build should still succeed; icon quality may be suboptimal
  </how-to-verify>
  <resume-signal>Type "approved" if AppImage was produced successfully, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
**Requirements coverage:**
- BUILD-01 (Linux AppImage via electron-builder): Task 1 adds the script, Task 2 verifies AppImage output
- BUILD-02 (Cross-platform build scripts): Task 1 adds `electron:build:win` and `electron:build:linux`
- BUILD-03 (Per-platform override blocks): Already satisfied by existing config; Task 1 verifies no changes needed
- PLAT-03 (Platform-conditional code isolated): Task 1 creates `electron/platform.ts` and removes `process.platform` from `main.ts`

**Regression check:**
- Windows build must still produce a working NSIS installer (Task 1 verify step 6)
- No functional changes to the application — only build scripts and platform code refactoring
</verification>

<success_criteria>
1. `npm run electron:build:win` produces a Windows `.exe` installer in `release/` (no regression)
2. `npm run electron:build:linux` (run from WSL) produces a `.AppImage` in `release/`
3. `electron/platform.ts` is the single location for `process.platform` checks
4. `electron/main.ts` has zero `process.platform` references
5. `npm run typecheck` passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/88-build-architecture/88-01-SUMMARY.md`
</output>
