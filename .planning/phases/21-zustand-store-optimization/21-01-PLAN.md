---
phase: 21-zustand-store-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/EditorState.ts
  - src/components/StatusBar/StatusBar.tsx
  - src/components/Minimap/Minimap.tsx
  - src/components/TilePalette/TilePalette.tsx
  - src/components/GameObjectToolPanel/GameObjectToolPanel.tsx
  - src/components/MapSettingsPanel/MapSettingsPanel.tsx
  - src/components/AnimationPanel/AnimationPanel.tsx
  - src/components/AnimationPreview/AnimationPreview.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "No component uses bare useEditorStore() destructuring (except ToolBar and MapCanvas, migrated in plan 02)"
    - "AnimationPanel and AnimationPreview still animate correctly (subscribe to animationFrame)"
    - "StatusBar, Minimap, TilePalette, GameObjectToolPanel, MapSettingsPanel do NOT subscribe to animationFrame"
    - "canUndo/canRedo methods removed from EditorState interface and implementation"
    - "Application builds without TypeScript errors"
  artifacts:
    - path: "src/core/editor/EditorState.ts"
      provides: "Store without canUndo/canRedo methods"
      contains: "undoStack"
    - path: "src/components/StatusBar/StatusBar.tsx"
      provides: "Granular selector subscriptions"
      contains: "useShallow"
    - path: "src/components/AnimationPanel/AnimationPanel.tsx"
      provides: "Granular selectors including animationFrame"
      contains: "useShallow"
  key_links:
    - from: "src/components/AnimationPanel/AnimationPanel.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "useShallow selector including animationFrame"
      pattern: "useShallow.*animationFrame"
    - from: "src/components/StatusBar/StatusBar.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "useShallow selector WITHOUT animationFrame"
      pattern: "useShallow.*viewport"
---

<objective>
Remove canUndo/canRedo methods from the Zustand store and migrate 8 simple/medium components from bare useEditorStore() destructuring to granular selectors using useShallow.

Purpose: Eliminate unnecessary re-renders across most of the component tree. Components that don't need animationFrame will no longer re-render every 150ms. Removing canUndo/canRedo methods prepares the store for selector-based reactive derived state (consumed in plan 02).

Output: EditorState.ts cleaned up, 8 components migrated to granular selectors, app builds clean.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-zustand-store-optimization/21-RESEARCH.md
@src/core/editor/EditorState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove canUndo/canRedo methods from EditorState</name>
  <files>src/core/editor/EditorState.ts</files>
  <action>
  Remove the canUndo and canRedo METHOD entries from the EditorState interface and from the store implementation.

  Specifically:
  1. In the `interface EditorState`, DELETE these two lines:
     ```
     canUndo: () => boolean;
     canRedo: () => boolean;
     ```
  2. In the `create<EditorState>` implementation, DELETE these two lines:
     ```
     canUndo: () => get().undoStack.length > 0,
     canRedo: () => get().redoStack.length > 0,
     ```

  Do NOT add any replacement. Components will use inline selectors like `useEditorStore((state) => state.undoStack.length > 0)` directly (done in plan 02 for ToolBar).

  Do NOT change any other part of EditorState.ts in this task.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -c "canUndo\|canRedo"` to find any remaining references. The ToolBar.tsx will have compile errors (expected - fixed in plan 02). No OTHER files should reference canUndo/canRedo.</verify>
  <done>canUndo and canRedo methods removed from EditorState interface and implementation. Only ToolBar.tsx has remaining references (expected, fixed in plan 02).</done>
</task>

<task type="auto">
  <name>Task 2: Migrate 8 components to granular useShallow selectors</name>
  <files>
    src/components/StatusBar/StatusBar.tsx
    src/components/Minimap/Minimap.tsx
    src/components/TilePalette/TilePalette.tsx
    src/components/GameObjectToolPanel/GameObjectToolPanel.tsx
    src/components/MapSettingsPanel/MapSettingsPanel.tsx
    src/components/AnimationPanel/AnimationPanel.tsx
    src/components/AnimationPreview/AnimationPreview.tsx
    src/App.tsx
  </files>
  <action>
  For each component, replace bare `useEditorStore()` destructuring with `useShallow` selectors. Add this import to each file:
  ```typescript
  import { useShallow } from 'zustand/react/shallow';
  ```

  **Pattern for state values (3+ fields):** Use useShallow with explicit property mapping:
  ```typescript
  const { field1, field2, field3 } = useEditorStore(
    useShallow((state) => ({
      field1: state.field1,
      field2: state.field2,
      field3: state.field3
    }))
  );
  ```

  **Pattern for single action:** Use inline selector:
  ```typescript
  const setFoo = useEditorStore((state) => state.setFoo);
  ```

  **Specific migrations:**

  1. **StatusBar.tsx** (3 state fields, no actions):
     ```typescript
     const { viewport, currentTool, tileSelection } = useEditorStore(
       useShallow((state) => ({
         viewport: state.viewport,
         currentTool: state.currentTool,
         tileSelection: state.tileSelection
       }))
     );
     ```
     Note: Does NOT subscribe to animationFrame.

  2. **Minimap.tsx** (2 state fields + 1 action):
     ```typescript
     const { map, viewport } = useEditorStore(
       useShallow((state) => ({
         map: state.map,
         viewport: state.viewport
       }))
     );
     const setViewport = useEditorStore((state) => state.setViewport);
     ```
     Note: Does NOT subscribe to animationFrame.

  3. **TilePalette.tsx** (3 state fields + 3 actions):
     ```typescript
     const { selectedTile, tileSelection, currentTool, wallType } = useEditorStore(
       useShallow((state) => ({
         selectedTile: state.selectedTile,
         tileSelection: state.tileSelection,
         currentTool: state.currentTool,
         wallType: state.wallType
       }))
     );
     const setTileSelection = useEditorStore((state) => state.setTileSelection);
     const setWallType = useEditorStore((state) => state.setWallType);
     ```
     Note: Does NOT subscribe to animationFrame.

  4. **GameObjectToolPanel.tsx** (2 state fields + 2 actions):
     ```typescript
     const { currentTool, gameObjectToolState } = useEditorStore(
       useShallow((state) => ({
         currentTool: state.currentTool,
         gameObjectToolState: state.gameObjectToolState
       }))
     );
     const setGameObjectTeam = useEditorStore((state) => state.setGameObjectTeam);
     const setWarpSettings = useEditorStore((state) => state.setWarpSettings);
     ```
     Note: Does NOT subscribe to animationFrame.

  5. **MapSettingsPanel.tsx** (1 state field + 1 action):
     ```typescript
     const map = useEditorStore((state) => state.map);
     const updateMapHeader = useEditorStore((state) => state.updateMapHeader);
     ```
     Note: Only 2 fields, use individual selectors (no useShallow needed).

  6. **AnimationPanel.tsx** (1 state field + 2 actions):
     ```typescript
     const animationFrame = useEditorStore((state) => state.animationFrame);
     const setSelectedTile = useEditorStore((state) => state.setSelectedTile);
     const advanceAnimationFrame = useEditorStore((state) => state.advanceAnimationFrame);
     ```
     Note: DOES subscribe to animationFrame (needed for live animation previews). Only 3 fields, use individual selectors.

  7. **AnimationPreview.tsx** (1 state field + 2 actions):
     ```typescript
     const animationFrame = useEditorStore((state) => state.animationFrame);
     const setSelectedTile = useEditorStore((state) => state.setSelectedTile);
     const advanceAnimationFrame = useEditorStore((state) => state.advanceAnimationFrame);
     ```
     Note: DOES subscribe to animationFrame (needed for live animation preview). Only 3 fields, use individual selectors.

  8. **App.tsx** (1 state field + 2 actions):
     ```typescript
     const map = useEditorStore((state) => state.map);
     const setMap = useEditorStore((state) => state.setMap);
     const markSaved = useEditorStore((state) => state.markSaved);
     ```
     Note: Only 3 fields, use individual selectors.

  **Important:**
  - Do NOT change any logic, event handlers, JSX, or other imports
  - Only replace the store destructuring pattern
  - For components using only 1-3 fields, prefer individual inline selectors over useShallow (cleaner, equally performant)
  - For components using 4+ fields, use useShallow
  - useShallow import is only needed for components that actually use it (TilePalette, StatusBar, Minimap, GameObjectToolPanel)
  </action>
  <verify>
  Run `npx tsc --noEmit 2>&1 | grep -v "ToolBar\|MapCanvas"` to verify all migrated files compile (ToolBar and MapCanvas errors expected, fixed in plan 02).
  Run `npm run electron:dev` and verify the app launches, tiles render, animations play, minimap works, status bar updates.
  </verify>
  <done>All 8 components use granular selectors. No bare useEditorStore() destructuring remains in migrated files. Only ToolBar.tsx and MapCanvas.tsx still use bare destructuring (migrated in plan 02). App compiles and runs correctly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` shows only errors in ToolBar.tsx related to canUndo/canRedo (expected, fixed in plan 02)
2. Grep for bare `useEditorStore()` (no selector argument) returns only ToolBar.tsx and MapCanvas.tsx
3. Grep for `useShallow` finds imports in StatusBar, Minimap, TilePalette, GameObjectToolPanel
4. AnimationPanel and AnimationPreview still subscribe to animationFrame (grep confirms)
5. StatusBar, Minimap, TilePalette, GameObjectToolPanel, MapSettingsPanel do NOT reference animationFrame
</verification>

<success_criteria>
- canUndo/canRedo methods removed from EditorState interface and store implementation
- 8 components migrated from bare destructuring to granular selectors
- Components needing animationFrame (AnimationPanel, AnimationPreview) still subscribe to it
- Components NOT needing animationFrame (StatusBar, Minimap, TilePalette, GameObjectToolPanel, MapSettingsPanel) do not subscribe to it
- App builds (ignoring ToolBar.tsx canUndo/canRedo errors, fixed in plan 02)
- App runs correctly: tiles render, animations play, status bar updates, minimap works
</success_criteria>

<output>
After completion, create `.planning/phases/21-zustand-store-optimization/21-01-SUMMARY.md`
</output>
