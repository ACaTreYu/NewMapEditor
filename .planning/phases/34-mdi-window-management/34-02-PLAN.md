---
phase: 34-mdi-window-management
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - src/components/Workspace/Workspace.tsx
  - src/components/Workspace/ChildWindow.tsx
  - src/components/Workspace/Workspace.css
  - src/components/index.ts
  - src/App.tsx
  - src/App.css
  - electron/main.ts
  - electron/preload.ts
  - src/vite-env.d.ts
autonomous: false

must_haves:
  truths:
    - "User sees multiple map windows rendered simultaneously in the workspace"
    - "User can drag a child window by its title bar to reposition it"
    - "User can resize a child window by dragging its edges/corners"
    - "Clicking a window brings it to front and makes it the active document"
    - "Window title bar shows filename (or Untitled) with * for unsaved changes"
    - "Active window has accent-colored title bar; inactive windows have grey title bar"
    - "Window > Cascade arranges all windows in cascade pattern"
    - "Window > Tile Horizontal stacks windows vertically with equal height"
    - "Window > Tile Vertical stacks windows side by side with equal width"
    - "Closing a window with unsaved changes shows a confirmation prompt"
    - "Minimap updates to show the active window's map when switching windows"
    - "Empty workspace shows placeholder message when no documents are open"
  artifacts:
    - path: "src/components/Workspace/Workspace.tsx"
      provides: "MDI workspace container rendering ChildWindow per document"
      exports: ["Workspace"]
    - path: "src/components/Workspace/ChildWindow.tsx"
      provides: "Draggable/resizable window wrapper using react-rnd"
      exports: ["ChildWindow"]
    - path: "src/components/Workspace/Workspace.css"
      provides: "Window chrome styling (title bar, borders, close button, active/inactive states)"
    - path: "electron/main.ts"
      provides: "Window menu with Cascade, Tile Horizontal, Tile Vertical commands"
      contains: "arrange-windows"
  key_links:
    - from: "src/components/Workspace/ChildWindow.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "useEditorStore selectors for windowState, isActive, actions"
      pattern: "useEditorStore.*windowStates"
    - from: "src/components/Workspace/ChildWindow.tsx"
      to: "src/components/MapCanvas/MapCanvas.tsx"
      via: "renders MapCanvas inside window content area"
      pattern: "<MapCanvas"
    - from: "src/components/Workspace/Workspace.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "iterates documents map to render ChildWindows"
      pattern: "documents.*keys"
    - from: "src/App.tsx"
      to: "src/components/Workspace/Workspace.tsx"
      via: "replaces single MapCanvas with Workspace component"
      pattern: "<Workspace"
    - from: "electron/main.ts"
      to: "renderer"
      via: "IPC send 'arrange-windows' with mode string"
      pattern: "arrange-windows.*cascade|tileHorizontal|tileVertical"
    - from: "src/App.tsx"
      to: "electron/main.ts"
      via: "IPC listener for arrange-windows calls store.arrangeWindows()"
      pattern: "onArrangeWindows|arrange-windows"
---

<objective>
Build the visual MDI workspace with draggable/resizable child windows and menu integration.

Purpose: This plan creates the UI components that let users see, drag, resize, and arrange multiple map windows simultaneously. It replaces the current single-MapCanvas layout with a Workspace container rendering ChildWindow components (one per document), adds Window menu commands for Cascade/Tile, and wires the close-with-save-prompt. This delivers MDI-01 through MDI-05.

Output: Working MDI workspace with child windows, Window menu, and close-save prompt.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-mdi-window-management/34-RESEARCH.md
@.planning/phases/34-mdi-window-management/34-01-SUMMARY.md
@src/App.tsx
@src/App.css
@src/components/index.ts
@src/components/MapCanvas/MapCanvas.tsx
@src/components/Minimap/Minimap.tsx
@src/core/editor/EditorState.ts
@electron/main.ts
@electron/preload.ts
@src/vite-env.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Workspace and ChildWindow components</name>
  <files>
    src/components/Workspace/Workspace.tsx
    src/components/Workspace/ChildWindow.tsx
    src/components/Workspace/Workspace.css
    src/components/index.ts
  </files>
  <action>
1. Create `src/components/Workspace/Workspace.css` with styles:
   - `.workspace` -- position: relative, width: 100%, height: 100%, overflow: hidden, background: var(--bg-secondary) (or slightly darker workspace background to distinguish from window content). This is the MDI workspace area.
   - `.workspace.empty` -- display: flex, align-items: center, justify-content: center.
   - `.empty-workspace-message` -- color: var(--text-secondary), text-align: center, user-select: none, font-size: 14px. Two `<p>` elements with gap.
   - `.child-window` -- display: flex, flex-direction: column, height: 100%, border: 1px solid var(--border-default), border-radius: var(--radius-sm), overflow: hidden, background: var(--bg-primary), box-shadow: 0 2px 8px rgba(0,0,0,0.15).
   - `.child-window.active` -- border-color: var(--accent-primary), box-shadow: 0 2px 12px rgba(0,0,0,0.25).
   - `.window-title-bar` -- display: flex, align-items: center, height: 28px, padding: 0 8px, user-select: none, cursor: default, gap: 8px, flex-shrink: 0. Background: var(--bg-tertiary), color: var(--text-primary).
   - `.child-window.active .window-title-bar` -- background: var(--accent-primary), color: white.
   - `.window-title` -- flex: 1, overflow: hidden, text-overflow: ellipsis, white-space: nowrap, font-size: var(--font-size-sm), font-weight: var(--font-weight-semibold).
   - `.window-close-btn` -- width: 20px, height: 20px, display: flex, align-items: center, justify-content: center, border: none, background: transparent, color: inherit, cursor: pointer, border-radius: var(--radius-sm), font-size: 14px, line-height: 1. Hover: background rgba(255,255,255,0.2). For inactive windows, hover: background var(--bg-hover).
   - `.window-content` -- flex: 1, overflow: hidden, position: relative.

2. Create `src/components/Workspace/ChildWindow.tsx`:
   - Props: `documentId: string`, `tilesetImage: HTMLImageElement | null`, `onClose: (docId: string) => void`, `onCursorMove?: (x: number, y: number) => void`
   - Use `useEditorStore` selectors (individual, not useShallow -- only 3-4 fields):
     - `windowState` from `state.windowStates.get(documentId)`
     - `isActive` from `state.activeDocumentId === documentId`
     - `windowTitle` computed from `state.documents.get(documentId)` -- extract filename from filePath (split on /\), append ' *' if modified, fallback 'Untitled'
     - `setActiveDocument` action
     - `updateWindowState` action
     - `raiseWindow` action
   - Import `Rnd` from 'react-rnd'.
   - `handleMouseDown` callback: if not already active, call setActiveDocument(documentId) which already calls raiseWindow internally (from Plan 01 override). If already active, still call raiseWindow(documentId) to bring to front on click.
   - `handleDragStop(e, d)`: call updateWindowState(documentId, { x: d.x, y: d.y })
   - `handleResizeStop(e, direction, ref, delta, position)`: call updateWindowState(documentId, { x: position.x, y: position.y, width: ref.offsetWidth, height: ref.offsetHeight })
   - `handleClose(e: React.MouseEvent)`: call e.stopPropagation() to prevent focus change, then call onClose(documentId).
   - Render: `<Rnd size={{width: ws.width, height: ws.height}} position={{x: ws.x, y: ws.y}} onDragStop={handleDragStop} onResizeStop={handleResizeStop} bounds="parent" minWidth={400} minHeight={300} style={{zIndex: ws.zIndex}} onMouseDown={handleMouseDown} dragHandleClassName="window-title-bar">` wrapping `<div className="child-window {isActive ? 'active' : 'inactive'}">` with title bar and content containing `<MapCanvas tilesetImage={tilesetImage} onCursorMove={onCursorMove} />`.
   - CRITICAL: The `dragHandleClassName="window-title-bar"` prop restricts dragging to the title bar only. Without this, clicking anywhere in the window (including MapCanvas) would start a drag.
   - CRITICAL: MapCanvas reads from top-level backward-compat fields (state.map, state.viewport). Since setActiveDocument syncs these, the MapCanvas inside the active window will render correctly. For INACTIVE windows, MapCanvas will still show the active document's data via backward compat. To solve this: each ChildWindow must call setActiveDocument BEFORE rendering tools, but for DISPLAY purposes, the static layer renders from state.map which only matches active doc. This is acceptable for Phase 34 -- inactive windows show stale content until clicked. Full per-window rendering is a future optimization.

3. Create `src/components/Workspace/Workspace.tsx`:
   - Props: `tilesetImage: HTMLImageElement | null`, `onCloseDocument: (docId: string) => void`, `onCursorMove?: (x: number, y: number) => void`
   - Use `useEditorStore` to get `documentIds` (Array.from(state.documents.keys())).
   - If documentIds.length === 0, render empty workspace message: "No documents open" / "File > New or File > Open to begin".
   - Otherwise render `<div className="workspace">` containing `{documentIds.map(id => <ChildWindow key={id} documentId={id} tilesetImage={tilesetImage} onClose={onCloseDocument} onCursorMove={onCursorMove} />)}`.
   - Import Workspace.css.

4. Update `src/components/index.ts` to add: `export { Workspace } from './Workspace/Workspace';`
  </action>
  <verify>
    `npx tsc --noEmit` passes with zero errors.
  </verify>
  <done>
    Workspace.tsx renders ChildWindow per document (or empty message). ChildWindow wraps MapCanvas in react-rnd with drag-by-title-bar, resize, z-index stacking, and close button. Window chrome styled with active/inactive states matching OKLCH design system. Zero TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rework App.tsx layout and add Window menu to Electron</name>
  <files>
    src/App.tsx
    src/App.css
    electron/main.ts
    electron/preload.ts
    src/vite-env.d.ts
  </files>
  <action>
1. Update `src/App.tsx`:
   - Import `Workspace` from '@components'.
   - Remove the current conditional rendering of MapCanvas vs empty-workspace div inside the canvas Panel.
   - Replace it with `<Workspace tilesetImage={tilesetImage} onCloseDocument={handleCloseDocument} onCursorMove={handleCursorMove} />`.
   - Remove the `void handleCloseDocument` suppression line (it's now used).
   - Add useEffect to listen for 'arrange-windows' IPC event from Electron:
     ```
     useEffect(() => {
       const handler = (_event: any, mode: string) => {
         useEditorStore.getState().arrangeWindows(mode as 'cascade' | 'tileHorizontal' | 'tileVertical');
       };
       if (window.electronAPI?.onArrangeWindows) {
         window.electronAPI.onArrangeWindows(handler);
       }
       return () => {
         if (window.electronAPI?.removeArrangeWindowsListener) {
           window.electronAPI.removeArrangeWindowsListener(handler);
         }
       };
     }, []);
     ```

2. Update `src/App.css`:
   - Remove the `.empty-workspace` styles (moved to Workspace.css).
   - Keep the `.main-area` styles but note the Workspace component now fills this space.

3. Update `electron/main.ts`:
   - After `createWindow()` function, add an application menu using `Menu.buildFromTemplate()` and `Menu.setApplicationMenu()`.
   - Import `Menu` from 'electron'.
   - Menu template structure:
     - File: New (sends 'menu-new-map'), Open (sends 'menu-open-map'), Save (sends 'menu-save-map'), separator, Exit (app.quit())
     - Edit: Undo (sends 'menu-undo'), Redo (sends 'menu-redo'), separator, Cut, Copy, Paste, Delete, separator, Select All
     - View: Toggle Grid (sends 'menu-toggle-grid'), Toggle Animations (sends 'menu-toggle-animations')
     - **Window**: Cascade (sends 'arrange-windows' with 'cascade'), Tile Horizontal (sends 'arrange-windows' with 'tileHorizontal'), Tile Vertical (sends 'arrange-windows' with 'tileVertical')
   - Note: For now, only implement the Window menu sends. File/Edit/View menu items can use accelerators and webContents.send() patterns but are not strictly required for this phase -- the toolbar already handles these. Keep menu items simple: just the Window menu with 3 arrangement commands. Add File menu with basic items for completeness. Skip Edit/View or keep them minimal.
   - Actually, simplify: ONLY add a Window submenu to the existing default menu. Use `Menu.getApplicationMenu()` to check if one exists, or build a minimal menu:
     ```typescript
     const menuTemplate: Electron.MenuItemConstructorOptions[] = [
       {
         label: 'File',
         submenu: [
           { label: 'New', accelerator: 'CmdOrCtrl+N', click: () => mainWindow?.webContents.send('menu-action', 'new') },
           { label: 'Open...', accelerator: 'CmdOrCtrl+O', click: () => mainWindow?.webContents.send('menu-action', 'open') },
           { label: 'Save', accelerator: 'CmdOrCtrl+S', click: () => mainWindow?.webContents.send('menu-action', 'save') },
           { type: 'separator' },
           { label: 'Exit', click: () => app.quit() }
         ]
       },
       {
         label: 'Edit',
         submenu: [
           { label: 'Undo', accelerator: 'CmdOrCtrl+Z', click: () => mainWindow?.webContents.send('menu-action', 'undo') },
           { label: 'Redo', accelerator: 'CmdOrCtrl+Y', click: () => mainWindow?.webContents.send('menu-action', 'redo') },
           { type: 'separator' },
           { role: 'cut' },
           { role: 'copy' },
           { role: 'paste' },
           { role: 'delete' },
           { type: 'separator' },
           { role: 'selectAll' }
         ]
       },
       {
         label: 'Window',
         submenu: [
           { label: 'Cascade', click: () => mainWindow?.webContents.send('arrange-windows', 'cascade') },
           { label: 'Tile Horizontal', click: () => mainWindow?.webContents.send('arrange-windows', 'tileHorizontal') },
           { label: 'Tile Vertical', click: () => mainWindow?.webContents.send('arrange-windows', 'tileVertical') }
         ]
       }
     ];
     const menu = Menu.buildFromTemplate(menuTemplate);
     Menu.setApplicationMenu(menu);
     ```
   - Place the menu setup inside `createWindow()` after the BrowserWindow is created.

4. Update `electron/preload.ts`:
   - Add `onArrangeWindows` and `removeArrangeWindowsListener` to the electronAPI:
     ```typescript
     onArrangeWindows: (callback: (event: any, mode: string) => void) => {
       ipcRenderer.on('arrange-windows', callback);
     },
     removeArrangeWindowsListener: (callback: (event: any, mode: string) => void) => {
       ipcRenderer.removeListener('arrange-windows', callback);
     }
     ```
   - Also add `onMenuAction` and `removeMenuActionListener` for the menu-action channel (for File > New/Open/Save and Edit > Undo/Redo from menu bar):
     ```typescript
     onMenuAction: (callback: (event: any, action: string) => void) => {
       ipcRenderer.on('menu-action', callback);
     },
     removeMenuActionListener: (callback: (event: any, action: string) => void) => {
       ipcRenderer.removeListener('menu-action', callback);
     }
     ```

5. Update `src/vite-env.d.ts`:
   - Add to the ElectronAPI interface:
     ```typescript
     onArrangeWindows?: (callback: (event: any, mode: string) => void) => void;
     removeArrangeWindowsListener?: (callback: (event: any, mode: string) => void) => void;
     onMenuAction?: (callback: (event: any, action: string) => void) => void;
     removeMenuActionListener?: (callback: (event: any, action: string) => void) => void;
     ```

6. In `src/App.tsx`, also add a useEffect for menu-action IPC to wire File > New/Open/Save and Edit > Undo/Redo from the native menu bar:
   ```
   useEffect(() => {
     const handler = (_event: any, action: string) => {
       switch (action) {
         case 'new': handleNewMap(); break;
         case 'open': handleOpenMap(); break;
         case 'save': handleSaveMap(); break;
         case 'undo': useEditorStore.getState().undo(); break;
         case 'redo': useEditorStore.getState().redo(); break;
       }
     };
     if (window.electronAPI?.onMenuAction) {
       window.electronAPI.onMenuAction(handler);
     }
     return () => {
       if (window.electronAPI?.removeMenuActionListener) {
         window.electronAPI.removeMenuActionListener(handler);
       }
     };
   }, [handleNewMap, handleOpenMap, handleSaveMap]);
   ```
  </action>
  <verify>
    `npx tsc --noEmit` passes with zero errors.
    Run `npm run electron:dev`:
    - App shows empty workspace on start.
    - File > New (toolbar or menu) creates a child window with title bar "Untitled".
    - File > New again creates a second window at cascaded position.
    - Click a window to focus it (title bar turns accent color, minimap updates).
    - Drag window by title bar to reposition.
    - Resize window by dragging edges/corners.
    - Window > Cascade rearranges windows.
    - Window > Tile Horizontal stacks windows.
    - Window > Tile Vertical stacks windows side by side.
    - Close button on window with modified map shows confirm dialog.
    - Closing last window returns to empty workspace.
  </verify>
  <done>
    App.tsx uses Workspace component instead of single MapCanvas. Child windows render with react-rnd drag/resize. Window menu in Electron sends arrange commands. Close-save prompt works via handleCloseDocument. Menu bar provides File/Edit/Window commands. Zero TypeScript errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete MDI workspace with draggable/resizable child windows, window arrangement commands, and close-save prompt.</what-built>
  <how-to-verify>
    1. Start the app with `npm run electron:dev`
    2. Verify empty workspace shows "No documents open" message
    3. Click File > New (toolbar button) -- a child window appears with "Untitled" title
    4. Click File > New again -- second window appears at offset position
    5. Click each window -- active window gets accent title bar, inactive gets grey
    6. Verify minimap updates when clicking different windows
    7. Drag a window by its title bar -- window repositions within workspace
    8. Resize a window by its corner/edge -- window resizes (min 400x300)
    9. Go to Window menu > Cascade -- windows rearrange in cascade pattern
    10. Go to Window menu > Tile Horizontal -- windows stack vertically
    11. Go to Window menu > Tile Vertical -- windows stack side by side
    12. Draw some tiles on a map, then click the X close button -- confirm dialog appears
    13. Close all windows -- returns to empty workspace message
    14. Open 8 maps via File > New rapidly -- 9th attempt shows alert about maximum documents
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero errors
2. MDI-01: Multiple maps open as child windows in workspace -- VERIFY by opening 2+ maps
3. MDI-02: Move and resize child windows freely -- VERIFY by drag title bar and resize edges
4. MDI-03: Tile and cascade via menu commands -- VERIFY Window > Cascade/Tile Horizontal/Tile Vertical
5. MDI-04: Active window drives minimap, settings, tools -- VERIFY minimap updates on window switch
6. MDI-05: Save prompt when closing modified window -- VERIFY close button shows confirm on dirty document
</verification>

<success_criteria>
- Workspace component renders ChildWindow per open document
- ChildWindow uses react-rnd with drag-by-title-bar, resize, bounds="parent"
- Window chrome shows filename + dirty indicator in title bar
- Active window has accent title bar, inactive has grey
- Z-index management brings clicked window to front
- Window > Cascade/Tile Horizontal/Tile Vertical work from Electron menu
- Close button triggers save prompt for dirty documents
- Empty workspace shows placeholder when no documents open
- All five MDI requirements (MDI-01 through MDI-05) met
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/34-mdi-window-management/34-02-SUMMARY.md`
</output>
