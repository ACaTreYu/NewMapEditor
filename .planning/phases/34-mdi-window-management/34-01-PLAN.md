---
phase: 34-mdi-window-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/slices/types.ts
  - src/core/editor/slices/windowSlice.ts
  - src/core/editor/slices/windowArrangement.ts
  - src/core/editor/EditorState.ts
  - src/core/editor/index.ts
  - package.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Window state (position, size, z-index) tracked per document"
    - "New documents automatically get cascaded window position"
    - "Closing a document removes its window state"
    - "Switching active document raises that window to front"
    - "Cascade/tile arrangement algorithms produce correct coordinates"
    - "Maximum 8 documents can be open simultaneously"
  artifacts:
    - path: "src/core/editor/slices/windowSlice.ts"
      provides: "Window state CRUD, raiseWindow, arrangeWindows actions"
      exports: ["WindowSlice", "createWindowSlice"]
    - path: "src/core/editor/slices/windowArrangement.ts"
      provides: "Pure cascade/tile arrangement functions"
      exports: ["cascadeWindows", "tileWindowsHorizontal", "tileWindowsVertical"]
    - path: "src/core/editor/slices/types.ts"
      provides: "WindowState interface and MAX_OPEN_DOCUMENTS constant"
      contains: "interface WindowState"
  key_links:
    - from: "src/core/editor/EditorState.ts"
      to: "src/core/editor/slices/windowSlice.ts"
      via: "slice composition in create()"
      pattern: "createWindowSlice"
    - from: "src/core/editor/EditorState.ts"
      to: "createDocument"
      via: "createWindowState called after document creation"
      pattern: "createWindowState.*docId"
    - from: "src/core/editor/slices/windowSlice.ts"
      to: "src/core/editor/slices/windowArrangement.ts"
      via: "arrangeWindows delegates to pure functions"
      pattern: "cascadeWindows|tileWindows"
---

<objective>
Create the window state management layer for MDI child windows.

Purpose: Phase 34 needs draggable/resizable child windows. This plan builds the Zustand state slice that tracks per-document window metadata (position, size, z-index) separately from document data, plus pure arrangement algorithms for cascade and tile commands. Also enforces MAX_OPEN_DOCUMENTS = 8 to prevent canvas context exhaustion.

Output: WindowSlice integrated into EditorState, arrangement algorithms, react-rnd installed, document limit enforced.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-mdi-window-management/34-RESEARCH.md
@src/core/editor/EditorState.ts
@src/core/editor/slices/types.ts
@src/core/editor/slices/documentsSlice.ts
@src/core/editor/slices/globalSlice.ts
@src/core/editor/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-rnd and create window types + arrangement algorithms</name>
  <files>
    package.json
    src/core/editor/slices/types.ts
    src/core/editor/slices/windowArrangement.ts
  </files>
  <action>
1. Run `npm install react-rnd` to add the dependency.

2. In `src/core/editor/slices/types.ts`, add AFTER the existing types:
   - `MAX_OPEN_DOCUMENTS = 8` constant
   - `WindowState` interface with fields: `x: number`, `y: number`, `width: number`, `height: number`, `zIndex: number`, `title: string`
   Do NOT modify any existing types -- only append new ones.

3. Create `src/core/editor/slices/windowArrangement.ts` with three pure functions:
   - `cascadeWindows(windowStates: Map<string, WindowState>, workspaceWidth: number, workspaceHeight: number): Map<string, WindowState>` -- Cascade offset of 40px from (0,0). Default window size 800x600. Wrap x/y back to 0 when window would exceed workspace bounds. Reassign z-indexes sequentially starting from 1000.
   - `tileWindowsHorizontal(windowStates: Map<string, WindowState>, workspaceWidth: number, workspaceHeight: number): Map<string, WindowState>` -- Stack windows vertically, each spanning full width, equal height = workspaceHeight/count.
   - `tileWindowsVertical(windowStates: Map<string, WindowState>, workspaceWidth: number, workspaceHeight: number): Map<string, WindowState>` -- Stack windows side by side, each spanning full height, equal width = workspaceWidth/count.
   All three functions return new Map instances (immutable). Handle count=0 edge case by returning empty map. Import WindowState from './types'.
  </action>
  <verify>
    `npx tsc --noEmit` passes with zero errors.
    `npm ls react-rnd` shows react-rnd installed.
  </verify>
  <done>
    react-rnd in package.json dependencies. WindowState type and MAX_OPEN_DOCUMENTS constant in types.ts. Three pure arrangement functions in windowArrangement.ts. Zero TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create windowSlice and integrate into EditorState</name>
  <files>
    src/core/editor/slices/windowSlice.ts
    src/core/editor/EditorState.ts
    src/core/editor/index.ts
  </files>
  <action>
1. Create `src/core/editor/slices/windowSlice.ts`:
   - Define `WindowSlice` interface with:
     - State: `windowStates: Map<string, WindowState>`, `nextZIndex: number` (initial: 1000)
     - Actions: `createWindowState(docId: string, title: string): void`, `removeWindowState(docId: string): void`, `updateWindowState(docId: string, updates: Partial<WindowState>): void`, `raiseWindow(docId: string): void`, `arrangeWindows(mode: 'cascade' | 'tileHorizontal' | 'tileVertical'): void`
   - `createWindowSlice` as StateCreator:
     - `createWindowState`: compute cascade position using `windowStates.size * 40` offset from (0,0), default size 800x600, assign nextZIndex and increment it. If nextZIndex > 100000, normalize all z-indexes starting at 1000.
     - `removeWindowState`: delete from map, create new Map for reactivity.
     - `updateWindowState`: merge partial updates into existing window state.
     - `raiseWindow`: set target window's zIndex to nextZIndex, increment nextZIndex. If nextZIndex > 100000, normalize.
     - `arrangeWindows`: query workspace size via `document.querySelector('.workspace')?.clientWidth/Height` (fallback 1200x800), delegate to the pure functions from windowArrangement.ts. Set result as new windowStates.

2. Update `src/core/editor/EditorState.ts`:
   - Import `createWindowSlice, WindowSlice` from windowSlice.
   - Import `MAX_OPEN_DOCUMENTS` from types.
   - Add WindowSlice to the EditorState type: `type EditorState = DocumentsSlice & GlobalSlice & WindowSlice & BackwardCompatLayer`
   - Compose windowSlice: `...createWindowSlice(set, get, store)` in the create() call.
   - Override `createDocument` to:
     a. Check `state.documents.size >= MAX_OPEN_DOCUMENTS` first. If exceeded, call `alert('Maximum 8 documents can be open simultaneously. Close a document first.')` and return `null` (update return type to `DocumentId | null`).
     b. After creating the document, call `createWindowState(id, title)` where title is derived from filePath (extract filename) or 'Untitled'.
   - Override `setActiveDocument` to also call `raiseWindow(id)` after setting the active document.
   - Override `closeDocument` to also call `removeWindowState(id)` before deleting the document.

3. Update `src/core/editor/index.ts` to export WindowSlice types if needed (windowSlice types already re-exported via EditorState imports).

IMPORTANT: The StateCreator type for windowSlice must use the combined store type for cross-slice access: `StateCreator<DocumentsSlice & GlobalSlice & WindowSlice, [], [], WindowSlice>`.
  </action>
  <verify>
    `npx tsc --noEmit` passes with zero errors.
    Open the app with `npm run electron:dev`, create a new map (File > New), verify no crashes. Create a second map -- verify it works. Try creating 9 maps -- the 9th should show an alert about maximum documents.
  </verify>
  <done>
    windowSlice.ts exists with window CRUD actions. EditorState composes all three slices. createDocument enforces MAX_OPEN_DOCUMENTS=8 and auto-creates window state. setActiveDocument calls raiseWindow. closeDocument removes window state. Zero TypeScript errors. App starts and functions.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero errors
2. `npm run electron:dev` -- app starts without crashes
3. File > New creates a document with window state in store
4. Multiple File > New calls create cascaded window positions (verify via console: `useEditorStore.getState().windowStates`)
5. 9th document creation shows alert and is rejected
6. Closing a document removes its window state
</verification>

<success_criteria>
- react-rnd installed in package.json
- WindowState type, MAX_OPEN_DOCUMENTS constant, arrangement functions exist
- windowSlice with CRUD + raise + arrange actions integrated into EditorState
- Document creation auto-creates window state with cascade positioning
- Document limit of 8 enforced with user-facing alert
- Active document switch raises window z-index
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/34-mdi-window-management/34-01-SUMMARY.md`
</output>
