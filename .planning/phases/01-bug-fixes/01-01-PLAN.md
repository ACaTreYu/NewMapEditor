---
phase: 01-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/EditorState.ts
autonomous: true

must_haves:
  truths:
    - "User can select 2x2 tile region in palette"
    - "User can use fill tool on map"
    - "Filled area shows pattern tiled correctly"
    - "Pattern repeats based on selection width/height"
  artifacts:
    - path: "src/core/editor/EditorState.ts"
      provides: "Pattern-aware fillArea function"
      contains: "tileSelection"
  key_links:
    - from: "fillArea function"
      to: "tileSelection state"
      via: "get() to read current selection"
      pattern: "tileSelection\\.width|tileSelection\\.height"
---

<objective>
Fix pattern fill to use multi-tile selection correctly.

Purpose: Currently the fill tool ignores tileSelection width/height and places only a single tile. Users need pattern fills to work like Photoshop - selecting a 2x2 region and filling should tile that pattern across the filled area.

Output: Modified `fillArea` function that reads `tileSelection` from state and applies modulo-based pattern tiling.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@E:\NewMapEditor\.planning\PROJECT.md
@E:\NewMapEditor\.planning\ROADMAP.md
@E:\NewMapEditor\.planning\phases\01-bug-fixes\01-RESEARCH.md

Key code reference:
- Current fillArea: src/core/editor/EditorState.ts lines 279-309
- TileSelection interface: src/core/editor/EditorState.ts lines 44-49
- TILES_PER_ROW constant: 40
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement pattern-aware flood fill</name>
  <files>src/core/editor/EditorState.ts</files>
  <action>
Modify the `fillArea` function (lines 279-309) to support multi-tile pattern fills:

1. Change function signature from `fillArea: (x, y, tile)` to `fillArea: (x, y)` - the tile is derived from tileSelection state, not passed in.

2. At start of function, get tileSelection from state:
   ```typescript
   const { map, tileSelection } = get();
   ```

3. Store the fill origin point (x, y) - this is the anchor for pattern offsets.

4. In the fill loop, calculate the tile to place using modulo arithmetic:
   ```typescript
   // Calculate offset from fill origin
   const offsetX = pos.x - x;
   const offsetY = pos.y - y;

   // Handle negative modulo correctly: ((n % m) + m) % m
   const patternX = ((offsetX % tileSelection.width) + tileSelection.width) % tileSelection.width;
   const patternY = ((offsetY % tileSelection.height) + tileSelection.height) % tileSelection.height;

   // Calculate actual tile index in tileset
   const tileIndex = (tileSelection.startRow + patternY) * TILES_PER_ROW
                   + (tileSelection.startCol + patternX);

   map.tiles[index] = tileIndex;
   ```

5. For the early exit check (target === replacement), compare against the top-left tile of the selection:
   ```typescript
   const startTile = tileSelection.startRow * TILES_PER_ROW + tileSelection.startCol;
   if (targetTile === startTile) return;
   ```

6. Update the MapCanvas.tsx call site (line 453) to remove the tile argument:
   ```typescript
   case ToolType.FILL:
     fillArea(x, y);  // Remove selectedTile argument
     break;
   ```

Important: Keep the iterative flood fill with explicit stack (not recursive) to prevent stack overflow on large areas.
  </action>
  <verify>
1. Run `npm run typecheck` - should pass with no errors
2. Manual test: Select 2x2 tiles in palette, click fill on empty area, verify pattern tiles correctly
3. Manual test: Verify pattern wraps correctly at edges (no single-tile artifacts)
  </verify>
  <done>
- Fill tool reads tileSelection.width and tileSelection.height
- Pattern tiles correctly using modulo arithmetic
- Negative offsets handled correctly (no misalignment near origin)
- TypeScript compiles without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Pattern fill with multi-tile selection support</what-built>
  <how-to-verify>
1. Run `npm run electron:dev`
2. In the tile palette (left panel), drag to select a 2x2 or 3x3 region of tiles
3. Select the Fill tool (paint bucket icon or press F)
4. Click on an empty area of the map
5. Verify: The filled area shows the selected tile pattern repeating correctly
6. Test edge case: Fill an area that spans past the origin point in both directions
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with pattern fill</resume-signal>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- Pattern fill works with 1x1, 2x2, 3x3, and larger selections
- Pattern maintains correct alignment regardless of fill origin
- No stack overflow on large fill operations (256x256 worst case)
</verification>

<success_criteria>
1. User selects 2x2 tile region in palette
2. User clicks fill tool on map
3. Filled area shows 2x2 pattern tiled correctly across entire region
4. Pattern wraps correctly at all boundaries
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes/01-01-SUMMARY.md`
</output>
