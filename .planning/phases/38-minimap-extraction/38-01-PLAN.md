---
phase: 38-minimap-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Minimap/Minimap.tsx
  - src/components/Minimap/Minimap.css
  - src/App.css
  - src/components/AnimationPanel/AnimationPanel.css
  - src/components/AnimationPanel/AnimationPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User sees minimap in top-right corner on startup even with no map loaded"
    - "Minimap remains visible when animation panel is collapsed or hidden"
    - "Empty map areas display a checkerboard pattern (gray/white, 8x8 blocks)"
    - "Occupied map areas show tile average colors matching previous behavior"
    - "Empty state shows centered 'Minimap' label that disappears when map loads"
    - "Minimap has 1px solid border, no drop shadow"
    - "Animation panel width matches minimap width for consistent right column"
  artifacts:
    - path: "src/components/Minimap/Minimap.tsx"
      provides: "Always-visible minimap with checkerboard background and empty state"
      contains: "createPattern"
    - path: "src/components/Minimap/Minimap.css"
      provides: "Minimap styling with border and empty label overlay"
      contains: "minimap-empty-label"
    - path: "src/App.css"
      provides: "Right sidebar fixed width matching minimap"
      contains: "right-sidebar-container"
    - path: "src/components/AnimationPanel/AnimationPanel.css"
      provides: "Animation panel width expanded to match minimap"
      contains: "width"
  key_links:
    - from: "src/components/Minimap/Minimap.tsx"
      to: "src/components/Minimap/Minimap.css"
      via: "className minimap-empty-label"
      pattern: "minimap-empty-label"
    - from: "src/components/Minimap/Minimap.tsx"
      to: "Canvas API"
      via: "createPattern for checkerboard"
      pattern: "createPattern.*repeat"
    - from: "src/App.css"
      to: "src/components/AnimationPanel/AnimationPanel.css"
      via: "consistent width in right sidebar"
      pattern: "right-sidebar-container"
---

<objective>
Extract the minimap into an always-visible, independent component with a checkerboard empty state.

Purpose: The minimap currently returns `null` when no map is loaded, making it invisible on startup and causing layout shifts. This plan makes it always render — showing a Photoshop-style checkerboard background with a centered "Minimap" label when empty, and painting occupied tiles over the checkerboard when a map is loaded. The animation panel width is expanded to match the minimap for a consistent right column.

Output: Modified Minimap.tsx (always renders, checkerboard + label), updated CSS for border/label, right sidebar and animation panel widths aligned.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-minimap-extraction/38-RESEARCH.md
@src/components/Minimap/Minimap.tsx
@src/components/Minimap/Minimap.css
@src/App.tsx
@src/App.css
@src/components/AnimationPanel/AnimationPanel.css
@src/components/AnimationPanel/AnimationPanel.tsx
@src/styles/variables.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Always-visible minimap with checkerboard background and empty state</name>
  <files>
    src/components/Minimap/Minimap.tsx
    src/components/Minimap/Minimap.css
  </files>
  <action>
Modify Minimap.tsx to always render (never return null) with a layered canvas approach:

**1. Remove the early return null (line 379):**
Delete `if (!map) return null;` — the component must always return JSX.

**2. Add a cached checkerboard pattern (useRef, created once):**
Create a `checkerboardPatternRef = useRef<CanvasPattern | null>(null)` that is built once on canvas mount. Use an offscreen 16x16 canvas with 2x2 blocks of 8px each:
- Top-left (0,0,8,8): `#C0C0C0` (light gray) — per user decision
- Top-right (8,0,8,8): `#FFFFFF` (white) — per user decision
- Bottom-left (0,8,8,8): `#FFFFFF` (white)
- Bottom-right (8,8,8,8): `#C0C0C0` (light gray)
Call `ctx.createPattern(patternCanvas, 'repeat')` and store in the ref. Create this pattern lazily in draw() the first time ctx is available, NOT in a useEffect (avoids needing canvas context at mount time).

**3. Restructure the draw function with layered rendering:**
The draw function should work in two modes:

**When `!map` (empty state):**
- Fill entire canvas with checkerboard pattern (layer 1)
- No tiles, no viewport rectangle
- The "Minimap" label is rendered as a React overlay (not canvas text) for crisp rendering

**When `map` exists:**
- Fill entire canvas with checkerboard pattern (layer 1 — shows through for empty/DEFAULT_TILE areas)
- Render tile imageData on top (layer 2). IMPORTANT: For tiles that equal `DEFAULT_TILE` (280), set alpha to 0 in the imageData so the checkerboard shows through. For all other tiles, set alpha to 255 as currently done.
- Draw viewport rectangle (layer 3)

The existing tile rendering loop (lines 252-306) stays mostly the same. The key change: when `tileValue === DEFAULT_TILE` (the empty space tile), set `data[idx + 3] = 0` (transparent) instead of 255 so checkerboard bleeds through. For ALL other tiles (walls, animated, powerups, etc.), keep alpha at 255.

**4. Update the "Loading..." placeholder:**
When `!tileColorCacheRef.current` but `map` exists, still draw checkerboard as background with "Loading..." text centered on canvas. This replaces the solid `#1a1a2e` fill.

**5. Add empty state label as React overlay:**
After the canvas element, add:
```tsx
{!map && (
  <div className="minimap-empty-label">Minimap</div>
)}
```

**6. Guard mouse handlers:**
The click-to-navigate handlers (`handleClick`, `handleMouseDown`, `handleMouseMove`) should early-return if `!map` — clicking the checkerboard when empty should be a no-op.

**7. Trigger draw on mount even without map:**
Add/modify the useEffect hooks so the checkerboard draws even when there's no map:
- The initial draw when cache finishes: keep `if (cacheReady && map)` guard — cache not needed for empty state
- Add a new useEffect that calls draw() when `map` is null (to paint the checkerboard)
- The debounced map redraw and viewport redraw effects can keep their current guards since they're only relevant with a map

Modify Minimap.css:

**1. Replace shadow with 1px solid border (per user decision):**
Remove `box-shadow: var(--shadow-md)` and `border-radius: var(--radius-md)`. The border is already `1px solid var(--border-default)` which is correct. Remove the padding (`padding: var(--space-1)`) — the border goes directly around the canvas with no padding, making the minimap container exactly 130x130 (128 canvas + 2px border).

**2. Add empty label styles:**
```css
.minimap-empty-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: var(--text-primary);
  font-size: var(--font-size-base);
  pointer-events: none;
  user-select: none;
  font-weight: 500;
}
```

**3. Ensure `.minimap` has `position: relative`** (already present) so the label overlay works.
  </action>
  <verify>
Run `npm run typecheck` — zero TypeScript errors. Launch app with `npm run electron:dev` — minimap should appear with checkerboard pattern and "Minimap" label on startup (no map loaded). Open a map — checkerboard should show through empty areas, tiles paint on top, viewport rectangle visible. Close all documents — minimap returns to empty state with label.
  </verify>
  <done>
Minimap always renders (never null). Empty state: checkerboard + centered "Minimap" label. Map loaded: checkerboard base with tiles painted over, DEFAULT_TILE areas show checkerboard. 1px border, no shadow, no padding. Mouse handlers no-op when empty.
  </done>
</task>

<task type="auto">
  <name>Task 2: Right sidebar and animation panel width alignment</name>
  <files>
    src/App.css
    src/components/AnimationPanel/AnimationPanel.css
    src/components/AnimationPanel/AnimationPanel.tsx
  </files>
  <action>
The right sidebar currently has `min-width: 80px` and the AnimationPanel is hardcoded at 70px wide. The minimap canvas is 128px with a 1px border on each side = 130px total (after Task 1 removes padding). The animation panel and sidebar need to match this width.

**1. Update App.css `.right-sidebar-container`:**
Change `min-width: 80px` to `width: 130px; min-width: 130px;` to match the minimap's 130px (128 + 2px border). This ensures the right column stays exactly as wide as the minimap.

**2. Update AnimationPanel.css:**
Change the fixed width from `70px` to `100%`:
```css
.animation-panel {
  width: 100%;
  min-width: unset;  /* was min-width: 70px */
  max-width: unset;  /* was max-width: 70px */
}
```
The animation panel should fill the sidebar width rather than being a fixed 70px. The sidebar width is already constrained by the container.

**3. Update AnimationPanel.tsx:**
Change `const PANEL_WIDTH = 70;` to derive the canvas width from the container. Since the animation panel canvas is inside a flex container that's now 130px wide, the simplest approach: change `PANEL_WIDTH` to `128` (matching the minimap canvas width, since the animation-panel-container takes full sidebar width and the canvas should fill it). Update `const canvasWidth = PANEL_WIDTH;` (line 313) accordingly — this just changes from 70 to 128.

**Also update `.animation-panel-container` in App.css:**
Change `min-width: 80px` to `min-width: unset` since the parent container already constrains width.
  </action>
  <verify>
Run `npm run typecheck` — zero TypeScript errors. Launch app — right sidebar should be exactly 130px wide. Animation panel should fill sidebar width (128px canvas inside 130px container). Minimap and animation panel should be visually aligned in width. Verify no horizontal overflow or scrollbars appear in the right sidebar.
  </verify>
  <done>
Right sidebar width matches minimap (130px). Animation panel expands from 70px to fill sidebar width. No layout overflow. Consistent right column appearance.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. App startup (no map): minimap visible in top-right with checkerboard pattern and "Minimap" label
3. Open a map: tiles render over checkerboard, empty areas (DEFAULT_TILE) show checkerboard through
4. Viewport rectangle visible and clickable for navigation
5. Close all documents: minimap returns to empty state with label
6. Animation panel width matches minimap width (consistent right column)
7. No performance regression: minimap redraws feel responsive, no visible lag
8. Checkerboard uses #C0C0C0/#FFFFFF with 8x8 blocks per user decision
9. Minimap has 1px solid border, no shadow, no rounded corners
</verification>

<success_criteria>
- Minimap renders on app startup with no map loaded (MMAP-02)
- Minimap stays visible regardless of animation panel state (MMAP-01)
- Empty areas display gray/white checkerboard at 8x8 block size (MMAP-03)
- Occupied tiles show average colors matching v2.2 behavior (MMAP-04)
- No measurable performance regression — pattern cached, existing debounce/idle patterns preserved (MMAP-05)
- Animation panel width matches minimap for consistent right column layout
</success_criteria>

<output>
After completion, create `.planning/phases/38-minimap-extraction/38-01-SUMMARY.md`
</output>
