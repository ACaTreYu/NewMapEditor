---
phase: 31-ui-completion-sedit-parity
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/components/MapSettingsDialog/MapSettingsDialog.tsx
  - src/components/MapSettingsDialog/MapSettingsDialog.css
  - src/components/MapSettingsDialog/CheckboxInput.tsx
  - src/components/MapSettingsDialog/SelectInput.tsx
  - src/components/MapSettingsDialog/SettingInput.tsx
autonomous: true

must_haves:
  truths:
    - "Map Settings dialog displays exactly 5 tabs (General, Weapons, Game Rules, Flagger, Advanced)"
    - "Boolean settings (Toggles) render as checkboxes, not sliders"
    - "Enum settings (objective, numTeams, maxPlayers) render as dropdowns"
    - "Weapons tab shows settings organized by subcategory (Laser, Missile, Bouncy, Grenade) with section headings"
    - "Header fields (laserDamage, specialDamage, rechargeRate, missilesEnabled, bombsEnabled, bounciesEnabled, holdingTime, maxPlayers, numTeams, objective, maxSimulPowerups) are synced on Apply"
    - "Dialog is fixed-size with compact, efficient density"
  artifacts:
    - path: "src/components/MapSettingsDialog/CheckboxInput.tsx"
      provides: "Reusable checkbox component for boolean settings"
      exports: ["CheckboxInput"]
    - path: "src/components/MapSettingsDialog/SelectInput.tsx"
      provides: "Reusable dropdown component for enum settings"
      exports: ["SelectInput"]
    - path: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      provides: "Refactored dialog with 5-tab layout and header field syncing"
      contains: "SETTING_CATEGORIES"
    - path: "src/components/MapSettingsDialog/MapSettingsDialog.css"
      provides: "Modern styles for checkbox, select, section headings, and compact layout"
      contains: "checkbox-input"
  key_links:
    - from: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      to: "src/core/map/GameSettings.ts"
      via: "SETTING_CATEGORIES, SETTING_SUBCATEGORIES, getSettingsByCategory, getSettingsBySubcategory"
      pattern: "SETTING_SUBCATEGORIES"
    - from: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "updateMapHeader syncs header fields from dialog state"
      pattern: "updateMapHeader"
    - from: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      to: "src/components/MapSettingsDialog/CheckboxInput.tsx"
      via: "import and render for boolean toggle settings"
      pattern: "CheckboxInput"
---

<objective>
Refactor Map Settings dialog from 10 tabs to 5 consolidated tabs, add CheckboxInput and SelectInput components for boolean/enum settings, sync header fields on Apply, and style with compact modern layout.

Purpose: Complete the visual modernization of the last major dialog (UI-09) and ensure header fields stay in sync with extended settings for SEdit compatibility.
Output: Modernized Map Settings dialog with 5 tabs, checkbox/dropdown controls, section headings for subcategories, and header field syncing.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-ui-completion-sedit-parity/31-01-SUMMARY.md
@src/components/MapSettingsDialog/MapSettingsDialog.tsx
@src/components/MapSettingsDialog/MapSettingsDialog.css
@src/components/MapSettingsDialog/SettingInput.tsx
@src/core/map/GameSettings.ts
@src/core/map/types.ts
@src/styles/variables.css
@.planning/phases/31-ui-completion-sedit-parity/31-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CheckboxInput and SelectInput components</name>
  <files>src/components/MapSettingsDialog/CheckboxInput.tsx, src/components/MapSettingsDialog/SelectInput.tsx, src/components/MapSettingsDialog/MapSettingsDialog.css</files>
  <action>
**Create `CheckboxInput.tsx`:**

Modern flat checkbox component using design tokens. User decision: checkboxes (NOT toggle switches).

```typescript
import React from 'react';

interface CheckboxInputProps {
  label: string;
  checked: boolean;
  onChange: (checked: boolean) => void;
}

export const CheckboxInput: React.FC<CheckboxInputProps> = ({
  label,
  checked,
  onChange
}) => {
  return (
    <div className="checkbox-input-row">
      <label className="checkbox-label">
        <input
          type="checkbox"
          checked={checked}
          onChange={(e) => onChange(e.target.checked)}
          className="checkbox-input"
        />
        <span className="checkbox-label-text">{label}</span>
      </label>
    </div>
  );
};
```

**Create `SelectInput.tsx`:**

Dropdown for enum settings (objective type, team count, max players). User decision: dropdown chosen for enums.

```typescript
import React from 'react';

export interface SelectOption {
  value: number;
  label: string;
}

interface SelectInputProps {
  label: string;
  value: number;
  options: SelectOption[];
  onChange: (value: number) => void;
}

export const SelectInput: React.FC<SelectInputProps> = ({
  label,
  value,
  options,
  onChange
}) => {
  return (
    <div className="select-input-row">
      <label className="select-input-label">{label}</label>
      <select
        value={value}
        onChange={(e) => onChange(Number(e.target.value))}
        className="select-input"
      >
        {options.map(opt => (
          <option key={opt.value} value={opt.value}>
            {opt.label}
          </option>
        ))}
      </select>
    </div>
  );
};
```

**Add CSS for both components to `MapSettingsDialog.css`:**

```css
/* ===== Checkbox Input ===== */

.checkbox-input-row {
  display: flex;
  align-items: center;
  margin-bottom: var(--space-0_75);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: var(--space-0_75);
  cursor: pointer;
  user-select: none;
}

.checkbox-input {
  width: 16px;
  height: 16px;
  cursor: pointer;
  accent-color: var(--accent-primary);
}

.checkbox-label-text {
  font-size: var(--font-size-xs);
  color: var(--text-primary);
}

/* ===== Select Input ===== */

.select-input-row {
  display: flex;
  align-items: center;
  gap: var(--space-1);
  margin-bottom: var(--space-1);
}

.select-input-label {
  flex: 0 0 140px;
  font-size: var(--font-size-xs);
  color: var(--text-primary);
}

.select-input {
  flex: 1;
  padding: var(--space-0_25) var(--space-0_75);
  font-size: var(--font-size-xs);
  color: var(--text-primary);
  background: var(--input-bg);
  border: 1px solid var(--input-border);
  border-radius: var(--radius-sm);
  cursor: pointer;
}

.select-input:focus {
  outline: none;
  border-color: var(--input-focus);
  box-shadow: 0 0 0 2px var(--focus-ring);
}

/* ===== Section Headings (for subcategory dividers) ===== */

.section-heading {
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-semibold);
  color: var(--text-secondary);
  margin: var(--space-1_5) 0 var(--space-0_75) 0;
  padding-bottom: var(--space-0_5);
  border-bottom: 1px solid var(--border-subtle);
}

.section-heading:first-child {
  margin-top: 0;
}
```

Also update dialog CSS for compact fixed-size layout:
- Change `max-width: 600px` to `width: 680px` (fixed width for predictable layout)
- Add `overflow-y: auto` to `.tab-content` (already has it)
- Add `max-height: 420px` to `.tab-content` to keep dialog compact
- Update `.dialog-tabs` to use `flex-wrap: nowrap` and smaller gap (since 5 tabs fit easily)
  </action>
  <verify>Verify CheckboxInput.tsx and SelectInput.tsx exist. Run `npm run typecheck` to confirm both compile. Grep for "checkbox-input-row" and "select-input-row" in MapSettingsDialog.css.</verify>
  <done>CheckboxInput renders checkboxes (not toggle switches per user decision). SelectInput renders dropdown for enum values. CSS styles use design tokens with compact spacing. Dialog has fixed width (680px).</done>
</task>

<task type="auto">
  <name>Task 2: Refactor dialog to 5-tab layout with header field syncing</name>
  <files>src/components/MapSettingsDialog/MapSettingsDialog.tsx, src/components/MapSettingsDialog/SettingInput.tsx</files>
  <action>
**Refactor `MapSettingsDialog.tsx` to use 5-tab consolidated layout:**

Import new components and updated GameSettings exports:
```typescript
import { SETTING_CATEGORIES, GAME_SETTINGS, getSettingsByCategory, getSettingsBySubcategory, SETTING_SUBCATEGORIES, getDefaultSettings } from '@core/map';
import { CheckboxInput } from './CheckboxInput';
import { SelectInput, SelectOption } from './SelectInput';
import { ObjectiveType } from '@core/map';
```

Add state for header-level fields (these are separate from extended settings because they live in the binary header):
```typescript
const [headerFields, setHeaderFields] = useState({
  maxPlayers: 16,
  numTeams: 2,
  objective: ObjectiveType.FRAG as number,
  laserDamage: 2,
  specialDamage: 2,
  rechargeRate: 2,
  holdingTime: 15,
  missilesEnabled: true,
  bombsEnabled: true,
  bounciesEnabled: true,
  maxSimulPowerups: 12,
  powerupCount: 0,
  switchCount: 0
});
```

In the `open()` handler, populate headerFields from map.header:
```typescript
setHeaderFields({
  maxPlayers: map.header.maxPlayers,
  numTeams: map.header.numTeams,
  objective: map.header.objective,
  laserDamage: map.header.laserDamage,
  specialDamage: map.header.specialDamage,
  rechargeRate: map.header.rechargeRate,
  holdingTime: map.header.holdingTime,
  missilesEnabled: map.header.missilesEnabled,
  bombsEnabled: map.header.bombsEnabled,
  bounciesEnabled: map.header.bounciesEnabled,
  maxSimulPowerups: map.header.maxSimulPowerups,
  powerupCount: map.header.powerupCount,
  switchCount: map.header.switchCount
});
```

In `handleApply()`, sync header fields along with extended settings:
```typescript
const handleApply = () => {
  updateMapHeader({
    name: mapName,
    description: buildDescription(localSettings, mapAuthor, unrecognizedRef.current),
    extendedSettings: localSettings,
    // Sync header fields for SEdit binary compatibility
    ...headerFields
  });
  setIsDirty(false);
};
```

**Refactor tab rendering:**

The 'General' tab should show:
1. Map Name text input (existing)
2. Author text input (existing)
3. SelectInput for Max Players (1-16), Num Teams (1-4), Objective (Frag/Flag/Switch)
4. CheckboxInput for Missiles Enabled, Bombs Enabled, Bouncies Enabled
5. SettingInput sliders for header numeric fields shown as sliders: laserDamage (0-5), specialDamage (0-5), rechargeRate (0-5), maxSimulPowerups (0-255), powerupCount (0-65535)
6. Then the 'General' category extended settings (ShipSpeed, HealthBonus, etc.)

For the header fields shown in General tab, create inline handler functions that update headerFields state AND set isDirty. Use the new SelectInput for maxPlayers/numTeams/objective:

```typescript
const objectiveOptions: SelectOption[] = [
  { value: ObjectiveType.FRAG, label: 'Deathmatch' },
  { value: ObjectiveType.FLAG, label: 'Capture the Flag' },
  { value: ObjectiveType.SWITCH, label: 'Switches' }
];

const maxPlayerOptions: SelectOption[] = Array.from({ length: 16 }, (_, i) => ({
  value: i + 1, label: String(i + 1)
}));

const teamOptions: SelectOption[] = Array.from({ length: 4 }, (_, i) => ({
  value: i + 1, label: String(i + 1)
}));
```

For 'Weapons' tab: Render settings grouped by subcategory with `<h3 className="section-heading">` dividers:
```tsx
{SETTING_SUBCATEGORIES['Weapons']?.map(sub => (
  <div key={sub}>
    <h3 className="section-heading">{sub}</h3>
    {getSettingsBySubcategory('Weapons', sub).map(setting => (
      <SettingInput key={setting.key} ... />
    ))}
  </div>
))}
```

For 'Game Rules' tab: Similarly, render 'Game' subcategory settings as sliders, then 'Toggles' subcategory as checkboxes:
```tsx
<h3 className="section-heading">Game</h3>
{getSettingsBySubcategory('Game Rules', 'Game').map(setting => (
  <SettingInput key={setting.key} ... />
))}
<h3 className="section-heading">Toggles</h3>
{getSettingsBySubcategory('Game Rules', 'Toggles').map(setting => (
  <CheckboxInput
    key={setting.key}
    label={setting.label}
    checked={(localSettings[setting.key] ?? setting.default) !== 0}
    onChange={(checked) => updateSetting(setting.key, checked ? 1 : 0)}
  />
))}
```

For 'Flagger' tab: Render all Flagger settings as SettingInput sliders (no subcategories needed).

For 'Advanced' tab: Render DHT settings with a 'Dynamic Holding Time' section heading.

**Key implementation detail:** The tab rendering needs to detect which tab types to show. Instead of the current generic loop that renders all tabs the same way, use the new category names and switch on tab behavior:
- Tab index 0 (General): Custom layout with text inputs + selects + checkboxes + sliders
- Tab index 1 (Weapons): Subcategory-grouped sliders
- Tab index 2 (Game Rules): Subcategory-grouped with sliders + checkboxes
- Tab index 3 (Flagger): Simple slider list
- Tab index 4 (Advanced): Subcategory-grouped sliders

The `handleResetAll` should also reset header fields to defaults from createDefaultHeader().
  </action>
  <verify>Run `npm run typecheck` to confirm zero errors. Visually inspect that tabs render 5 entries. Verify that CheckboxInput is used for Toggle settings and SelectInput for objective/teams/maxPlayers.</verify>
  <done>Dialog shows exactly 5 tabs (General, Weapons, Game Rules, Flagger, Advanced). General tab has text inputs + dropdowns + checkboxes + sliders for header fields. Weapons tab shows 4 subcategory groups. Game Rules tab has slider group + checkbox group. Header fields sync on Apply via updateMapHeader spread. Boolean settings use CheckboxInput. Enum settings use SelectInput dropdowns.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes cleanly
2. Dialog renders exactly 5 tabs: General, Weapons, Game Rules, Flagger, Advanced
3. General tab: name/author text inputs, maxPlayers/numTeams/objective dropdowns, weapon enable checkboxes, header sliders, then extended General settings
4. Weapons tab: 4 subcategory sections (Laser, Missile, Bouncy, Grenade) with section headings
5. Game Rules tab: Game settings as sliders, then Toggles section with 5 checkboxes
6. Flagger tab: 12 settings as sliders
7. Advanced tab: 7 DHT settings with section heading
8. Apply button syncs header fields (missilesEnabled, bombsEnabled, bounciesEnabled, objective, numTeams, maxPlayers, laserDamage, specialDamage, rechargeRate, holdingTime, maxSimulPowerups) to map header
9. CheckboxInput.tsx and SelectInput.tsx exist and export correctly
10. Dialog has fixed width (680px) with compact density
</verification>

<success_criteria>
- Map Settings dialog fully modernized with 5 consolidated tabs (UI-09)
- Boolean settings rendered as checkboxes, not toggle switches (user decision honored)
- Enum settings rendered as dropdowns (user decision honored)
- Header fields sync bidirectionally (open reads from header, apply writes back)
- Compact, efficient layout with section headings for subcategories
- All design tokens used (no hardcoded colors/spacing)
</success_criteria>

<output>
After completion, create `.planning/phases/31-ui-completion-sedit-parity/31-02-SUMMARY.md`
</output>
