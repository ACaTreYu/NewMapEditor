---
phase: 100-desktop-patch-dropdown-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron/main.ts
  - electron/preload.ts
  - src/App.tsx
  - src/components/TilesetPanel/TilesetPanel.tsx
  - src/components/TilesetPanel/TilesetPanel.css
autonomous: true

must_haves:
  truths:
    - "Selecting a bundled patch from the dropdown loads the correct tileset and farplane in a packaged Electron build"
    - "The currently loaded bundled patch is visually indicated in the dropdown with a checkmark and bold text"
    - "Loading AC Default patch loads its .jpg farplane successfully (extension-agnostic probe)"
    - "Startup patch load works in production builds (uses IPC, not URL-based loading)"
    - "Selecting a custom patch folder via Browse still works as before"
  artifacts:
    - path: "electron/main.ts"
      provides: "patches:getDir IPC handler"
      contains: "patches:getDir"
    - path: "electron/preload.ts"
      provides: "getPatchesDir exposed via contextBridge + ElectronAPI type"
      contains: "getPatchesDir"
    - path: "src/App.tsx"
      provides: "IPC-based handleSelectBundledPatch, IPC-based startup load, activePatchName state, shared loadImageFromPath helper"
      contains: "getPatchesDir"
    - path: "src/components/TilesetPanel/TilesetPanel.tsx"
      provides: "activePatchName prop + checkmark/bold visual indicator"
      contains: "activePatchName"
    - path: "src/components/TilesetPanel/TilesetPanel.css"
      provides: "Active patch indicator styles"
      contains: "tileset-patch-option--active"
  key_links:
    - from: "src/App.tsx"
      to: "electron/main.ts"
      via: "window.electronAPI.getPatchesDir() IPC call"
      pattern: "getPatchesDir"
    - from: "src/App.tsx"
      to: "src/components/TilesetPanel/TilesetPanel.tsx"
      via: "activePatchName prop"
      pattern: "activePatchName="
    - from: "electron/preload.ts"
      to: "electron/main.ts"
      via: "ipcRenderer.invoke('patches:getDir')"
      pattern: "patches:getDir"
---

<objective>
Fix bundled patch dropdown to work in production Electron builds by replacing URL-based image loading with IPC-based path resolution and file reading, and add a visual indicator showing which patch is currently active.

Purpose: The patch dropdown silently fails in packaged builds because `./assets/patches/...` URLs resolve against `dist/` but patches live in `resources/patches/`. The AC Default farplane also fails because it's `.jpg` not `.png`. This fix uses the same IPC+readFile pattern already proven in `handleChangeTileset`.

Output: Working patch dropdown in dev and production, active patch indicator in UI.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/100-desktop-patch-dropdown-fix/100-RESEARCH.md

Key source files to read before implementing:
@src/App.tsx (lines 61-199: startup load, handleChangeTileset, handleSelectBundledPatch)
@electron/main.ts (lines 551-554: existing patchesDir logic in dialog:openPatchFolder)
@electron/preload.ts (full file: contextBridge + ElectronAPI interface)
@src/components/TilesetPanel/TilesetPanel.tsx (full file: dropdown rendering)
@src/components/TilesetPanel/TilesetPanel.css (full file: dropdown styles)
</context>

<tasks>

<task type="auto">
  <name>Task 1: IPC handler + App.tsx rewrite (patch loading via readFile)</name>
  <files>
    electron/main.ts
    electron/preload.ts
    src/App.tsx
  </files>
  <action>
**electron/main.ts:** Add a new `patches:getDir` IPC handler that returns the platform-correct absolute patches directory path. Place it near the existing `dialog:openPatchFolder` handler (around line 551). Reuse the same `isDev` logic:
```typescript
ipcMain.handle('patches:getDir', async () => {
  return isDev
    ? path.join(process.cwd(), 'public', 'assets', 'patches')
    : path.join(process.resourcesPath, 'patches');
});
```

**electron/preload.ts:** Add `getPatchesDir` to the contextBridge `exposeInMainWorld` object:
```typescript
getPatchesDir: () => ipcRenderer.invoke('patches:getDir'),
```
Add to the `ElectronAPI` interface:
```typescript
getPatchesDir?: () => Promise<string>;
```
Note: Use `?` (optional) because web mode has no electronAPI.

**src/App.tsx:** Make three changes:

1. **Extract shared `loadImageFromPath` helper** at module level or inside the component (before the callbacks). This helper takes an absolute file path, reads it via `window.electronAPI.readFile()`, constructs a `data:` URL with correct MIME type, and returns a Promise<HTMLImageElement>. This is the exact logic currently duplicated in `handleChangeTileset` (lines 105-123). Both `handleChangeTileset` and the rewritten `handleSelectBundledPatch` will call this shared helper. Do NOT change `handleChangeTileset`'s behavior, just extract its `loadImage` inner function to a shared scope so both callbacks can use it.

2. **Add `activePatchName` state:** `const [activePatchName, setActivePatchName] = useState<string | null>('AC Default');` Initialize to `'AC Default'` because that is always loaded on startup.

3. **Rewrite `handleSelectBundledPatch`** (currently lines 164-199) to use IPC-based loading instead of URL-based loading. The new implementation should:
   - Call `window.electronAPI.getPatchesDir?.()` to get the absolute patches directory
   - If `getPatchesDir` is not available (web mode / no electronAPI), fall back to URL-based loading with `./assets/patches/...` (preserve web compatibility)
   - Construct `patchDir = patchesDir + '/' + patchName`
   - Call `window.electronAPI.listDir(patchDir)` to get the file list
   - Use a `findImage(prefix)` helper (same pattern as in `handleChangeTileset`) to find files by prefix with any image extension (.png, .jpg, .jpeg, .bmp, .gif)
   - Load `imgTiles` (required) via `loadImageFromPath` -> `setTilesetImage`
   - Load `imgFarplane` (optional, extension-agnostic via findImage) -> `setFarplaneImage` or null
   - Load `imgTuna` (optional) -> `setTunaImage` or null
   - Only call `setActivePatchName(patchName)` AFTER successful imgTiles load
   - On failure, do NOT update activePatchName
   - See the full code example in 100-RESEARCH.md "Full Rewritten handleSelectBundledPatch" section

4. **Rewrite startup patch load** (currently lines 62-84, the `useEffect` that loads AC Default). The current implementation uses URL-based `new Image().src` which has the SAME production bug. Rewrite to:
   - Attempt IPC-based loading first: call `getPatchesDir`, then `listDir`, then `findImage` + `loadImageFromPath` for imgTiles and imgFarplane
   - If IPC is not available (web mode), fall back to the existing URL-based approach
   - This ensures startup also works in packaged builds
   - The web fallback should try `imgFarplane.jpg` (as currently implemented) since AC Default uses .jpg

5. **Pass `activePatchName` to TilesetPanel** in the JSX (around line 541):
```tsx
<TilesetPanel
  tilesetImage={tilesetImage}
  onTileHover={handleTilesetHover}
  onChangeTileset={handleChangeTileset}
  onSelectBundledPatch={handleSelectBundledPatch}
  activePatchName={activePatchName}
/>
```

Also: when `handleChangeTileset` (custom folder browse) is used successfully, call `setActivePatchName(null)` to clear the active bundled patch indicator since the user loaded a custom non-bundled patch.
  </action>
  <verify>
Run `npm run typecheck` — no TypeScript errors. Verify that `getPatchesDir` is in both preload.ts contextBridge and ElectronAPI interface. Verify `handleSelectBundledPatch` calls `getPatchesDir` not URL construction. Verify startup useEffect calls `getPatchesDir`. Verify `activePatchName` state exists and is passed to TilesetPanel.
  </verify>
  <done>
IPC `patches:getDir` handler exists in main.ts and is exposed in preload.ts. App.tsx handleSelectBundledPatch uses IPC readFile pattern (not URL). Startup load uses IPC readFile pattern with web fallback. loadImageFromPath is shared between handleChangeTileset and handleSelectBundledPatch. activePatchName state tracks current bundled patch and is passed to TilesetPanel. Custom folder browse clears activePatchName.
  </done>
</task>

<task type="auto">
  <name>Task 2: TilesetPanel active patch indicator</name>
  <files>
    src/components/TilesetPanel/TilesetPanel.tsx
    src/components/TilesetPanel/TilesetPanel.css
  </files>
  <action>
**TilesetPanel.tsx:**
1. Add `activePatchName` to the Props interface:
```typescript
interface Props {
  tilesetImage: HTMLImageElement | null;
  onTileHover?: (tileId: number | undefined, col: number, row: number) => void;
  onChangeTileset?: () => void;
  onSelectBundledPatch?: (patchName: string) => void;
  activePatchName?: string | null;
}
```

2. Destructure `activePatchName` in the component signature.

3. Update the dropdown button rendering (currently line 52-61) to show a checkmark and active class for the currently loaded patch:
```tsx
{BUNDLED_PATCHES.map((name) => (
  <button
    key={name}
    className={`tileset-patch-option${name === activePatchName ? ' tileset-patch-option--active' : ''}`}
    onClick={() => {
      onSelectBundledPatch(name);
      setDropdownOpen(false);
    }}
  >
    {name === activePatchName && <span className="tileset-patch-check">&#10003; </span>}
    {name}
  </button>
))}
```

**TilesetPanel.css:** Add active indicator styles after the existing `.tileset-patch-option:hover` rule (after line 71):
```css
.tileset-patch-option--active {
  font-weight: 600;
  color: var(--accent, var(--text-primary));
}

.tileset-patch-check {
  margin-right: 4px;
  color: var(--accent, var(--text-primary));
}
```
  </action>
  <verify>
Run `npm run typecheck` — no TypeScript errors. Run `npm run electron:dev` and visually verify: the patch dropdown shows a checkmark next to "AC Default" on startup, selecting a different patch moves the checkmark, and the active patch name is bold. Selecting "Browse for patch folder" (custom folder) clears the checkmark from all bundled patches.
  </verify>
  <done>
TilesetPanel accepts activePatchName prop. Dropdown items show a checkmark and bold text for the currently active bundled patch. Checkmark clears when a custom (non-bundled) patch is loaded via Browse.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with no errors
2. `npm run electron:dev` starts successfully
3. In dev mode: selecting any bundled patch from dropdown loads the tileset (visible change in tile palette) and the checkmark moves to the selected patch
4. In dev mode: selecting AC Default loads its .jpg farplane without error
5. In dev mode: browsing a custom patch folder clears the active patch indicator
6. The startup load uses IPC when electronAPI is available (check by adding a temporary console.log in the getPatchesDir IPC handler and confirming it fires on app start)
</verification>

<success_criteria>
- Bundled patch dropdown uses IPC readFile pattern (not URL-based loading) when electronAPI is available
- Startup patch load uses IPC readFile pattern (not URL-based loading) when electronAPI is available
- AC Default farplane loads correctly (.jpg extension found via findImage probe)
- Active patch visually indicated in dropdown with checkmark + bold
- Custom folder browse clears active patch indicator
- TypeScript compiles without errors
- Web fallback preserved for non-Electron environments
</success_criteria>

<output>
After completion, create `.planning/phases/100-desktop-patch-dropdown-fix/100-01-SUMMARY.md`
</output>
