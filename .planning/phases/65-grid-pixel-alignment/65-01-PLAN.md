---
phase: 65-grid-pixel-alignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/MapCanvas/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - Grid lines align exactly to tile borders at all zoom levels (0.25x to 4x)
    - No pixel drift or sub-pixel gaps visible between grid and tile edges
    - Grid remains stable during pan/zoom operations without shifting
  artifacts:
    - path: src/components/MapCanvas/MapCanvas.tsx
      provides: Integer pixel snapping for grid offset calculation
      contains: "Math.round\\(.*offsetX"
  key_links:
    - from: src/components/MapCanvas/MapCanvas.tsx
      to: grid offset calculation (lines 277-278)
      via: Math.round() wrapper
      pattern: "Math\\.round\\(-\\(vp\\.[xy] % 1\\) \\* tilePixelSize\\)"
---

<objective>
Fix grid line misalignment by adding integer pixel snapping to grid offset calculations.

Purpose: Eliminate subpixel rendering artifacts that cause grid lines to appear blurry or misaligned with tile borders at fractional viewport positions.

Output: Grid rendering with perfect tile border alignment at all zoom levels.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-grid-pixel-alignment/65-RESEARCH.md
@src/components/MapCanvas/MapCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Add Math.round() to grid offset calculations</name>
  <files>src/components/MapCanvas/MapCanvas.tsx</files>
  <action>
In MapCanvas.tsx, locate the grid rendering section in drawUiLayer callback (lines 277-278).

Current code:
```typescript
const offsetX = -(vp.x % 1) * tilePixelSize;
const offsetY = -(vp.y % 1) * tilePixelSize;
```

Wrap both offset calculations with Math.round() for integer pixel snapping:
```typescript
const offsetX = Math.round(-(vp.x % 1) * tilePixelSize);
const offsetY = Math.round(-(vp.y % 1) * tilePixelSize);
```

**Why this works:** Fractional viewport coordinates (e.g., viewport.x = 12.347) create subpixel offsets (e.g., -0.347 * 16 = -5.552px) that trigger canvas antialiasing. Rounding to integer pixels (-6px) eliminates subpixel rendering and aligns grid pattern with tile borders.

**What NOT to change:** Do NOT round viewport state in Zustand (preserves zoom-to-cursor accuracy). Only round during rendering. tilePixelSize is already rounded on line 251 (correct).
  </action>
  <verify>
1. Run `npm run typecheck` to confirm no type errors
2. Visual verification at multiple zoom levels:
   - Start dev app: `npm run electron:dev`
   - Enable grid (toolbar grid button or G key)
   - Test zoom levels: 0.25x, 0.5x, 1x, 2x, 4x
   - Pan around map at each zoom level
   - Expected: Grid lines perfectly aligned with tile borders, no blurring, no 1px gaps
   - Test intermediate zooms (0.9x, 1.3x): Grid should remain crisp
  </verify>
  <done>
Grid offset calculations use Math.round() wrapper (lines 277-278 modified). Type checking passes. Visual verification shows perfect grid alignment at all zoom levels with no subpixel artifacts.
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Grid pixel alignment fix with integer snapping for offset calculations</what-built>
  <how-to-verify>
**Testing procedure:**

1. Launch dev app (`npm run electron:dev`)
2. Create new map or open existing map
3. Enable grid (toolbar button or press G)
4. Set grid opacity to 100%, line weight to 1px for maximum visibility (grid settings dropdown)

**Test 1 - Standard zoom levels:**
- Set zoom to 1x (Ctrl+0 or 100% button)
- Pan around map - grid lines should perfectly align with tile edges
- Zoom to 0.25x - verify grid remains aligned
- Zoom to 4x - verify grid remains aligned

**Test 2 - Intermediate zoom levels:**
- Set zoom to 90% (type in zoom input box)
- Pan around - grid should remain crisp and aligned
- Try 130%, 270% - no blurring or gaps expected

**Test 3 - Fractional viewport positions:**
- At 1x zoom, pan with right-click drag in small increments (touchpad)
- Watch grid lines as you pan slowly - should not shift/jump/blur
- Grid should move smoothly with tiles, not lag or drift

**Expected results:**
- ✓ Grid lines snap to exact tile borders at all zoom levels
- ✓ No pixel drift or sub-pixel gaps between grid and tile edges
- ✓ Grid remains stable during pan operations (no flickering or jumping)
- ✓ Grid lines appear crisp (not blurred or antialiased)
- ✓ Alignment is consistent across entire viewport (not just at origin)

**If you see issues:**
- Describe which zoom level shows misalignment
- Note whether issue occurs during static view or during pan
- Screenshot if possible (Ctrl+Shift+S in Windows)
  </how-to-verify>
  <resume-signal>Reply "approved" if grid alignment is correct, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
**Code verification:**
- [ ] MapCanvas.tsx lines 277-278 modified to use Math.round()
- [ ] No changes to tilePixelSize calculation (already rounded on line 251)
- [ ] No changes to viewport state (remains fractional)
- [ ] TypeScript compilation succeeds

**Visual verification:**
- [ ] Grid aligns perfectly at 0.25x, 0.5x, 1x, 2x, 4x zoom
- [ ] Grid aligns at intermediate zoom levels (0.9x, 1.3x, 2.7x)
- [ ] Grid remains stable during pan operations
- [ ] No blurring or antialiasing artifacts on grid lines
- [ ] Alignment consistent across entire viewport (edge to edge)

**Regression checks:**
- [ ] Zoom-to-cursor still works correctly (cursor stays over same tile)
- [ ] Pan drag feels smooth (no stuttering from rounding)
- [ ] Grid pattern cache still functions (pattern recreated only on settings change)
- [ ] Grid toggle and settings dropdown work as before
</verification>

<success_criteria>
Phase complete when:

1. **REND-03 requirement met:** Grid lines always align to tile borders at all zoom levels with integer pixel snapping
2. **Code changes minimal:** Only two lines modified (277-278), Math.round() wrapper added
3. **No regressions:** Zoom-to-cursor accuracy preserved, pan smoothness maintained
4. **Visual quality:** Grid rendering is crisp and artifact-free at all tested zoom levels
5. **Human verification passed:** User confirms grid alignment is perfect across all test scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/65-grid-pixel-alignment/65-01-SUMMARY.md`
</output>
