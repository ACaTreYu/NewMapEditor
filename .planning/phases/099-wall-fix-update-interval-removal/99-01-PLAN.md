---
phase: 099-wall-fix-update-interval-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/WallSystem.ts
  - electron/main.ts
autonomous: true

must_haves:
  truths:
    - "Drawing wall type B adjacent to existing wall type A leaves type-A tile unchanged"
    - "Wall line tool (drag-draw) preserves neighbor wall types during batch placement"
    - "After app launch, auto-updater fires one check and no further periodic checks occur"
  artifacts:
    - path: "src/core/map/WallSystem.ts"
      provides: "Wall neighbor type preservation in updateNeighbor and collectNeighborUpdate"
      contains: "findWallType(currentTile)"
    - path: "electron/main.ts"
      provides: "Startup-only update check with no recurring interval"
      contains: "setTimeout"
  key_links:
    - from: "src/core/map/WallSystem.ts:updateNeighbor"
      to: "src/core/map/WallSystem.ts:findWallType"
      via: "neighbor type lookup before getWallTile call"
      pattern: "findWallType\\(currentTile\\)"
    - from: "src/core/map/WallSystem.ts:collectNeighborUpdate"
      to: "src/core/map/WallSystem.ts:findWallType"
      via: "neighbor type lookup before getWallTile call"
      pattern: "findWallType\\(currentTile\\)"
---

<objective>
Fix two bugs: (1) wall neighbor updates that corrupt adjacent tile types by using the brush type instead of the neighbor's own type, and (2) a recurring 30-minute auto-updater interval that should not exist.

Purpose: WALL-01/WALL-02 prevent wall type bleeding where placing one wall type converts nearby walls of a different type. UPDT-01 eliminates unnecessary background network polling.
Output: Corrected WallSystem.ts methods and cleaned-up main.ts auto-updater setup.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/099-wall-fix-update-interval-removal/99-RESEARCH.md
@src/core/map/WallSystem.ts
@electron/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix wall neighbor type preservation in WallSystem.ts</name>
  <files>src/core/map/WallSystem.ts</files>
  <action>
Fix two methods that incorrectly use `this.currentType` (the brush type) when updating neighbor wall tiles. Both must use `this.findWallType(currentTile)` (the neighbor's own type) instead, matching the pattern already used in `updateNeighborDisconnect`.

**Method 1 — `updateNeighbor` (single-tile pencil path, ~line 163):**

Replace the method body to:
1. Add `const wallType = this.findWallType(currentTile);` after the `isWallTile` check
2. Add `if (wallType === -1) return;` guard
3. Change `this.getWallTile(this.currentType, connections)` to `this.getWallTile(wallType, connections)`
4. Update the method comment from "Uses currentType for the new tile" to "Preserve the neighbor's existing wall type"

Complete corrected method:
```typescript
private updateNeighbor(map: MapData, x: number, y: number, _addConnection: number): void {
    if (x < 0 || x >= MAP_WIDTH || y < 0 || y >= MAP_HEIGHT) return;

    const index = y * MAP_WIDTH + x;
    const currentTile = map.tiles[index];

    // Only update if it's already a wall
    if (!this.isWallTile(currentTile)) return;

    // Preserve the neighbor's existing wall type (not the brush's current type)
    const wallType = this.findWallType(currentTile);
    if (wallType === -1) return;

    // Recalculate connections for the neighbor
    const connections = this.getConnections(map, x, y);
    const newTile = this.getWallTile(wallType, connections);
    map.tiles[index] = newTile;
}
```

**Method 2 — `collectNeighborUpdate` (batch/line-draw path, ~line 227):**

Same pattern. Replace `this.getWallTile(this.currentType, connections)` with the `findWallType` lookup:

```typescript
private collectNeighborUpdate(
    map: MapData,
    x: number,
    y: number,
    affectedTiles: Map<string, number>
): void {
    if (x < 0 || x >= MAP_WIDTH || y < 0 || y >= MAP_HEIGHT) return;

    const index = y * MAP_WIDTH + x;
    const currentTile = map.tiles[index];

    // Only update if it's already a wall
    if (!this.isWallTile(currentTile)) return;

    // Preserve the neighbor's existing wall type (not the brush's current type)
    const wallType = this.findWallType(currentTile);
    if (wallType === -1) return;

    // Recalculate connections for the neighbor
    const connections = this.getConnections(map, x, y);
    const newTile = this.getWallTile(wallType, connections);
    affectedTiles.set(`${x},${y}`, newTile);
}
```

Do NOT change `placeWall`, `placeWallBatch`, or any other method. Do NOT change the batch phase ordering in `placeWallBatch`. Do NOT duplicate the `getConnections` call — it already exists in both methods.
  </action>
  <verify>
1. `npm run typecheck` passes with no errors
2. Grep WallSystem.ts for `this.currentType` — it should appear ONLY in `placeWall` (line ~149), `placeWallBatch` Phase 1 and Phase 2 (lines ~196, ~204), and `getWallType`/`setWallType` accessors. It must NOT appear in `updateNeighbor` or `collectNeighborUpdate`.
3. Grep WallSystem.ts for `findWallType` — it should appear in `updateNeighbor`, `collectNeighborUpdate`, AND `updateNeighborDisconnect` (all three neighbor-update methods now use the same pattern).
  </verify>
  <done>
Both `updateNeighbor` and `collectNeighborUpdate` use `findWallType(currentTile)` to look up the neighbor's wall type before calling `getWallTile`. The `-1` guard is present in both. No other methods were changed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove recurring auto-updater interval in main.ts</name>
  <files>electron/main.ts</files>
  <action>
In `electron/main.ts`, inside the `setupAutoUpdater()` function (~line 388-389), remove the `setInterval` call and its comment:

```typescript
// DELETE these two lines:
// Re-check every 30 minutes
setInterval(() => autoUpdater.checkForUpdates(), 30 * 60 * 1000);
```

Keep the `setTimeout` call on the line above (~line 386):
```typescript
// Check on launch (delay to not compete with startup)
setTimeout(() => autoUpdater.checkForUpdates(), 5000);
```

Do NOT remove the `setTimeout`. Do NOT modify `manualCheckInProgress`, the menu "Check for Updates" handler, `autoUpdater.autoDownload`, `autoUpdater.autoInstallOnAppQuit`, or any event handlers (`update-available`, `update-downloaded`, etc.).
  </action>
  <verify>
1. `npm run typecheck` passes with no errors
2. Grep main.ts for `setInterval` — should return zero matches
3. Grep main.ts for `setTimeout.*checkForUpdates` — should return exactly one match (the startup check)
  </verify>
  <done>
The `setInterval` line is removed. The `setTimeout` startup check remains. No other auto-updater code was changed.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` — full project type check passes
2. In WallSystem.ts, `this.currentType` does NOT appear in `updateNeighbor` or `collectNeighborUpdate`
3. In WallSystem.ts, `findWallType(currentTile)` appears in all three neighbor-update methods: `updateNeighbor`, `collectNeighborUpdate`, `updateNeighborDisconnect`
4. In main.ts, no `setInterval` calls exist; exactly one `setTimeout` for `checkForUpdates` exists
5. `npm run electron:dev` launches without errors
</verification>

<success_criteria>
- Wall neighbor updates preserve the neighbor's existing wall type (use findWallType, not this.currentType)
- Batch wall placement (line tool) also preserves neighbor types via the same fix in collectNeighborUpdate
- Auto-updater checks once on startup only — no recurring setInterval
- TypeScript compilation passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/099-wall-fix-update-interval-removal/99-01-SUMMARY.md`
</output>
