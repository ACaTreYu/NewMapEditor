---
phase: 86-settings-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/settingsSerializer.ts
  - src/core/map/index.ts
  - src/components/MapSettingsDialog/MapSettingsDialog.tsx
  - src/core/map/types.ts
  - src/core/services/MapService.ts
autonomous: true

must_haves:
  truths:
    - "A newly created map's description starts with Format=1.1 and contains all 53 GAME_SETTINGS keys at default values"
    - "A newly created map's extendedSettings record contains all 53 default values"
    - "Opening an existing map merges binary header values into the description, producing all 53 keys with Format=1.1 prefix"
    - "Opening an existing map syncs extendedSettings to match the merged description"
    - "Saving a map re-serializes extendedSettings into the description before writing to disk"
    - "Author= always appears as the last item in the description string"
    - "Unrecognized key-value pairs in the description survive open-save round-trips"
  artifacts:
    - path: "src/core/map/settingsSerializer.ts"
      provides: "Shared serialization module with lifecycle helpers"
      exports: ["serializeSettings", "parseSettings", "buildDescription", "parseDescription", "initializeDescription", "mergeDescriptionWithHeader", "reserializeDescription", "LASER_DAMAGE_VALUES", "SPECIAL_DAMAGE_VALUES", "RECHARGE_RATE_VALUES", "findClosestIndex"]
    - path: "src/core/map/index.ts"
      provides: "Re-exports settingsSerializer"
      contains: "export * from './settingsSerializer'"
    - path: "src/core/map/types.ts"
      provides: "createEmptyMap calls initializeDescription"
      contains: "initializeDescription"
    - path: "src/core/services/MapService.ts"
      provides: "loadMap calls mergeDescriptionWithHeader, saveMap/saveMapAs call reserializeDescription"
      contains: "mergeDescriptionWithHeader"
    - path: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      provides: "Imports from @core/map instead of local definitions"
      contains: "import.*from '@core/map'"
  key_links:
    - from: "src/core/map/settingsSerializer.ts"
      to: "src/core/map/GameSettings.ts"
      via: "imports GAME_SETTINGS, getDefaultSettings"
      pattern: "import.*from './GameSettings'"
    - from: "src/core/map/types.ts"
      to: "src/core/map/settingsSerializer.ts"
      via: "imports initializeDescription"
      pattern: "import.*initializeDescription.*from './settingsSerializer'"
    - from: "src/core/services/MapService.ts"
      to: "src/core/map/settingsSerializer.ts"
      via: "imports mergeDescriptionWithHeader, reserializeDescription, parseDescription"
      pattern: "import.*mergeDescriptionWithHeader"
    - from: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      to: "src/core/map/settingsSerializer.ts"
      via: "imports serializeSettings, parseSettings, buildDescription, parseDescription, constants"
      pattern: "import.*from '@core/map'"
---

<objective>
Extract settings serialization logic from MapSettingsDialog.tsx into a shared module and wire it into the map lifecycle (create, open, save) so every map always carries a complete, correctly ordered description field.

Purpose: Currently, settings are only written to the description when the user manually opens and applies the Map Settings dialog. New maps get a bare "New map" description, opened maps keep whatever the file contained, and saves write description as-is. This means maps can exist without any settings in their description -- breaking the AC game server's ability to read them.

Output: A new `settingsSerializer.ts` module in `src/core/map/`, updated lifecycle hooks in `types.ts` and `MapService.ts`, and `MapSettingsDialog.tsx` refactored to import from the shared module.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/86-settings-lifecycle/86-RESEARCH.md
@src/core/map/GameSettings.ts
@src/core/map/types.ts
@src/core/map/index.ts
@src/core/services/MapService.ts
@src/components/MapSettingsDialog/MapSettingsDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract settingsSerializer.ts and update MapSettingsDialog imports</name>
  <files>
    src/core/map/settingsSerializer.ts
    src/core/map/index.ts
    src/components/MapSettingsDialog/MapSettingsDialog.tsx
  </files>
  <action>
**1. Create `src/core/map/settingsSerializer.ts`:**

Move (not copy) these items from `MapSettingsDialog.tsx`:
- Constants: `LASER_DAMAGE_VALUES`, `SPECIAL_DAMAGE_VALUES`, `RECHARGE_RATE_VALUES` (lines 168-170)
- Function: `findClosestIndex` (lines 176-187)
- Function: `serializeSettings` (lines 15-35)
- Function: `parseSettings` (lines 43-73)
- Function: `buildDescription` (lines 83-100) -- **FIX ORDERING: unrecognized pairs BEFORE Author=** (currently Author= comes before unrecognized, which is wrong per SETT-04)
- Function: `parseDescription` (lines 107-118)

All functions and constants must be `export`ed.

The module imports only from `./GameSettings` and `./types` (no circular deps).

```typescript
import { GAME_SETTINGS, getDefaultSettings } from './GameSettings';
import { MapHeader } from './types';
```

**Fix `buildDescription` ordering (SETT-04):**
The current code puts `Author=` before unrecognized pairs. Fix to:
```typescript
export function buildDescription(settings: Record<string, number>, author: string, unrecognized?: string[]): string {
  const parts: string[] = [];
  parts.push(serializeSettings(settings));          // Format=1.1 + all settings
  if (unrecognized && unrecognized.length > 0) {
    parts.push(...unrecognized);                    // unrecognized pairs BEFORE Author=
  }
  if (author.trim()) {
    parts.push(`Author=${author.trim()}`);          // Author= ALWAYS LAST
  }
  return parts.join(', ');
}
```

**Add 3 new lifecycle helpers:**

```typescript
/** SETT-01: Build a fresh description with all defaults */
export function initializeDescription(): string {
  return buildDescription(getDefaultSettings(), '', []);
}

/** SETT-02: Merge existing description + binary header values into canonical form */
export function mergeDescriptionWithHeader(description: string, header: MapHeader): string {
  const { settings, author, unrecognized } = parseDescription(description);
  const headerDerived: Record<string, number> = {
    LaserDamage: LASER_DAMAGE_VALUES[header.laserDamage] ?? 27,
    MissileDamage: SPECIAL_DAMAGE_VALUES[header.specialDamage] ?? 102,
    MissileRecharge: RECHARGE_RATE_VALUES[header.rechargeRate] ?? 945,
  };
  const defaults = getDefaultSettings();
  // Merge priority: defaults < headerDerived < parsed description settings
  const merged = { ...defaults, ...headerDerived, ...settings };
  if (merged['SwitchWin'] === 0 && header.switchCount > 0) {
    merged['SwitchWin'] = header.switchCount;
  }
  return buildDescription(merged, author, unrecognized);
}

/** SETT-03: Re-serialize description from extendedSettings before save */
export function reserializeDescription(
  description: string,
  extendedSettings: Record<string, number>
): string {
  const { author, unrecognized } = parseDescription(description);
  const defaults = getDefaultSettings();
  const settings = { ...defaults, ...extendedSettings };
  return buildDescription(settings, author, unrecognized);
}
```

**2. Update `src/core/map/index.ts`:**

Add this line after the existing exports:
```typescript
export * from './settingsSerializer';
```

**3. Update `src/components/MapSettingsDialog/MapSettingsDialog.tsx`:**

- Add imports from `@core/map` for the extracted items:
  ```typescript
  import {
    GAME_SETTINGS, getSettingsByCategory, getSettingsBySubcategory,
    SETTING_SUBCATEGORIES, getDefaultSettings, ObjectiveType, createDefaultHeader,
    serializeSettings, parseSettings, buildDescription, parseDescription,
    LASER_DAMAGE_VALUES, SPECIAL_DAMAGE_VALUES, RECHARGE_RATE_VALUES, findClosestIndex
  } from '@core/map';
  ```
- Remove the local function definitions for `serializeSettings` (lines 15-35), `parseSettings` (lines 43-73), `buildDescription` (lines 83-100), `parseDescription` (lines 107-118)
- Remove the local constant definitions for `LASER_DAMAGE_VALUES`, `SPECIAL_DAMAGE_VALUES`, `RECHARGE_RATE_VALUES` (lines 168-170)
- Remove the local `findClosestIndex` function (lines 176-187)
- Verify no other local references break -- the dialog still calls `parseDescription`, `buildDescription`, `findClosestIndex`, and the constant arrays, but now via the shared import

**Important:** The `serializeSettings` function is NOT used directly by MapSettingsDialog (it calls `buildDescription` which calls `serializeSettings` internally). But export it anyway for completeness.
  </action>
  <verify>
Run `npm run typecheck` -- must pass with zero errors. The MapSettingsDialog must compile successfully with all its internal references resolving to the shared module.
  </verify>
  <done>
`settingsSerializer.ts` exists in `src/core/map/` with all 4 extracted functions + 3 constants + `findClosestIndex` + 3 lifecycle helpers exported. `buildDescription` ordering is fixed (unrecognized before Author=). `MapSettingsDialog.tsx` no longer defines any of the extracted items locally. `index.ts` re-exports the new module. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire lifecycle hooks into createEmptyMap, loadMap, and saveMap</name>
  <files>
    src/core/map/types.ts
    src/core/services/MapService.ts
  </files>
  <action>
**1. Fix `createEmptyMap()` in `src/core/map/types.ts` (SETT-01):**

Add import at top of file:
```typescript
import { initializeDescription } from './settingsSerializer';
import { getDefaultSettings } from './GameSettings';
```

Note: `getDefaultSettings` may already be available if GameSettings is imported. Check existing imports. If not imported, add it.

Update `createEmptyMap()`:
```typescript
export function createEmptyMap(): MapData {
  const tiles = new Uint16Array(TILE_COUNT);
  tiles.fill(DEFAULT_TILE);
  const header = createDefaultHeader();
  header.description = initializeDescription();
  header.extendedSettings = getDefaultSettings();
  return { header, tiles, modified: false };
}
```

This ensures every new map starts with `Format=1.1, BouncyDamage=48, BouncyEnergy=12, ...` in its description and a fully populated `extendedSettings` record.

**2. Fix `MapService.loadMap()` in `src/core/services/MapService.ts` (SETT-02):**

Add imports:
```typescript
import { mergeDescriptionWithHeader, parseDescription } from '../map/settingsSerializer';
import { getDefaultSettings } from '../map/GameSettings';
```

After the decompression block (around line 77, after `mapData.tiles = new Uint16Array(decompResult.data!);`) and before the return statement (line 79), add:

```typescript
// SETT-02: Merge settings into description (binary header values + defaults for missing keys)
mapData.header.description = mergeDescriptionWithHeader(
  mapData.header.description,
  mapData.header
);
// Sync extendedSettings so Map Settings dialog has correct values
const { settings: parsedSettings } = parseDescription(mapData.header.description);
mapData.header.extendedSettings = { ...getDefaultSettings(), ...parsedSettings };
```

**Important:** This code must run for ALL map versions, not just v3. Move the merge+sync code AFTER the v3 decompression `if` block but BEFORE the `return`. The current code structure has the return at line 79 (`return { success: true, map: mapData, filePath };`). The merge code goes just before this return, outside the `if (mapData.header.version === 3)` block.

**3. Fix `MapService.saveMap()` in `src/core/services/MapService.ts` (SETT-03):**

Add import (if not already added above):
```typescript
import { reserializeDescription } from '../map/settingsSerializer';
```

Before `const headerBuffer = mapParser.serialize(map);` (line 98), insert:
```typescript
// SETT-03: Re-serialize current settings into description before writing
const mapToSave: MapData = {
  ...map,
  header: {
    ...map.header,
    description: reserializeDescription(map.header.description, map.header.extendedSettings)
  }
};
```

Then change `mapParser.serialize(map)` to `mapParser.serialize(mapToSave)` and update all subsequent references to `map` in this method to use `mapToSave` (specifically `map.tiles` becomes `mapToSave.tiles` for the tile compression step).

**4. Fix `MapService.saveMapAs()` in `src/core/services/MapService.ts` (SETT-03):**

Apply the same pattern before `const headerBuffer = mapParser.serialize(map);` (line 140):
```typescript
// SETT-03: Re-serialize current settings into description before writing
const mapToSave: MapData = {
  ...map,
  header: {
    ...map.header,
    description: reserializeDescription(map.header.description, map.header.extendedSettings)
  }
};
```

Then change `mapParser.serialize(map)` to `mapParser.serialize(mapToSave)` and update `map.tiles` to `mapToSave.tiles`.

**Note on MapData import:** `MapData` is already imported in MapService.ts (line 9). The type annotation on `mapToSave` uses this existing import.
  </action>
  <verify>
Run `npm run typecheck` -- must pass with zero errors. Specifically verify:
1. `types.ts` compiles with the new `initializeDescription` import (no circular dependency)
2. `MapService.ts` compiles with imports from `settingsSerializer` and `GameSettings`
3. No unused import warnings
  </verify>
  <done>
`createEmptyMap()` produces a map with a fully populated description (Format=1.1 + all 53 settings) and `extendedSettings` record. `loadMap()` merges binary header values and defaults into the description after parsing any map version, and syncs `extendedSettings`. `saveMap()` and `saveMapAs()` both re-serialize `extendedSettings` into the description before writing to disk. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
After both tasks are complete:

1. **TypeScript compilation:** `npm run typecheck` passes with zero errors
2. **No circular dependencies:** `settingsSerializer.ts` only imports from `GameSettings.ts` and `types.ts`
3. **SETT-01 verification:** Inspect `createEmptyMap()` -- returned map's `header.description` starts with `Format=1.1` and contains all 53 GAME_SETTINGS keys. `header.extendedSettings` has all 53 keys with default values.
4. **SETT-02 verification:** Inspect `MapService.loadMap()` -- after the return, `mapData.header.description` contains all 53 keys and `header.extendedSettings` is synced.
5. **SETT-03 verification:** Inspect `MapService.saveMap()` and `saveMapAs()` -- both call `reserializeDescription` before `mapParser.serialize`.
6. **SETT-04 verification:** Inspect `buildDescription()` in `settingsSerializer.ts` -- Author= is appended AFTER unrecognized pairs.
7. **SETT-05 verification:** `parseDescription()` preserves unrecognized pairs (excluding Author= and Format=), `buildDescription()` passes them through.
8. **MapSettingsDialog regression:** Dialog still compiles and all its references to `parseDescription`, `buildDescription`, `findClosestIndex`, `LASER_DAMAGE_VALUES`, etc. resolve to the shared imports.
</verification>

<success_criteria>
- `npm run typecheck` passes
- `settingsSerializer.ts` exists with 4 extracted functions, 3 constants, `findClosestIndex`, and 3 lifecycle helpers (11 exports total)
- `buildDescription` puts Author= LAST (after unrecognized pairs)
- `createEmptyMap()` calls `initializeDescription()` and sets `extendedSettings = getDefaultSettings()`
- `MapService.loadMap()` calls `mergeDescriptionWithHeader()` and syncs `extendedSettings`
- `MapService.saveMap()` and `saveMapAs()` call `reserializeDescription()` on a shallow copy before serialize
- `MapSettingsDialog.tsx` has zero locally-defined serialization functions or constant arrays -- all imported from `@core/map`
</success_criteria>

<output>
After completion, create `.planning/phases/86-settings-lifecycle/86-01-SUMMARY.md`
</output>
