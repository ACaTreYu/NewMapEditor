---
phase: 69-conveyor-fix-farplane-toggle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/GameObjectData.ts
  - src/core/editor/slices/globalSlice.ts
  - src/core/canvas/CanvasEngine.ts
  - src/components/ToolBar/ToolBar.tsx
autonomous: true

must_haves:
  truths:
    - "Downward conveyor tiles animate through 8 frames at the same speed as horizontal conveyors"
    - "User can toggle farplane background rendering on/off via toolbar button"
    - "Farplane toggle state persists across tool switches and viewport changes within a session"
  artifacts:
    - path: "src/core/map/GameObjectData.ts"
      provides: "Animated tile encoding for CONV_DOWN_DATA"
      contains: "0x8000 | 0x94"
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "showFarplane boolean state with toggleFarplane action"
      contains: "showFarplane"
    - path: "src/core/canvas/CanvasEngine.ts"
      provides: "Conditional farplane rendering in renderTile and subscription for showFarplane changes"
      contains: "showFarplane"
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Farplane toggle button in toolbar"
      contains: "toggleFarplane"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "useEditorStore showFarplane + toggleFarplane"
      pattern: "toggleFarplane"
    - from: "src/core/canvas/CanvasEngine.ts"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "useEditorStore.getState().showFarplane in renderTile"
      pattern: "showFarplane"
---

<objective>
Fix downward conveyor animation by switching CONV_DOWN_DATA to animated tile encoding, and add a farplane background toggle to the editing canvas with toolbar button and session persistence.

Purpose: Complete the v3.2 milestone by fixing the last animation bug and adding the final UX feature.
Output: Working animated downward conveyors, functional farplane toggle button in toolbar.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/69-conveyor-fix-farplane-toggle/69-RESEARCH.md
@src/core/map/GameObjectData.ts
@src/core/map/AnimationDefinitions.ts
@src/core/editor/slices/globalSlice.ts
@src/core/canvas/CanvasEngine.ts
@src/components/ToolBar/ToolBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix downward conveyor animation data</name>
  <files>src/core/map/GameObjectData.ts</files>
  <action>
  Replace `CONV_DOWN_DATA` array with animated tile encoding using `0x8000 | animId`.

  The current data uses static tile IDs `[1581, 1582, 1621, 1622, 1621, 1622, 1661, 1662]` which don't animate because they're not flagged as animated tiles. The downward conveyor animations are defined as:

  - 0x94: top-left column frames `[1581, 1583, 1585, 1587, 1589, 1591, 1593, 1595]`
  - 0x95: top-right column frames `[1582, 1584, 1586, 1588, 1590, 1592, 1594, 1596]`
  - 0x96: middle-left column frames `[1621, 1623, 1625, 1627, 1629, 1631, 1633, 1635]`
  - 0x97: middle-right column frames `[1622, 1624, 1626, 1628, 1630, 1632, 1634, 1636]`
  - 0x98: bottom-left column frames `[1661, 1663, 1665, 1667, 1669, 1671, 1673, 1675]`
  - 0x99: bottom-right column frames `[1662, 1664, 1666, 1668, 1670, 1672, 1674, 1676]`

  Change line 97 from:
  ```typescript
  export const CONV_DOWN_DATA: number[] = [1581, 1582, 1621, 1622, 1621, 1622, 1661, 1662];
  ```
  To:
  ```typescript
  export const CONV_DOWN_DATA: number[] = [
    0x8000 | 0x94,  // Top-left (anim 0x94)
    0x8000 | 0x95,  // Top-right (anim 0x95)
    0x8000 | 0x96,  // Middle-left (anim 0x96)
    0x8000 | 0x97,  // Middle-right (anim 0x97)
    0x8000 | 0x96,  // Middle-left repeat (anim 0x96)
    0x8000 | 0x97,  // Middle-right repeat (anim 0x97)
    0x8000 | 0x98,  // Bottom-left (anim 0x98)
    0x8000 | 0x99,  // Bottom-right (anim 0x99)
  ];
  ```

  The 8-entry layout matches the conveyor placement pattern: [top-L, top-R, mid-L, mid-R, mid-L, mid-R, bot-L, bot-R]. The middle rows repeat (entries 2-3 and 4-5 are the same) because placeConveyor() uses `data[(k % 2 + 1) * 2 + hh % 2]` for interior rows, alternating between entries 2-3 and 4-5.

  Do NOT modify CONV_RIGHT_DATA or any other data arrays. Do NOT modify AnimationDefinitions.ts. Do NOT modify placeConveyor() logic.
  </action>
  <verify>
  Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify the array still has exactly 8 entries. Grep for `CONV_DOWN_DATA` to confirm it uses animated encoding and is still imported correctly in MapCanvas.tsx and documentsSlice.ts.
  </verify>
  <done>CONV_DOWN_DATA uses animated tile encoding (0x8000 | 0x94 through 0x8000 | 0x99) so downward conveyors will animate through 8 frames at speed 2 (matching horizontal conveyor speed).</done>
</task>

<task type="auto">
  <name>Task 2: Add farplane toggle with toolbar button and session persistence</name>
  <files>
    src/core/editor/slices/globalSlice.ts
    src/core/canvas/CanvasEngine.ts
    src/components/ToolBar/ToolBar.tsx
  </files>
  <action>
  **Step A: Add showFarplane state to GlobalSlice** (globalSlice.ts)

  1. Add `showFarplane: boolean;` to the GlobalSlice interface, after the `showGrid` field (around line 38).
  2. Add `toggleFarplane: () => void;` to the actions section of the GlobalSlice interface, after `toggleGrid` (around line 91).
  3. In createGlobalSlice, add initial state: `showFarplane: localStorage.getItem('showFarplane') === 'true',` after the `showGrid: false,` line (around line 152). Default is false (off).
  4. Add the toggle action after `toggleGrid`:
     ```typescript
     toggleFarplane: () => set((state) => {
       const newValue = !state.showFarplane;
       localStorage.setItem('showFarplane', String(newValue));
       return { showFarplane: newValue };
     }),
     ```

  Follow the exact showGrid pattern. Use localStorage for persistence. Default to false.

  **Step B: Add farplane rendering to CanvasEngine** (CanvasEngine.ts)

  1. In `renderTile()`, modify the last `else` branch (line 150-153, the "no tileset loaded" fallback). When `showFarplane` is true and the tile is DEFAULT_TILE (280), render it as black (`#000000`) instead of gray. This represents the space/farplane background color. For non-280 tiles, keep the existing hsl fallback.

  Change the current fallback block:
  ```typescript
  } else {
    ctx.fillStyle = tile === 280 ? '#b0b0b0' : `hsl(${(tile * 7) % 360}, 50%, 40%)`;
    ctx.fillRect(destX, destY, destSize, destSize);
  }
  ```
  To:
  ```typescript
  } else {
    const showFarplane = useEditorStore.getState().showFarplane;
    ctx.fillStyle = tile === 280
      ? (showFarplane ? '#000000' : '#b0b0b0')
      : `hsl(${(tile * 7) % 360}, 50%, 40%)`;
    ctx.fillRect(destX, destY, destSize, destSize);
  }
  ```

  2. Also add farplane rendering for tile 280 when tileset IS loaded. In the `else if (this.tilesetImage)` branch (line 146-149), add a check: if `showFarplane` is enabled and the tile is 280 (DEFAULT_TILE), render it as black instead of drawing from the tileset. This makes space tiles show the farplane color on the editing canvas.

  Change:
  ```typescript
  } else if (this.tilesetImage) {
    const srcX = (tile % TILES_PER_ROW) * TILE_SIZE;
    const srcY = Math.floor(tile / TILES_PER_ROW) * TILE_SIZE;
    ctx.drawImage(this.tilesetImage, srcX, srcY, TILE_SIZE, TILE_SIZE, destX, destY, destSize, destSize);
  ```
  To:
  ```typescript
  } else if (this.tilesetImage) {
    if (tile === 280 && useEditorStore.getState().showFarplane) {
      ctx.fillStyle = '#000000';
      ctx.fillRect(destX, destY, destSize, destSize);
    } else {
      const srcX = (tile % TILES_PER_ROW) * TILE_SIZE;
      const srcY = Math.floor(tile / TILES_PER_ROW) * TILE_SIZE;
      ctx.drawImage(this.tilesetImage, srcX, srcY, TILE_SIZE, TILE_SIZE, destX, destY, destSize, destSize);
    }
  ```

  3. Add a Zustand subscription in `setupSubscriptions()` to trigger a full buffer rebuild when `showFarplane` changes. Add after the animation subscription (around line 448):

  ```typescript
  // Subscription 4: Farplane toggle (full rebuild needed since it changes tile rendering)
  const unsubFarplane = useEditorStore.subscribe((state, prevState) => {
    if (state.showFarplane !== prevState.showFarplane) {
      // Force full rebuild by clearing prevTiles
      this.prevTiles = null;
      if (!this.screenCtx) return;
      const map = this.getMap(state);
      const vp = this.getViewport(state);
      if (!map) return;
      this.drawMapLayer(map, vp, this.animationFrame);
    }
  });
  this.unsubscribers.push(unsubFarplane);
  ```

  This ensures the entire buffer is re-rendered when the toggle changes, since every tile 280 on the map needs to switch between gray/tileset and black.

  **Step C: Add farplane toggle button to ToolBar** (ToolBar.tsx)

  1. Add `LuEye, LuEyeOff` to the react-icons/lu import (line 13-21).
  2. In the component, extract `showFarplane` from the existing `useShallow` selector (line 119-126):
     ```typescript
     const { currentTool, showGrid, showFarplane, map, gameObjectToolState } = useEditorStore(
       useShallow((state) => ({
         currentTool: state.currentTool,
         showGrid: state.showGrid,
         showFarplane: state.showFarplane,
         map: state.map,
         gameObjectToolState: state.gameObjectToolState
       }))
     );
     ```
  3. Extract `toggleFarplane` action: `const toggleFarplane = useEditorStore((state) => state.toggleFarplane);` (near line 150, after `toggleGrid`).
  4. Add the farplane toggle button in the JSX, immediately AFTER the grid settings wrapper closing `</div>` (after line 708) and BEFORE the settings button (line 710):
     ```tsx
     <button
       className={`toolbar-button ${showFarplane ? 'active' : ''}`}
       onClick={toggleFarplane}
       title="Toggle farplane background"
     >
       {showFarplane ? <LuEye size={16} /> : <LuEyeOff size={16} />}
     </button>
     ```

  Do NOT add a keyboard shortcut for the farplane toggle. Do NOT add a dropdown or settings panel for it. Simple toggle button only.
  </action>
  <verify>
  Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify:
  1. globalSlice.ts has `showFarplane` in both interface and implementation, with localStorage persistence in toggle action
  2. CanvasEngine.ts has farplane conditional in both the tileset-loaded and no-tileset branches of renderTile, plus a subscription for full rebuild on toggle
  3. ToolBar.tsx imports LuEye/LuEyeOff, extracts showFarplane and toggleFarplane, renders toggle button near grid toggle
  </verify>
  <done>
  Farplane toggle button appears in toolbar next to grid toggle. Clicking it toggles black background for tile-280 (space) tiles on the editing canvas. State persists in localStorage across app restarts and persists within session across tool switches and viewport changes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` â€” zero TypeScript errors
2. CONV_DOWN_DATA contains `0x8000 | 0x94` through `0x8000 | 0x99` (animated encoding)
3. globalSlice.ts exports `showFarplane` boolean and `toggleFarplane` action with localStorage persistence
4. CanvasEngine.ts conditionally renders tile 280 as black when showFarplane is true (both tileset-loaded and no-tileset paths)
5. CanvasEngine.ts has subscription to rebuild buffer when showFarplane changes
6. ToolBar.tsx has farplane toggle button with LuEye/LuEyeOff icon near grid toggle
</verification>

<success_criteria>
- Downward conveyor tiles animate through 8 frames (matching horizontal conveyor speed and pattern)
- Toolbar shows farplane toggle button (eye icon) next to grid toggle
- Clicking farplane toggle renders tile-280 (space) tiles as black instead of gray/tileset texture
- Farplane state persists across tool switches, viewport changes, and app restarts via localStorage
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/69-conveyor-fix-farplane-toggle/69-01-SUMMARY.md`
</output>
