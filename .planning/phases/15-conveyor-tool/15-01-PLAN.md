---
phase: 15-conveyor-tool
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ToolBar/ToolBar.tsx
  - src/components/ToolBar/ToolBar.css
  - src/components/GameObjectToolPanel/GameObjectToolPanel.tsx
autonomous: true

must_haves:
  truths:
    - "CONVEYOR tool button appears in toolbar with icon and keyboard shortcut C"
    - "Clicking a tool button with variants opens a visual dropdown showing available variants"
    - "Selecting a variant from dropdown activates the tool with that variant and closes dropdown"
    - "Clicking outside the dropdown closes it without changing anything"
    - "SPAWN dropdown shows 3 spawn types per team, SWITCH shows switch types, BUNKER shows direction+style, BRIDGE shows H/V, CONVEYOR shows H/V"
  artifacts:
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "CONVEYOR button + variant dropdown for all game object tools with variants"
      contains: "CONVEYOR"
    - path: "src/components/ToolBar/ToolBar.css"
      provides: "Dropdown styling matching Win98 aesthetic"
      contains: "toolbar-dropdown"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "EditorState"
      via: "setTool, setConveyorDirection, setSpawnType, setSwitchType, setBunkerSettings, setBridgeDirection"
      pattern: "set(ConveyorDirection|SpawnType|SwitchType|BunkerSettings|BridgeDirection)"
---

<objective>
Add CONVEYOR tool button to the toolbar and implement a variant dropdown pattern for ALL game object tools that have variants (SPAWN, SWITCH, BUNKER, BRIDGE, CONVEYOR, HOLDING_PEN). When the user clicks a tool button that has variants, a visual dropdown appears below the button showing the available options. Selecting a variant closes the dropdown and activates the tool with that setting.

Purpose: This is the primary UX for CONV-01 and CONV-02, and retrofits all game object tools to use a consistent dropdown pattern instead of requiring the separate GameObjectToolPanel for variant selection.

Output: ToolBar.tsx with CONVEYOR button, variant dropdown logic, and dropdown CSS styling.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-conveyor-tool/15-CONTEXT.md
@.planning/phases/15-conveyor-tool/15-RESEARCH.md
@src/components/ToolBar/ToolBar.tsx
@src/components/ToolBar/ToolBar.css
@src/core/map/types.ts (ToolType enum, GameObjectToolState)
@src/core/editor/EditorState.ts (store actions: setConveyorDirection, setSpawnType, etc.)
@src/components/GameObjectToolPanel/GameObjectToolPanel.tsx (existing variant UI to reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CONVEYOR to toolbar and implement variant dropdown</name>
  <files>src/components/ToolBar/ToolBar.tsx, src/components/ToolBar/ToolBar.css</files>
  <action>
**Step 1: Add CONVEYOR to toolbar button arrays**

In `ToolBar.tsx`, add CONVEYOR to the `gameObjectRectTools` array:
```ts
{ tool: ToolType.CONVEYOR, label: 'Conv', icon: '\u21C4', shortcut: 'C' },
```
Place it after BRIDGE in the `gameObjectRectTools` array. The icon `\u21C4` is the left-right arrows Unicode character. The shortcut C is not currently used by any other tool.

The `allToolsWithShortcuts` spread already includes `gameObjectRectTools` so the C shortcut will work automatically.

**Step 2: Implement variant dropdown state and logic**

Add React state to ToolBar component:
- `openDropdown: ToolType | null` -- which tool's dropdown is currently open (null = none)

Define a data structure mapping tool types to their variant options:
```ts
interface ToolVariant {
  label: string;
  value: number;    // the variant value to set
  value2?: number;  // optional second value (e.g., bunkerStyle)
}

interface ToolVariantConfig {
  tool: ToolType;
  settingName: string;      // describes what's being set
  variants: ToolVariant[];
  setter: (v: number, v2?: number) => void;  // will be bound to store actions
}
```

Build variant configs for these tools:
- **SPAWN**: 3 types (Type 1, Type 2, Type 3) -- calls `setSpawnType(value)`
- **SWITCH**: dynamic based on `switchData.length` -- calls `setSwitchType(value)`
- **BUNKER**: 4 directions x 2 styles = 8 combos, OR separate direction (N/E/S/W) + style (Standard/Industrial) dropdowns -- calls `setBunkerSettings(dir, style)`. Simplest: show 4 directions, keep style as secondary option. Show dropdown items: "North", "East", "South", "West" for direction. Add a separate row or sub-section for style toggle.
  - Actually, to keep it simple and match the existing GameObjectToolPanel pattern: show direction options (North, East, South, West) in dropdown. The style is less commonly changed, so keep it accessible but secondary. Show direction as main dropdown items. Add a small "(Std)" / "(Ind)" toggle in the dropdown footer.
- **HOLDING_PEN**: 2 types (Static, Animated) -- calls `setHoldingPenType(value)`
- **BRIDGE**: 2 directions (Horizontal, Vertical) -- calls `setBridgeDirection(value)`
- **CONVEYOR**: 2 directions (Horizontal, Vertical) -- calls `setConveyorDirection(value)`

Import needed store actions: `setSpawnType, setSwitchType, setBunkerSettings, setHoldingPenType, setBridgeDirection, setConveyorDirection, gameObjectToolState` from useEditorStore.

Also import `switchData` from `@core/map/GameObjectData`.

**Step 3: Modify toolbar button rendering for variant tools**

For tool buttons that have variant configs, modify the click handler:
- If the tool is already active AND this click is on the same tool button, toggle the dropdown (open/close)
- If the tool is NOT active, activate it AND open the dropdown
- If clicking a DIFFERENT tool, close any open dropdown and activate the new tool

```tsx
const handleToolClick = (tool: ToolType) => {
  if (variantTools.has(tool)) {
    if (currentTool === tool) {
      // Toggle dropdown for already-active tool
      setOpenDropdown(openDropdown === tool ? null : tool);
    } else {
      // Switch to this tool and open its dropdown
      setTool(tool);
      setOpenDropdown(tool);
    }
  } else {
    setTool(tool);
    setOpenDropdown(null);
  }
};
```

Add a small dropdown indicator to variant tool buttons (a tiny triangle/arrow below the icon indicating it has options). Use a CSS class `has-variants` on toolbar buttons that have variants.

**Step 4: Render dropdown panel**

When `openDropdown` is set, render a positioned dropdown panel below the active tool button. Use a `ref` on each tool button to position the dropdown.

Actually, simpler approach: use `position: relative` on the toolbar button wrapper and `position: absolute` on the dropdown. Wrap each variant tool button in a div with relative positioning:

```tsx
<div className="toolbar-button-wrapper" style={{ position: 'relative' }}>
  <button className={`toolbar-button ${active} ${hasVariants}`} onClick={...}>
    ...
  </button>
  {openDropdown === tool.tool && (
    <div className="toolbar-dropdown">
      {variants.map(v => (
        <button key={v.value} className="toolbar-dropdown-item" onClick={(e) => {
          e.stopPropagation();
          handleVariantSelect(tool.tool, v.value, v.value2);
        }}>
          {v.label}
        </button>
      ))}
    </div>
  )}
</div>
```

The variant select handler should:
1. Call the appropriate setter (setSpawnType, etc.)
2. Ensure the tool is active (setTool if not already)
3. Close the dropdown

**Step 5: Close dropdown on outside click**

Add a useEffect that listens for mousedown events on the document. If the click target is NOT inside the dropdown or the toolbar button that owns it, close the dropdown:

```tsx
useEffect(() => {
  if (!openDropdown) return;
  const handleClickOutside = (e: MouseEvent) => {
    // Close dropdown if click is outside
    const target = e.target as HTMLElement;
    if (!target.closest('.toolbar-button-wrapper')) {
      setOpenDropdown(null);
    }
  };
  document.addEventListener('mousedown', handleClickOutside);
  return () => document.removeEventListener('mousedown', handleClickOutside);
}, [openDropdown]);
```

**Step 6: Show active variant indicator on button**

For variant tools, show a small text indicator of the current selection below the tool label. For example, CONVEYOR might show "H" or "V" to indicate current direction. Keep it minimal -- a tiny secondary label.

Use `gameObjectToolState` to read current values. Show the current variant label as a subtitle on the button. For example:
- SPAWN: shows "T1", "T2", "T3"
- BRIDGE: shows "H", "V"
- CONVEYOR: shows "H", "V"
- BUNKER: shows "N", "E", "S", "W"

This is optional -- only add if it doesn't clutter the toolbar. A simpler approach: just show the dropdown arrow indicator and rely on the dropdown itself for feedback.

**Step 7: Style the dropdown in ToolBar.css**

Add Win98-themed dropdown styling:
```css
.toolbar-button-wrapper {
  position: relative;
}

.toolbar-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 1000;
  min-width: 80px;
  background: var(--win98-ButtonFace);
  border-top: 1px solid var(--win98-ButtonHighlight);
  border-left: 1px solid var(--win98-ButtonHighlight);
  border-right: 1px solid var(--win98-ButtonDkShadow);
  border-bottom: 1px solid var(--win98-ButtonDkShadow);
  padding: 2px;
  box-shadow: 1px 1px 0 var(--win98-ButtonDkShadow);
}

.toolbar-dropdown-item {
  display: block;
  width: 100%;
  padding: 2px 8px;
  font-size: 10px;
  font-family: inherit;
  text-align: left;
  background: transparent;
  border: 1px solid transparent;
  color: var(--win98-ButtonText);
  cursor: pointer;
  white-space: nowrap;
}

.toolbar-dropdown-item:hover {
  background: var(--win98-Highlight);
  color: var(--win98-HighlightText);
}

.toolbar-dropdown-item.selected {
  font-weight: bold;
}

/* Small triangle indicator for variant tools */
.toolbar-button.has-variants .toolbar-label::after {
  content: '';
  display: inline-block;
  width: 0;
  height: 0;
  margin-left: 2px;
  border-left: 3px solid transparent;
  border-right: 3px solid transparent;
  border-top: 3px solid var(--win98-ButtonText);
  vertical-align: middle;
}
```

**Important implementation notes:**
- Call `e.stopPropagation()` on dropdown item clicks to prevent the event from bubbling to the toolbar button click handler
- The dropdown should appear below the button, aligned to the left edge
- Mark the currently selected variant with the `.selected` class
- Do NOT remove the existing GameObjectToolPanel -- it still shows team selector, warp settings, and custom.dat warnings. The dropdown replaces only the variant/direction selectors that were in GameObjectToolPanel. The GameObjectToolPanel should still render for TEAM_TOOLS (flag, pole, spawn, holding_pen) to show the team selector, and for WARP to show source/dest/style. But the direction/type selects for SPAWN, SWITCH, BUNKER, BRIDGE, CONVEYOR, HOLDING_PEN should now be controlled via the toolbar dropdown instead. Update GameObjectToolPanel to remove duplicate controls that are now in the dropdown (spawn type, switch type, bunker dir/style, holding pen type, bridge dir, conveyor dir selects). Keep team selector, warp settings, and custom.dat warning.

Wait -- that would also modify GameObjectToolPanel. Let me reconsider. The CONTEXT says the dropdown should be the primary way to select variants. The GameObjectToolPanel already exists with these selects. To avoid conflict, the simplest approach:

**Updated approach:** Add the dropdown to toolbar AND remove the duplicate select controls from GameObjectToolPanel in the same task. This means also modifying:
- `src/components/GameObjectToolPanel/GameObjectToolPanel.tsx` -- remove spawn type, switch type, bunker settings, holding pen type, bridge direction, conveyor direction selects. Keep: team selector for TEAM_TOOLS, warp settings, custom.dat warning.

This keeps the UX clean without duplicate controls.
  </action>
  <verify>
1. Run `npm run typecheck` -- no TypeScript errors
2. Run `npm run electron:dev` -- app launches
3. Verify CONVEYOR button appears in toolbar between BRIDGE and wall draw tools with shortcut C
4. Press C key -- CONVEYOR tool activates
5. Click CONVEYOR button -- dropdown appears with "Horizontal" and "Vertical" options
6. Click SPAWN button -- dropdown appears with type options
7. Click outside dropdown -- it closes
8. Select a variant -- dropdown closes and tool activates with that variant
  </verify>
  <done>
CONVEYOR tool accessible via toolbar button with icon and keyboard shortcut C. All game object tools with variants show dropdown on click. Selecting variant closes dropdown and activates tool. GameObjectToolPanel no longer shows duplicate direction/type selects (keeps team selector, warp settings, custom.dat warning).
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with no errors
2. App launches with `npm run electron:dev`
3. CONVEYOR button visible in toolbar with correct shortcut
4. Variant dropdowns work for SPAWN, SWITCH, BUNKER, HOLDING_PEN, BRIDGE, CONVEYOR
5. GameObjectToolPanel still shows team selector for flag/pole/spawn/holding_pen tools
6. GameObjectToolPanel still shows warp settings for warp tool
7. No duplicate variant controls between toolbar dropdown and GameObjectToolPanel
</verification>

<success_criteria>
- CONVEYOR button in toolbar with shortcut C (CONV-01)
- All variant tools show dropdown on click with correct options
- Dropdown closes on outside click or variant selection
- No regression in existing tool functionality
</success_criteria>

<output>
After completion, create `.planning/phases/15-conveyor-tool/15-01-SUMMARY.md`
</output>
