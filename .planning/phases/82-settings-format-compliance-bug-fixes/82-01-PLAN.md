---
phase: 82-settings-format-compliance-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/GameSettings.ts
  - src/components/MapSettingsDialog/MapSettingsDialog.tsx
autonomous: true

must_haves:
  truths:
    - "All 54 game settings in GAME_SETTINGS match AC_Setting_Info_25.txt for key names, ranges, and defaults"
    - "Serialized description contains Format=1.1 positioned after all non-flagger settings and before all flagger settings"
    - "Maps without Format=1.1 (pre-v1.0.4) load correctly without errors"
    - "Settings serialization order is: non-flagger (sorted) -> Format=1.1 -> flagger (sorted) -> Author -> unrecognized"
  artifacts:
    - path: "src/core/map/GameSettings.ts"
      provides: "Validated game settings with correct defaults, ranges, and count"
      contains: "GAME_SETTINGS"
    - path: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      provides: "Correct serialization ordering and Format=1.1 placement"
      contains: "serializeSettings"
  key_links:
    - from: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      to: "src/core/map/GameSettings.ts"
      via: "GAME_SETTINGS import for serialization/parsing"
      pattern: "GAME_SETTINGS\\.filter"
---

<objective>
Validate all game settings against the AC_Setting_Info_25.txt reference and fix serialization ordering for Format=1.1 compliance.

Purpose: Ensures the settings data layer is correct (right defaults, ranges, count) and that saved maps produce the correct Format=1.1 description string ordering that AC expects for turret customization to work.

Output: Corrected GameSettings.ts with validated defaults/ranges and MapSettingsDialog.tsx with correct serialization order.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/82-settings-format-compliance-bug-fixes/82-RESEARCH.md
@src/core/map/GameSettings.ts
@src/components/MapSettingsDialog/MapSettingsDialog.tsx
@AC_Setting_Info_25.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate and fix GameSettings.ts against AC reference</name>
  <files>src/core/map/GameSettings.ts</files>
  <action>
Cross-reference every setting in GAME_SETTINGS against AC_Setting_Info_25.txt and fix discrepancies.

**Known discrepancies to fix:**
1. `RepairRate` default: currently 0, AC_Setting_Info_25.txt says 2 -> change default to 2
2. `FRepairRate` default: currently 0, should match RepairRate default of 2 -> change default to 2
3. `ElectionTime` default: currently 14, AC_Setting_Info_25.txt says 50 -> change default to 50
4. `DominationWin` default: currently 100, AC_Setting_Info_25.txt says 9999999 -> change default to 9999999

**Settings count verification:**
Current count is 53. The AC reference lists these settings that are in description fields:
- 25 non-flagger weapon/game settings
- 12 flagger (F-prefixed) settings
- 7 DHT settings
- 4 game rule settings (ElectionTime, SwitchWin, DominationWin, DeathMatchWin)
- 5 toggle settings (DisableSwitchSound, InvisibleMap, FogOfWar, FlagInPlay, Widescreen)

That's 53 total. The "54" in requirements appears to be a documentation error. Verify the count is 53, add a comment confirming the count, and note that HoldingTime is a header field (not an extended setting) which accounts for the common miscount.

**Also verify these ranges match AC_Setting_Info_25.txt:**
- LaserDamage: 0-225, default 27 (correct)
- MissileDamage: 0-225, default 102 (correct)
- BouncyDamage: 0-225, default 48 (correct)
- NadeDamage: 0-225, default 21 (correct)
- TurretHealth: 0-224, default 224 (correct)
- HealthBonus: 0-224, default 60 (correct)
- DHT ranges: -999999 to 999999 (correct)
- DHT_minimum: 0-255 (correct)
- DHT_maximum: 0-255 (correct)

Add a `SETTINGS_COUNT` export constant set to `GAME_SETTINGS.length` with a comment explaining the count.

Update the dialog's reference to "54 settings" if it appears anywhere.
  </action>
  <verify>
Run `npm run typecheck` to ensure no type errors. Manually verify the count: `node -e "const gs = require('./src/core/map/GameSettings.ts'); console.log(gs.GAME_SETTINGS.length)"` (or equivalent grep count of key: entries equals 53).
  </verify>
  <done>
GameSettings.ts has correct defaults (RepairRate=2, FRepairRate=2, ElectionTime=50, DominationWin=9999999), all ranges match AC_Setting_Info_25.txt, and SETTINGS_COUNT export confirms the count.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix serialization ordering and Author/unrecognized handling</name>
  <files>src/components/MapSettingsDialog/MapSettingsDialog.tsx</files>
  <action>
Audit and fix the serialization pipeline in MapSettingsDialog.tsx:

**1. Verify serializeSettings ordering (lines 15-35):**
Current code: `[...nonFlaggerPairs, 'Format=1.1', ...flaggerPairs]`
This is CORRECT per SFMT-02. Verify the sort is alphabetical within each group (it uses `localeCompare` which is correct). No change needed here unless the sort mutates the original GAME_SETTINGS array - if so, use `.slice().sort()` instead of `.sort()` to avoid mutation.

IMPORTANT: Lines 21-22 call `.sort()` directly on the filtered arrays. While `Array.filter()` returns a new array, calling `.sort()` on GAME_SETTINGS entries is fine since we're sorting the filtered copy. However, confirm this doesn't cause issues with subsequent calls. Add `.slice()` before `.sort()` for defensive coding: `nonFlaggerSettings.slice().sort(...)`.

**2. Verify buildDescription ordering (lines 83-100):**
Current order: serialized settings (which includes Format=1.1), then Author, then unrecognized. This matches SFMT-02 requirement: non-flagger -> Format=1.1 -> flagger -> Author -> unrecognized. Confirm this is correct.

**3. Verify parseSettings backward compatibility (lines 43-73):**
Line 71 filters out `Format=X.X` patterns from unrecognized. This ensures pre-v1.0.4 maps (no Format=1.1) load fine, and maps with Format=1.1 don't duplicate it on re-save. Confirm this regex `^Format=[\d.]+$` correctly matches Format=1.1. It does.

**4. Fix the ElectionTime default reference in the dialog open() handler:**
Line 428 uses `default: 14` for ElectionTime inline setting definition. After Task 1 changes the default to 50, this inline definition will be stale. Update line 428 to use `default: 50` to match.

Similarly check all inline setting definitions in the JSX that duplicate defaults from GameSettings.ts. These should ideally reference the GAME_SETTINGS array rather than hardcoding, but at minimum update the hardcoded values to match the corrected defaults:
- ElectionTime default: 14 -> 50 (line 425-429)
- DominationWin default: 100 -> 9999999 (lines 441-445)

Also update the corresponding `onReset` callbacks and `?? fallback` values that reference these defaults.

**5. Add defensive .slice() before .sort() in serializeSettings:**
Change lines 21-22 from:
```typescript
const sortedNonFlagger = nonFlaggerSettings.sort(...)
const sortedFlagger = flaggerSettings.sort(...)
```
to:
```typescript
const sortedNonFlagger = [...nonFlaggerSettings].sort(...)
const sortedFlagger = [...flaggerSettings].sort(...)
```
This prevents any potential mutation of filter results across multiple calls.
  </action>
  <verify>
Run `npm run typecheck`. Then run `npm run electron:dev`, open Settings dialog on a new map, click Apply, and verify description field in Zustand store contains correct ordering: non-flagger settings alphabetically, then Format=1.1, then flagger settings alphabetically, then Author.
  </verify>
  <done>
Serialization produces correct SFMT-02 ordering, inline defaults match GameSettings.ts, and .sort() calls are non-mutating. Backward compatibility for pre-v1.0.4 maps preserved (parseSettings filters Format= from unrecognized).
  </done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes with no errors
- GAME_SETTINGS array has 53 entries (verified by grep count of `key:` patterns)
- RepairRate default is 2, FRepairRate default is 2, ElectionTime default is 50, DominationWin default is 9999999
- serializeSettings output format: `BouncyDamage=48, ..., Widescreen=0, Format=1.1, FBouncyDamage=48, ...`
- Format=1.1 appears exactly once in serialized output, between last non-flagger and first flagger setting
- Inline defaults in MapSettingsDialog.tsx match corrected GameSettings.ts defaults
</verification>

<success_criteria>
1. All settings defaults and ranges match AC_Setting_Info_25.txt reference document
2. Serialization order matches SFMT-02: non-flagger (sorted) -> Format=1.1 -> flagger (sorted) -> Author -> unrecognized
3. No type errors in typecheck
4. Pre-v1.0.4 maps without Format=1.1 continue to load correctly
</success_criteria>

<output>
After completion, create `.planning/phases/82-settings-format-compliance-bug-fixes/82-01-SUMMARY.md`
</output>
