---
phase: 71-wall-type-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ToolBar/ToolBar.tsx
  - src/components/ToolBar/ToolBar.css
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can select any of the 15 wall types from a dropdown on each wall tool button"
    - "Dropdown shows a visual preview (3-tile horizontal wall segment) for each wall type"
    - "Selected wall type is used by wall, wall pencil, and wall rect tools when placing tiles"
    - "Wall tool icons are visually distinct (wall=brick, pencil=pencil, rect=rectangle)"
  artifacts:
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Wall type variant configs with canvas preview rendering"
      contains: "WALL_TYPE_NAMES"
    - path: "src/components/ToolBar/ToolBar.css"
      provides: "Styling for wall preview canvases in dropdown items"
      contains: "wall-preview"
    - path: "src/App.tsx"
      provides: "tilesetImage prop passed to ToolBar"
      contains: "tilesetImage={tilesetImage}"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/ToolBar/ToolBar.tsx"
      via: "tilesetImage prop"
      pattern: "tilesetImage=\\{tilesetImage\\}"
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/map/WallSystem.ts"
      via: "getWallTile() for preview rendering and WALL_TYPE_NAMES for labels"
      pattern: "wallSystem\\.getWallTile|WALL_TYPE_NAMES"
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "wallType state + setWallType action"
      pattern: "wallType|setWallType"
---

<objective>
Add wall type selection dropdown with visual tile previews to all three wall tool buttons, and make each wall tool icon visually distinct.

Purpose: Users currently have a text-only wall type selector hidden in the TilePalette that only shows for the WALL tool. This makes wall type selection undiscoverable for WALL_PENCIL and WALL_RECT. Moving selection to the toolbar with visual previews makes it accessible from any wall tool and shows what each wall type looks like before selection.

Output: Wall tool buttons in toolbar show visual preview dropdown of all 15 wall types; each wall tool has a distinct icon.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/ToolBar/ToolBar.tsx
@src/components/ToolBar/ToolBar.css
@src/core/map/WallSystem.ts
@src/core/editor/slices/globalSlice.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tilesetImage prop to ToolBar and wall type variant configs with distinct icons</name>
  <files>src/App.tsx, src/components/ToolBar/ToolBar.tsx</files>
  <action>
**In src/App.tsx:**
- Pass `tilesetImage` as a prop to the `<ToolBar>` component: `<ToolBar tilesetImage={tilesetImage} onNewMap={...} ...>`

**In src/components/ToolBar/ToolBar.tsx:**

1. **Update Props interface** to include `tilesetImage: HTMLImageElement | null`

2. **Add imports:**
   - Import `wallSystem` and `WALL_TYPE_NAMES` from `@core/map/WallSystem`
   - Import `TILE_SIZE` already imported from `@core/map`
   - `LuPencil` and `LuRectangleHorizontal` are already imported — reuse them

3. **Change wall tool icons** in the `toolIcons` record:
   - `wall`: keep `LuBrickWall` (line tool)
   - `wallpencil`: change from `LuBrickWall` to `LuPencil` (pencil tool)
   - `wallrect`: change from `LuBrickWall` to `LuRectangleHorizontal` (rect tool)

4. **Add `wallType` and `setWallType` to the component:**
   - Subscribe: `const wallType = useEditorStore((state) => state.wallType);`
   - Get setter: `const setWallType = useEditorStore((state) => state.setWallType);`

5. **Build wall type variants array** (shared by all 3 wall tools):
   ```typescript
   const wallVariants: ToolVariant[] = WALL_TYPE_NAMES.map((name, index) => ({
     label: name,
     value: index,
   }));
   ```

6. **Add three variant configs** to `variantConfigs` array — one for each wall tool:
   ```typescript
   {
     tool: ToolType.WALL,
     settingName: 'Type',
     getCurrentValue: () => wallType,
     variants: wallVariants,
     setter: (type) => setWallType(type)
   },
   {
     tool: ToolType.WALL_PENCIL,
     settingName: 'Type',
     getCurrentValue: () => wallType,
     variants: wallVariants,
     setter: (type) => setWallType(type)
   },
   {
     tool: ToolType.WALL_RECT,
     settingName: 'Type',
     getCurrentValue: () => wallType,
     variants: wallVariants,
     setter: (type) => setWallType(type)
   },
   ```
   All three share the same wallType state and setter — selecting a wall type on any tool affects all wall tools.

This task wires up the dropdown mechanics. Without Task 2's preview rendering, the dropdown will show text-only labels (which is a correct fallback).
  </action>
  <verify>Run `npm run typecheck` — no type errors. Open the app and click any wall tool button — dropdown should appear showing 15 wall type names. Selecting a type should update all wall tools. Wall pencil icon should be a pencil, wall rect should be a rectangle.</verify>
  <done>All 3 wall tools have variant dropdowns with 15 wall type entries. Icons are visually distinct (brick, pencil, rectangle). Wall type selection is shared across all 3 tools.</done>
</task>

<task type="auto">
  <name>Task 2: Add canvas-based wall tile previews to dropdown items</name>
  <files>src/components/ToolBar/ToolBar.tsx, src/components/ToolBar/ToolBar.css</files>
  <action>
**In src/components/ToolBar/ToolBar.tsx:**

1. **Add a `useMemo` import** if not already present (it is not — add to the React import line).

2. **Create a memoized wall preview map** using `useMemo`. This generates a `Map<number, string>` mapping wall type index to a data URL of a 3-tile horizontal wall segment preview:

   ```typescript
   const wallPreviewUrls = useMemo(() => {
     const map = new Map<number, string>();
     if (!tilesetImage) return map;

     const TILES_PER_ROW = 40;
     for (let type = 0; type < WALL_TYPE_NAMES.length; type++) {
       const canvas = document.createElement('canvas');
       canvas.width = 3 * TILE_SIZE;
       canvas.height = TILE_SIZE;
       const ctx = canvas.getContext('2d');
       if (!ctx) continue;
       ctx.imageSmoothingEnabled = false;

       // 3-tile horizontal segment: left end, middle, right end
       // Connection bitmask: LEFT=0b0010, RIGHT=0b0100
       const leftTile = wallSystem.getWallTile(type, 0b0100);   // right connection only
       const middleTile = wallSystem.getWallTile(type, 0b0110); // left + right
       const rightTile = wallSystem.getWallTile(type, 0b0010);  // left connection only

       [leftTile, middleTile, rightTile].forEach((tile, idx) => {
         const srcX = (tile % TILES_PER_ROW) * TILE_SIZE;
         const srcY = Math.floor(tile / TILES_PER_ROW) * TILE_SIZE;
         ctx.drawImage(
           tilesetImage,
           srcX, srcY, TILE_SIZE, TILE_SIZE,
           idx * TILE_SIZE, 0, TILE_SIZE, TILE_SIZE
         );
       });

       map.set(type, canvas.toDataURL());
     }
     return map;
   }, [tilesetImage]);
   ```

   Key points:
   - Memoized on `tilesetImage` — regenerates only when tileset changes
   - Uses data URLs (not live canvas elements) so React can render `<img>` tags
   - Connection states: 0b0100 (right), 0b0110 (left+right), 0b0010 (left) produce a clean horizontal segment

3. **Modify the `renderToolButton` function** to detect wall tool dropdown items and render preview images. In the dropdown rendering section where `config.variants.map(v => ...)` is called, check if the tool is a wall tool (WALL, WALL_PENCIL, or WALL_RECT) and render the preview image before the label:

   Inside the dropdown item button, replace the bare `{v.label}` with:
   ```tsx
   {(tool.tool === ToolType.WALL || tool.tool === ToolType.WALL_PENCIL || tool.tool === ToolType.WALL_RECT) && wallPreviewUrls.get(v.value) && (
     <img
       src={wallPreviewUrls.get(v.value)}
       className="wall-preview"
       alt={v.label}
       draggable={false}
     />
   )}
   <span className="variant-label">{v.label}</span>
   ```

   Also add the `wall-dropdown` class to the dropdown container div when rendering wall tool variants, to enable wider styling:
   ```tsx
   <div className={`toolbar-dropdown ${isWallTool ? 'wall-dropdown' : ''}`}>
   ```
   Where `isWallTool` is `tool.tool === ToolType.WALL || tool.tool === ToolType.WALL_PENCIL || tool.tool === ToolType.WALL_RECT`.

**In src/components/ToolBar/ToolBar.css:**

4. **Add wall preview styles:**
   ```css
   /* Wall type preview image (3-tile horizontal segment) */
   .wall-preview {
     display: block;
     width: 48px;
     height: 16px;
     image-rendering: pixelated;
     flex-shrink: 0;
   }

   /* Wall dropdown items: horizontal layout with preview + label */
   .wall-dropdown {
     min-width: 140px;
   }

   .wall-dropdown .toolbar-dropdown-item {
     display: flex;
     align-items: center;
     gap: var(--space-1);
   }

   .variant-label {
     flex: 1;
   }
   ```

   The `.wall-preview` uses `image-rendering: pixelated` to keep pixel art sharp at native 48x16 size. The `.wall-dropdown` overrides `min-width` to accommodate preview + label. The flex layout puts preview image on the left, label on the right.
  </action>
  <verify>Run `npm run typecheck` — no type errors. Open the app, click any wall tool — dropdown should show 15 entries, each with a small 3-tile horizontal wall segment preview image on the left and the wall type name on the right. Previews should be crisp pixel art (not blurry). Selecting a wall type should close dropdown and update the active wall type for all wall tools.</verify>
  <done>Dropdown items show canvas-rendered wall tile previews. Each preview displays a 3-tile horizontal segment (left end, middle, right end) at native pixel resolution. Previews are memoized and regenerate only on tileset change.</done>
</task>

</tasks>

<verification>
1. **Visual:** Open app. Verify wall tool icons are distinct: wall=brick, wall pencil=pencil, wall rect=rectangle.
2. **Dropdown:** Click each wall tool button. Verify dropdown appears with 15 wall types, each showing a tile preview image and name.
3. **Selection:** Select "Metal" wall type from any wall tool dropdown. Switch to a different wall tool. Click to open dropdown — "Metal" should be highlighted/selected.
4. **Placement:** With "Metal" selected, use wall line tool to draw. Verify Metal wall tiles are placed. Switch to wall pencil, draw — same Metal walls. Switch to wall rect, draw — same Metal walls.
5. **Type check:** `npm run typecheck` passes with zero errors.
</verification>

<success_criteria>
- All 3 wall tools show variant dropdowns with 15 wall type entries
- Each dropdown item shows a visual tile preview (3-tile horizontal segment)
- Wall type selection is shared across all 3 wall tools
- Wall tool icons are visually distinct (brick, pencil, rectangle)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/71-wall-type-selection/71-01-SUMMARY.md`
</output>
