---
phase: 62-ruler-notepad-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/slices/globalSlice.ts
  - electron/preload.ts
  - src/utils/measurementFormatter.ts
  - src/components/RulerNotepadPanel/RulerNotepadPanel.tsx
  - src/components/RulerNotepadPanel/RulerNotepadPanel.css
  - src/components/TilesetPanel/TilesetPanel.tsx
  - src/components/RightSidebar/RightSidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Ruler notepad panel appears in freed horizontal space beside tile palette"
    - "Pinned measurements appear in notepad with type, value, and timestamp"
    - "User can add or edit text labels on measurement entries via inline input"
    - "User can delete individual entries from the notepad"
    - "User can copy all measurements to clipboard as formatted text"
    - "Empty notepad shows instructional hint about P key"
  artifacts:
    - path: "src/utils/measurementFormatter.ts"
      provides: "Shared formatMeasurement utility"
      exports: ["formatMeasurement"]
    - path: "src/components/RulerNotepadPanel/RulerNotepadPanel.tsx"
      provides: "Ruler notepad panel component"
      exports: ["RulerNotepadPanel"]
      min_lines: 60
    - path: "src/components/RulerNotepadPanel/RulerNotepadPanel.css"
      provides: "Ruler notepad panel styles"
      min_lines: 40
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "updateMeasurementLabel action and label field on pinnedMeasurements"
      contains: "updateMeasurementLabel"
    - path: "electron/preload.ts"
      provides: "writeClipboard method on electronAPI"
      contains: "writeClipboard"
  key_links:
    - from: "src/components/RulerNotepadPanel/RulerNotepadPanel.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "useEditorStore selectors for pinnedMeasurements, unpinMeasurement, updateMeasurementLabel"
      pattern: "useEditorStore.*pinnedMeasurements"
    - from: "src/components/RulerNotepadPanel/RulerNotepadPanel.tsx"
      to: "src/utils/measurementFormatter.ts"
      via: "import formatMeasurement"
      pattern: "import.*formatMeasurement.*measurementFormatter"
    - from: "src/components/RulerNotepadPanel/RulerNotepadPanel.tsx"
      to: "electron/preload.ts"
      via: "window.electronAPI.writeClipboard"
      pattern: "writeClipboard"
    - from: "src/components/TilesetPanel/TilesetPanel.tsx"
      to: "src/components/RulerNotepadPanel/RulerNotepadPanel.tsx"
      via: "import and render in tileset-freed-section"
      pattern: "RulerNotepadPanel"
    - from: "src/components/RightSidebar/RightSidebar.tsx"
      to: "src/utils/measurementFormatter.ts"
      via: "import shared formatMeasurement (replacing local copy)"
      pattern: "import.*formatMeasurement.*measurementFormatter"
---

<objective>
Create the ruler notepad panel in the freed horizontal space beside the tile palette. The panel displays pinned measurement entries with type, value, and timestamp; supports inline text label editing; allows individual entry deletion; and provides clipboard export of all measurements.

Purpose: Give users a persistent measurement log during editing sessions so they can annotate, review, and export ruler measurements without losing them.
Output: Working RulerNotepadPanel component integrated into TilesetPanel's freed section, with all CRUD operations and clipboard export.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-ruler-notepad-panel/62-RESEARCH.md
@.planning/phases/61-layout-restructure/61-01-SUMMARY.md
@src/core/editor/slices/globalSlice.ts
@src/components/TilesetPanel/TilesetPanel.tsx
@src/components/TilesetPanel/TilesetPanel.css
@src/components/RightSidebar/RightSidebar.tsx
@electron/preload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add label field to state, extract formatMeasurement utility, expose clipboard API</name>
  <files>
    src/core/editor/slices/globalSlice.ts
    electron/preload.ts
    src/utils/measurementFormatter.ts
    src/components/RightSidebar/RightSidebar.tsx
  </files>
  <action>
Three changes in this task:

**1. globalSlice.ts — Add label field and updateMeasurementLabel action:**

In the `GlobalSlice` interface:
- Add optional `label?: string` to the pinnedMeasurements array type (line 71-74), making it:
  ```
  pinnedMeasurements: Array<{
    id: string;
    measurement: NonNullable<GlobalSlice['rulerMeasurement']>;
    label?: string;
  }>;
  ```
- Add `updateMeasurementLabel: (id: string, label: string) => void;` to the actions section (after `clearAllPinnedMeasurements` around line 95).

In `createGlobalSlice`:
- Add the `updateMeasurementLabel` implementation after `clearAllPinnedMeasurements` (around line 221):
  ```
  updateMeasurementLabel: (id, label) => set((state) => ({
    pinnedMeasurements: state.pinnedMeasurements.map(p =>
      p.id === id ? { ...p, label } : p
    )
  })),
  ```

**2. electron/preload.ts — Expose clipboard.writeText:**

- Add `clipboard` to the import: `import { contextBridge, ipcRenderer, clipboard } from 'electron';`
- Add `writeClipboard: (text: string) => clipboard.writeText(text)` to the `contextBridge.exposeInMainWorld` object (after the `removeMenuActionListener` entry, around line 40).
- Add `writeClipboard: (text: string) => void;` to the `ElectronAPI` interface.

**3. src/utils/measurementFormatter.ts — Extract shared utility (NEW FILE):**

Create `src/utils/measurementFormatter.ts` with the `formatMeasurement` function extracted from RightSidebar.tsx (lines 19-34). Import `RulerMode` from `@core/editor/slices/globalSlice`. The function signature:
```typescript
import { RulerMode } from '@core/editor/slices/globalSlice';

type RulerMeasurement = {
  mode: RulerMode;
  startX: number;
  startY: number;
  endX: number;
  endY: number;
  dx?: number;
  dy?: number;
  manhattan?: number;
  euclidean?: number;
  width?: number;
  height?: number;
  tileCount?: number;
  waypoints?: Array<{ x: number; y: number }>;
  totalDistance?: number;
  centerX?: number;
  centerY?: number;
  radius?: number;
  area?: number;
};

export const formatMeasurement = (m: RulerMeasurement): string => {
  // Same logic as RightSidebar.tsx lines 20-33
};
```

**4. src/components/RightSidebar/RightSidebar.tsx — Use shared utility:**

- Remove the local `formatMeasurement` function (lines 19-34).
- Add import: `import { formatMeasurement } from '@/utils/measurementFormatter';`
- Everything else in the file stays the same.

Note: The `@/utils/*` path alias maps to `src/utils/*` via tsconfig paths (`@/*` -> `src/*`).
  </action>
  <verify>
Run `npx tsc --noEmit` — should compile without errors related to these changes. Check that:
- globalSlice.ts has `updateMeasurementLabel` in both interface and implementation
- preload.ts has `writeClipboard` in both runtime code and type interface
- measurementFormatter.ts exports `formatMeasurement`
- RightSidebar.tsx imports from the shared utility instead of defining locally
  </verify>
  <done>
- pinnedMeasurements type includes optional `label` field
- `updateMeasurementLabel` action exists in globalSlice interface and implementation
- `writeClipboard` exposed in preload.ts electronAPI and typed in ElectronAPI interface
- `formatMeasurement` extracted to src/utils/measurementFormatter.ts
- RightSidebar.tsx uses shared utility (no local formatMeasurement function)
- TypeScript compiles cleanly for these files
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RulerNotepadPanel component and styles</name>
  <files>
    src/components/RulerNotepadPanel/RulerNotepadPanel.tsx
    src/components/RulerNotepadPanel/RulerNotepadPanel.css
  </files>
  <action>
**Create src/components/RulerNotepadPanel/RulerNotepadPanel.tsx (NEW FILE):**

A React functional component that renders the measurement log panel. Structure:

1. **Imports:** React (useState), useEditorStore from `@core/editor`, formatMeasurement from `@/utils/measurementFormatter`, local CSS.

2. **State from Zustand (individual selectors for render optimization):**
   - `pinnedMeasurements` — the array of pinned measurements
   - `unpinMeasurement` — action to delete an entry
   - `updateMeasurementLabel` — action to update a label

3. **Local state:**
   - `editingId: string | null` — which entry is being edited (null = none)
   - `editValue: string` — current input value during editing

4. **Handlers:**
   - `handleEditStart(id, currentLabel)` — set editingId and editValue
   - `handleEditSave()` — trim editValue, call updateMeasurementLabel, clear editingId. If editingId is null, no-op.
   - `handleDelete(id)` — if editingId matches id, clear editingId first, then call unpinMeasurement(id)
   - `handleCopyAll()` — format all pinnedMeasurements as text lines in format `[timestamp] measurement - label`, join with newlines, call `window.electronAPI.writeClipboard(text)`. Timestamp format: `new Date(parseInt(p.id)).toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })`.

5. **formatTimestamp(id)** — helper that converts the id (Date.now string) to readable format using `toLocaleString` with short month, numeric day, 2-digit hour/minute.

6. **Render structure:**
   ```
   div.ruler-notepad-panel
     div.notepad-header
       span "Measurements"
       button.notepad-copy-btn (only if pinnedMeasurements.length > 0)
         onClick={handleCopyAll} title="Copy all to clipboard"
         text: "Copy"

     IF pinnedMeasurements.length === 0:
       div.notepad-empty-state
         p: "Press " <kbd>P</kbd> " to pin measurements"

     ELSE:
       div.notepad-entries (scrollable)
         FOR each p in pinnedMeasurements:
           div.notepad-entry key={p.id}
             div.entry-header
               span.entry-timestamp {formatTimestamp(p.id)}
               button.entry-delete-btn onClick={() => handleDelete(p.id)} title="Remove"
                 text: x character (multiplication sign or unicode times)
             div.entry-value {formatMeasurement(p.measurement)}
             IF editingId === p.id:
               input.entry-label-input
                 value={editValue}
                 onChange -> setEditValue
                 onBlur -> handleEditSave
                 onKeyDown: Enter -> handleEditSave, Escape -> setEditingId(null)
                 autoFocus
                 placeholder="Add note..."
             ELSE:
               div.entry-label onClick={() => handleEditStart(p.id, p.label || '')
                 text: p.label || "Add note..."
                 class: "entry-label" + (p.label ? "" : " entry-label-placeholder")
   ```

Export as named export: `export const RulerNotepadPanel: React.FC`.

**Create src/components/RulerNotepadPanel/RulerNotepadPanel.css (NEW FILE):**

Follow project CSS conventions (CSS custom properties from OKLCH design tokens). Key styles:

```css
.ruler-notepad-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

.notepad-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-0_75) var(--space-1);
  border-bottom: 1px solid var(--border-subtle);
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: var(--text-primary);
  flex-shrink: 0;
}

.notepad-copy-btn {
  font-size: var(--font-size-2xs);
  padding: var(--space-0_25) var(--space-0_75);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
}

.notepad-copy-btn:hover {
  background: var(--surface-hover, rgba(255, 255, 255, 0.1));
  color: var(--text-primary);
}

.notepad-empty-state {
  display: flex;
  align-items: center;
  justify-content: center;
  flex: 1;
  padding: var(--space-2);
  color: var(--text-secondary);
  font-size: var(--font-size-xs);
  text-align: center;
}

.notepad-empty-state kbd {
  display: inline-block;
  padding: var(--space-0_25) var(--space-0_5);
  font-size: var(--font-size-2xs);
  font-family: var(--font-mono);
  background: var(--surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-sm);
  margin: 0 var(--space-0_25);
}

.notepad-entries {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}

.notepad-entry {
  padding: var(--space-0_5) var(--space-1);
  border-bottom: 1px solid var(--border-subtle);
}

.notepad-entry:last-child {
  border-bottom: none;
}

.entry-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-0_25);
}

.entry-timestamp {
  font-size: var(--font-size-2xs);
  color: var(--text-secondary);
}

.entry-delete-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  padding: 0;
  border: none;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: var(--font-size-xs);
  opacity: 0;
  transition: opacity 0.1s;
}

.notepad-entry:hover .entry-delete-btn {
  opacity: 1;
}

.entry-delete-btn:hover {
  background: var(--surface-hover, rgba(255, 255, 255, 0.1));
  color: var(--text-primary);
}

.entry-value {
  font-size: var(--font-size-xs);
  font-family: var(--font-mono);
  color: var(--text-primary);
  padding: var(--space-0_25) var(--space-0_5);
  background: var(--surface);
  border-radius: var(--radius-sm);
  margin-bottom: var(--space-0_25);
}

.entry-label {
  font-size: var(--font-size-2xs);
  color: var(--text-primary);
  cursor: text;
  padding: var(--space-0_25) 0;
}

.entry-label-placeholder {
  color: var(--text-secondary);
  font-style: italic;
}

.entry-label-input {
  width: 100%;
  font-size: var(--font-size-2xs);
  font-family: inherit;
  color: var(--text-primary);
  background: var(--surface);
  border: 1px solid var(--border-accent, var(--border-default));
  border-radius: var(--radius-sm);
  padding: var(--space-0_25) var(--space-0_5);
  outline: none;
  box-sizing: border-box;
}
```

Ensure styles match the project's minimalist OKLCH design language. Delete button uses hover-reveal pattern (opacity: 0 -> 1 on entry hover) for clean appearance.
  </action>
  <verify>
Run `npx tsc --noEmit` — component should compile cleanly. Verify:
- RulerNotepadPanel.tsx exports a named React component
- All Zustand selectors use individual field selectors (not destructuring entire state)
- CSS file uses project design tokens (var(--space-*), var(--font-size-*), var(--text-*), etc.)
- No unused imports or variables
  </verify>
  <done>
- RulerNotepadPanel component renders measurement entries with timestamp, formatted value, and editable label
- Empty state shows "Press P to pin measurements" hint
- Delete button appears on entry hover
- Inline label editing with Enter/Escape/blur support
- Copy All button formats and writes to clipboard via electronAPI
- CSS follows project design token conventions
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate RulerNotepadPanel into TilesetPanel freed section</name>
  <files>
    src/components/TilesetPanel/TilesetPanel.tsx
  </files>
  <action>
**Update src/components/TilesetPanel/TilesetPanel.tsx:**

1. Add import at top: `import { RulerNotepadPanel } from '../RulerNotepadPanel/RulerNotepadPanel';`

2. Replace the empty freed section content (lines 33-36):
   ```
   {/* Right: Freed space for Phase 62 */}
   <div className="tileset-freed-section">
     {/* Empty - no content needed */}
   </div>
   ```
   With:
   ```
   {/* Right: Ruler notepad panel */}
   <div className="tileset-freed-section">
     <RulerNotepadPanel />
   </div>
   ```

That is the only change. The freed section already has `flex: 1; min-width: 0; overflow: hidden;` from Phase 61, so the notepad panel will fill available space and collapse gracefully at narrow widths.
  </action>
  <verify>
Run `npx tsc --noEmit` — full project should compile. Then run `npm run electron:dev` and verify:
1. Ruler notepad panel appears in the freed space to the right of the tile palette
2. Empty state shows "Press P to pin measurements" message
3. Switch to ruler tool, make a measurement, press P — entry appears in notepad
4. Entry shows timestamp, measurement type+value, and "Add note..." placeholder
5. Click "Add note..." — inline input appears, type text, press Enter — label saved
6. Hover entry — delete button (x) appears, click it — entry removed
7. Pin multiple measurements, click "Copy" — formatted text copied to clipboard (paste in text editor to verify)
8. At narrow window widths, notepad panel collapses gracefully
  </verify>
  <done>
- RulerNotepadPanel renders inside tileset-freed-section in TilesetPanel
- Panel fills available horizontal space beside 640px tile palette
- All 6 success criteria from the roadmap are satisfied:
  1. Panel appears in freed horizontal space (LAYOUT-02)
  2. Measurements auto-log when pinned with P key (NOTE-02)
  3. Entries display type, value, and timestamp (NOTE-01)
  4. User can add/edit text labels (NOTE-03)
  5. User can delete individual entries (NOTE-04)
  6. User can copy measurement list to clipboard (NOTE-05)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without new errors
2. App launches with `npm run electron:dev`
3. Ruler notepad panel visible in freed space beside tile palette
4. Pin a measurement (ruler tool + P key) — appears in notepad
5. Edit label on pinned measurement — saves on Enter/blur, cancels on Escape
6. Delete a measurement entry — removed from list
7. Copy All — clipboard contains formatted measurement text
8. Empty state message shown when no measurements pinned
9. Narrow window — notepad collapses gracefully (min-width: 0 from Phase 61)
</verification>

<success_criteria>
- Ruler notepad panel appears in freed horizontal space beside tile palette
- Pinned measurements display with type, value, and timestamp
- User can add/edit text labels via inline controlled input
- User can delete individual entries
- User can copy all measurements to clipboard as formatted text
- Empty state shows P key instruction
- All 6 requirements covered: LAYOUT-02, NOTE-01, NOTE-02, NOTE-03, NOTE-04, NOTE-05
</success_criteria>

<output>
After completion, create `.planning/phases/62-ruler-notepad-panel/62-01-SUMMARY.md`
</output>
