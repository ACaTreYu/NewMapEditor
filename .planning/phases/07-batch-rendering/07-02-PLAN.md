---
phase: 07-batch-rendering
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/core/editor/slices/globalSlice.ts
  - src/core/editor/EditorState.ts
  - src/components/BatchRenderDialog/BatchRenderDialog.tsx
  - src/components/BatchRenderDialog/BatchRenderDialog.css
  - src/App.tsx
  - electron/main.ts
autonomous: false

must_haves:
  truths:
    - "User can trigger batch render from the File menu"
    - "User sees a modal dialog with progress bar, current patch name, and count (e.g. '12 / 44 - Gold')"
    - "User can cancel an in-progress batch render"
    - "Batch completion shows summary (rendered count, failed count)"
    - "App remains responsive during batch rendering"
  artifacts:
    - path: "src/components/BatchRenderDialog/BatchRenderDialog.tsx"
      provides: "Modal dialog with progress bar, cancel button, and completion summary"
      min_lines: 60
    - path: "src/components/BatchRenderDialog/BatchRenderDialog.css"
      provides: "Dialog styling consistent with existing app theme"
      min_lines: 20
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "Batch render state fields and actions"
      contains: "batchRendering"
    - path: "electron/main.ts"
      provides: "Batch Render All Patches menu item under File"
      contains: "batch-render"
  key_links:
    - from: "src/components/BatchRenderDialog/BatchRenderDialog.tsx"
      to: "src/core/export/batchRenderer.ts"
      via: "calls executeBatchRender"
      pattern: "import.*executeBatchRender.*from.*batchRenderer"
    - from: "src/components/BatchRenderDialog/BatchRenderDialog.tsx"
      to: "src/core/editor"
      via: "reads batch state from Zustand"
      pattern: "useEditorStore"
    - from: "src/App.tsx"
      to: "src/components/BatchRenderDialog/BatchRenderDialog.tsx"
      via: "renders BatchRenderDialog conditionally"
      pattern: "BatchRenderDialog"
    - from: "electron/main.ts"
      to: "renderer"
      via: "menu-action 'batch-render'"
      pattern: "batch-render"
---

<objective>
Wire batch rendering into the UI: add Zustand state for batch progress, create a modal progress dialog, add a File menu trigger, and connect everything end-to-end so users can batch-render all patches with live progress feedback.

Purpose: Completes the batch rendering feature by giving users a way to trigger it and see progress.
Output: Working batch render flow: File > Batch Render All Patches > directory picker > progress dialog > PNG files on disk.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@E:/newmapeditor/.planning/phases/07-batch-rendering/07-RESEARCH.md
@E:/newmapeditor/.planning/phases/07-batch-rendering/07-01-SUMMARY.md
@E:/newmapeditor/src/core/editor/slices/globalSlice.ts
@E:/newmapeditor/src/core/editor/EditorState.ts
@E:/newmapeditor/src/App.tsx
@E:/newmapeditor/electron/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Batch state + dialog UI + menu trigger</name>
  <files>
    src/core/editor/slices/globalSlice.ts
    src/core/editor/EditorState.ts
    src/components/BatchRenderDialog/BatchRenderDialog.tsx
    src/components/BatchRenderDialog/BatchRenderDialog.css
    src/App.tsx
    electron/main.ts
  </files>
  <action>
**A. Add batch render state to globalSlice.ts:**

Add these fields to the `GlobalSlice` interface:
```typescript
// Batch render state
batchRendering: boolean;
batchProgress: {
  current: number;
  total: number;
  currentPatch: string;
} | null;
batchResult: {
  rendered: number;
  failed: number;
  errors: string[];
} | null;
batchDialogOpen: boolean;

// Batch render actions
startBatchRender: () => void;
updateBatchProgress: (current: number, total: number, patchName: string) => void;
finishBatchRender: (rendered: number, failed: number, errors: string[]) => void;
closeBatchDialog: () => void;
```

Add initial values in `createGlobalSlice`:
```typescript
batchRendering: false,
batchProgress: null,
batchResult: null,
batchDialogOpen: false,
```

Add action implementations:
- `startBatchRender`: sets `batchRendering: true, batchDialogOpen: true, batchProgress: null, batchResult: null`
- `updateBatchProgress(current, total, patchName)`: sets `batchProgress: { current, total, currentPatch: patchName }`
- `finishBatchRender(rendered, failed, errors)`: sets `batchRendering: false, batchResult: { rendered, failed, errors }`
- `closeBatchDialog`: sets `batchDialogOpen: false, batchProgress: null, batchResult: null`

**B. Create `src/components/BatchRenderDialog/BatchRenderDialog.tsx`:**

A modal dialog component that shows batch render progress. Uses the same overlay/dialog pattern as existing dialogs in the app (e.g., MapSettingsDialog).

Props: none (reads all state from Zustand).

Behavior:
1. When `batchDialogOpen` is true, render a centered modal overlay.
2. If `batchRendering` is true and `batchProgress` exists:
   - Show "Rendering Patches..." title
   - Show progress bar: `batchProgress.current / batchProgress.total` as percentage width
   - Show text: `{current + 1} / {total} - {currentPatch}` (1-indexed for display)
   - Show a "Cancel" button that calls the AbortController (passed via ref or module-level variable)
3. If `batchRendering` is false and `batchResult` exists:
   - Show "Batch Render Complete" title
   - Show `{rendered} of {total} patches rendered successfully`
   - If `failed > 0`, show "Failed: {errors.join(', ')}" in a red/warning style
   - Show "Close" button that calls `closeBatchDialog()`
4. Clicking the overlay backdrop does nothing (modal is non-dismissible during render).

The actual batch render orchestration happens in this component (or a hook called by it):
- On mount (when batchDialogOpen transitions to true and batchRendering is true):
  - Create an AbortController, store in a ref.
  - Get the current map tiles from `useEditorStore.getState().map?.tiles`.
  - If no map loaded, show error and close.
  - Call `window.electronAPI.selectDirectory()` to pick output folder.
  - If user cancels directory picker, call `closeBatchDialog()` and return.
  - Call `executeBatchRender(mapTiles, outputDir, onProgress, signal)`.
  - `onProgress` calls `updateBatchProgress(p.current, p.total, p.patchName)`.
  - On completion, call `finishBatchRender(result.rendered, result.failed, result.errors)`.
- Cancel button: calls `abortController.current.abort()`, then `finishBatchRender` with current counts.

**C. Create `src/components/BatchRenderDialog/BatchRenderDialog.css`:**

Style the dialog to match the app's existing design system:
- Use existing CSS custom properties (`--bg-surface`, `--text-primary`, `--border-color`, etc.)
- Modal overlay: fixed position, semi-transparent dark background, z-index 10000
- Dialog box: centered, 400px width, rounded corners, padding, surface background
- Progress bar: height 20px, background `--bg-secondary`, filled portion uses a blue/accent color
- Buttons: match existing button styles in the app

**D. Wire into App.tsx:**

1. Import `BatchRenderDialog` from `@components/BatchRenderDialog/BatchRenderDialog`.
2. Import `useEditorStore` (already imported).
3. Add a selector: `const batchDialogOpen = useEditorStore(s => s.batchDialogOpen);`
4. Render `{batchDialogOpen && <BatchRenderDialog />}` alongside other modals in the JSX.
5. Add a `handleBatchRender` callback that calls `useEditorStore.getState().startBatchRender()`.
6. Wire the `menu-action` handler (already exists in App.tsx for 'new', 'open', 'save', etc.) to handle `'batch-render'` by calling `handleBatchRender()`.

**E. Add File menu item in electron/main.ts:**

In the `buildMenu()` function, add a menu item to the File submenu, before the Exit separator:
```typescript
{ type: 'separator' },
{
  label: 'Batch Render All Patches...',
  click: () => { mainWindow?.webContents.send('menu-action', 'batch-render'); }
},
```
Place it after "Import Trace Image..." and before the Exit separator.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no type errors.
    Run `npm run dev` (or `npx vite build`) to confirm the app builds.
    In the running app: File > Batch Render All Patches should open a directory picker, then show a progress dialog rendering all 44 patches.
  </verify>
  <done>
    File menu contains "Batch Render All Patches..." item. Clicking it opens a directory picker, then shows a modal progress dialog that displays current patch name, progress count, and a progress bar. After completion, shows a summary of rendered/failed counts. Cancel button stops the batch mid-run. All 44 PNGs are written to the chosen directory.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete batch rendering feature: File menu trigger, directory picker, sequential rendering of all 44 patches with progress dialog, cancel support, PNG output.</what-built>
  <how-to-verify>
    1. Open the app with a map loaded (any .map file or the default new map)
    2. Click File > Batch Render All Patches...
    3. Select an output directory in the folder picker
    4. Verify the progress dialog appears showing:
       - Progress bar filling up
       - Current patch name (e.g., "3 / 44 - AS")
       - A Cancel button
    5. Let it run to completion (~45-90 seconds)
    6. Verify the completion summary shows "44 of 44 patches rendered successfully"
    7. Check the output directory -- it should contain 44 PNG files named after each patch
    8. Open a few PNGs to verify they show the map rendered with the correct tileset
    9. (Optional) Run again and click Cancel mid-way to verify cancellation works
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- File > Batch Render All Patches menu item exists
- Directory picker opens when menu item is clicked
- Progress dialog shows during batch render with live updates
- All 44 PNG files are written to the selected directory
- Cancel button stops rendering without crashing
- App remains responsive during batch render (progress bar animates smoothly)
</verification>

<success_criteria>
Users can trigger batch render from File menu, see live progress with patch name and count, cancel if desired, and find all 44 PNG files in their chosen output directory after completion. No memory exhaustion, no UI freeze, no crashes.
</success_criteria>

<output>
After completion, create `.planning/phases/07-batch-rendering/07-02-SUMMARY.md`
</output>
