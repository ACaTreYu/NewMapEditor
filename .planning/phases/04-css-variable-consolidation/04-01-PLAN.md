---
phase: 04-css-variable-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.css
  - src/hooks/useTheme.ts
  - index.html
  - src/components/AnimationPanel/AnimationPanel.css
  - src/components/MapSettingsPanel/MapSettingsPanel.css
  - src/components/MapCanvas/MapCanvas.css
  - src/components/StatusBar/StatusBar.css
  - src/components/Toolbar/Toolbar.tsx
  - src/components/MapSettingsPanel/MapSettingsPanel.tsx
autonomous: true

must_haves:
  truths:
    - "AnimationPanel switches colors correctly when theme changes"
    - "MapSettingsPanel switches colors correctly when theme changes"
    - "MapCanvas scrollbar area switches colors correctly when theme changes"
    - "StatusBar switches colors correctly when theme changes"
    - "Theme persists across page refresh"
    - "System preference is respected when set to 'system' mode"
  artifacts:
    - path: "src/App.css"
      provides: "Complete CSS variable system with dark/light theme definitions"
      contains: ":root"
    - path: "src/hooks/useTheme.ts"
      provides: "Theme state management hook"
      exports: ["useTheme"]
    - path: "index.html"
      provides: "FOUC prevention script"
      contains: "localStorage.getItem"
  key_links:
    - from: "src/hooks/useTheme.ts"
      to: "document.documentElement"
      via: "classList.add/remove"
      pattern: "classList\\.(add|remove)"
    - from: "src/components/Toolbar/Toolbar.tsx"
      to: "src/hooks/useTheme.ts"
      via: "useTheme import"
      pattern: "import.*useTheme"
---

<objective>
Migrate all hardcoded colors to CSS custom properties and implement dual-theme system (dark/light) with three-way toggle (dark, light, system).

Purpose: Establish consistent theming across all UI components (POL-01 through POL-04) enabling future theme customization and improving user experience with proper dark/light mode support.

Output: Complete CSS variable system, useTheme hook, FOUC prevention, migrated CSS files, and theme toggle in toolbar and settings panel.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-css-variable-consolidation/04-RESEARCH.md

@src/App.css
@src/components/AnimationPanel/AnimationPanel.css
@src/components/MapSettingsPanel/MapSettingsPanel.css
@src/components/MapCanvas/MapCanvas.css
@src/components/StatusBar/StatusBar.css
@src/components/Toolbar/Toolbar.tsx
@src/components/MapSettingsPanel/MapSettingsPanel.tsx
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theme Infrastructure</name>
  <files>
    src/App.css
    src/hooks/useTheme.ts
    index.html
  </files>
  <action>
  Create the complete CSS theming infrastructure:

  **1. App.css - Replace media query approach with class-based theming:**

  Replace the existing :root and @media blocks with a two-tier variable system:

  - Tier 1: Primitive color tokens (raw colors)
    - Dark palette: --color-dark-900 (#0d0d1a), --color-dark-800 (#1a1a2e), --color-dark-700 (#2a2a4e), --color-dark-600 (#3a3a4e), --color-dark-500 (#4a4a6e)
    - Neutral palette: --color-neutral-400 (#666), --color-neutral-300 (#888), --color-neutral-200 (#aaa), --color-neutral-100 (#c0c0c0), --color-neutral-050 (#e0e0e0)
    - Accent palette: --color-accent-600 (#6a6aae), --color-accent-500 (#5a5a7e), --color-accent-400 (#8a8ace)
    - Cream palette (light theme): --color-cream-900 (#544739), --color-cream-800 (#967259), --color-cream-100 (#F9F9F7), --color-cream-200 (#F4F3EF), --color-cream-300 (#EFEEE8), --color-cream-400 (#EAE8E0)
    - Blue accent (light theme): --color-blue-500 (#5a7d9e), --color-blue-600 (#4a6d8e)

  - Tier 2: Semantic tokens mapped to primitives (default = dark theme)
    - --bg-primary, --bg-secondary, --bg-tertiary, --bg-hover, --bg-active
    - --border-default, --border-subtle
    - --text-primary, --text-secondary, --text-tertiary
    - --accent-primary, --accent-hover, --accent-active
    - --scrollbar-track, --scrollbar-thumb, --scrollbar-thumb-hover
    - --input-bg, --input-border, --input-focus
    - --slider-track, --slider-thumb, --slider-thumb-active

  - Add .theme-light class that remaps semantic tokens to cream/blue palette

  - Add comment block at top documenting all available variables

  - Keep existing body, .app, .app-content, .main-area, .resize-handle-vertical styles
  - Update any remaining var() references to use new semantic names if needed

  **2. src/hooks/useTheme.ts - Create custom hook:**

  Create new file with:
  - Type: Theme = 'light' | 'dark' | 'system'
  - useState for themeChoice (initialized from localStorage or 'system')
  - useState for effectiveTheme ('light' | 'dark')
  - getEffectiveTheme function using window.matchMedia('(prefers-color-scheme: dark)')
  - useEffect to apply theme class to document.documentElement
  - useEffect to persist themeChoice to localStorage
  - useEffect to listen for system preference changes when themeChoice is 'system'
  - Wrap localStorage operations in try-catch for error handling
  - Export: { theme, effectiveTheme, setTheme }

  **3. index.html - Add FOUC prevention script:**

  Add inline script BEFORE the root div to prevent flash:
  ```html
  <script>
    (function() {
      try {
        var stored = localStorage.getItem('theme') || 'system';
        var effective = stored;
        if (stored === 'system') {
          effective = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.classList.add('theme-' + effective);
      } catch (e) {
        document.documentElement.classList.add('theme-dark');
      }
    })();
  </script>
  ```

  Note: This script runs synchronously before CSS loads, preventing FOUC.
  </action>
  <verify>
  - `npm run typecheck` passes
  - Open index.html and verify script is present before root div
  - Check App.css has :root with primitives and .theme-light with overrides
  - Check useTheme.ts exports useTheme hook with correct types
  </verify>
  <done>
  CSS variable infrastructure complete: App.css defines two-tier variable system with dark default and light theme class, useTheme hook manages state with localStorage persistence and system preference detection, index.html prevents FOUC.
  </done>
</task>

<task type="auto">
  <name>Task 2: CSS Migration</name>
  <files>
    src/components/AnimationPanel/AnimationPanel.css
    src/components/MapSettingsPanel/MapSettingsPanel.css
    src/components/MapCanvas/MapCanvas.css
    src/components/StatusBar/StatusBar.css
  </files>
  <action>
  Migrate all hardcoded hex colors to CSS variables. Use semantic variable names from App.css.

  **AnimationPanel.css migrations:**
  - #1a1a2e -> var(--bg-primary)
  - #2a2a4e -> var(--border-default)
  - #e0e0e0 -> var(--text-primary)
  - #0d0d1a -> var(--bg-tertiary)
  - #3a3a6e -> var(--bg-hover)
  - #888 -> var(--text-secondary)
  - #6a6aae -> var(--slider-thumb)
  - #4a4a8e -> var(--accent-primary)
  - #5a5aae -> var(--accent-hover)
  - #666 -> var(--text-tertiary)

  **MapSettingsPanel.css migrations:**
  - #1a1a2e -> var(--bg-primary)
  - #2a2a4e -> var(--border-default)
  - #e0e0e0 -> var(--text-primary)
  - #0d0d1a -> var(--bg-tertiary) or var(--input-bg) for inputs
  - #888 -> var(--text-secondary)
  - #666 -> var(--text-tertiary)
  - #c0c0c0 -> var(--text-primary) (labels)
  - #6a6aae -> var(--slider-thumb) or var(--input-focus)
  - #8a8ace -> var(--slider-thumb-active)

  **MapCanvas.css migrations:**
  - #1a1a2e -> var(--bg-primary) for .map-canvas-container
  - #0d0d1a -> var(--scrollbar-track) for scroll tracks
  - #2a2a4e -> var(--border-default)
  - #4a4a6e -> var(--scrollbar-thumb)
  - #5a5a8e -> var(--scrollbar-thumb-hover)
  - #6a6aae -> var(--accent-primary) for :active state

  **StatusBar.css migrations:**
  - #1a1a2e -> var(--bg-primary)
  - #3a3a4e -> var(--border-default)
  - #666 -> var(--text-tertiary)
  - #aaa -> var(--text-secondary)

  **Important:** Do NOT change any CSS that affects canvas rendering (the actual tile display area). Only migrate UI chrome colors.
  </action>
  <verify>
  Run `grep -r "#[0-9a-fA-F]\{3,6\}" src/components/AnimationPanel/AnimationPanel.css src/components/MapSettingsPanel/MapSettingsPanel.css src/components/MapCanvas/MapCanvas.css src/components/StatusBar/StatusBar.css` - should return empty (no hardcoded colors remaining in target files)
  </verify>
  <done>
  All four target CSS files (AnimationPanel, MapSettingsPanel, MapCanvas, StatusBar) use CSS variables exclusively for colors. Zero hardcoded hex colors remain in these files.
  </done>
</task>

<task type="auto">
  <name>Task 3: Theme Toggle UI</name>
  <files>
    src/components/Toolbar/Toolbar.tsx
    src/components/MapSettingsPanel/MapSettingsPanel.tsx
  </files>
  <action>
  Add theme toggle controls to both toolbar (quick access) and settings panel (with options).

  **Toolbar.tsx:**

  1. Import useTheme from '../../hooks/useTheme'

  2. Add to component:
     ```typescript
     const { theme, setTheme } = useTheme();

     const cycleTheme = () => {
       const order: ('system' | 'light' | 'dark')[] = ['system', 'light', 'dark'];
       const current = order.indexOf(theme);
       const next = (current + 1) % order.length;
       setTheme(order[next]);
     };

     const themeIcons = { system: 'S', light: 'L', dark: 'D' };
     const themeLabels = { system: 'Auto', light: 'Light', dark: 'Dark' };
     ```

  3. Add theme toggle button before the toolbar-spacer div:
     ```tsx
     <button
       className="toolbar-button"
       onClick={cycleTheme}
       title={`Theme: ${themeLabels[theme]} (click to cycle)`}
     >
       <span className="toolbar-icon">{themeIcons[theme]}</span>
       <span className="toolbar-label">{themeLabels[theme]}</span>
     </button>
     ```

  Use simple text characters for icons (S/L/D) to match existing toolbar style that uses text/symbols, not emoji icons throughout.

  **MapSettingsPanel.tsx:**

  1. Import useTheme from '../../hooks/useTheme'

  2. Add theme setting section (at bottom, after other settings sections):
     ```tsx
     <div className="settings-section">
       <h3 className="section-title">Appearance</h3>
       <div className="setting-row">
         <label className="setting-label">Theme</label>
         <select
           className="setting-select"
           value={theme}
           onChange={(e) => setTheme(e.target.value as 'system' | 'light' | 'dark')}
         >
           <option value="system">System Default</option>
           <option value="light">Light</option>
           <option value="dark">Dark</option>
         </select>
       </div>
     </div>
     ```

  3. Add useTheme hook call at top of component with other hooks.

  Note: The select uses existing .setting-select class which will be styled by migrated CSS.
  </action>
  <verify>
  - `npm run typecheck` passes
  - `npm run electron:dev` - app launches
  - Click theme button in toolbar - cycles through System/Light/Dark
  - Open Map Settings panel - Theme dropdown visible and functional
  - Both controls stay in sync (change in one reflects in other)
  - Refresh page - theme persists
  </verify>
  <done>
  Theme toggle available in toolbar (quick cycle button) and Map Settings panel (dropdown with System/Light/Dark options). Both controls use shared useTheme hook and stay synchronized. Theme preference persists across sessions.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **No hardcoded colors in target files:**
   ```bash
   grep -r "#[0-9a-fA-F]\{3,6\}" src/components/AnimationPanel/AnimationPanel.css src/components/MapSettingsPanel/MapSettingsPanel.css src/components/MapCanvas/MapCanvas.css src/components/StatusBar/StatusBar.css
   ```
   Should return empty.

2. **Theme switching works:**
   - Launch app with `npm run electron:dev`
   - Default theme matches system preference (or dark if system is dark)
   - Click toolbar theme button - UI switches correctly
   - AnimationPanel, MapSettingsPanel, MapCanvas scrollbars, StatusBar all change colors
   - Tile canvas content remains unchanged (neutral background)

3. **Persistence works:**
   - Set theme to Light
   - Close and reopen app
   - Theme is still Light

4. **System preference works:**
   - Set app to System mode
   - Change OS theme
   - App theme updates (may need to restart app depending on OS)

5. **No FOUC:**
   - Set theme to Light, refresh page
   - No flash of dark theme before light appears
</verification>

<success_criteria>
- POL-01: AnimationPanel.css uses CSS variables (zero hardcoded colors)
- POL-02: MapSettingsPanel.css uses CSS variables (zero hardcoded colors)
- POL-03: MapCanvas.css uses CSS variables (zero hardcoded colors)
- POL-04: StatusBar.css uses CSS variables (zero hardcoded colors)
- Theme toggle available in toolbar and settings panel
- Dark and light themes both functional
- System preference detection works
- Theme persists across page refresh
- No flash of unstyled content on load
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-css-variable-consolidation/04-01-SUMMARY.md`
</output>
