---
phase: 35-cross-document-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/slices/types.ts
  - src/core/editor/slices/globalSlice.ts
  - src/core/editor/slices/documentsSlice.ts
  - src/core/editor/EditorState.ts
  - src/components/MapCanvas/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "User can copy tiles from one map and paste them into a different map"
    - "User can use color picker on one map and draw with the picked tile on another map"
    - "Cross-document paste preserves full 16-bit tile encoding including animation flags"
    - "Paste preview state (isPasting, pastePreviewPosition) remains per-document and does not leak across windows"
    - "Clipboard persists until overwritten, not cleared on document switch or close"
  artifacts:
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "Global clipboard state and transformation actions"
      contains: "clipboard: ClipboardData | null"
    - path: "src/core/editor/slices/types.ts"
      provides: "DocumentState without clipboard field"
    - path: "src/core/editor/slices/documentsSlice.ts"
      provides: "Clipboard actions reading global state instead of per-document"
    - path: "src/core/editor/EditorState.ts"
      provides: "Updated backward-compat wrappers and syncTopLevelFields"
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "MapCanvas reading clipboard from global state"
  key_links:
    - from: "src/core/editor/slices/documentsSlice.ts"
      to: "globalSlice clipboard"
      via: "copySelectionForDocument calls set({ clipboard: ... }) on global state"
      pattern: "set\\(\\{\\s*clipboard:"
    - from: "src/core/editor/slices/documentsSlice.ts"
      to: "globalSlice clipboard"
      via: "startPastingForDocument and pasteAtForDocument read state.clipboard (global)"
      pattern: "state\\.clipboard"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "global clipboard"
      via: "useEditorStore selector reads state.clipboard directly (not doc.clipboard)"
      pattern: "state\\.clipboard"
    - from: "src/core/editor/EditorState.ts"
      to: "globalSlice clipboard"
      via: "syncTopLevelFields no longer syncs clipboard from document"
---

<objective>
Move clipboard state from per-document to global scope, enabling cross-document copy/paste operations.

Purpose: XDOC-01 requires copying tiles from map A and pasting into map B. Currently clipboard is stored per-document in DocumentState, isolating each document's clipboard. Moving it to GlobalSlice makes clipboard shared across all documents. XDOC-02 (picker tool) already works cross-document because selectedTile is in GlobalSlice -- this plan verifies that with typecheck.

Output: Global clipboard with cross-document copy/cut/paste, mirror, rotate. Zero TypeScript errors.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-cross-document-operations/35-RESEARCH.md
@src/core/editor/slices/types.ts
@src/core/editor/slices/globalSlice.ts
@src/core/editor/slices/documentsSlice.ts
@src/core/editor/EditorState.ts
@src/components/MapCanvas/MapCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move clipboard state from DocumentState to GlobalSlice</name>
  <files>
    src/core/editor/slices/types.ts
    src/core/editor/slices/globalSlice.ts
    src/core/editor/slices/documentsSlice.ts
  </files>
  <action>
**types.ts -- Remove clipboard from DocumentState:**
1. Remove `clipboard: ClipboardData | null;` from the `DocumentState` interface (line 68). Keep `isPasting` and `pastePreviewPosition` -- these remain per-document.
2. Remove `clipboard: null,` from `createDefaultDocumentState()` (line 84).
3. Remove `clipboard: null,` from `createDocumentFromMap()` (line 101).

**globalSlice.ts -- Add clipboard state and actions:**
1. Import `ClipboardData` from `./types`.
2. Add to `GlobalSlice` interface:
   - `clipboard: ClipboardData | null;`
   - `setClipboard: (data: ClipboardData | null) => void;`
   - `mirrorClipboardHorizontal: () => void;`
   - `mirrorClipboardVertical: () => void;`
   - `rotateClipboard: () => void;`
3. Add initial state: `clipboard: null,`
4. Add `setClipboard` action: `set({ clipboard: data })`
5. Port `mirrorClipboardHorizontal` from documentsSlice's `mirrorHorizontalForDocument` logic:
   - Read `clipboard` from `get()` (not from a document)
   - If no clipboard, return early
   - Create new Uint16Array, flip horizontally: `newTiles[y * width + (width - 1 - x)] = tiles[y * width + x]`
   - `set({ clipboard: { ...clipboard, tiles: newTiles } })`
6. Port `mirrorClipboardVertical` similarly:
   - `newTiles[(height - 1 - y) * width + x] = tiles[y * width + x]`
   - `set({ clipboard: { ...clipboard, tiles: newTiles } })`
7. Port `rotateClipboard`:
   - Swap width/height: `newWidth = height, newHeight = width`
   - `dstX = y; dstY = width - 1 - x; newTiles[dstY * newWidth + dstX] = tiles[y * width + x]`
   - `set({ clipboard: { width: newWidth, height: newHeight, tiles: newTiles, originX, originY } })`

**documentsSlice.ts -- Update clipboard actions to use global state:**

1. **Remove from DocumentsSlice interface:** `mirrorHorizontalForDocument`, `mirrorVerticalForDocument`, `rotateClipboardForDocument` (these are now in GlobalSlice).

2. **Update `copySelectionForDocument`:** Instead of writing to `doc.clipboard`, write to global state:
   - Replace the `set()` call: instead of updating `doc.clipboard`, call `set({ clipboard: { width, height, tiles, originX: minX, originY: minY } })` which writes to global state.
   - Do NOT update the document -- clipboard is no longer per-document.

3. **Update `cutSelectionForDocument`:** No changes needed -- it calls `copySelectionForDocument` which now writes to global. The rest (clearing tiles) stays the same.

4. **Update `startPastingForDocument`:** Change guard from `!doc.clipboard` to reading global clipboard:
   - `const clipboard = get().clipboard;` (reads GlobalSlice)
   - Guard: `if (!doc || !clipboard) return;`
   - Keep setting `isPasting: true` on the document (paste preview is per-document).

5. **Update `pasteAtForDocument`:** Change clipboard source from `doc.clipboard` to global:
   - `const clipboard = get().clipboard;` (reads GlobalSlice)
   - Guard: `if (!doc || !doc.map || !clipboard) return;`
   - Replace all `doc.clipboard` references with `clipboard` local variable.

6. **Remove implementations:** Delete the `mirrorHorizontalForDocument`, `mirrorVerticalForDocument`, and `rotateClipboardForDocument` action implementations entirely (they are now in globalSlice).

7. **Update the StateCreator generic type parameter** if needed: `DocumentsSlice & GlobalSlice` is already the combined type, so `get()` already has access to `clipboard` from GlobalSlice.

CRITICAL: All Uint16Array operations must preserve full 16-bit values. No masking with `& 0x7FFF`. Copy raw values to maintain animation flags (bit 15).
  </action>
  <verify>
Run `npx tsc --noEmit` -- should pass with zero errors. Specifically verify:
- `DocumentState` interface no longer has `clipboard` field
- `GlobalSlice` interface has `clipboard: ClipboardData | null` and the four clipboard actions
- `documentsSlice.ts` no longer has mirror/rotate implementations
- `documentsSlice.ts` copy/paste actions reference `get().clipboard` not `doc.clipboard`
  </verify>
  <done>
Clipboard state lives in GlobalSlice. Copy writes to global clipboard. Paste reads from global clipboard. Mirror/rotate operate on global clipboard. isPasting and pastePreviewPosition remain per-document. TypeScript compiles with zero errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update EditorState wrappers and MapCanvas selector</name>
  <files>
    src/core/editor/EditorState.ts
    src/components/MapCanvas/MapCanvas.tsx
  </files>
  <action>
**EditorState.ts -- Update syncTopLevelFields and wrappers:**

1. **Update `syncTopLevelFields`:** Remove `clipboard: doc.clipboard` from the return object (line 105). The top-level `clipboard` field should NOT be synced from the document -- it's now global state managed by GlobalSlice. Remove `clipboard: null` from both early-return objects (lines 75 and 91) since clipboard is global.

   The top-level `clipboard` field in BackwardCompatLayer will now naturally reflect the GlobalSlice's clipboard value because GlobalSlice sets `clipboard` directly on the store root. Since `createGlobalSlice` initializes `clipboard: null` and `setClipboard` calls `set({ clipboard: data })`, the top-level field is already managed by GlobalSlice.

2. **Update `createDocument` override (line 133-177):** Remove `clipboard: null,` from the inline `docState` object (line 147) since DocumentState no longer has a clipboard field.

3. **Update backward-compat wrapper `mirrorHorizontal`:** Change from:
   ```
   get().mirrorHorizontalForDocument(id);
   ```
   To:
   ```
   get().mirrorClipboardHorizontal();
   ```
   No document ID needed -- operates on global clipboard. Remove the syncTopLevelFields call since clipboard is already global.

4. **Update backward-compat wrapper `mirrorVertical`:** Change from:
   ```
   get().mirrorVerticalForDocument(id);
   ```
   To:
   ```
   get().mirrorClipboardVertical();
   ```
   Remove syncTopLevelFields call.

5. **Update backward-compat wrapper `rotateClipboard`:** Change from:
   ```
   get().rotateClipboardForDocument(id);
   ```
   To:
   ```
   get().rotateClipboard();
   ```
   Remove syncTopLevelFields call.

6. **Update `copySelection` wrapper:** Keep delegating to `copySelectionForDocument(id)`. The sync call is still needed for other fields but clipboard sync will be a no-op. This is fine -- syncTopLevelFields just won't include clipboard in its return.

7. **Update `pasteClipboard` wrapper:** The `startPastingForDocument` now reads global clipboard, so this wrapper works correctly. Keep the sync call for isPasting.

**MapCanvas.tsx -- Update clipboard selector:**

1. Find the `useEditorStore` selector around line 85-97 where clipboard is read. Currently it reads:
   ```
   clipboard: doc ? doc.clipboard : state.clipboard,
   ```
   Change to always read from global state:
   ```
   clipboard: state.clipboard,
   ```
   This is correct because clipboard is now in GlobalSlice (store root), not per-document.

2. No other changes needed in MapCanvas -- `isPasting` and `pastePreviewPosition` are still read from the document (per-document), and the paste preview rendering logic uses `clipboard` which now comes from global state.
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- zero errors.
2. Run `npm run electron:dev` -- app launches without console errors.
3. Manual verification sequence:
   - Open map A (File > Open or File > New)
   - Open map B (File > New, creating a second document)
   - On map A: use SELECT tool, drag to select a region, press Ctrl+C
   - Switch to map B by clicking its window
   - Press Ctrl+V -- paste preview should appear on map B
   - Click to place -- tiles from map A should appear on map B
   - Verify animated tiles (if any) retain their animation after paste
  </verify>
  <done>
Cross-document copy/paste works: copy from map A, paste into map B. Picker tool works cross-document (pick tile on map A, draw on map B). All clipboard transformations (mirror H/V, rotate) operate on global clipboard. 16-bit tile encoding preserved. TypeScript compiles with zero errors. App runs without runtime errors.
  </done>
</task>

</tasks>

<verification>
1. **TypeScript:** `npx tsc --noEmit` passes with zero errors
2. **Runtime:** `npm run electron:dev` launches without console errors
3. **XDOC-01 (cross-document clipboard):**
   - Open two maps (A and B)
   - On map A: SELECT tool, drag selection, Ctrl+C
   - Switch to map B, Ctrl+V, click to paste -- tiles from A appear on B
   - Repeat with Ctrl+X (cut) -- source cleared on A, paste works on B
4. **XDOC-02 (cross-document picker):**
   - On map A: press I (picker), click a tile
   - Switch to map B: draw with pencil -- picked tile from A is drawn on B
5. **16-bit preservation:**
   - Copy a region containing animated tiles (bit 15 set)
   - Paste into different document -- animation flags preserved
6. **Paste preview isolation:**
   - On map A: copy selection, Ctrl+V (enter paste mode)
   - Switch to map B -- map B should NOT be in paste mode
   - Switch back to map A -- paste preview still active
7. **Clipboard persistence:**
   - Copy tiles from map A
   - Close map A
   - Open map C, Ctrl+V -- clipboard data still available
8. **Transform operations:**
   - Copy selection, apply mirror/rotate, paste into different document -- transformation preserved
</verification>

<success_criteria>
- Cross-document copy/paste works (XDOC-01)
- Cross-document picker works (XDOC-02)
- 16-bit tile encoding preserved across documents
- Paste preview state remains per-document
- Clipboard persists across document switches and closures
- TypeScript zero errors maintained
- No runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-cross-document-operations/35-01-SUMMARY.md`
</output>
