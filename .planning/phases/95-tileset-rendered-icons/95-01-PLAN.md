---
phase: 95-tileset-rendered-icons
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ToolBar/ToolBar.tsx
autonomous: true

must_haves:
  truths:
    - "Flag toolbar button displays a tile image from the loaded tileset (tile 905 = green flag pad)"
    - "Switch toolbar button displays a tile image from the loaded tileset (tile 743 = switch unflipped)"
    - "Conveyor toolbar button displays a tile image from the loaded tileset (tile 1717 = conveyor right TL)"
    - "Spawn toolbar button still displays tileset tile 1223 (unchanged from v3.6)"
    - "Pole toolbar button still displays tileset tile 1361 (unchanged from v3.6)"
    - "Warp toolbar button still displays first frame of anim 0x9E (unchanged from v3.6)"
    - "When no tileset is loaded, all six tools fall back to SVG Lucide icons without errors"
    - "Loading a different GFX patch updates all six icons to reflect the new tileset"
  artifacts:
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Tileset-rendered icons for all six game object tools"
      contains: "['flag', 905]"
  key_links:
    - from: "tilesetToolIcons useMemo"
      to: "renderToolButton tilesetIcon check"
      via: "tilesetToolIcons[tool.icon] lookup returns dataURL string"
      pattern: "tilesetToolIcons\\[tool\\.icon\\]"
---

<objective>
Convert flag, switch, and conveyor toolbar icons from static PNG images to tileset-rendered canvas snippets, matching the existing pattern used by spawn, pole, and warp.

Purpose: All six game object tool buttons should display the actual tile artwork from the loaded tileset rather than generic static PNGs. This ensures visual consistency and correct rendering when different GFX patches are loaded.

Output: Updated ToolBar.tsx where the `tilesetToolIcons` useMemo renders all six game object tools from the tileset, with clean SVG fallbacks when no tileset is loaded.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/ToolBar/ToolBar.tsx
@.planning/phases/95-tileset-rendered-icons/95-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add flag, switch, conveyor to tileset-rendered singles array and add conveyor SVG fallback</name>
  <files>src/components/ToolBar/ToolBar.tsx</files>
  <action>
Modify the `tilesetToolIcons` useMemo block (around lines 295-333) to:

1. **Remove the static PNG import lines** at the top of the file (lines 25-29):
   - Remove: `import bunkerIcon from '@/assets/toolbar/bunkericon.png';`
   - Remove: `import conveyorIcon from '@/assets/toolbar/conveyoricon.png';`
   - Remove: `import flagIcon from '@/assets/toolbar/flagicon.png';`
   - Remove: `import switchIcon from '@/assets/toolbar/switchicon.png';`
   - Remove: `import turretIcon from '@/assets/toolbar/turreticon.png';`

2. **Replace the pre-populated icons object** (lines 296-302) with an empty object:
   ```typescript
   const icons: Record<string, string> = {};
   if (!tilesetImage) return icons;
   ```
   This removes the dead-at-runtime static PNG references from the icons object. When no tileset is loaded, the empty object means all tools fall through to their SVG fallback in `toolIcons`.

3. **Add flag, switch, conveyor to the `singles` array** (currently line 314):
   Change from:
   ```typescript
   const singles: [string, number][] = [['spawn', 1223], ['pole', 1361]];
   ```
   To:
   ```typescript
   const singles: [string, number][] = [
     ['spawn', 1223],    // anim 0xA6 Yellow OnMapSpawn
     ['pole', 1361],     // anim 0x6A Neutral Cap Pad MM
     ['flag', 905],      // anim 0x1C Green Pad GreenFlag Sec, frame 0
     ['switch', 743],    // anim 0x7B Switch Unflipped, frame 0
     ['conveyor', 1717], // anim 0xB7 Conveyor right TL, frame 0
   ];
   ```
   The warp entry via `ANIMATION_DEFINITIONS[0x9E]` remains unchanged after the singles array.

4. **Add a conveyor fallback SVG icon** to the `toolIcons` map (around line 33). Import `LuArrowRightFromLine` (or `LuMoveRight`) from react-icons/lu and add:
   ```typescript
   conveyor: LuMoveRight,
   ```
   This provides a visible icon when no tileset is loaded. Check which Lucide icon is available — `LuMoveRight` or `LuArrowRight` are suitable. If neither is imported already, use `LuArrowRight` which is a common Lucide icon.

   Also add fallback entries for `bunker` and `turret` so they have SVG fallbacks now that their PNG imports are removed:
   - `bunker` already exists in toolIcons as... check: No, `bunker` is NOT in toolIcons. The bunkerIcon PNG was the only icon. Add a temporary fallback. Since `GiStoneBridge` is already imported, and there's no perfect Lucide match, skip bunker for now — Phase 97 handles it. Actually, the bunker icon PNG *does* exist on disk (bunkericon.png is 258 bytes). **Keep the bunkerIcon import** (`import bunkerIcon from '@/assets/toolbar/bunkericon.png'`) since it's a real file that renders correctly, and bunker is Phase 97's concern. Same for turretIcon — keep it if the file exists.

   **CORRECTION based on filesystem check:** The PNG files DO exist on disk:
   - `bunkericon.png` (258 bytes) — KEEP this import, bunker is Phase 97
   - `turreticon.png` (634 bytes) — KEEP this import, turret is out of scope
   - `conveyoricon.png` (409 bytes) — REMOVE (replacing with tileset-rendered)
   - `flagicon.png` (318 bytes) — REMOVE (replacing with tileset-rendered)
   - `switchicon.png` (670 bytes) — REMOVE (replacing with tileset-rendered)

   So the final import cleanup is:
   - KEEP: `import bunkerIcon from '@/assets/toolbar/bunkericon.png';`
   - KEEP: `import turretIcon from '@/assets/toolbar/turreticon.png';`
   - REMOVE: `import conveyorIcon from '@/assets/toolbar/conveyoricon.png';`
   - REMOVE: `import flagIcon from '@/assets/toolbar/flagicon.png';`
   - REMOVE: `import switchIcon from '@/assets/toolbar/switchicon.png';`

   And the icons object initialization becomes:
   ```typescript
   const icons: Record<string, string> = {
     bunker: bunkerIcon,
     turret: turretIcon,
   };
   if (!tilesetImage) return icons;
   ```
   This keeps bunker and turret as static PNGs (their phases handle them later), while flag/switch/conveyor are now tileset-rendered when a tileset is loaded, or fall back to SVG icons when not.

5. **Add conveyor to the `toolIcons` SVG fallback map.** Currently `toolIcons` has no `conveyor` entry. Add one so that when no tileset is loaded, the conveyor button shows an SVG icon instead of plain text. Use an appropriate Lucide icon — check what's available in the existing imports. If none fits, add a new import. `LuArrowRight` would work but isn't imported. Use a creative approach: the `LuRotateCw` icon is already imported but used for rotate. Instead, add a new import for a conveyor-like icon. The simplest approach is to just add `import { LuArrowRight } from 'react-icons/lu'` to the existing destructured import and add `conveyor: LuArrowRight` to `toolIcons`.

   Actually, looking at existing imports more carefully, the react-icons imports are all from `'react-icons/lu'` and `'react-icons/gi'`. Add `LuArrowRight` to the existing destructured `react-icons/lu` import, then add `conveyor: LuArrowRight` to the `toolIcons` map.
  </action>
  <verify>
  1. Run `npm run typecheck` — no TypeScript errors
  2. Run `npm run electron:dev` — app launches, toolbar renders
  3. Open a map file (which loads the tileset): flag, switch, and conveyor buttons show tileset tiles instead of generic PNGs
  4. Close all maps (no tileset loaded): flag and switch show SVG Lucide icons, conveyor shows arrow SVG icon
  5. Spawn, pole, warp icons still render correctly from tileset (regression check)
  6. Bunker and turret still show their PNG icons (not affected by changes)
  </verify>
  <done>
  - Flag button: shows tile 905 (green flag pad) when tileset loaded, LuFlag SVG when not
  - Switch button: shows tile 743 (switch unflipped) when tileset loaded, LuToggleLeft SVG when not
  - Conveyor button: shows tile 1717 (conveyor right TL) when tileset loaded, LuArrowRight SVG when not
  - Spawn/pole/warp: unchanged, still tileset-rendered
  - Bunker/turret: unchanged, still static PNGs
  - No TypeScript errors, no console errors, no broken img src
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of all six tileset-rendered icons</name>
  <what-built>Flag, switch, and conveyor toolbar buttons now render tiles from the loaded tileset, joining spawn/pole/warp which were already tileset-rendered. When no tileset is loaded, all six fall back to SVG Lucide icons.</what-built>
  <how-to-verify>
    1. Run `npm run electron:dev`
    2. Open the app — before loading any map, check toolbar:
       - Flag button: LuFlag SVG icon (pennant shape)
       - Switch button: LuToggleLeft SVG icon
       - Conveyor button: arrow SVG icon
       - Spawn/pole/warp: SVG fallback icons (crosshair, flag-triangle, circle-dot)
       - Bunker: PNG icon (unchanged)
       - Turret: PNG icon (unchanged)
    3. Open a map file (File > Open or Ctrl+O)
    4. After tileset loads, check toolbar:
       - Flag button: green flag pad tile (tile 905)
       - Switch button: switch tile (tile 743)
       - Conveyor button: conveyor arrow tile (tile 1717)
       - Spawn: yellow spawn tile (tile 1223)
       - Pole: neutral cap pad tile (tile 1361)
       - Warp: big warp tile (first frame of anim 0x9E)
    5. All six icons should be 16x16 pixel art, crisp (not blurry)
    6. Load a different GFX patch (File > Load GFX Patch) — all six icons update
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles cleanly: `npm run typecheck` passes with no errors
2. No console errors on startup (no broken img src, no missing module warnings)
3. All six game object tool buttons (flag, pole, warp, spawn, switch, conveyor) display tileset tiles when a tileset is loaded
4. Switching GFX patches updates all six icons
5. When no tileset loaded, SVG fallback icons appear for all six tools
6. Bunker and turret remain on their static PNG icons (not affected)
7. Icon dimensions are 16x16 with pixelated rendering (no blurring)
</verification>

<success_criteria>
- ICON-01: Flag tool icon rendered from tileset tile 905 (green flag pad)
- ICON-02: Pole tool icon rendered from tileset tile 1361 (neutral cap pad) [already done in v3.6, confirmed working]
- ICON-03: Warp tool icon rendered from tileset anim 0x9E frame 0 [already done in v3.6, confirmed working]
- ICON-04: Spawn tool icon rendered from tileset tile 1223 [already done in v3.6, confirmed working]
- ICON-05: Switch tool icon rendered from tileset tile 743 (switch unflipped)
- ICON-06: Conveyor tool icon rendered from tileset tile 1717 (conveyor right TL)
- No JavaScript errors when tileset is not loaded (graceful SVG fallback)
- Loading a different GFX patch updates all icons
</success_criteria>

<output>
After completion, create `.planning/phases/95-tileset-rendered-icons/95-01-SUMMARY.md`
</output>
