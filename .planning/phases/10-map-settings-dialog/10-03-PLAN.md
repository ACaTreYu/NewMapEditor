---
phase: 10-map-settings-dialog
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - src/components/MapSettingsDialog/MapSettingsDialog.tsx
  - src/components/MapSettingsDialog/MapSettingsDialog.css
  - src/components/ToolBar/Toolbar.tsx
  - src/core/map/types.ts
  - src/core/editor/EditorState.ts
autonomous: true

must_haves:
  truths:
    - "Toolbar has Map Settings button that opens dialog"
    - "Dialog loads current map settings when opened"
    - "Apply button saves all settings to store"
    - "Close button closes without saving"
    - "Closing with unsaved changes shows confirmation"
    - "Reset All button resets all settings to defaults (with confirmation)"
    - "Extended settings stored in MapHeader.extendedSettings"
  artifacts:
    - path: "src/components/ToolBar/Toolbar.tsx"
      provides: "Map Settings button"
      contains: "Map Settings"
    - path: "src/core/map/types.ts"
      provides: "extendedSettings field in MapHeader"
      contains: "extendedSettings"
    - path: "src/core/editor/EditorState.ts"
      provides: "Extended settings update support"
      contains: "extendedSettings"
    - path: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      provides: "Complete dialog with Apply/Close/Reset All"
      contains: "handleApply"
      min_lines: 200
  key_links:
    - from: "src/components/ToolBar/Toolbar.tsx"
      to: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      via: "ref.open() call"
      pattern: "dialogRef.*open"
    - from: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "updateMapHeader call"
      pattern: "updateMapHeader"
---

<objective>
Complete the Map Settings dialog by integrating with the store, adding toolbar button, and implementing Apply/Close/Reset All functionality with dirty flag and unsaved changes confirmation.

Purpose: Wire up the dialog to actually save settings to the map, provide toolbar access, and handle edge cases (unsaved changes, reset all).
Output: Fully functional Map Settings dialog accessible from toolbar, saving to Zustand store.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@E:\NewMapEditor\.planning\PROJECT.md
@E:\NewMapEditor\.planning\phases\10-map-settings-dialog\10-CONTEXT.md
@E:\NewMapEditor\.planning\phases\10-map-settings-dialog\10-RESEARCH.md
@E:\NewMapEditor\src\components\ToolBar\Toolbar.tsx
@E:\NewMapEditor\src\core\editor\EditorState.ts
@E:\NewMapEditor\src\core\map\types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extendedSettings field to MapHeader and EditorState</name>
  <files>src/core/map/types.ts, src/core/editor/EditorState.ts</files>
  <action>
**types.ts changes:**

1. Add extendedSettings field to MapHeader interface:
```typescript
export interface MapHeader {
  // ... existing fields ...
  extendedSettings: Record<string, number>;  // Extended game settings from description
}
```

2. Update createDefaultHeader() to initialize extendedSettings:
```typescript
export function createDefaultHeader(): MapHeader {
  return {
    // ... existing fields ...
    extendedSettings: {}
  };
}
```

**EditorState.ts changes:**

The existing updateMapHeader action already handles partial updates via spread:
```typescript
updateMapHeader: (updates) => {
  const { map } = get();
  if (!map) return;
  set({
    map: {
      ...map,
      header: { ...map.header, ...updates },
      modified: true
    }
  });
},
```

This should already work for extendedSettings updates like:
```typescript
updateMapHeader({ extendedSettings: { ...current.extendedSettings, ...newSettings } })
```

No changes needed to EditorState.ts logic, just ensure the type flows through properly.
  </action>
  <verify>`npm run typecheck` passes</verify>
  <done>MapHeader has extendedSettings: Record<string, number> field. createDefaultHeader returns empty object for extendedSettings.</done>
</task>

<task type="auto">
  <name>Task 2: Complete dialog with store integration and Apply/Close/Reset All</name>
  <files>src/components/MapSettingsDialog/MapSettingsDialog.tsx, src/components/MapSettingsDialog/MapSettingsDialog.css</files>
  <action>
**MapSettingsDialog.tsx changes:**

1. Import store hook:
```tsx
import { useEditorStore } from '@core/editor';
```

2. Add dirty flag state:
```tsx
const [isDirty, setIsDirty] = useState(false);
```

3. Update the open function to load current map data:
```tsx
useImperativeHandle(ref, () => ({
  open: () => {
    const { map } = useEditorStore.getState();
    if (map) {
      setMapName(map.header.name);
      setMapDescription(map.header.description);
      // Merge defaults with any extended settings from the map
      const defaults = getDefaultSettings();
      setLocalSettings({ ...defaults, ...map.header.extendedSettings });
    }
    setIsDirty(false);
    dialogRef.current?.showModal();
  }
}));
```

4. Update all change handlers to set dirty flag:
```tsx
const updateSetting = (key: string, value: number) => {
  setLocalSettings(prev => ({ ...prev, [key]: value }));
  setIsDirty(true);
};

const setMapNameWithDirty = (name: string) => {
  setMapName(name);
  setIsDirty(true);
};

const setMapDescriptionWithDirty = (desc: string) => {
  setMapDescription(desc);
  setIsDirty(true);
};
```

5. Add handleApply function:
```tsx
const { updateMapHeader } = useEditorStore();

const handleApply = () => {
  updateMapHeader({
    name: mapName,
    description: mapDescription,
    extendedSettings: localSettings
  });
  setIsDirty(false);
};
```

6. Update handleClose to check dirty flag:
```tsx
const handleClose = () => {
  if (isDirty) {
    if (!confirm('You have unsaved changes. Discard them?')) {
      return;
    }
  }
  dialogRef.current?.close();
};
```

7. Add onClose handler to dialog for Escape key:
```tsx
const handleDialogClose = (e: React.SyntheticEvent<HTMLDialogElement>) => {
  if (isDirty) {
    e.preventDefault();
    if (confirm('You have unsaved changes. Discard them?')) {
      dialogRef.current?.close();
    } else {
      dialogRef.current?.showModal(); // Reopen
    }
  }
};
```

8. Add Reset All functionality:
```tsx
const handleResetAll = () => {
  if (confirm('Reset ALL settings to their default values?')) {
    setLocalSettings(getDefaultSettings());
    setIsDirty(true);
  }
};
```

9. Update button row to include Apply and Reset All:
```tsx
<div className="dialog-buttons">
  <button
    type="button"
    className="win95-button reset-all-button"
    onClick={handleResetAll}
  >
    Reset All
  </button>
  <div className="button-spacer" />
  <button
    type="button"
    className="win95-button"
    onClick={handleApply}
    disabled={!isDirty}
  >
    Apply
  </button>
  <button
    type="button"
    className="win95-button"
    onClick={handleClose}
  >
    Close
  </button>
</div>
```

10. Add onClose to dialog element:
```tsx
<dialog
  ref={dialogRef}
  className="map-settings-dialog"
  onClose={handleDialogClose}
>
```

**MapSettingsDialog.css additions:**

1. Button row layout with Reset All on left:
```css
.dialog-buttons {
  display: flex;
  align-items: center;
  padding: 12px;
  border-top: 1px solid var(--border-default);
  gap: 8px;
}

.button-spacer {
  flex: 1;
}

.reset-all-button {
  margin-right: auto;
}
```

2. Apply button disabled state:
```css
.win95-button:disabled {
  opacity: 0.6;
  cursor: default;
}

.win95-button:disabled:active {
  box-shadow:
    inset -1px -1px 0px #808080,
    inset 1px 1px 0px #ffffff,
    inset -2px -2px 0px #000000,
    inset 2px 2px 0px #dfdfdf;
  padding: 6px 20px;
}
```
  </action>
  <verify>`npm run typecheck` passes</verify>
  <done>Dialog loads map settings on open, Apply saves to store, Close prompts if dirty, Reset All resets with confirmation. Apply button disabled when no changes.</done>
</task>

<task type="auto">
  <name>Task 3: Add Map Settings button to Toolbar</name>
  <files>src/components/ToolBar/Toolbar.tsx</files>
  <action>
Update Toolbar to include Map Settings button and integrate dialog:

1. Add ref for dialog:
```tsx
import { useRef } from 'react';
import { MapSettingsDialog, MapSettingsDialogHandle } from '../MapSettingsDialog/MapSettingsDialog';
```

2. Create ref in component:
```tsx
const settingsDialogRef = useRef<MapSettingsDialogHandle>(null);
```

3. Add open handler:
```tsx
const openSettings = () => {
  settingsDialogRef.current?.open();
};
```

4. Add button to toolbar after the Grid toggle button, before the Theme button:
```tsx
<button
  className="toolbar-button"
  onClick={openSettings}
  disabled={!map}
  title="Map Settings"
>
  <span className="toolbar-icon">&#9881;</span>
  <span className="toolbar-label">Settings</span>
</button>
```

The gear symbol (&#9881; or the cog emoji) works as the icon. Could also use unicode gear: \u2699

5. Render the dialog at the end of the component, outside the toolbar div but inside the component return:
```tsx
return (
  <>
    <div className="toolbar">
      {/* ... existing buttons ... */}
    </div>
    <MapSettingsDialog ref={settingsDialogRef} />
  </>
);
```

NOTE: The dialog must be rendered at the top level (direct child of App or near it) to avoid z-index issues. If Toolbar is nested, consider moving the dialog render to App.tsx instead and passing the ref down. However, since HTML5 `<dialog>` with showModal() creates a top-layer element, it should work from within Toolbar.

If z-index issues occur, move dialog to App.tsx and pass openSettings as prop to Toolbar.
  </action>
  <verify>
1. `npm run typecheck` passes
2. Run `npm run electron:dev`
3. Open a map file
4. Click Settings button in toolbar - dialog opens
5. Modify a setting - Apply becomes enabled
6. Click Apply - changes saved (verify by reopening dialog)
7. Modify a setting, click Close - confirmation appears
8. Click "Reset All" - confirmation appears, all settings reset to defaults
9. Press Escape with unsaved changes - confirmation appears
  </verify>
  <done>Settings button in toolbar opens Map Settings dialog. Full Apply/Close/Reset All workflow functional.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. MapHeader.extendedSettings field exists
3. Toolbar has "Settings" button with gear icon
4. Button disabled when no map loaded
5. Clicking button opens dialog
6. Dialog loads current map name/description
7. Dialog loads extendedSettings (or defaults if none)
8. Modifying any value sets dirty flag
9. Apply button enabled only when dirty
10. Apply saves name, description, and all settings to store
11. Close with dirty flag shows confirmation
12. Escape key with dirty flag shows confirmation
13. Reset All shows confirmation, resets all settings
14. After Apply, dirty flag cleared
</verification>

<success_criteria>
- Toolbar shows Map Settings button with gear icon
- Dialog opens and loads current map data
- Apply saves all settings to Zustand store via updateMapHeader
- Close without saving prompts if changes exist
- Reset All resets all settings with confirmation
- No TypeScript errors
- Dialog accessible via toolbar, functional end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/10-map-settings-dialog/10-03-SUMMARY.md`
</output>
