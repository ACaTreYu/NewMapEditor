---
phase: 63-ruler-angle-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/slices/globalSlice.ts
  - src/utils/measurementFormatter.ts
  - src/components/MapCanvas/MapCanvas.tsx
  - src/components/StatusBar/StatusBar.tsx
  - src/components/RulerNotepadPanel/RulerNotepadPanel.tsx
  - src/components/RulerNotepadPanel/RulerNotepadPanel.css
autonomous: true

must_haves:
  truths:
    - "LINE mode displays angle from horizontal (0deg = right, 90deg = up, standard math convention)"
    - "PATH mode displays angle of each segment alongside segment length in overlay"
    - "Angle values update in real-time during ruler drag"
    - "Angles persist correctly when measurements are pinned"
    - "Pinned measurements can be hidden from canvas overlay while remaining in notepad"
    - "Hidden measurements retain full edit/delete/copy functionality in notepad"
  artifacts:
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "angle field on LINE measurement, segmentAngles on PATH measurement, visible boolean on pinned entries, toggleMeasurementVisibility action"
      contains: "angle"
    - path: "src/utils/measurementFormatter.ts"
      provides: "Angle display in formatted measurement strings"
      contains: "angle"
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "Angle calculation in mouse handlers, display in canvas overlay labels, filter pinned by visible"
      contains: "atan2"
    - path: "src/components/StatusBar/StatusBar.tsx"
      provides: "Angle display in status bar measurement readout"
      contains: "angle"
    - path: "src/components/RulerNotepadPanel/RulerNotepadPanel.tsx"
      provides: "Visibility toggle button per entry"
      contains: "toggleMeasurementVisibility"
  key_links:
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "setRulerMeasurement with angle field"
      pattern: "angle.*atan2"
    - from: "src/utils/measurementFormatter.ts"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "RulerMeasurement type with angle fields"
      pattern: "angle.*toFixed"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "pinnedMeasurements filtered by visible"
      pattern: "visible"
    - from: "src/components/RulerNotepadPanel/RulerNotepadPanel.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "toggleMeasurementVisibility action"
      pattern: "toggleMeasurementVisibility"
---

<objective>
Add angle measurements to the ruler tool's LINE and PATH modes, and decouple measurement visibility from notepad entries.

Purpose: Users measuring distances between map positions also need to know the direction/angle of their measurements. Additionally, users need to hide measurements from the canvas overlay while keeping them logged in the notepad — currently removing from one removes from both.

Output: LINE mode shows angle from horizontal (0-360 degrees, standard math convention). PATH mode shows per-segment angles. Angles appear in canvas overlay labels, status bar, and formatted measurement strings. Pinned measurements have independent visibility toggle (notepad always shows all entries, canvas only renders visible ones).
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-ruler-angle-display/63-RESEARCH.md
@src/core/editor/slices/globalSlice.ts
@src/utils/measurementFormatter.ts
@src/components/MapCanvas/MapCanvas.tsx
@src/components/StatusBar/StatusBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add angle fields to state type and formatter</name>
  <files>
    src/core/editor/slices/globalSlice.ts
    src/utils/measurementFormatter.ts
  </files>
  <action>
**globalSlice.ts** — Add angle fields to the `rulerMeasurement` type in the `GlobalSlice` interface:

1. In the LINE mode section (after `euclidean?: number;` around line 57), add:
   ```typescript
   angle?: number;  // Angle from horizontal in degrees (0-360, standard math convention)
   ```

2. In the PATH mode section (after `totalDistance?: number;` around line 63), add:
   ```typescript
   segmentAngles?: number[];  // Angle of each segment in degrees (0-360)
   ```

No other changes needed in globalSlice — the type flows through `NonNullable<GlobalSlice['rulerMeasurement']>` to pinnedMeasurements automatically.

**measurementFormatter.ts** — Update the local `RulerMeasurement` type AND `formatMeasurement` function:

1. Add `angle?: number;` and `segmentAngles?: number[];` to the local `RulerMeasurement` type (it mirrors the globalSlice type).

2. Update LINE mode format string to include angle when present:
   ```typescript
   if (m.mode === RulerMode.LINE) {
     const dx = Math.abs(m.endX - m.startX);
     const dy = Math.abs(m.endY - m.startY);
     const angleStr = m.angle !== undefined ? `, ${m.angle.toFixed(1)}°` : '';
     return `Line: ${dx}×${dy} (${dx + dy} tiles, ${Math.hypot(dx, dy).toFixed(1)} dist${angleStr})`;
   }
   ```

3. Update PATH mode format string to include segment count with angles:
   ```typescript
   if (m.mode === RulerMode.PATH) {
     const segCount = m.segmentAngles?.length ?? 0;
     const segInfo = segCount > 0 ? `, ${segCount} segs` : '';
     return `Path: ${m.waypoints?.length ?? 0} pts (${(m.totalDistance ?? 0).toFixed(1)} dist${segInfo})`;
   }
   ```
  </action>
  <verify>Run `npm run typecheck` — no type errors. The new optional fields don't break existing code since they're all optional.</verify>
  <done>globalSlice rulerMeasurement type has `angle?: number` and `segmentAngles?: number[]`. formatMeasurement includes angle in LINE output string and segment count in PATH output string.</done>
</task>

<task type="auto">
  <name>Task 2: Calculate angles in mouse handlers and display in overlay/status bar</name>
  <files>
    src/components/MapCanvas/MapCanvas.tsx
    src/components/StatusBar/StatusBar.tsx
  </files>
  <action>
**MapCanvas.tsx** — Add angle calculation to ALL places that call `setRulerMeasurement` for LINE and PATH modes, and update ALL overlay label strings.

**Angle calculation helper** (use inline, do NOT extract to separate function — it's 4 lines):
```typescript
// Standard math convention: 0° = right, 90° = up, 180° = left, 270° = down
// Canvas Y is inverted (increases downward), so dy = startY - endY
const adx = endX - startX;       // signed delta X
const ady = startY - endY;       // inverted signed delta Y
let angle = Math.atan2(ady, adx) * 180 / Math.PI;
if (angle < 0) angle += 360;
```

**Changes required (6 locations in MapCanvas.tsx):**

1. **handleMouseMove — LINE mode drag** (~line 1678): After computing dx/dy/manhattan/euclidean, calculate angle using signed coords `(x - prev.startX)` and `(prev.startY - y)`, add `angle` to the `setRulerMeasurement` call.

2. **handleMouseMove — PATH mode** (~line 1639-1668): After computing totalDistance, also compute `segmentAngles` array. For each pair of consecutive waypoints, calculate angle using `Math.atan2(wp[i].y - wp[i+1].y, wp[i+1].x - wp[i].x)`. Also calculate angle for the preview segment (last waypoint to cursor). Add `segmentAngles` to the `setRulerMeasurement` call.

3. **handleMouseDown — LINE click-click finalize** (~line 1511-1517): After computing dx/dy, calculate angle using signed coords `(x - prev.startX)` and `(prev.startY - y)`, add `angle` to the `setRulerMeasurement` call.

4. **drawUiLayer — active LINE overlay label** (~line 667-672): After computing dx/dy/manhattan/euclidean from `startX/startY/endX/endY`, calculate angle from signed deltas `(endX - startX)` and `(startY - endY)`. Change label text to:
   ```typescript
   const labelText = `Ruler: ${dx}×${dy} (Tiles: ${manhattan}, Dist: ${euclidean.toFixed(2)}, ${angle.toFixed(1)}°)`;
   ```

5. **drawUiLayer — completed LINE measurement label** (~line 895-899): Same angle calculation using `rulerMeasurement.endX - rulerMeasurement.startX` and `rulerMeasurement.startY - rulerMeasurement.endY`. Append angle to label text:
   ```typescript
   const labelText = `Ruler: ${dx}×${dy} (Tiles: ${manhattan}, Dist: ${euclidean.toFixed(2)}, ${angle.toFixed(1)}°)`;
   ```

6. **drawUiLayer — active PATH overlay label** (~line 832): Change label to include segment count and current segment angle. The current segment is the preview segment (last waypoint to cursor). Show:
   ```typescript
   const currentAngle = currentMeasurement?.segmentAngles?.length
     ? currentMeasurement.segmentAngles[currentMeasurement.segmentAngles.length - 1]
     : null;
   const angleStr = currentAngle !== null ? `, ${currentAngle.toFixed(1)}°` : '';
   const labelText = `Path: ${waypoints.length}pts, Dist: ${(currentMeasurement?.totalDistance ?? 0).toFixed(2)}${angleStr}`;
   ```

7. **drawUiLayer — completed PATH measurement label** (~line 1034): Show total segments and no inline angle (too many segments to show all):
   ```typescript
   const segCount = rulerMeasurement.segmentAngles?.length ?? 0;
   const segStr = segCount > 0 ? `, ${segCount} segs` : '';
   const labelText = `Path: ${waypoints.length}pts, Dist: ${(rulerMeasurement.totalDistance ?? 0).toFixed(2)}${segStr}`;
   ```

**IMPORTANT — Consistency rules:**
- Always use signed deltas for angle: `adx = endX - startX`, `ady = startY - endY` (Y inverted for standard math convention)
- Always normalize: `if (angle < 0) angle += 360`
- Always display with `.toFixed(1)` and degree symbol `°`
- Do NOT use `Math.abs()` on deltas before `Math.atan2()`
- The existing `dx` and `dy` variables in the code use `Math.abs()` — do NOT reuse them for angle. Create separate signed variables.

**StatusBar.tsx** — Update LINE and PATH measurement displays:

1. LINE mode (~line 228): Add angle display:
   ```tsx
   <>Ruler: {rulerMeasurement.dx}×{rulerMeasurement.dy} (Tiles: {rulerMeasurement.manhattan}, Dist: {rulerMeasurement.euclidean?.toFixed(2)}{rulerMeasurement.angle !== undefined ? `, ${rulerMeasurement.angle.toFixed(1)}°` : ''})</>
   ```

2. PATH mode (~line 234): Add segment count:
   ```tsx
   <>Path: {rulerMeasurement.waypoints?.length ?? 0}pts, {rulerMeasurement.totalDistance?.toFixed(2)}t{rulerMeasurement.segmentAngles?.length ? `, ${rulerMeasurement.segmentAngles.length} segs` : ''}</>
   ```
  </action>
  <verify>
1. `npm run typecheck` passes with no errors.
2. Visual verification: Run `npm run electron:dev`, select Ruler tool, draw a LINE going right (should show ~0°), going up (should show ~90°), going left (should show ~180°), going down (should show ~270°). Verify angle updates in real-time during drag.
3. PATH mode: Click multiple waypoints, verify angle of current segment shows in overlay. Finalize with double-click, verify "segs" count in completed label.
4. Pin a LINE measurement (press P), verify angle is preserved in status bar and notepad panel.
  </verify>
  <done>
All 4 success criteria satisfied:
- LINE mode displays angle from horizontal (0° = right, 90° = up, standard math convention)
- PATH mode displays angle of each segment alongside segment length
- Angle values update in real-time during ruler drag
- Angles persist correctly when measurements are pinned (stored in rulerMeasurement type, flows through to pinnedMeasurements and formatMeasurement)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add measurement visibility toggle</name>
  <files>
    src/core/editor/slices/globalSlice.ts
    src/components/MapCanvas/MapCanvas.tsx
    src/components/RulerNotepadPanel/RulerNotepadPanel.tsx
    src/components/RulerNotepadPanel/RulerNotepadPanel.css
  </files>
  <action>
**globalSlice.ts** — Add `visible` field and toggle action:

1. Add `visible: boolean` to the `pinnedMeasurements` array item type (alongside `id`, `measurement`, `label`):
   ```typescript
   pinnedMeasurements: Array<{
     id: string;
     measurement: NonNullable<GlobalSlice['rulerMeasurement']>;
     label?: string;
     visible: boolean;
   }>;
   ```

2. In the `pinMeasurement` action, default `visible: true` when creating entries:
   ```typescript
   { id: Date.now().toString(), measurement: current, visible: true }
   ```

3. Add `toggleMeasurementVisibility` action (alongside `unpinMeasurement`, `updateMeasurementLabel`):
   ```typescript
   toggleMeasurementVisibility: (id: string) => set((state) => ({
     pinnedMeasurements: state.pinnedMeasurements.map(p =>
       p.id === id ? { ...p, visible: !p.visible } : p
     )
   })),
   ```

4. Add the action type to the `GlobalSlice` interface:
   ```typescript
   toggleMeasurementVisibility: (id: string) => void;
   ```

**MapCanvas.tsx** — Filter pinned measurements by visibility in the overlay rendering:

In the `drawUiLayer` function (~line 1057-1059), change:
```typescript
const pinnedMeasurements = useEditorStore.getState().pinnedMeasurements;
for (const pinned of pinnedMeasurements) {
```
to:
```typescript
const pinnedMeasurements = useEditorStore.getState().pinnedMeasurements;
for (const pinned of pinnedMeasurements) {
  if (!pinned.visible) continue;
```

**RulerNotepadPanel.tsx** — Add visibility toggle button per entry:

1. Import `toggleMeasurementVisibility` from store:
   ```typescript
   const toggleMeasurementVisibility = useEditorStore(state => state.toggleMeasurementVisibility);
   ```

2. In the entry header (alongside the delete button), add a visibility toggle button BEFORE the delete button:
   ```tsx
   <div className="entry-header">
     <span className="entry-timestamp">{formatTimestamp(p.id)}</span>
     <div className="entry-actions">
       <button
         className={`entry-vis-btn${p.visible ? '' : ' entry-hidden'}`}
         onClick={() => toggleMeasurementVisibility(p.id)}
         title={p.visible ? 'Hide from map' : 'Show on map'}
       >
         {p.visible ? '◉' : '○'}
       </button>
       <button
         className="entry-delete-btn"
         onClick={() => handleDelete(p.id)}
         title="Remove"
       >
         ×
       </button>
     </div>
   </div>
   ```

3. Dim the entry-value when hidden — add conditional class:
   ```tsx
   <div className={`entry-value${p.visible ? '' : ' entry-value-hidden'}`}>
   ```

**RulerNotepadPanel.css** — Add styles for visibility toggle:

```css
.entry-actions {
  display: flex;
  align-items: center;
  gap: var(--space-0_25);
}

.entry-vis-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  padding: 0;
  border: none;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: var(--font-size-2xs);
  opacity: 0;
  transition: opacity 0.1s;
}

.notepad-entry:hover .entry-vis-btn {
  opacity: 1;
}

.entry-vis-btn.entry-hidden {
  opacity: 1;
  color: var(--text-secondary);
}

.entry-vis-btn:hover {
  color: var(--text-primary);
}

.entry-value-hidden {
  opacity: 0.4;
}
```
  </action>
  <verify>
1. `npm run typecheck` passes.
2. Pin a measurement, verify it appears both on canvas and in notepad.
3. Click the visibility toggle (◉) in notepad — measurement disappears from canvas but stays in notepad with dimmed text.
4. Click toggle again (○) — measurement reappears on canvas.
5. Hidden measurements can still be edited (label), deleted, and copied to clipboard.
6. New measurements default to visible.
  </verify>
  <done>
Pinned measurements have independent visibility from notepad. Canvas only renders visible entries. Notepad shows all entries with visibility toggle per entry. Edit/delete/copy work regardless of visibility state.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` — zero errors
2. LINE ruler: drag horizontal right = ~0°, straight up = ~90°, left = ~180°, down = ~270°
3. LINE ruler: diagonal (e.g., 3 tiles right, 3 tiles up) = ~45°
4. PATH ruler: each segment shows its own angle during active measurement
5. Pin measurement (P key): angle preserved in status bar, notepad panel, and clipboard export
6. Angle display uses 1 decimal place (e.g., "45.0°")
7. No regressions in RECTANGLE or RADIUS modes (they don't show angle)
8. Visibility toggle: hide a pinned measurement from canvas, verify it stays in notepad
9. Visibility toggle: re-show hidden measurement, verify it reappears on canvas
10. Hidden measurements retain edit/delete/copy functionality in notepad
</verification>

<success_criteria>
1. LINE mode displays angle from horizontal (0° = right, 90° = up, standard math convention) in overlay, status bar, and formatted text
2. PATH mode displays angle of current segment during active measurement and segment count when finalized
3. Angle values update in real-time during ruler drag (both click-click and drag interactions)
4. Angles persist correctly when measurements are pinned (via P key) — visible in notepad panel and clipboard export
5. Pinned measurements can be hidden from canvas overlay independently of notepad via visibility toggle
6. Hidden measurements remain fully functional in notepad (edit, delete, copy)
</success_criteria>

<output>
After completion, create `.planning/phases/63-ruler-angle-display/63-01-SUMMARY.md`
</output>
