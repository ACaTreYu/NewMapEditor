---
phase: 41-rotation-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/SelectionTransforms.ts
  - src/core/editor/slices/documentsSlice.ts
  - src/components/ToolBar/ToolBar.tsx
  - src/core/map/types.ts
autonomous: true

must_haves:
  truths:
    - "User can rotate selected tiles 90° clockwise in-place on the map"
    - "User can rotate selected tiles 90° counter-clockwise in-place on the map"
    - "User can rotate selected tiles 180° in-place on the map"
    - "Selection bounds resize to fit rotated dimensions (e.g., 3x5 becomes 5x3 for 90°)"
    - "Rotate toolbar button appears with dropdown listing all 4 rotation options"
  artifacts:
    - path: "src/core/map/SelectionTransforms.ts"
      provides: "Pure rotation algorithms (transpose+reverse for 90°, reversal for 180°)"
      min_lines: 100
      exports: ["rotate90Clockwise", "rotate90CounterClockwise", "rotate180"]
    - path: "src/core/editor/slices/documentsSlice.ts"
      provides: "rotateSelectionForDocument action"
      contains: "rotateSelectionForDocument"
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "ROTATE tool button with variant dropdown"
      contains: "ToolType.ROTATE"
    - path: "src/core/map/types.ts"
      provides: "ROTATE tool enum value"
      contains: "ROTATE = 'rotate'"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "documentsSlice.rotateSelectionForDocument"
      via: "variant dropdown setter (action button, not mode)"
      pattern: "rotateSelectionForDocument.*as 90"
    - from: "documentsSlice.rotateSelectionForDocument"
      to: "SelectionTransforms.rotate"
      via: "rotation algorithm call"
      pattern: "SelectionTransforms\\.rotate"
    - from: "documentsSlice.rotateSelectionForDocument"
      to: "pushUndoForDocument/commitUndoForDocument"
      via: "delta-based undo"
      pattern: "pushUndoForDocument.*commitUndoForDocument"
---

<objective>
Implement in-place rotation of selected map tiles with 4 rotation options (90°, -90°, 180°, -180°) accessible via toolbar button with variant dropdown.

Purpose: Enable users to rotate selected tiles directly on the map without clipboard manipulation, with automatic selection bound resizing to accommodate dimension changes.

Output: Working rotation feature with toolbar UI, pure rotation algorithms in portable core layer, and full undo/redo support via existing delta system.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@E:\NewMapEditor\.planning\PROJECT.md
@E:\NewMapEditor\.planning\ROADMAP.md
@E:\NewMapEditor\.planning\STATE.md
@E:\NewMapEditor\.planning\phases\41-rotation-tools\41-RESEARCH.md

# Relevant prior implementations
@E:\NewMapEditor\src\core\editor\slices\documentsSlice.ts
@E:\NewMapEditor\src\components\ToolBar\ToolBar.tsx
@E:\NewMapEditor\src\core\map\types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SelectionTransforms.ts with rotation algorithms and add ROTATE tool enum</name>
  <files>
    src/core/map/SelectionTransforms.ts
    src/core/map/types.ts
    src/core/map/index.ts
  </files>
  <action>
Create `src/core/map/SelectionTransforms.ts` with pure rotation algorithms using transpose+reverse pattern for 90° rotations and simple reversal for 180°:

1. **rotate90Clockwise(tiles: Uint16Array, width: number, height: number)**: Transpose then reverse rows. Returns {tiles: Uint16Array, width: newWidth, height: newHeight}. New dimensions are height×width.

2. **rotate90CounterClockwise(tiles: Uint16Array, width: number, height: number)**: Transpose then reverse columns. Returns {tiles: Uint16Array, width: newWidth, height: newHeight}. New dimensions are height×width.

3. **rotate180(tiles: Uint16Array, width: number, height: number)**: Reverse array order. Returns {tiles: Uint16Array, width, height}. Dimensions unchanged.

4. **rotate(tiles: Uint16Array, width: number, height: number, angle: 90 | -90 | 180 | -180)**: Dispatcher function that calls appropriate rotation based on angle. -180° is alias for 180° (mathematically identical).

Use Uint16Array everywhere to preserve 16-bit tile encoding including animation flags (bit 15). Follow research Pattern 1 and Pattern 2 for algorithm implementation.

Add `ROTATE = 'rotate'` to ToolType enum in `src/core/map/types.ts` after PICKER and before game object tools (consistent with tool category ordering).

Export SelectionTransforms from `src/core/map/index.ts` barrel file.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero TypeScript errors
2. Grep confirms all 4 rotation functions exist in SelectionTransforms.ts: `grep -E "(rotate90Clockwise|rotate90CounterClockwise|rotate180|^export function rotate)" src/core/map/SelectionTransforms.ts`
3. Grep confirms ToolType.ROTATE enum exists: `grep "ROTATE = 'rotate'" src/core/map/types.ts`
4. Grep confirms barrel export: `grep "SelectionTransforms" src/core/map/index.ts`
  </verify>
  <done>
SelectionTransforms.ts exists with 4 rotation functions using correct algorithms (transpose+reverse for 90°, reversal for 180°). ToolType.ROTATE enum value added. Module exported from barrel. Zero TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rotateSelectionForDocument action and ROTATE toolbar button with variant dropdown</name>
  <files>
    src/core/editor/slices/documentsSlice.ts
    src/components/ToolBar/ToolBar.tsx
  </files>
  <action>
**In documentsSlice.ts:**

Add `rotateSelectionForDocument: (id: DocumentId, angle: 90 | -90 | 180 | -180) => void` action following the in-place rotation pattern from research Pattern 3:

1. Get document and early return if no map or no active selection
2. Calculate selection bounds using min/max pattern (lines 448-451)
3. Extract selection into temp Uint16Array (pattern from lines 453-463)
4. Call SelectionTransforms.rotate(extracted, width, height, angle) to get rotated tiles
5. Snapshot for undo: `get().pushUndoForDocument(id)`
6. Clear original area with DEFAULT_TILE (existing pattern)
7. Write rotated tiles starting at minX/minY, clipping out-of-bounds with existing setTilesForDocument bounds check (pattern from lines 574-585)
8. Update selection bounds: `startX=minX, startY=minY, endX=Math.min(MAP_WIDTH-1, minX+rotated.width-1), endY=Math.min(MAP_HEIGHT-1, minY+rotated.height-1), active=true`
9. Commit undo: `get().commitUndoForDocument(id, \`Rotate ${angle}°\`)`

Import SelectionTransforms from '@core/map' and MAP_WIDTH/MAP_HEIGHT constants.

**In ToolBar.tsx:**

1. Add ROTATE to ToolType import
2. Add ROTATE variant config to variantConfigs array following existing pattern (lines 128-206):
```typescript
{
  tool: ToolType.ROTATE,
  settingName: 'Angle',
  getCurrentValue: () => 0, // No persistent value, action on click
  variants: [
    { label: '90° CW', value: 90 },
    { label: '90° CCW', value: -90 },
    { label: '180°', value: 180 },
    { label: '-180°', value: -180 },
  ],
  setter: (angle) => {
    const activeDocId = useEditorStore.getState().activeDocumentId;
    if (!activeDocId) return;
    const doc = useEditorStore.getState().documents.get(activeDocId);
    if (!doc || !doc.selection.active || doc.isPasting) return;
    useEditorStore.getState().rotateSelectionForDocument(activeDocId, angle as 90 | -90 | 180 | -180);
  }
}
```

3. Add ROTATE toolbar button to toolGroups array following existing pattern (after SELECT, before game object tools):
```typescript
{ type: ToolType.ROTATE, icon: '↻', label: 'Rotate', tooltip: 'Rotate selection', shortcut: null }
```

**IMPORTANT:** ROTATE is an ACTION BUTTON (executes immediately) not a MODE TOOL (sets persistent state). The variant setter directly calls rotateSelectionForDocument(id, angle) without storing angle value. This differs from game object tools which set persistent mode state.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero TypeScript errors
2. Grep confirms rotateSelectionForDocument exists: `grep "rotateSelectionForDocument:" src/core/editor/slices/documentsSlice.ts`
3. Grep confirms ROTATE variant config: `grep -A 10 "tool: ToolType.ROTATE" src/components/ToolBar/ToolBar.tsx`
4. Grep confirms SelectionTransforms import in documentsSlice: `grep "import.*SelectionTransforms" src/core/editor/slices/documentsSlice.ts`
5. `npm run electron:dev` starts without errors
6. Manual test: Create 3x5 selection with distinct tiles (place tiles 1-15 sequentially in rows). Rotate 90° CW. Verify result matches expected transpose+reverse pattern: first row becomes last column, dimensions swap to 5x3. Undo should restore original 3x5 layout with tiles in original positions.
  </verify>
  <done>
rotateSelectionForDocument action exists in documentsSlice with full implementation (extract → rotate → undo snapshot → write back → update bounds → commit undo). ROTATE toolbar button exists with 4-variant dropdown (90°, -90°, 180°, -180°). Rotation executes immediately on variant click. Selection bounds resize correctly. Undo/redo works via delta system. Zero TypeScript errors.
  </done>
</task>

</tasks>

<verification>
## Phase-Level Verification

After completing both tasks, verify the complete rotation feature:

**Functional verification:**
1. Open a map file
2. Use SELECT tool to create a rectangular selection (e.g., 3 tiles wide × 5 tiles tall)
3. Click ROTATE toolbar button → dropdown shows 4 options (90° CW, 90° CCW, 180°, -180°)
4. Select "90° CW" → selection rotates in-place, becomes 5 tiles wide × 3 tiles tall, top-left anchor preserved
5. Press Ctrl+Z → rotation undone, selection returns to original 3×5
6. Press Ctrl+Y → rotation redone, selection becomes 5×3 again
7. Try other rotation angles (90° CCW, 180°) → all work correctly
8. Rotate selection near map edge (e.g., x=250, y=250) → rotated tiles clipped to map bounds without error
9. Verify animated tiles preserve animation flags after rotation (bit 15 intact)
10. Verify ROTATE button dropdown only appears when ROTATE is active tool (consistent with variant pattern)

**Edge cases:**
- No selection active → ROTATE button clickable but variants no-op (early return in setter)
- Paste mode active (isPasting=true) → ROTATE variants no-op (early return in setter)
- 1×1 selection → rotation works, dimensions unchanged
- Non-square selection → 90° rotations swap width/height correctly

**Acceptance:**
- All ROT-01 through ROT-06 requirements met
- All must_haves truths observable
- All must_haves artifacts exist
- All key_links verified via grep patterns
</verification>

<success_criteria>
**Phase 41 complete when:**

1. User can rotate 3×5 selection 90° clockwise → becomes 5×3 rotated tiles
2. User can rotate selection 90° counter-clockwise → correct rotation applied
3. User can rotate selection 180° → tiles reversed, dimensions unchanged
4. Selection bounds resize automatically on 90° rotations (width ↔ height swap)
5. ROTATE toolbar button visible with dropdown listing all 4 angles
6. Undo/redo works correctly for all rotation operations
7. Rotations preserve 16-bit tile encoding including animation flags
8. Out-of-bounds rotated tiles silently clipped (no crashes near map edges)
9. Zero TypeScript errors, app starts and runs without issues
10. All 6 requirements (ROT-01 through ROT-06) verified as TRUE
</success_criteria>

<output>
After completion, create `.planning/phases/41-rotation-tools/41-01-SUMMARY.md` following the template at `C:\Users\arcje\.claude/get-shit-done/templates/summary.md`.

Summary should document:
- Task commits with rotation algorithm implementation and UI wiring
- Files created (SelectionTransforms.ts) and modified (documentsSlice.ts, ToolBar.tsx, types.ts)
- Key decisions (transpose+reverse vs other rotation algorithms, dimension swapping, bounds clipping)
- Patterns established (in-place transform pattern, variant dropdown for actions not modes)
- Testing notes (edge cases verified, animation flag preservation, bounds clipping)
</output>
