---
phase: 74-multi-tile-previews
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/MapCanvas/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "Animated warp tool (variant=1) shows 9 semi-transparent animated tiles in 3x3 grid centered on cursor during hover"
    - "Bunker tool shows full tile pattern at 70% opacity during rect drag, matching exact placement algorithm"
    - "Bridge tool shows full tile pattern at 70% opacity during rect drag, matching exact placement algorithm"
    - "Conveyor tool continues to show its existing preview (no regression)"
    - "All animated tiles in previews cycle frames using global animationFrame counter"
    - "Warp center tile (0x9E) preview encodes warpSrc/warpDest routing from gameObjectToolState"
  artifacts:
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "Multi-tile preview rendering for warp, bunker, bridge tools"
      contains: "ANIMATED_WARP_PATTERN"
  key_links:
    - from: "drawUiLayer warp preview"
      to: "ANIMATED_WARP_PATTERN + makeAnimatedTile"
      via: "import from GameObjectData + TileEncoding"
      pattern: "ANIMATED_WARP_PATTERN"
    - from: "drawUiLayer bunker preview"
      to: "BUNKER_DATA + gameObjectToolState.bunkerDir/bunkerStyle"
      via: "import from GameObjectData"
      pattern: "BUNKER_DATA"
    - from: "drawUiLayer bridge preview"
      to: "bridgeLrData/bridgeUdData + gameObjectToolState.bridgeDir"
      via: "import from GameObjectData"
      pattern: "bridgeLrData|bridgeUdData"
---

<objective>
Add semi-transparent multi-tile previews for warp (3x3 hover), bunker (rect drag), and bridge (rect drag) game object tools, using the same rendering pattern already proven in the conveyor preview.

Purpose: Users currently see only outlines when hovering/dragging with these tools — they cannot see what tiles will actually be placed. Adding tile previews at 70% opacity provides professional visual feedback matching the conveyor tool's existing behavior.

Output: Updated MapCanvas.tsx with preview rendering for 3 additional game object tools.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/74-multi-tile-previews/74-RESEARCH.md
@src/components/MapCanvas/MapCanvas.tsx
@src/core/map/GameObjectData.ts
@src/core/map/GameObjectSystem.ts (lines 133-360 for placement algorithms)
@src/core/map/TileEncoding.ts (makeAnimatedTile)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add animated warp 3x3 hover preview</name>
  <files>src/components/MapCanvas/MapCanvas.tsx</files>
  <action>
  Add semi-transparent 3x3 tile preview for the animated warp tool (variant=1) that renders on cursor hover before click.

  **Import additions** (line ~10):
  Add to the existing GameObjectData import: `ANIMATED_WARP_PATTERN`, `BUNKER_DATA`, `bridgeLrData`, `bridgeUdData`
  Add import: `import { makeAnimatedTile } from '@core/map/TileEncoding';`

  **Replace warp single-tile outline** (lines 430-438):
  The current warp cursor code at lines 430-438 draws a single-tile blue outline for all warp variants. Replace it with variant-aware rendering:

  - If `gameObjectToolState.warpVariant === 0` (single encoded warp): keep the existing single-tile blue outline as-is.
  - If `gameObjectToolState.warpVariant === 1` (animated 3x3 warp): render a 3x3 semi-transparent tile preview centered on cursor, PLUS the existing green/red 3x3 stroke outline used by stamp tools.

  For variant=1 preview rendering:
  1. Calculate `topLeftX = cx - 1`, `topLeftY = cy - 1` (center on cursor)
  2. Check bounds: `valid = cx - 1 >= 0 && cx + 1 < MAP_WIDTH && cy - 1 >= 0 && cy + 1 < MAP_HEIGHT`
  3. Set `ctx.globalAlpha = 0.7`
  4. Loop `row = 0..2`, `col = 0..2`:
     - Get base tile from `ANIMATED_WARP_PATTERN[row * 3 + col]`
     - For center tile (index 4, animId 0x9E): use `makeAnimatedTile(0x9E, gameObjectToolState.warpDest * 10 + gameObjectToolState.warpSrc)` to show routing-encoded animation
     - For border tiles: use `makeAnimatedTile(animId, 0)` where animId = baseTile & 0xFF
     - Render as animated tile: check `isAnim = (tile & 0x8000) !== 0`, look up `ANIMATION_DEFINITIONS[animId]`, compute `frameIdx = (animFrameRef.current + frameOffset) % anim.frameCount`, get `displayTile = anim.frames[frameIdx]`, draw from tileset
     - Calculate screen position: `screenX = Math.floor((topLeftX + col - vp.x) * tilePixels)`, same for Y
  5. Restore `ctx.globalAlpha = 1.0`
  6. Draw 3x3 outline around the preview (same as stamp tools): green if valid, red if invalid, 2px stroke

  The animated tile rendering code is identical to the conveyor preview (lines 513-525) — reuse that exact pattern.
  </action>
  <verify>
  Run `npm run typecheck` — no TypeScript errors.
  Visual: Select warp tool, set variant to animated (3x3), hover over map — should see 9 semi-transparent animated warp tiles centered on cursor with green/red validity outline.
  </verify>
  <done>
  Animated warp (variant=1) shows all 9 warp tiles at 70% opacity on hover, with animation cycling via global animationFrame. Center tile reflects current warpSrc/warpDest routing. Single warp (variant=0) still shows blue single-tile outline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bunker and bridge rect drag tile previews</name>
  <files>src/components/MapCanvas/MapCanvas.tsx</files>
  <action>
  Add semi-transparent tile previews for bunker and bridge tools during rect drag, using the exact same rendering pattern as the conveyor preview (lines 458-537). Insert the new preview blocks inside the existing `if (rectDragRef.current.active)` block (after line 537, before the rect outline drawing at line 540).

  **Bunker preview** — add after conveyor preview block:
  ```
  if (currentTool === ToolType.BUNKER && tilesetImage && w >= 2 && h >= 2) {
  ```
  1. Get pattern index: `const j = gameObjectToolState.bunkerStyle * 4 + gameObjectToolState.bunkerDir`
  2. Validate: `j >= 0 && j < BUNKER_DATA.length`
  3. Get pattern: `const pattern = BUNKER_DATA[j]`
  4. Set `ctx.globalAlpha = 0.7`
  5. Loop `row = 0..h-1`, `col = 0..w-1`:
     - Use EXACT same tile selection logic as `GameObjectSystem.placeBunker()` (lines 185-202):
       - `row === 0 && col === 0` → `pattern[0]`
       - `row === 0 && col === w - 1` → `pattern[3]`
       - `row === 0` → `pattern[1 + col % 2]`
       - `row === h - 1 && col === 0` → `pattern[12]`
       - `row === h - 1 && col === w - 1` → `pattern[15]`
       - `row === h - 1` → `pattern[13 + col % 2]`
       - `col === 0` → `pattern[4]`
       - `col === w - 1` → `pattern[7]`
       - else → `pattern[5 + (col % 2) + 4 * (row % 2)]`
     - If tile > -1: calculate screenX/Y and draw from tileset (static tiles, no animation check needed since bunker data is all static tile IDs)
  6. Restore `ctx.globalAlpha = 1.0`

  **Bridge preview** — add after bunker preview block:
  ```
  if (currentTool === ToolType.BRIDGE && tilesetImage && w >= 2 && h >= 2) {
  ```
  1. Get bridge data based on direction: `gameObjectToolState.bridgeDir === 0` → use `bridgeLrData[0]`, else use `bridgeUdData[0]`
  2. Validate data exists: `data && data[0] !== 0`
  3. Set `ctx.globalAlpha = 0.7`
  4. Loop `row = 0..h-1`, `col = 0..w-1`:
     - Use EXACT same tile selection logic as `GameObjectSystem.placeBridge()` (lines 286-350):
       - For direction 0 (LR): the full 15-tile edge pattern logic from lines 288-317
       - For direction 1 (UD): the full 15-tile edge pattern logic from lines 320-349
     - If tile > -1: calculate screenX/Y and draw from tileset (bridge tiles are static, no animation check needed — unless bridge data from custom.dat contains animated tiles, so include the animated tile check to be safe, same as conveyor preview)
  5. Restore `ctx.globalAlpha = 1.0`

  **Important:** All screen coordinate calculations use: `Math.floor((minX + col - vp.x) * tilePixels)` — same formula as conveyor preview. All tile-to-tileset source coords use: `srcX = (tile % TILES_PER_ROW) * TILE_SIZE`, `srcY = Math.floor(tile / TILES_PER_ROW) * TILE_SIZE`. Include the animated tile check (`tile & 0x8000`) for bridge tiles since custom.dat data could contain animated tile IDs.
  </action>
  <verify>
  Run `npm run typecheck` — no TypeScript errors.
  Visual checks:
  1. Select bunker tool, drag a rectangle on map — should see the full bunker tile pattern at 70% opacity during drag
  2. Change bunker style/direction — preview should update to match
  3. Select bridge tool (need custom.dat loaded), drag a rectangle — should see bridge tile pattern at 70% opacity
  4. Verify conveyor preview still works (no regression)
  </verify>
  <done>
  Bunker tool shows full tile pattern preview during rect drag matching exact placement algorithm. Bridge tool shows full tile pattern preview during rect drag matching exact placement algorithm. Conveyor tool preview unchanged. All previews render at 70% opacity with correct tile patterns.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. Warp tool (animated variant): hover shows 3x3 animated tile preview centered on cursor
3. Warp tool (single variant): hover shows blue single-tile outline (unchanged)
4. Bunker tool: drag shows full pattern preview at 70% opacity
5. Bridge tool: drag shows full pattern preview at 70% opacity (requires custom.dat)
6. Conveyor tool: drag preview still works (no regression)
7. All animated tile previews cycle frames in sync with placed animated tiles
8. Preview patterns match exactly what gets placed (no visual drift)
</verification>

<success_criteria>
- PREV-01: Multi-tile tools show full tile pattern as semi-transparent preview ✓
- PREV-02: Warp 3x3 preview shows all 9 tiles on hover ✓
- PREV-03: Bunker preview shows full pattern on drag ✓
- PREV-04: Bridge preview shows full pattern on drag (conveyor already has it) ✓
- All previews at 70% opacity matching existing conveyor pattern
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/74-multi-tile-previews/74-01-SUMMARY.md`
</output>
