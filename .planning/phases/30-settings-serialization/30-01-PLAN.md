---
phase: 30-settings-serialization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/MapSettingsDialog/MapSettingsDialog.tsx
autonomous: true

must_haves:
  truths:
    - "On save (Apply), all 53 extendedSettings serialize to description field as comma-space delimited Key=Value pairs"
    - "Non-flagger settings appear before flagger settings in serialized output"
    - "Author= metadata appends after the last settings entry"
    - "On load (dialog open), settings parse from description field and merge with extendedSettings"
    - "Description textarea is hidden from user interface"
    - "Legacy maps without settings in description load correctly with default values"
    - "Unrecognized Key=Value pairs are preserved through save round-trips"
    - "Out-of-range values are clamped to min/max bounds on parse"
  artifacts:
    - path: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      provides: "serializeSettings, parseSettings, buildDescription, parseDescription helpers + updated dialog logic"
      contains: "serializeSettings"
  key_links:
    - from: "MapSettingsDialog handleApply"
      to: "buildDescription(localSettings, mapAuthor)"
      via: "serializeSettings + Author append"
      pattern: "buildDescription.*localSettings"
    - from: "MapSettingsDialog open callback"
      to: "parseDescription(map.header.description)"
      via: "parseSettings + parseAuthor extraction"
      pattern: "parseDescription.*description"
---

<objective>
Auto-serialize all 53 extended game settings to the map's description field and parse them back on load. Remove the description textarea from the UI since the field is now fully machine-managed.

Purpose: Map settings must persist to the description field so game clients can read them. The description field transitions from user-editable text to an auto-generated settings store, enabling portability across different AC game clients.

Output: Updated MapSettingsDialog.tsx with serialize/parse helpers, updated open/apply logic, and description textarea removed.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-settings-serialization/30-RESEARCH.md
@.planning/phases/29-author-metadata/29-01-SUMMARY.md
@src/components/MapSettingsDialog/MapSettingsDialog.tsx
@src/core/map/GameSettings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings serialization and parsing helpers</name>
  <files>src/components/MapSettingsDialog/MapSettingsDialog.tsx</files>
  <action>
Replace the existing `parseAuthor` and `serializeAuthor` helper functions with four new helpers. These replace Phase 29's simple author-only helpers with a comprehensive settings system.

**1. `serializeSettings(settings: Record<string, number>): string`**
- Import `GAME_SETTINGS` from `@core/map` (already partially imported via `getSettingsByCategory` etc.)
- Split GAME_SETTINGS into two groups:
  - Non-flagger: `GAME_SETTINGS.filter(s => s.category !== 'Flagger')` — IMPORTANT: Do NOT use `s.key.startsWith('F')` because `FlagInPlay` and `FogOfWar` are Toggle settings that start with 'F' but are NOT flagger settings. Filter by category instead.
  - Flagger: `GAME_SETTINGS.filter(s => s.category === 'Flagger')`
- Sort each group alphabetically by key (`a.key.localeCompare(b.key)`)
- For each setting, emit `${setting.key}=${settings[setting.key] ?? setting.default}`
- Join all pairs with `, ` (comma-space)
- Non-flagger pairs come first, then flagger pairs (game client requirement)

**2. `parseSettings(description: string): { settings: Record<string, number>; unrecognized: string[] }`**
- Split description by `,` then `.map(p => p.trim()).filter(Boolean)`
- For each pair, match against `/^(\w+)=(.+)$/`
- If match: look up key in GAME_SETTINGS (use `.find(s => s.key === key)`)
  - If found: parse value as integer, clamp to `Math.max(setting.min, Math.min(setting.max, value))`, store in settings record
  - If not found: push the raw pair string to `unrecognized[]` (preserves future settings)
- If no match (not a Key=Value pair): push to `unrecognized[]` (preserves legacy text)
- Return `{ settings, unrecognized }`

**3. `buildDescription(settings: Record<string, number>, author: string, unrecognized?: string[]): string`**
- Call `serializeSettings(settings)` to get the settings string
- Build parts array: `[settingsStr]`
- If `author.trim()` is non-empty, push `Author=${author.trim()}`
- If `unrecognized` array has entries, push each one
- Join all parts with `, ` and return
- This ensures order: [settings] [Author=...] [unrecognized...]

**4. `parseDescription(description: string): { settings: Record<string, number>; author: string; unrecognized: string[] }`**
- Call `parseSettings(description)` to get `{ settings, unrecognized }`
- Find Author entry: `unrecognized.find(p => p.startsWith('Author='))`
- Extract author value: `authorPair.slice('Author='.length).trim()` or empty string
- Filter Author entry out of unrecognized array: `unrecognized.filter(p => !p.startsWith('Author='))`
- Return `{ settings, author, unrecognized }`

Also update the import line to include `GAME_SETTINGS`:
```typescript
import { SETTING_CATEGORIES, GAME_SETTINGS, getSettingsByCategory, getDefaultSettings } from '@core/map';
```

Delete the old `parseAuthor` and `serializeAuthor` functions entirely.
  </action>
  <verify>
Run `npm run typecheck` — no new TypeScript errors. Verify that `serializeSettings`, `parseSettings`, `buildDescription`, `parseDescription` are defined in the file. Verify `parseAuthor` and `serializeAuthor` are removed.
  </verify>
  <done>
Four helper functions exist in MapSettingsDialog.tsx: serializeSettings (outputs non-flagger before flagger, alphabetically within each group), parseSettings (clamps values, preserves unrecognized), buildDescription (settings then Author then unrecognized), parseDescription (extracts settings + author + unrecognized from description string). Old parseAuthor/serializeAuthor functions are deleted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate helpers into dialog and remove description textarea</name>
  <files>src/components/MapSettingsDialog/MapSettingsDialog.tsx</files>
  <action>
**Update the `open()` callback** in useImperativeHandle:
- After loading `map.header.description`, call `parseDescription(map.header.description)` to get `{ settings, author, unrecognized }`
- Set `setMapAuthor(author)`
- Store unrecognized pairs in a new `useRef<string[]>([])` called `unrecognizedRef` (persists across renders without triggering re-renders). Set it: `unrecognizedRef.current = unrecognized`
- Merge parsed settings with defaults and extendedSettings: `setLocalSettings({ ...getDefaultSettings(), ...settings, ...map.header.extendedSettings })`
  - Defaults first (ensures all 53 keys exist), then parsed description settings (may override defaults), then extendedSettings from header (takes priority since it's the runtime state)
- Remove `setMapDescription(map.header.description)` — the mapDescription state is no longer needed

**Update `handleApply()`:**
- Replace `description: serializeAuthor(mapDescription, mapAuthor)` with:
  `description: buildDescription(localSettings, mapAuthor, unrecognizedRef.current)`
- This generates the full description string from current settings + author + preserved unrecognized pairs

**Remove description-related state and UI:**
- Delete the `mapDescription` state: `const [mapDescription, setMapDescription] = useState('');`
- Delete the `setMapDescriptionWithDirty` function
- Remove the entire description textarea JSX block from the Map tab:
  ```tsx
  {/* DELETE THIS ENTIRE BLOCK: */}
  <div className="setting-group">
    <label className="setting-label">Description</label>
    <textarea
      value={mapDescription}
      onChange={(e) => setMapDescriptionWithDirty(e.target.value)}
      className="text-area"
      rows={3}
      maxLength={256}
    />
  </div>
  ```

**Add unrecognizedRef:**
- Add `const unrecognizedRef = useRef<string[]>([]);` near the other refs at the top of the component (after `dialogRef`)
  </action>
  <verify>
Run `npm run typecheck` — no TypeScript errors. Verify that:
1. `mapDescription` state is removed
2. `setMapDescriptionWithDirty` function is removed
3. Description textarea JSX is removed from the Map tab
4. `handleApply` calls `buildDescription(localSettings, mapAuthor, unrecognizedRef.current)`
5. `open()` callback calls `parseDescription(map.header.description)`
6. `unrecognizedRef` is declared as a `useRef<string[]>([])`
  </verify>
  <done>
MapSettingsDialog Map tab shows only Name and Author fields (description textarea removed). On Apply, description field is auto-generated from all 53 settings + author + preserved unrecognized pairs. On open, settings are parsed from description and merged with defaults and extendedSettings. Legacy maps without settings in description load with defaults. Unrecognized Key=Value pairs survive round-trips.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. Open Map Settings dialog — Map tab shows only "Map Name" and "Author" fields, no description textarea
3. Click Apply — `map.header.description` contains all 53 settings as comma-space-delimited Key=Value pairs, with non-flagger settings before flagger settings, and Author= at the end (if set)
4. Close and reopen Map Settings — all settings values are preserved (round-trip integrity)
5. Toggle settings (FogOfWar, FlagInPlay, etc.) appear BEFORE flagger settings in output (they are NOT F-prefixed flagger settings despite starting with 'F')
6. Load a legacy map with no settings in description — defaults applied, dialog shows correct values
7. Save a map with unrecognized Key=Value pairs in description — they survive the round-trip
</verification>

<success_criteria>
- All 53 extendedSettings auto-serialize to description field on Apply
- Non-flagger settings appear before flagger settings (category-based, not prefix-based)
- Author= metadata appears after settings
- Settings parse from description on dialog open and merge with extendedSettings
- Description textarea is not visible in Map Settings dialog
- Legacy maps load with default settings values
- Unrecognized pairs preserved through save round-trips
- Out-of-range values clamped on parse
- `npm run typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/30-settings-serialization/30-01-SUMMARY.md`
</output>
