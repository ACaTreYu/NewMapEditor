---
phase: 06-collapsible-panels
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/App.css
  - src/components/TabbedBottomPanel/TabbedBottomPanel.tsx
  - src/components/TabbedBottomPanel/TabbedBottomPanel.css
  - src/components/TabbedBottomPanel/index.ts
  - src/components/index.ts
autonomous: true

must_haves:
  truths:
    - "Bottom panel opens at 20% height by default on app launch"
    - "User can collapse panel to show only the tab bar"
    - "User can click collapse button on divider to toggle collapse/expand"
    - "User can double-click divider to toggle collapse/expand"
    - "User can drag panel down to collapse it (snap at threshold)"
    - "Clicking any tab when collapsed expands panel and shows that tab content"
    - "Panel height persists within session when switching tabs"
    - "No animation/transition when collapsing or expanding"
  artifacts:
    - path: "src/components/TabbedBottomPanel/TabbedBottomPanel.tsx"
      provides: "Tabbed panel with Tiles/Animations/Settings tabs"
      exports: ["TabbedBottomPanel"]
    - path: "src/components/TabbedBottomPanel/TabbedBottomPanel.css"
      provides: "Tab bar styling and collapsed state styles"
      contains: ".tab-bar"
    - path: "src/App.tsx"
      provides: "Vertical panel layout with collapsible bottom"
      contains: "collapsible={true}"
  key_links:
    - from: "src/App.tsx"
      to: "TabbedBottomPanel"
      via: "import and render"
      pattern: "import.*TabbedBottomPanel"
    - from: "src/App.tsx"
      to: "bottomPanelRef"
      via: "imperative collapse API"
      pattern: "bottomPanelRef\\.current"
    - from: "src/components/TabbedBottomPanel/TabbedBottomPanel.tsx"
      to: "panelRef.current"
      via: "expand on tab click when collapsed"
      pattern: "panelRef.*isCollapsed.*expand"
---

<objective>
Create a collapsible tabbed bottom panel that maximizes canvas space

Purpose: Users need to maximize their editing canvas while retaining quick access to tiles, animations, and settings. The bottom panel should collapse to just the tab bar, giving full canvas space when needed.

Output: Vertical layout with collapsible TabbedBottomPanel, collapse button on divider, instant transitions
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-collapsible-panels/06-CONTEXT.md
@.planning/phases/06-collapsible-panels/06-RESEARCH.md
@src/App.tsx
@src/App.css
@src/components/RightSidebar/RightSidebar.tsx
@src/components/TilePalette/TilePalette.tsx
@src/components/AnimationPanel/AnimationPanel.tsx
@src/components/MapSettingsPanel/MapSettingsPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TabbedBottomPanel component with tabs and collapse-aware behavior</name>
  <files>
    src/components/TabbedBottomPanel/TabbedBottomPanel.tsx
    src/components/TabbedBottomPanel/TabbedBottomPanel.css
    src/components/TabbedBottomPanel/index.ts
    src/components/index.ts
  </files>
  <action>
Create a new TabbedBottomPanel component that displays three tabs (Tiles, Animations, Settings) with their content panels.

**TabbedBottomPanel.tsx requirements:**
- Accept props: `tilesetImage: HTMLImageElement | null` and `panelRef: React.RefObject<ImperativePanelHandle>`
- Import ImperativePanelHandle type from 'react-resizable-panels'
- Maintain local state for activeTab (default: 'tiles')
- Tab bar at top with three tabs: Tiles (grid icon), Animations (play icon), Settings (gear icon)
- Use simple SVG icons inline or unicode symbols for tab icons
- Tab click handler: if `panelRef.current?.isCollapsed()` then call `panelRef.current.expand()` BEFORE setting activeTab
- Use CSS `hidden` attribute to hide inactive tab content (preserve scroll position, don't unmount)
- Include TilePalette, AnimationPanel, and MapSettingsPanel as tab content
- ARIA attributes: role="tablist" on tab container, role="tab" on buttons, role="tabpanel" on content divs

**TabbedBottomPanel.css requirements:**
- .tabbed-bottom-panel: flex column, full height, background var(--bg-secondary)
- .tab-bar: flex row, height 32px, border-bottom 1px solid var(--border-default)
- .tab: padding 8px 16px, no border, cursor pointer, display flex align-items center gap 4px
- .tab:hover: background var(--bg-hover)
- .tab.active: border-bottom 2px solid var(--accent-primary)
- .tab-content: flex 1, overflow hidden
- .tab-content[hidden]: display none
- NO transitions on any elements (instant feel per user decision)

**index.ts:** Export TabbedBottomPanel
**components/index.ts:** Add export for TabbedBottomPanel
  </action>
  <verify>
- TypeScript compiles: `npm run typecheck`
- Component file exists with proper structure
- CSS uses theme variables (no hardcoded colors)
  </verify>
  <done>
TabbedBottomPanel component exists with tab bar showing three tabs, click handler that expands collapsed panel before switching, and themed CSS styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert App.tsx to vertical layout with collapsible bottom panel</name>
  <files>
    src/App.tsx
    src/App.css
  </files>
  <action>
Convert the horizontal panel layout to vertical with a collapsible bottom panel.

**App.tsx changes:**

1. Update imports:
   - Change `react-resizable-panels` import to include ImperativePanelHandle type
   - Add useRef import if not present
   - Import TabbedBottomPanel from '@components'
   - Remove RightSidebar import

2. Add state and ref:
   ```typescript
   const bottomPanelRef = useRef<ImperativePanelHandle>(null);
   const [isCollapsed, setIsCollapsed] = useState(false);
   ```

3. Add collapse toggle handler:
   ```typescript
   const handleToggleCollapse = useCallback(() => {
     const panel = bottomPanelRef.current;
     if (!panel) return;
     if (panel.isCollapsed()) {
       panel.expand();
     } else {
       panel.collapse();
     }
   }, []);
   ```

4. Add layout change handler to track collapsed state:
   ```typescript
   const handleBottomLayoutChange = useCallback(() => {
     const panel = bottomPanelRef.current;
     if (panel) {
       setIsCollapsed(panel.isCollapsed());
     }
   }, []);
   ```

5. Update localStorage key to 'editor-panel-sizes-v3' (vertical layout)
   - Default layout: { main: 80, bottom: 20 }

6. Replace horizontal PanelGroup with vertical layout:
   ```tsx
   <PanelGroup
     orientation="vertical"
     onLayout={handleBottomLayoutChange}
     className="app-content"
   >
     <Panel id="main" defaultSize={80} minSize={30}>
       <div className="main-area">
         <MapCanvas tilesetImage={tilesetImage} onCursorMove={handleCursorMove} />
         <Minimap tilesetImage={tilesetImage} />
       </div>
     </Panel>

     <PanelResizeHandle
       className="resize-handle-horizontal"
       onDoubleClick={handleToggleCollapse}
     >
       <button
         onClick={handleToggleCollapse}
         className={`collapse-button ${isCollapsed ? 'collapsed' : 'expanded'}`}
         aria-label={isCollapsed ? "Expand panel" : "Collapse panel"}
       />
     </PanelResizeHandle>

     <Panel
       id="bottom"
       ref={bottomPanelRef}
       defaultSize={20}
       minSize={5}
       collapsible={true}
       collapsedSize={3}
     >
       <TabbedBottomPanel
         tilesetImage={tilesetImage}
         panelRef={bottomPanelRef}
       />
     </Panel>
   </PanelGroup>
   ```

7. Remove localStorage persistence for panel sizes (per user decision: "Always start expanded at 20% height on app launch, no persistence across sessions")
   - Remove defaultLayout state initialization from localStorage
   - Remove onLayoutChanged callback that saves to localStorage
   - Keep handleBottomLayoutChange for tracking collapsed state

**App.css changes:**

1. Add horizontal resize handle styles (for bottom panel divider):
   ```css
   .resize-handle-horizontal {
     flex: 0 0 6px;
     background-color: var(--border-subtle);
     cursor: row-resize;
     position: relative;
     display: flex;
     align-items: center;
     justify-content: center;
   }

   .resize-handle-horizontal:hover {
     background-color: var(--accent-primary);
   }

   .resize-handle-horizontal[data-resize-handle-active] {
     background-color: var(--accent-primary);
   }
   ```

2. Add collapse button styles (using CSS border triangle pattern from Phase 5):
   ```css
   .collapse-button {
     display: flex;
     align-items: center;
     justify-content: center;
     width: 24px;
     height: 14px;
     background-color: var(--scrollbar-track);
     border: 1px solid var(--border-default);
     cursor: pointer;
     padding: 0;
     z-index: 1;
   }

   .collapse-button:hover {
     background-color: var(--bg-hover);
   }

   .collapse-button::after {
     content: '';
     display: block;
     width: 0;
     height: 0;
     border-style: solid;
   }

   /* Chevron up when collapsed (pointing up to indicate "expand") */
   .collapse-button.collapsed::after {
     border-width: 0 4px 5px 4px;
     border-color: transparent transparent var(--text-secondary) transparent;
   }

   /* Chevron down when expanded (pointing down to indicate "collapse") */
   .collapse-button.expanded::after {
     border-width: 5px 4px 0 4px;
     border-color: var(--text-secondary) transparent transparent transparent;
   }
   ```

3. Ensure NO transitions on panel elements (instant collapse/expand):
   ```css
   [data-panel-resize-handle-id],
   [data-panel-id],
   [data-panel-group-id] {
     transition: none !important;
   }
   ```

4. Keep existing vertical resize handle styles for future horizontal panel splits if needed.
  </action>
  <verify>
- App loads without errors: `npm run electron:dev`
- Panel starts at 20% height
- Collapse button visible on divider
- Click collapse button toggles panel collapse/expand
- Double-click divider toggles collapse/expand
- Drag panel down past threshold collapses it
- Clicking tab when collapsed expands panel
- No animation during collapse/expand
  </verify>
  <done>
Vertical layout with collapsible bottom panel working: 20% default height, collapse button on divider, double-click toggles, drag-to-collapse works, tab click expands when collapsed, instant transitions
  </done>
</task>

</tasks>

<verification>
Run the app and verify all four PNL requirements:

1. **PNL-01** (20% default): App launches with bottom panel at 20% height
2. **PNL-02** (collapse to tab bar): Click collapse button OR drag down OR double-click divider - panel collapses to show only tab bar
3. **PNL-03** (expand button): Collapse button visible on divider, click to restore panel
4. **PNL-04** (double-click reset): Double-click divider toggles between collapsed and expanded states

Additional verification:
- Tabs work correctly (switch content, preserve state)
- Tab click when collapsed expands the panel
- No visible animation/transition during collapse/expand
- Window resize maintains percentage-based panel proportions
</verification>

<success_criteria>
- All four PNL requirements (PNL-01 through PNL-04) satisfied
- TabbedBottomPanel component created with three working tabs
- Vertical layout with canvas top, collapsible bottom panel
- Collapse button on divider using CSS border triangle chevron
- Double-click divider toggles collapse/expand
- Drag-to-collapse snaps at threshold
- Tab click when collapsed expands panel first
- No transitions/animations (instant feel)
- TypeScript compiles without errors
- App runs without console errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-collapsible-panels/06-01-SUMMARY.md`
</output>
