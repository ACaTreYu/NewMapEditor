---
phase: 44-animation-visibility-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/AnimationPanel/AnimationPanel.tsx
autonomous: false

must_haves:
  truths:
    - "Animated tiles at viewport center at 1x zoom play their animation"
    - "Animated tiles at 0.25x zoom (full map visible) continue animating"
    - "Animated tiles at 4x zoom render without artifacts"
    - "Animation loop pauses when viewport contains zero animated tiles"
  artifacts:
    - path: "src/components/AnimationPanel/AnimationPanel.tsx"
      provides: "Fixed hasVisibleAnimatedTiles() with correct tile coordinate math"
      contains: "Math.floor(viewport.x)"
  key_links:
    - from: "AnimationPanel.tsx hasVisibleAnimatedTiles()"
      to: "viewport tile coordinates"
      via: "direct use of viewport.x/y as tile coords (no pixel division)"
      pattern: "Math\\.floor\\(viewport\\.x\\)"
---

<objective>
Fix the animation visibility bug that prevents animated tiles from rendering at normal zoom levels (1x-4x). The root cause is a coordinate system confusion in `hasVisibleAnimatedTiles()` that treats tile coordinates as pixel coordinates.

Purpose: Animated tiles only play at extreme zoom-out (0.25x) because the viewport bounds calculation divides tile coordinates by `(TILE_SIZE * zoom)` as if they were pixel values. This makes the animation loop think no animated tiles are visible at normal zoom levels.

Output: Fixed `hasVisibleAnimatedTiles()` function using the proven coordinate pattern from `MapCanvas.getVisibleTiles()`.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-animation-visibility-fix/44-RESEARCH.md

# Source files
@src/components/AnimationPanel/AnimationPanel.tsx
@src/components/MapCanvas/MapCanvas.tsx (lines 139-153 — getVisibleTiles reference pattern)
@src/core/editor/slices/types.ts (lines 11-15 — Viewport type confirms tile coordinates)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hasVisibleAnimatedTiles coordinate math</name>
  <files>src/components/AnimationPanel/AnimationPanel.tsx</files>
  <action>
Replace the broken viewport bounds calculation in `hasVisibleAnimatedTiles()` (lines 55-58) with the correct tile-based pattern from `MapCanvas.getVisibleTiles()` (lines 139-153).

**Current broken code (lines 55-58):**
```typescript
const startX = Math.max(0, Math.floor(viewport.x / (TILE_SIZE * viewport.zoom)));
const startY = Math.max(0, Math.floor(viewport.y / (TILE_SIZE * viewport.zoom)));
const endX = Math.min(MAP_SIZE, Math.ceil((viewport.x + window.innerWidth) / (TILE_SIZE * viewport.zoom)));
const endY = Math.min(MAP_SIZE, Math.ceil((viewport.y + window.innerHeight) / (TILE_SIZE * viewport.zoom)));
```

**Replace with correct code:**
```typescript
// viewport.x/y are already in tile coordinates (see types.ts Viewport interface)
const tilePixels = TILE_SIZE * viewport.zoom;
// Conservative canvas estimate (AnimationPanel doesn't have canvas ref)
// 1920x1080 covers most displays; overestimating is safe (just checks more tiles)
const tilesX = Math.ceil(1920 / tilePixels) + 1;
const tilesY = Math.ceil(1080 / tilePixels) + 1;

const startX = Math.max(0, Math.floor(viewport.x));
const startY = Math.max(0, Math.floor(viewport.y));
const endX = Math.min(MAP_SIZE, Math.floor(viewport.x) + tilesX);
const endY = Math.min(MAP_SIZE, Math.floor(viewport.y) + tilesY);
```

**Why 1920x1080 instead of window.innerWidth:**
- AnimationPanel doesn't have access to the map canvas element
- Using window.innerWidth overestimates (includes sidebars), but that's a performance issue not a correctness issue
- 1920x1080 is a reasonable conservative maximum canvas size
- Overestimating means we check a few extra tiles (cheap), underestimating would miss visible animated tiles (broken)
- The critical fix is removing the `/ (TILE_SIZE * viewport.zoom)` division from viewport.x/y

**Why this fixes the bug:**
- viewport.x = 50 means "tile 50 from left" (confirmed by Viewport type definition)
- Old code: `50 / (16 * 1) = 3.125` — checks wrong tile range, misses animated tiles
- New code: `Math.floor(50) = 50` — checks correct tile range
- At 0.25x zoom the old code accidentally worked because the huge tile ranges overlapped the correct viewport

Do NOT change anything else in the file. The animation loop (lines 88-110), draw function, and all other code is correct.
  </action>
  <verify>
Run `npm run typecheck` to confirm no TypeScript errors.

Manual verification: Read the modified function and confirm:
1. viewport.x is NOT divided by TILE_SIZE or zoom (it's used directly with Math.floor)
2. viewport.y is NOT divided by TILE_SIZE or zoom (it's used directly with Math.floor)
3. tilesX/tilesY are calculated from canvas dimensions divided by (TILE_SIZE * zoom)
4. endX/endY use Math.min(MAP_SIZE, ...) to clamp
  </verify>
  <done>
hasVisibleAnimatedTiles() uses viewport.x/y directly as tile coordinates (no pixel division), matching the proven pattern from MapCanvas.getVisibleTiles(). TypeScript compiles without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed animation visibility at all zoom levels by correcting coordinate math in hasVisibleAnimatedTiles()</what-built>
  <how-to-verify>
1. Run `npm run electron:dev` to start the editor
2. Open or create a map
3. Load animation data (Gfx.dll) if not already loaded
4. Place an animated tile near the center of the map (around tile 128,128)
5. **Test at 1x zoom**: Scroll to the animated tile — verify the animation plays (tile cycles through frames)
6. **Test at 0.25x zoom**: Zoom out fully with mouse wheel — verify the animated tile still animates
7. **Test at 4x zoom**: Zoom in close to the animated tile — verify animation plays without artifacts
8. **Test no-animation case**: Scroll viewport far away from any animated tiles — verify CPU usage stays low (animation loop should pause)
  </how-to-verify>
  <resume-signal>Type "approved" if animations work at all zoom levels, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. AnimationPanel.tsx hasVisibleAnimatedTiles() no longer divides viewport.x/y by (TILE_SIZE * zoom)
3. Animated tiles render and play at 1x, 0.25x, 2x, and 4x zoom levels
4. Animation loop pauses when viewport is scrolled away from all animated tiles
</verification>

<success_criteria>
- Animated tiles visible in the map canvas at ANY zoom level (0.25x to 4x) show playing animations
- The animation loop correctly pauses when no animated tiles are in the viewport
- No TypeScript compilation errors
- No visual artifacts at any zoom level
</success_criteria>

<output>
After completion, create `.planning/phases/44-animation-visibility-fix/44-01-SUMMARY.md`
</output>
