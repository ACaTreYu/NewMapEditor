---
phase: 70-animation-offset-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/slices/globalSlice.ts
  - src/components/AnimationPanel/AnimationPanel.tsx
  - src/components/AnimationPanel/AnimationPanel.css
  - src/core/map/GameObjectSystem.ts
  - src/core/editor/slices/documentsSlice.ts
autonomous: true

must_haves:
  truths:
    - "User can set animation offset (0-127) in the Animations panel offset input"
    - "Placed animated spawn tiles encode the current panel offset value"
    - "Placed animated warp tiles encode the current panel offset value"
    - "Offset value persists between placements until user changes it (GlobalSlice state)"
    - "Offset input shows error state for out-of-range values (< 0 or > 127)"
    - "Offset input is disabled when placement mode is 'tile' (not 'anim')"
  artifacts:
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "animationOffsetInput state + setAnimationOffsetInput action"
      contains: "animationOffsetInput"
    - path: "src/components/AnimationPanel/AnimationPanel.tsx"
      provides: "Offset input wired to GlobalSlice instead of local state"
      contains: "setAnimationOffsetInput"
    - path: "src/core/map/GameObjectSystem.ts"
      provides: "Offset parameter on placeAnimatedSpawn and placeAnimatedWarp"
      contains: "makeAnimatedTile"
    - path: "src/core/editor/slices/documentsSlice.ts"
      provides: "Offset read from GlobalSlice and passed to GameObjectSystem"
      contains: "animationOffsetInput"
  key_links:
    - from: "src/components/AnimationPanel/AnimationPanel.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "useEditorStore((state) => state.animationOffsetInput)"
      pattern: "animationOffsetInput"
    - from: "src/core/editor/slices/documentsSlice.ts"
      to: "src/core/map/GameObjectSystem.ts"
      via: "get().animationOffsetInput passed to placeAnimatedSpawn/placeAnimatedWarp"
      pattern: "animationOffsetInput"
    - from: "src/core/map/GameObjectSystem.ts"
      to: "src/core/map/TileEncoding.ts"
      via: "makeAnimatedTile(animId, offset)"
      pattern: "makeAnimatedTile"
---

<objective>
Add animation offset state to GlobalSlice, wire AnimationPanel to use it, parameterize GameObjectSystem placement methods with offset, and connect documentsSlice callers to read offset from GlobalSlice.

Purpose: Enable users to control animation frame offset (0-127) for placed tiles, with the value persisting across placements and encoding correctly into tile data.

Output: Working offset control from AnimationPanel through to tile placement, with input validation and error feedback.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/70-animation-offset-control/70-RESEARCH.md
@src/core/editor/slices/globalSlice.ts
@src/components/AnimationPanel/AnimationPanel.tsx
@src/components/AnimationPanel/AnimationPanel.css
@src/core/map/GameObjectSystem.ts
@src/core/editor/slices/documentsSlice.ts
@src/core/map/TileEncoding.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add animationOffsetInput to GlobalSlice and wire AnimationPanel</name>
  <files>
    src/core/editor/slices/globalSlice.ts
    src/components/AnimationPanel/AnimationPanel.tsx
    src/components/AnimationPanel/AnimationPanel.css
  </files>
  <action>
**globalSlice.ts:**
1. Add `animationOffsetInput: number` to the `GlobalSlice` interface (after `customDatLoaded` field, near other tool state). Default value: 0.
2. Add `setAnimationOffsetInput: (offset: number) => void` to the interface actions section (near setGameObjectTeam).
3. In `createGlobalSlice`, add initial state `animationOffsetInput: 0`.
4. Add action implementation: `setAnimationOffsetInput: (offset) => set({ animationOffsetInput: Math.max(0, Math.min(127, offset)) })` — clamps to 0-127 range, matching the `setGridOpacity` clamping pattern.

**AnimationPanel.tsx:**
1. Remove the local `frameOffset` state: `const [frameOffset, setFrameOffset] = useState(0)` — delete this line.
2. Add Zustand subscriptions:
   ```
   const animationOffsetInput = useEditorStore((state) => state.animationOffsetInput);
   const setAnimationOffsetInput = useEditorStore((state) => state.setAnimationOffsetInput);
   ```
3. Replace all references to `frameOffset` with `animationOffsetInput` (there are 4 occurrences):
   - Line 253: `const animatedTile = ANIMATED_FLAG | (frameOffset << 8) | animId` → use `animationOffsetInput`
   - Line 273: same pattern in handleDoubleClick
   - Line 289: `const animatedTile = ANIMATED_FLAG | (num << 8) | selectedAnimId` — keep `num` here since this is the onChange handler
   - Line 302: same pattern in handleModeChange
4. Update `handleOffsetChange` to use `setAnimationOffsetInput(num)` instead of `setFrameOffset(num)`. Also add error state tracking:
   - Add local state: `const [offsetError, setOffsetError] = useState(false)`
   - In handleOffsetChange, if value is empty or NaN or out of range (< 0 or > 127), set `setOffsetError(true)` and return without updating store
   - If valid, call `setOffsetError(false)` then `setAnimationOffsetInput(num)`
   - Also update the selected tile encoding in the valid case (keep existing logic)
5. Update the offset `<input>` element:
   - Change `value={frameOffset}` to `value={animationOffsetInput}`
   - Add className conditional: `className={\`offset-input ${offsetError ? 'error' : ''}\`}`
   - Keep `disabled={placementMode !== 'anim'}` as-is

**AnimationPanel.css:**
Add error styling for the offset input (after the `.offset-input:disabled` rule at ~line 136):
```css
.offset-input.error {
  border-color: var(--color-error, #e53935);
  background-color: color-mix(in oklch, var(--color-error, #e53935) 10%, var(--input-bg));
}
```
Use `color-mix` with fallback to keep the OKLCH design system consistent. If `--color-error` doesn't exist as a CSS variable, the fallback `#e53935` provides a standard error red.
  </action>
  <verify>
Run `npm run typecheck` — zero errors. Confirm `animationOffsetInput` appears in globalSlice.ts interface and implementation. Confirm `frameOffset` does NOT appear anywhere in AnimationPanel.tsx (fully replaced by `animationOffsetInput`).
  </verify>
  <done>
AnimationPanel offset input reads/writes from GlobalSlice. Offset persists across component lifecycle. Error state shown for invalid input. Value clamped to 0-127 in the store action. Requirements: OFST-01 (offset control in panel), OFST-03 (persistence via GlobalSlice), FDBK-02 (error feedback).
  </done>
</task>

<task type="auto">
  <name>Task 2: Parameterize GameObjectSystem and wire documentsSlice callers</name>
  <files>
    src/core/map/GameObjectSystem.ts
    src/core/editor/slices/documentsSlice.ts
  </files>
  <action>
**GameObjectSystem.ts:**
1. Add import: `import { makeAnimatedTile } from './TileEncoding';`
2. Modify `placeAnimatedSpawn` signature to accept offset parameter with default 0:
   ```typescript
   placeAnimatedSpawn(map: MapData, x: number, y: number, team: Team, offset: number = 0): boolean {
   ```
   Replace the tile encoding line `map.tiles[y * MAP_WIDTH + x] = 0x8000 | animId;` with:
   ```typescript
   map.tiles[y * MAP_WIDTH + x] = makeAnimatedTile(animId, offset);
   ```
3. Modify `placeAnimatedWarp` signature to accept offset parameter with default 0:
   ```typescript
   placeAnimatedWarp(map: MapData, x: number, y: number, offset: number = 0): boolean {
   ```
   Replace the body. Instead of passing `ANIMATED_WARP_PATTERN` directly to `stamp3x3`, create a new array with offset applied:
   ```typescript
   const patternWithOffset = ANIMATED_WARP_PATTERN.map(tile =>
     (tile & 0x8000) ? makeAnimatedTile(tile & 0xFF, offset) : tile
   );
   return this.stamp3x3(map, x, y, patternWithOffset);
   ```
   This applies the same offset to all 9 animated tiles in the warp pattern, which matches SEdit behavior.

**documentsSlice.ts:**
1. In `placeGameObjectForDocument`, after the existing destructuring of `gameObjectToolState` (line ~828), also read `animationOffsetInput` from GlobalSlice:
   ```typescript
   const animationOffsetInput = get().animationOffsetInput;
   ```
   Note: `get()` returns the full combined store (GlobalSlice + DocumentsSlice + WindowSlice), so `animationOffsetInput` is directly accessible.

2. In the `case ToolType.SPAWN:` block (line ~849), pass the offset to the animated variant:
   ```typescript
   case ToolType.SPAWN:
     if (spawnVariant === 1) {
       success = gameObjectSystem.placeAnimatedSpawn(doc.map, x, y, selectedTeam, animationOffsetInput);
     } else {
       success = gameObjectSystem.placeSpawn(doc.map, x, y, selectedTeam);
     }
     break;
   ```
   IMPORTANT: Only pass offset to the animated variant (spawnVariant === 1). Static spawn (spawnVariant === 0) does NOT use offset.

3. In the `case ToolType.WARP:` block (line ~842), pass the offset to the animated variant:
   ```typescript
   case ToolType.WARP:
     if (warpVariant === 1) {
       success = gameObjectSystem.placeAnimatedWarp(doc.map, x, y, animationOffsetInput);
     } else {
       success = gameObjectSystem.placeWarp(doc.map, x, y, warpStyle, warpSrc, warpDest);
     }
     break;
   ```
   IMPORTANT: Only animated warp (warpVariant === 1) uses the offset from AnimationPanel. Static warp (warpVariant === 0) already encodes routing via `encodeWarpTile()` which uses `warpSrc`/`warpDest` from gameObjectToolState — do NOT change this.
  </action>
  <verify>
Run `npm run typecheck` — zero errors. Verify that `makeAnimatedTile` is imported in GameObjectSystem.ts. Verify that `animationOffsetInput` is read from `get()` in documentsSlice.ts and passed only to animated variants (not static placements).
  </verify>
  <done>
Animated spawn and warp placement methods accept and encode offset parameter. DocumentsSlice reads offset from GlobalSlice and passes to GameObjectSystem for animated variants only. Static variants unchanged. Requirements: OFST-02 (placed tiles encode offset).
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. AnimationPanel offset input reads from GlobalSlice `animationOffsetInput` (not local state)
3. Changing offset value in AnimationPanel updates GlobalSlice state
4. Placing animated spawn encodes offset into tile value
5. Placing animated warp encodes offset into all 9 pattern tiles
6. Static spawn/warp placement is not affected by offset value
7. StatusBar already shows "Anim: XX Offset: Y" for animated tiles (FDBK-01 pre-existing)
8. Offset input shows error border for out-of-range values
</verification>

<success_criteria>
- Zero TypeScript errors
- `animationOffsetInput` field exists in GlobalSlice with clamp action
- AnimationPanel uses GlobalSlice state (no local `frameOffset`)
- GameObjectSystem `placeAnimatedSpawn` and `placeAnimatedWarp` accept offset parameter
- documentsSlice passes `animationOffsetInput` to animated placement methods
- Offset input has error CSS class for invalid values
- Requirements covered: OFST-01, OFST-02, OFST-03, FDBK-01, FDBK-02
</success_criteria>

<output>
After completion, create `.planning/phases/70-animation-offset-control/70-01-SUMMARY.md`
</output>
