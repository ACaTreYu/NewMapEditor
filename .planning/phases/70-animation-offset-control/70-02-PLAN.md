---
phase: 70-animation-offset-control
plan: 02
type: execute
wave: 2
depends_on: ["70-01"]
files_modified:
  - src/components/MapCanvas/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "Picker tool captures offset from existing animated tiles and updates AnimationPanel offset field"
    - "After picking an animated tile, the offset value is available for next placement"
    - "Picking a warp tile (animId 0xFA) populates Source/Dest dropdowns with decoded values"
    - "Picking a non-animated tile does not change the offset value"
  artifacts:
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "Picker tool offset extraction and warp decode"
      contains: "setAnimationOffsetInput"
  key_links:
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "src/core/editor/slices/globalSlice.ts"
      via: "setAnimationOffsetInput and setWarpSettings calls in picker handler"
      pattern: "setAnimationOffsetInput|setWarpSettings"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "src/core/map/TileEncoding.ts"
      via: "getFrameOffset and getAnimationId for tile decoding"
      pattern: "getFrameOffset|getAnimationId"
---

<objective>
Add offset extraction and warp decode to the picker tool handler in MapCanvas, enabling the inspect-adjust-replace workflow where users can pick an existing animated tile and have its offset automatically populate the AnimationPanel.

Purpose: Complete the picker integration loop so users can inspect placed tiles and adjust their offsets, and decode warp routing data into the Source/Dest dropdowns.

Output: Picker tool that captures offset from animated tiles and warp routing from warp tiles.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/70-animation-offset-control/70-RESEARCH.md
@.planning/phases/70-animation-offset-control/70-01-SUMMARY.md
@src/components/MapCanvas/MapCanvas.tsx
@src/core/map/TileEncoding.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add offset extraction and warp decode to picker tool handler</name>
  <files>
    src/components/MapCanvas/MapCanvas.tsx
  </files>
  <action>
**Imports:**
Add imports from TileEncoding (if not already imported):
```typescript
import { getFrameOffset, getAnimationId, isAnimatedTile } from '@core/map/TileEncoding';
```
Note: MapCanvas currently imports from `@core/map` (types and ANIMATION_DEFINITIONS). The TileEncoding functions may need a separate import from `@core/map/TileEncoding` or may be re-exported from `@core/map/index.ts`. Check the barrel export and import accordingly.

**Zustand selectors:**
Add selectors for the new GlobalSlice actions (find where other selectors like `setSelectedTile` are declared, near the top of the component):
```typescript
const setAnimationOffsetInput = useEditorStore((state) => state.setAnimationOffsetInput);
const setWarpSettings = useEditorStore((state) => state.setWarpSettings);
```
Note: `setWarpSettings` may already be imported via `useEditorStore` — check if it's already subscribed. If `setWarpSettings` is not subscribed in MapCanvas, add it. The GameObjectToolPanel has its own subscription but the picker handler needs to call it from MapCanvas.

**Modify picker handler (line ~1951-1956):**
Replace the current picker case:
```typescript
case ToolType.PICKER:
  if (map) {
    setSelectedTile(map.tiles[y * MAP_WIDTH + x]);
    restorePreviousTool();
  }
  break;
```

With expanded logic:
```typescript
case ToolType.PICKER:
  if (map) {
    const pickedTile = map.tiles[y * MAP_WIDTH + x];
    setSelectedTile(pickedTile);

    // Extract offset from animated tiles and sync to AnimationPanel
    if (isAnimatedTile(pickedTile)) {
      const offset = getFrameOffset(pickedTile);
      setAnimationOffsetInput(offset);

      // Decode warp routing if this is a warp tile (animId 0xFA)
      const animId = getAnimationId(pickedTile);
      if (animId === 0xFA) {
        const encodedOffset = offset;  // For warps, offset encodes routing
        const warpSrc = encodedOffset % 10;
        const warpDest = Math.floor(encodedOffset / 10);
        // Read current warpStyle to preserve it
        const { warpStyle } = useEditorStore.getState().gameObjectToolState;
        setWarpSettings(warpSrc, warpDest, warpStyle);
      }
    }

    restorePreviousTool();
  }
  break;
```

**Key implementation details:**
- `isAnimatedTile(pickedTile)` checks bit 15 — only animated tiles have offset data
- `getFrameOffset()` extracts bits 14-8 (the 7-bit offset field): `(tile >> 8) & 0x7F`
- `getAnimationId()` extracts bits 7-0 (the animation ID): `tile & 0xFF`
- For warp tiles (animId === 0xFA), the offset field encodes routing as `dest * 10 + src`
- `setWarpSettings` takes (src, dest, style) and updates gameObjectToolState in GlobalSlice
- Preserving `warpStyle` via `useEditorStore.getState()` is safe here since this is an event handler (not a render path) — direct getState() is the correct pattern for one-off reads in handlers
- Non-animated tiles (bit 15 = 0) do NOT update the offset or warp settings — this is intentional to avoid corrupting state when picking regular tiles

**What NOT to change:**
- Do NOT modify the `restorePreviousTool()` call or its position (must remain after all state updates)
- Do NOT change behavior for non-animated tiles — they still just set selectedTile as before
- Do NOT add any UI changes to MapCanvas — this is purely logic in the mouse handler
  </action>
  <verify>
Run `npm run typecheck` — zero errors. Verify that `isAnimatedTile`, `getFrameOffset`, `getAnimationId` are properly imported. Verify that `setAnimationOffsetInput` and `setWarpSettings` are subscribed from `useEditorStore`. Verify the picker case handles both animated and non-animated tiles correctly.
  </verify>
  <done>
Picker tool extracts offset from animated tiles and syncs to GlobalSlice (AnimationPanel auto-updates via subscription). Warp tiles have their routing decoded into Source/Dest dropdowns. Non-animated tiles are unaffected. Requirements: PICK-01 (offset extraction), PICK-02 (offset available for next placement), WARP-02 (warp decode to dropdowns).
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. Picking an animated tile with offset 50 updates AnimationPanel offset input to 50
3. Picking a warp tile with routing (e.g., src=3, dest=5 → offset=53) populates Source=3 and Dest=5 in GameObjectToolPanel dropdowns
4. Picking a static tile does NOT change the offset value
5. After picking, restorePreviousTool still works correctly
6. The complete workflow works: place animated spawn with offset 0 → pick it → AnimationPanel shows 0 → change to 30 → place new spawn → new spawn has offset 30
</verification>

<success_criteria>
- Zero TypeScript errors
- Picker extracts offset from animated tiles
- Picker decodes warp routing (animId 0xFA) into Source/Dest
- Non-animated tiles don't affect offset state
- Complete inspect-adjust-replace workflow functional
- Requirements covered: PICK-01, PICK-02, WARP-02
</success_criteria>

<output>
After completion, create `.planning/phases/70-animation-offset-control/70-02-SUMMARY.md`
</output>
