---
phase: 17-clipboard-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/editor/EditorState.ts
  - src/components/ToolBar/ToolBar.tsx
autonomous: true

must_haves:
  truths:
    - "User can copy selected tiles to clipboard with Ctrl+C"
    - "User can cut selected tiles with Ctrl+X (copies then fills DEFAULT_TILE 280)"
    - "User can paste clipboard at original position with Ctrl+V"
    - "User can delete selection contents with Delete key (fills DEFAULT_TILE 280)"
    - "Selection persists after cut and delete (marching ants stay visible)"
    - "Pasted region becomes the active selection (marching ants around it)"
    - "Clipboard persists across tool switches"
    - "Cut, paste, and delete integrate with undo/redo (pushUndo before modification)"
  artifacts:
    - path: "src/core/editor/EditorState.ts"
      provides: "ClipboardData interface, clipboard state, copySelection/cutSelection/pasteClipboard/deleteSelection actions"
      contains: "clipboard"
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Ctrl+C/X/V/D, Delete, Ctrl+Insert keyboard shortcuts calling clipboard actions"
      contains: "copySelection"
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "src/core/editor/EditorState.ts"
      via: "useEditorStore destructuring clipboard actions"
      pattern: "copySelection|cutSelection|pasteClipboard|deleteSelection"
---

<objective>
Implement clipboard operations (copy, cut, paste, delete) for marquee selection with keyboard shortcuts.

Purpose: Enable users to duplicate, move, and clear tile regions using standard keyboard shortcuts (Ctrl+C/X/V, Delete) plus SEdit aliases (Ctrl+D, Ctrl+Insert). This is the core editing workflow that makes the SELECT tool useful beyond visual feedback.

Output: Clipboard state and 4 clipboard actions in EditorState.ts, keyboard shortcut bindings in ToolBar.tsx.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-clipboard-operations/17-RESEARCH.md
@.planning/phases/17-clipboard-operations/17-CONTEXT.md
@.planning/phases/16-marquee-selection-foundation/16-01-SUMMARY.md
@src/core/editor/EditorState.ts
@src/components/ToolBar/ToolBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clipboard state and actions to EditorState</name>
  <files>src/core/editor/EditorState.ts</files>
  <action>
Add clipboard data model and four clipboard actions to EditorState.ts:

1. **Add ClipboardData interface** (after the TileSelection interface, around line 54):
```typescript
interface ClipboardData {
  width: number;
  height: number;
  tiles: Uint16Array;  // Full 16-bit values (preserves animation flags, game objects)
  originX: number;     // Top-left X of original copied region
  originY: number;     // Top-left Y of original copied region
}
```

2. **Add to EditorState interface** (after `selection: Selection;` around line 76):
```typescript
clipboard: ClipboardData | null;
```

3. **Add clipboard action signatures to EditorState interface** (after `clearSelection` around line 105):
```typescript
copySelection: () => void;
cutSelection: () => void;
pasteClipboard: () => void;
deleteSelection: () => void;
```

4. **Add initial state** (after `selection: { ... }` around line 155):
```typescript
clipboard: null,
```

5. **Implement copySelection** (after `clearSelection` implementation, around line 261):
```typescript
copySelection: () => {
  const { map, selection } = get();
  if (!map || !selection.active) return;

  const minX = Math.min(selection.startX, selection.endX);
  const minY = Math.min(selection.startY, selection.endY);
  const maxX = Math.max(selection.startX, selection.endX);
  const maxY = Math.max(selection.startY, selection.endY);

  const width = maxX - minX + 1;
  const height = maxY - minY + 1;
  const tiles = new Uint16Array(width * height);

  let pos = 0;
  for (let y = minY; y <= maxY; y++) {
    for (let x = minX; x <= maxX; x++) {
      tiles[pos++] = map.tiles[y * MAP_WIDTH + x];
    }
  }

  set({
    clipboard: { width, height, tiles, originX: minX, originY: minY }
  });
},
```

6. **Implement cutSelection** (immediately after copySelection):
```typescript
cutSelection: () => {
  const { map, selection } = get();
  if (!map || !selection.active) return;

  // Copy first
  get().copySelection();

  // Then clear (with undo)
  get().pushUndo('Cut selection');

  const minX = Math.min(selection.startX, selection.endX);
  const minY = Math.min(selection.startY, selection.endY);
  const maxX = Math.max(selection.startX, selection.endX);
  const maxY = Math.max(selection.startY, selection.endY);

  const tiles: Array<{ x: number; y: number; tile: number }> = [];
  for (let y = minY; y <= maxY; y++) {
    for (let x = minX; x <= maxX; x++) {
      tiles.push({ x, y, tile: DEFAULT_TILE });
    }
  }
  get().setTiles(tiles);
  // Selection persists (user decision from CONTEXT.md)
},
```

7. **Implement pasteClipboard** (immediately after cutSelection):
```typescript
pasteClipboard: () => {
  const { map, clipboard } = get();
  if (!map || !clipboard) return;

  get().pushUndo('Paste');

  const tiles: Array<{ x: number; y: number; tile: number }> = [];
  for (let y = 0; y < clipboard.height; y++) {
    for (let x = 0; x < clipboard.width; x++) {
      const mapX = clipboard.originX + x;
      const mapY = clipboard.originY + y;

      // Silently discard out-of-bounds tiles (user decision)
      if (mapX >= 0 && mapX < MAP_WIDTH && mapY >= 0 && mapY < MAP_HEIGHT) {
        tiles.push({ x: mapX, y: mapY, tile: clipboard.tiles[y * clipboard.width + x] });
      }
    }
  }
  get().setTiles(tiles);

  // Pasted region becomes active selection (user decision)
  set({
    selection: {
      startX: clipboard.originX,
      startY: clipboard.originY,
      endX: clipboard.originX + clipboard.width - 1,
      endY: clipboard.originY + clipboard.height - 1,
      active: true
    }
  });
},
```

8. **Implement deleteSelection** (immediately after pasteClipboard):
```typescript
deleteSelection: () => {
  const { map, selection } = get();
  if (!map || !selection.active) return;

  get().pushUndo('Delete selection');

  const minX = Math.min(selection.startX, selection.endX);
  const minY = Math.min(selection.startY, selection.endY);
  const maxX = Math.max(selection.startX, selection.endX);
  const maxY = Math.max(selection.startY, selection.endY);

  const tiles: Array<{ x: number; y: number; tile: number }> = [];
  for (let y = minY; y <= maxY; y++) {
    for (let x = minX; x <= maxX; x++) {
      tiles.push({ x, y, tile: DEFAULT_TILE });
    }
  }
  get().setTiles(tiles);
  // Selection persists (user decision from CONTEXT.md)
},
```

**Critical details:**
- Copy full 16-bit tile values (no masking) — preserves animation flags, warp params, game object encodings
- Use `get()` to call other actions (copySelection from cutSelection, pushUndo, setTiles) — Zustand pattern for action composition
- Selection persists after cut and delete — do NOT call clearSelection
- Paste only checks `clipboard !== null`, not `selection.active` — paste works without active selection
- Paste sets new selection around pasted region
- Do NOT reset clipboard on setMap/newMap — it can persist (not harmful, gets garbage collected)
  </action>
  <verify>Run `npm run typecheck` from project root. No new TypeScript errors in EditorState.ts. Verify clipboard property exists on store, all four actions exist.</verify>
  <done>EditorState has ClipboardData interface, clipboard: null initial state, and four working clipboard actions (copySelection, cutSelection, pasteClipboard, deleteSelection) that integrate with undo/redo via pushUndo.</done>
</task>

<task type="auto">
  <name>Task 2: Add clipboard keyboard shortcuts to ToolBar</name>
  <files>src/components/ToolBar/ToolBar.tsx</files>
  <action>
Extend the existing keyboard handler in ToolBar.tsx to support clipboard shortcuts:

1. **Add clipboard actions to useEditorStore destructuring** (around line 79-96). Add these to the existing destructure:
```typescript
copySelection,
cutSelection,
pasteClipboard,
deleteSelection,
```

2. **Add clipboard shortcuts inside the existing `if (e.ctrlKey || e.metaKey)` block** (lines 229-256). Add new cases BEFORE the existing `return;` at line 256. Insert after the `case 'y':` block (line 254):

```typescript
case 'c':
  e.preventDefault();
  copySelection();
  break;
case 'x':
  e.preventDefault();
  cutSelection();
  break;
case 'v':
  e.preventDefault();
  pasteClipboard();
  break;
case 'd':
  e.preventDefault();
  deleteSelection();
  break;
```

3. **Add Ctrl+Insert as copy alias** inside the same `if (e.ctrlKey || e.metaKey)` block:
```typescript
case 'insert':
  e.preventDefault();
  copySelection();
  break;
```

4. **Add Delete key handler** AFTER the `if (e.ctrlKey || e.metaKey) { ... return; }` block but BEFORE the tool shortcut section (line 259). Add:
```typescript
// Delete key (no modifier) - delete selection contents
if (e.key === 'Delete') {
  e.preventDefault();
  deleteSelection();
  return;
}
```

5. **Update useEffect dependency array** (line 268) to include the new actions:
```typescript
}, [setTool, undo, redo, onNewMap, onOpenMap, onSaveMap, copySelection, cutSelection, pasteClipboard, deleteSelection]);
```

**Critical details:**
- Shortcuts work with ANY active tool (not just SELECT) — this is why they're in ToolBar's global handler, not MapCanvas
- The clipboard actions already guard on `selection.active` / `clipboard !== null` internally, so no tool check needed in the handler
- `e.key` for Insert is `'Insert'` (capital I) — use `.toLowerCase()` comparison or just `'insert'` in the switch since we already lowercase `e.key`
- Wait — the existing switch uses `e.key.toLowerCase()`. `'Insert'.toLowerCase()` = `'insert'`. So using `case 'insert':` is correct.
- The Ctrl+C/V/X shortcuts do NOT conflict with tool shortcuts because the `return;` at the end of the ctrl block (line 256) prevents falling through to tool shortcuts
  </action>
  <verify>Run `npm run typecheck` from project root. No new TypeScript errors in ToolBar.tsx. Verify the keyboard handler includes Ctrl+C/X/V/D, Delete, and Ctrl+Insert cases.</verify>
  <done>ToolBar handles Ctrl+C (copy), Ctrl+X (cut), Ctrl+V (paste), Ctrl+D (delete/SEdit alias), Delete key (delete), and Ctrl+Insert (copy/SEdit alias). All shortcuts work regardless of active tool.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` — no new TypeScript errors
2. Manual test: Open map, switch to SELECT (V), drag a rectangle, press Ctrl+C — no errors in console
3. Manual test: After copy, press Ctrl+V — tiles appear at original position, selection updates to pasted region
4. Manual test: Select region, press Delete — tiles become DEFAULT_TILE (280), selection stays visible
5. Manual test: Select region, press Ctrl+X — tiles copied to clipboard AND cleared, selection stays
6. Manual test: After cut, press Ctrl+Z — tiles restored (undo works)
7. Manual test: Copy with SELECT, switch to WALL tool, switch back to SELECT, Ctrl+V — paste still works (clipboard persists across tools)
8. Manual test: Ctrl+D works same as Delete (SEdit alias)
</verification>

<success_criteria>
- Ctrl+C copies selected tiles (full 16-bit values) to in-memory clipboard
- Ctrl+X copies then clears selection (fills DEFAULT_TILE 280), pushes undo
- Ctrl+V pastes at original position, pushes undo, creates selection around pasted region
- Delete fills selection with DEFAULT_TILE 280, pushes undo
- Ctrl+D and Ctrl+Insert work as SEdit aliases
- Selection persists after cut and delete
- Clipboard persists across tool switches
- All map-modifying operations (cut, paste, delete) integrate with undo/redo
</success_criteria>

<output>
After completion, create `.planning/phases/17-clipboard-operations/17-01-SUMMARY.md`
</output>
