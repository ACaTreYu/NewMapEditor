---
phase: 92-settings-bug-fixes
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/settingsSerializer.ts
  - src/core/services/MapService.ts
  - src/components/MapSettingsDialog/MapSettingsDialog.tsx
autonomous: true

must_haves:
  truths:
    - "Selecting a Grenade damage preset from the dropdown immediately updates the NadeDamage slider to the matching value"
    - "Selecting a Grenade recharge preset from the dropdown immediately updates the NadeRecharge slider to the matching value"
    - "Selecting a Bouncy damage preset from the dropdown immediately updates the BouncyDamage slider to the matching value"
    - "Selecting a Bouncy recharge preset from the dropdown immediately updates the BouncyRecharge slider to the matching value"
    - "Format=1.1 is placed between non-flagger and flagger groups in the serialized description, not at position 0"
    - "Console triage logs confirm all 53 extendedSettings keys are present at save time"
    - "Saving a new map without opening settings dialog produces a complete description field with all 53 settings"
  artifacts:
    - path: "src/core/map/settingsSerializer.ts"
      provides: "NADE_DAMAGE_VALUES, NADE_RECHARGE_VALUES, BOUNCY_DAMAGE_VALUES, BOUNCY_RECHARGE_VALUES constants and corrected Format=1.1 ordering"
      contains: "NADE_DAMAGE_VALUES"
    - path: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      provides: "Four new dropdown selects in Weapons tab for Grenade/Bouncy damage/recharge"
      contains: "NADE_DAMAGE_VALUES"
    - path: "src/core/services/MapService.ts"
      provides: "Triage console.log statements for settings round-trip debugging"
      contains: "SETT-02 TRIAGE"
  key_links:
    - from: "src/components/MapSettingsDialog/MapSettingsDialog.tsx"
      to: "src/core/map/settingsSerializer.ts"
      via: "import NADE_DAMAGE_VALUES, NADE_RECHARGE_VALUES, BOUNCY_DAMAGE_VALUES, BOUNCY_RECHARGE_VALUES"
      pattern: "NADE_DAMAGE_VALUES"
    - from: "MapSettingsDialog dropdown onChange"
      to: "localSettings via updateSetting"
      via: "updateSetting('NadeDamage', NADE_DAMAGE_VALUES[val])"
      pattern: "updateSetting.*NadeDamage"
    - from: "settingsSerializer.serializeSettings"
      to: "Format=1.1 placement"
      via: "allPairs array ordering"
      pattern: "nonFlaggerPairs.*Format=1\\.1.*flaggerPairs"
---

<objective>
Fix settings serialization ordering (Format=1.1 placement) and add Grenade/Bouncy damage/recharge preset dropdowns to the Weapons tab so that all 53 settings reliably round-trip through save/load and weapon presets work for all weapon types.

Purpose: SETT-01 (Grenade/Bouncy dropdown sync) and SETT-02 (complete settings in SEdit description field) are the two remaining settings bugs blocking v1.1.3 release.

Output: Updated settingsSerializer.ts with correct Format=1.1 ordering and 4 new preset arrays, updated MapSettingsDialog.tsx with 4 new dropdown selects, triage logging in MapService.ts.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/92-settings-bug-fixes/92-RESEARCH.md
@.planning/phases/86-settings-lifecycle/86-01-SUMMARY.md
@src/core/map/settingsSerializer.ts
@src/core/map/GameSettings.ts
@src/core/services/MapService.ts
@src/components/MapSettingsDialog/MapSettingsDialog.tsx
@src/core/map/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Grenade/Bouncy preset arrays and fix Format=1.1 ordering in settingsSerializer.ts</name>
  <files>src/core/map/settingsSerializer.ts</files>
  <action>
**Part A: Add 4 new preset constant arrays** after the existing `RECHARGE_RATE_VALUES` constant (around line 27):

```typescript
/** Maps Grenade damage preset (0-4) to the NadeDamage extended setting value.
 *  Doubling scale centered on AC default 21 at index 2 (Normal). */
export const NADE_DAMAGE_VALUES = [5, 11, 21, 42, 84];

/** Maps Grenade recharge preset (0-4) to the NadeRecharge extended setting value.
 *  Halving scale centered on AC default 1950 at index 2 (Normal). Lower = faster. */
export const NADE_RECHARGE_VALUES = [7800, 3900, 1950, 975, 488];

/** Maps Bouncy damage preset (0-4) to the BouncyDamage extended setting value.
 *  Doubling scale centered on AC default 48 at index 2 (Normal). */
export const BOUNCY_DAMAGE_VALUES = [12, 24, 48, 96, 192];

/** Maps Bouncy recharge preset (0-4) to the BouncyRecharge extended setting value.
 *  Halving scale centered on AC default 765 at index 2 (Normal). Lower = faster. */
export const BOUNCY_RECHARGE_VALUES = [3060, 1530, 765, 383, 191];
```

All four arrays: index 2 equals the AC default from `AC_Setting_Info_25.txt`. Damage scales double per step, recharge scales halve per step (lower recharge = faster, so "Very High" recharge rate = lowest number).

**Part B: Fix Format=1.1 placement** in `serializeSettings()` function. Change line 73 from:
```typescript
const allPairs = ['Format=1.1', ...nonFlaggerPairs, ...flaggerPairs];
```
to:
```typescript
const allPairs = [...nonFlaggerPairs, 'Format=1.1', ...flaggerPairs];
```

This matches the AC format spec: non-flagger settings (sorted) -> Format=1.1 -> flagger settings (sorted). Also update the JSDoc comment on `serializeSettings` to reflect the correct ordering (remove "Prefixes the result with Format=1.1" and say "Inserts Format=1.1 between non-flagger and flagger groups").

**Part C: Update module docstring** at the top of the file to include the 4 new constants in the Exports list:
```
 *   - Constants: LASER_DAMAGE_VALUES, SPECIAL_DAMAGE_VALUES, RECHARGE_RATE_VALUES,
 *               NADE_DAMAGE_VALUES, NADE_RECHARGE_VALUES, BOUNCY_DAMAGE_VALUES, BOUNCY_RECHARGE_VALUES
```

Do NOT modify `parseSettings` — it already filters out `Format=X.X` from unrecognized regardless of position.
  </action>
  <verify>
1. `npm run typecheck` passes with zero errors.
2. Grep confirms `NADE_DAMAGE_VALUES` is exported from `settingsSerializer.ts`.
3. Grep confirms the `allPairs` line now reads `[...nonFlaggerPairs, 'Format=1.1', ...flaggerPairs]`.
4. Verify each array's index-2 value: NADE_DAMAGE_VALUES[2]===21, NADE_RECHARGE_VALUES[2]===1950, BOUNCY_DAMAGE_VALUES[2]===48, BOUNCY_RECHARGE_VALUES[2]===765.
  </verify>
  <done>Four new preset arrays exported from settingsSerializer.ts with correct AC default values at index 2. Format=1.1 is placed between non-flagger and flagger groups in serialized output.</done>
</task>

<task type="auto">
  <name>Task 2: Add Grenade/Bouncy dropdown selects to Weapons tab and add triage logging to MapService</name>
  <files>src/components/MapSettingsDialog/MapSettingsDialog.tsx, src/core/services/MapService.ts</files>
  <action>
**Part A: Update MapSettingsDialog imports** (line 6-7). Add the 4 new constants to the import from `@core/map`:

```typescript
import {
  getSettingsByCategory, getSettingsBySubcategory,
  SETTING_SUBCATEGORIES, getDefaultSettings, ObjectiveType, createDefaultHeader,
  buildDescription, parseDescription,
  LASER_DAMAGE_VALUES, SPECIAL_DAMAGE_VALUES, RECHARGE_RATE_VALUES,
  NADE_DAMAGE_VALUES, NADE_RECHARGE_VALUES, BOUNCY_DAMAGE_VALUES, BOUNCY_RECHARGE_VALUES,
  findClosestIndex
} from '@core/map';
```

**Part B: Add 4 new SelectInput dropdowns** in the Weapons tab. Place them in the existing "Damage & Recharge" column (`<div className="weapons-header-col">`, the second column), AFTER the existing "Recharge Rate" SelectInput (after line ~424). Add these 4 new dropdowns:

```tsx
<SelectInput
  label="Grenade Damage"
  value={findClosestIndex(localSettings['NadeDamage'] ?? 21, NADE_DAMAGE_VALUES)}
  options={damageRechargeOptions}
  onChange={(val) => {
    updateSetting('NadeDamage', NADE_DAMAGE_VALUES[val] ?? 21);
    setIsDirty(true);
  }}
/>
<SelectInput
  label="Grenade Recharge"
  value={findClosestIndex(localSettings['NadeRecharge'] ?? 1950, NADE_RECHARGE_VALUES)}
  options={damageRechargeOptions}
  onChange={(val) => {
    updateSetting('NadeRecharge', NADE_RECHARGE_VALUES[val] ?? 1950);
    setIsDirty(true);
  }}
/>
<SelectInput
  label="Bouncy Damage"
  value={findClosestIndex(localSettings['BouncyDamage'] ?? 48, BOUNCY_DAMAGE_VALUES)}
  options={damageRechargeOptions}
  onChange={(val) => {
    updateSetting('BouncyDamage', BOUNCY_DAMAGE_VALUES[val] ?? 48);
    setIsDirty(true);
  }}
/>
<SelectInput
  label="Bouncy Recharge"
  value={findClosestIndex(localSettings['BouncyRecharge'] ?? 765, BOUNCY_RECHARGE_VALUES)}
  options={damageRechargeOptions}
  onChange={(val) => {
    updateSetting('BouncyRecharge', BOUNCY_RECHARGE_VALUES[val] ?? 765);
    setIsDirty(true);
  }}
/>
```

**IMPORTANT pattern difference from Laser/Missile dropdowns:** Do NOT add new fields to `headerFields` state. The existing Laser/Missile dropdowns use `headerFields.laserDamage` etc. because those correspond to binary header fields. Grenade/Bouncy have no binary header field — they are purely extended settings. Instead, derive the dropdown value inline from `localSettings` using `findClosestIndex()` on each render. This avoids stale state and is the correct pattern (per research Pitfall 1).

The `onChange` handlers call `updateSetting` directly (which updates `localSettings`), which triggers a re-render, which re-derives the dropdown value via `findClosestIndex`. No extra state needed.

**Part C: Add triage logging to MapService.saveMap()** (the `saveMap` method, around line 110-117). Insert console.log statements BEFORE the `reserializeDescription` call to trace the round-trip:

```typescript
// SETT-02 TRIAGE: Log settings round-trip state at save time
console.log('[SETT-02 TRIAGE] extendedSettings keys:', Object.keys(map.header.extendedSettings).length);
console.log('[SETT-02 TRIAGE] description length (pre-reserialize):', map.header.description.length);
```

And AFTER `reserializeDescription` is applied (in the `mapToSave` construction), add:

```typescript
console.log('[SETT-02 TRIAGE] description length (post-reserialize):', mapToSave.header.description.length);
console.log('[SETT-02 TRIAGE] first 300 chars:', mapToSave.header.description.substring(0, 300));
```

Place these between the existing comment `// SETT-03:` and the `const headerBuffer = mapParser.serialize(mapToSave);` line. The 4 console.log lines are temporary triage instrumentation that will be removed after verification.

Do NOT add triage logging to `saveMapAs` — one save path is sufficient for diagnosis.
  </action>
  <verify>
1. `npm run typecheck` passes with zero errors.
2. Grep confirms `NADE_DAMAGE_VALUES` appears in `MapSettingsDialog.tsx` import line.
3. Grep confirms 4 new `SelectInput` elements with labels "Grenade Damage", "Grenade Recharge", "Bouncy Damage", "Bouncy Recharge" exist in the Weapons tab panel.
4. Grep confirms NO new fields were added to the `headerFields` useState object (should still only have: maxPlayers, numTeams, objective, laserDamage, specialDamage, rechargeRate, holdingTime, missilesEnabled, bombsEnabled, bounciesEnabled, maxSimulPowerups, powerupCount, switchCount).
5. Grep confirms `[SETT-02 TRIAGE]` appears in `MapService.ts`.
6. `npm run electron:dev` starts without errors (visual check not required for autonomous plan).
  </verify>
  <done>
Four new Grenade/Bouncy dropdown selects appear in the Weapons tab "Damage & Recharge" section. Selecting any preset immediately updates the corresponding extended setting value via updateSetting, which is reflected in the individual sliders in the subcategory sections below. Triage logging in MapService.saveMap confirms extendedSettings key count and description content at save time.
  </done>
</task>

</tasks>

<verification>
1. **Typecheck:** `npm run typecheck` must pass with zero errors after both tasks.
2. **Format=1.1 ordering:** The output of `serializeSettings(getDefaultSettings())` should contain `...Widescreen=0, Format=1.1, FBouncyDamage=48...` (Format=1.1 between non-flagger and flagger groups, not at the start).
3. **Preset array correctness:** Each array's index-2 value matches AC default: NadeDamage=21, NadeRecharge=1950, BouncyDamage=48, BouncyRecharge=765.
4. **No headerFields pollution:** The `headerFields` useState object in MapSettingsDialog has exactly the same fields as before (no nadePreset, bouncyPreset, etc.).
5. **Dropdown derivation pattern:** Each new SelectInput's `value` prop uses `findClosestIndex(localSettings[key], ARRAY)`, NOT a headerFields entry.
6. **Triage logging present:** `[SETT-02 TRIAGE]` console.log statements appear in MapService.saveMap.
</verification>

<success_criteria>
- SETT-01: Grenade Damage, Grenade Recharge, Bouncy Damage, and Bouncy Recharge dropdown selects exist in the Weapons tab and update their corresponding extended setting values on change.
- SETT-02: Format=1.1 is correctly placed between non-flagger and flagger groups in serialized output. Triage logging confirms all 53 keys are present at save time.
- All changes typecheck clean. No new dependencies. No breaking changes to existing Laser/Missile dropdown behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/92-settings-bug-fixes/92-01-SUMMARY.md`
</output>
