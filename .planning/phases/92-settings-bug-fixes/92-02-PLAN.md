---
phase: 92-settings-bug-fixes
plan: "02"
type: execute
wave: 2
depends_on: ["92-01"]
files_modified:
  - src/core/map/settingsSerializer.ts
  - src/core/services/MapService.ts
autonomous: true

must_haves:
  truths:
    - "Format=1.1 is placed between non-flagger and flagger groups in the serialized description, not at position 0"
    - "Saving a new map without opening settings dialog produces a complete description field with all 53 settings"
    - "Triage console.log statements are removed from MapService.saveMap (cleanup)"
  artifacts:
    - path: "src/core/map/settingsSerializer.ts"
      provides: "Corrected Format=1.1 ordering in serializeSettings"
      contains: "nonFlaggerPairs, 'Format=1.1', ...flaggerPairs"
    - path: "src/core/services/MapService.ts"
      provides: "Clean saveMap without triage logging"
  key_links:
    - from: "settingsSerializer.serializeSettings"
      to: "Format=1.1 placement"
      via: "allPairs array ordering"
      pattern: "nonFlaggerPairs.*Format=1\\.1.*flaggerPairs"
---

<objective>
Fix the SETT-02 bug based on triage findings from Plan 92-01's human checkpoint. The default fix is to reorder Format=1.1 placement from position 0 to between non-flagger and flagger groups, matching the AC format spec. After applying the fix, remove the temporary triage logging from MapService.saveMap.

Purpose: SETT-02 (complete settings in SEdit description field) is the remaining settings bug blocking v1.1.3 release. The triage checkpoint in Plan 92-01 confirmed the root cause; this plan applies the fix.

Output: Updated settingsSerializer.ts with correct Format=1.1 ordering, cleaned-up MapService.ts with triage logs removed.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/92-settings-bug-fixes/92-RESEARCH.md
@.planning/phases/92-settings-bug-fixes/92-01-SUMMARY.md
@src/core/map/settingsSerializer.ts
@src/core/services/MapService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Format=1.1 ordering and remove triage logging</name>
  <files>src/core/map/settingsSerializer.ts, src/core/services/MapService.ts</files>
  <action>
**IMPORTANT: Before executing, read the 92-01-SUMMARY.md to understand what the human checkpoint revealed about the SETT-02 root cause. If the summary indicates a DIFFERENT root cause than Format=1.1 positioning (e.g., extendedSettings empty at save time, or SEdit display truncation), adapt the fix accordingly. The actions below assume the default/expected root cause: Format=1.1 at position 0.**

**Part A: Fix Format=1.1 placement** in `serializeSettings()` function in settingsSerializer.ts. Change the allPairs line from:
```typescript
const allPairs = ['Format=1.1', ...nonFlaggerPairs, ...flaggerPairs];
```
to:
```typescript
const allPairs = [...nonFlaggerPairs, 'Format=1.1', ...flaggerPairs];
```

This matches the AC format spec: non-flagger settings (sorted) -> Format=1.1 -> flagger settings (sorted).

Also update the JSDoc comment on `serializeSettings` to reflect the correct ordering. Change "Prefixes the result with Format=1.1" (or similar) to "Inserts Format=1.1 between non-flagger and flagger groups".

Do NOT modify `parseSettings` â€” it already filters out `Format=X.X` from unrecognized regardless of position.

**Part B: Remove triage console.log statements** from MapService.saveMap(). Delete all 4 lines containing `[SETT-02 TRIAGE]` and the associated comment line (`// SETT-02 TRIAGE:`). These were temporary instrumentation added in Plan 92-01 for diagnosis.

**Part C (conditional): If the 92-01-SUMMARY indicates a different root cause**, apply the appropriate fix instead of or in addition to Part A:
- If "extendedSettings empty at save time": Add a guard in saveMap that initializes extendedSettings from getDefaultSettings() when it's empty `{}`.
- If "SEdit display truncation": Document in the summary that this is a SEdit display limitation, not our bug. The Format=1.1 reorder is still correct per spec and should be applied regardless.
  </action>
  <verify>
1. `npm run typecheck` passes with zero errors.
2. Grep confirms the `allPairs` line now reads `[...nonFlaggerPairs, 'Format=1.1', ...flaggerPairs]`.
3. Grep confirms NO lines containing `[SETT-02 TRIAGE]` remain in `MapService.ts`.
4. Grep confirms `parseSettings` was NOT modified (it should still be unchanged).
  </verify>
  <done>Format=1.1 is correctly placed between non-flagger and flagger groups in serialized output. Triage logging has been cleaned up from MapService.saveMap. The serialization round-trip produces a complete description field matching the AC format spec.</done>
</task>

</tasks>

<verification>
1. **Typecheck:** `npm run typecheck` must pass with zero errors.
2. **Format=1.1 ordering:** The output of `serializeSettings(getDefaultSettings())` should contain `...Widescreen=0, Format=1.1, FBouncyDamage=48...` (Format=1.1 between non-flagger and flagger groups, not at the start).
3. **Clean code:** No `[SETT-02 TRIAGE]` lines remain in MapService.ts.
4. **No regressions:** `parseSettings` unchanged. Existing Laser/Missile dropdown behavior unaffected.
</verification>

<success_criteria>
- SETT-02: Format=1.1 is correctly placed between non-flagger and flagger groups in serialized output, matching the AC format spec.
- Triage logging is removed (clean production code).
- All changes typecheck clean. No breaking changes to existing functionality.
</success_criteria>

<output>
After completion, create `.planning/phases/92-settings-bug-fixes/92-02-SUMMARY.md`
</output>
