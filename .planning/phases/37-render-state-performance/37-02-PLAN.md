---
phase: 37-render-state-performance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/MapCanvas/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "Static layer redraws only when map/viewport/tileset changes (NOT animationFrame)"
    - "Animation layer redraws only when animationFrame changes (NOT tool state)"
    - "Overlay layer redraws on tool/selection changes, but animationFrame ONLY for marching ants"
    - "Grid layer redraws only on viewport/showGrid changes (NOT animationFrame or tool state)"
    - "MapCanvas re-renders are scoped to changed data (viewport change doesn't trigger tool state re-render)"
  artifacts:
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "Granular selectors + layer-specific redraw triggers"
      contains: "const currentTool = useEditorStore.*state\\.currentTool"
      min_lines: 600
  key_links:
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "drawStaticLayer"
      via: "useEffect dependency array WITHOUT animationFrame"
      pattern: "useEffect.*drawStaticLayer.*\\[.*map.*viewport.*\\]"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "drawOverlayLayer"
      via: "Conditional animationFrame dependency (only if selection.active)"
      pattern: "selection\\.active.*animationFrame"
---

<objective>
Split MapCanvas mega-selector and decouple canvas layer redraws from unrelated state changes.

Purpose: MapCanvas currently subscribes to 9+ fields via useShallow, causing re-renders when ANY field changes. Each canvas layer redraws on every animation tick even when its inputs haven't changed. This plan creates focused subscriptions and layer-specific triggers.

Output: Granular selectors (1-3 fields each) + layer-specific redraw triggers (static/anim/overlay/grid independent).
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@E:\NewMapEditor\.planning\PROJECT.md
@E:\NewMapEditor\.planning\ROADMAP.md
@E:\NewMapEditor\.planning\STATE.md
@E:\NewMapEditor\.planning\phases\37-render-state-performance\37-RESEARCH.md
@E:\NewMapEditor\src\components\MapCanvas\MapCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Split MapCanvas mega-selector into focused subscriptions</name>
  <files>src/components/MapCanvas/MapCanvas.tsx</files>
  <action>
Replace mega-selector (lines 85-100) with granular selectors by concern:

**Current (WRONG):**
```typescript
const { currentTool, selectedTile, tileSelection, rectDragState, gameObjectToolState,
        selection, isPasting, clipboard, pastePreviewPosition } = useEditorStore(
  useShallow((state) => ({ /* 9 fields */ }))
);
```

**Target (RIGHT):**

1. **Individual selectors for tool state (1-3 fields, change independently):**
```typescript
const currentTool = useEditorStore(state => state.currentTool);
const selectedTile = useEditorStore(state => state.selectedTile);
const tileSelection = useEditorStore(state => state.tileSelection);
const gameObjectToolState = useEditorStore(state => state.gameObjectToolState);
```

2. **Grouped selector for paste state (changes together):**
```typescript
const { isPasting, clipboard, pastePreviewPosition } = useEditorStore(
  useShallow((state) => {
    const doc = documentId ? state.documents.get(documentId) : null;
    return {
      isPasting: doc ? doc.isPasting : state.isPasting,
      clipboard: state.clipboard,
      pastePreviewPosition: doc ? doc.pastePreviewPosition : state.pastePreviewPosition
    };
  })
);
```

3. **Grouped selector for selection + rect drag (changes together):**
```typescript
const { selection, rectDragState } = useEditorStore(
  useShallow((state) => {
    const doc = documentId ? state.documents.get(documentId) : null;
    return {
      selection: doc ? doc.selection : state.selection,
      rectDragState: state.rectDragState
    };
  })
);
```

**CRITICAL:** Replace ONLY lines 85-100 (tool/interaction mega-selector). Do NOT touch lines 65-76 (map+viewport) or line 79 (animationFrame) — those are already correct.

**Actions selector (lines 103-130):** Change from useShallow to individual selectors:
```typescript
const setTile = useEditorStore(state => state.setTile);
const setTiles = useEditorStore(state => state.setTiles);
// ... etc (all 15 actions as individual selectors)
```
Reason: Actions are stable references, never change, don't need useShallow overhead.

Pattern from research (37-RESEARCH.md lines 145-169): Individual selectors for <4 fields, useShallow for 4+ related fields that change together. Actions always individual.
  </action>
  <verify>
Run `npm run typecheck` — zero errors.

Manual test with React DevTools Profiler:
1. Record interaction: change currentTool from Pencil to Wall
2. Profiler shows MapCanvas rendered because "currentTool changed"
3. Profiler does NOT show "tileSelection changed" or "selection changed" as reasons
4. Before fix: all 9 fields in "why did this render" list
5. After fix: only currentTool in list
  </verify>
  <done>
- Mega-selector split into 3 focused selectors (tool, paste, selection)
- Actions use individual selectors (not useShallow)
- npm run typecheck passes
- Profiler shows granular re-render reasons (not false-positive updates)
  </done>
</task>

<task type="auto">
  <name>Decouple canvas layer redraws from unrelated state changes</name>
  <files>src/components/MapCanvas/MapCanvas.tsx</files>
  <action>
Fix layer-specific redraw triggers to eliminate unnecessary redraws:

**Find current useEffect dependencies** for each draw function (search for "useEffect.*drawStaticLayer", "useEffect.*drawAnimLayer", etc.).

**Update dependencies for each layer:**

1. **drawStaticLayer** (draws non-animated tiles):
   - CURRENT deps likely include: map, viewport, tilesetImage, animationFrame (WRONG)
   - TARGET deps: [drawStaticLayer] (function is memoized with useCallback)
   - useCallback deps: [map, viewport, tilesetImage] (NOT animationFrame, NOT currentTool, NOT selection)
   - Static tiles don't animate → animationFrame is irrelevant

2. **drawAnimLayer** (draws animated tiles only):
   - CURRENT deps: likely correct already (animationFrame, map, viewport, tilesetImage)
   - TARGET deps: [drawAnimLayer]
   - useCallback deps: [map, viewport, tilesetImage, animationFrame] (correct — needs animationFrame)

3. **drawOverlayLayer** (draws cursor, selection, tool previews):
   - CURRENT deps likely include: animationFrame (line 568 per planning context) — WRONG for most overlays
   - TARGET: Conditional animationFrame dependency
   - useCallback deps: [currentTool, selectedTile, selection, viewport, ...(selection.active ? [animationFrame] : [])]
   - Reasoning: animationFrame ONLY needed for marching ants when selection.active
   - If selection NOT active, overlay redraws on tool/cursor changes, NOT every 150ms

4. **drawGridLayer** (draws grid lines):
   - CURRENT deps: likely correct already (viewport, showGrid)
   - TARGET deps: [drawGridLayer]
   - useCallback deps: [viewport, showGrid] (NOT animationFrame, NOT map, NOT currentTool)

**Conditional dependency pattern** (for drawOverlayLayer):
```typescript
const drawOverlayLayer = useCallback(() => {
  // ... draw cursor, tool preview
  if (selection.active) {
    const dashOffset = -(animationFrame * 0.5) % 12;
    // ... draw marching ants with dashOffset
  }
}, [
  currentTool, selectedTile, selection, viewport,
  ...(selection.active ? [animationFrame] : [])
]);
```

**Locate existing draw functions** (search for "const drawStaticLayer = useCallback", line ~237 for drawAnimLayer, line ~278 for drawOverlayLayer per planning context).

Pattern from research (37-RESEARCH.md lines 182-206, 379-406): Layer separation with independent triggers, conditional animationFrame for overlay.
  </action>
  <verify>
Run `npm run typecheck` — zero errors.

Manual test:
1. Open map, place cursor on canvas (don't move)
2. Monitor canvas redraws with performance.mark in each draw function
3. Wait 1 second → verify drawStaticLayer NOT called, drawGridLayer NOT called
4. Only drawAnimLayer called if animated tiles visible
5. drawOverlayLayer NOT called unless cursor moves OR selection active with marching ants

Console verification:
```javascript
// In each draw function, add:
console.log('drawStaticLayer called', performance.now());
```
Static layer should log ONLY on viewport pan/zoom, NOT on animation tick.
  </verify>
  <done>
- drawStaticLayer deps exclude animationFrame
- drawAnimLayer deps include animationFrame (correct)
- drawOverlayLayer has conditional animationFrame (only if selection.active)
- drawGridLayer deps exclude animationFrame and tool state
- npm run typecheck passes
- Canvas layers redraw independently based on their specific inputs
  </done>
</task>

</tasks>

<verification>
**Selector granularity:**
- React DevTools Profiler → record changing currentTool
- Profiler shows MapCanvas rendered, reason: "currentTool changed"
- Does NOT show tileSelection, selection, clipboard as reasons
- Before fix: 9 fields in re-render reason
- After fix: 1 field

**Layer independence:**
- Add performance.mark in each draw function
- Pan viewport → static + grid redraw, anim + overlay do NOT (unless anim tiles visible or selection active)
- Change tool → overlay redraws, static + anim + grid do NOT
- Animation tick with visible animated tiles → ONLY anim layer redraws (not static/overlay/grid)
- Create selection → overlay redraws with marching ants, but static/anim/grid do NOT

**Combined test:**
- Open map with no animated tiles, no selection
- Task Manager: CPU at 0-1%
- Add selection → overlay animates at 6-8 FPS (marching ants), but static/anim/grid do NOT redraw
</verification>

<success_criteria>
- [ ] Canvas layers only redraw when their specific inputs change (PERF-03)
- [ ] MapCanvas re-renders scoped to changed data (PERF-05)
- [ ] Idle canvas with no animated tiles shows zero static/grid redraws (PERF-01 partial)
- [ ] npm run typecheck passes with zero errors
- [ ] Profiler shows granular re-render reasons (1-3 fields, not 9)
</success_criteria>

<output>
After completion, create `.planning/phases/37-render-state-performance/37-02-SUMMARY.md`
</output>
