---
phase: 39-minimize-restore-controls
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - src/components/Workspace/ChildWindow.tsx
  - src/components/Workspace/MinimizedBar.tsx
  - src/components/Workspace/Workspace.tsx
  - src/components/Workspace/Workspace.css
autonomous: true

must_haves:
  truths:
    - "User can minimize a child window via minimize button in title bar"
    - "User can maximize a child window via maximize button in title bar"
    - "User can close a child window via close button in title bar"
    - "Title bar buttons appear in order: minimize, maximize, close (Windows classic _ [] X)"
    - "Minimized window appears as 160px-wide compact titled bar at top of workspace"
    - "Multiple minimized bars stack horizontally with flex-wrap"
    - "Minimized bar shows document name and has restore + close buttons"
    - "Clicking a minimized bar restores the window to previous position and size"
    - "Minimized bars have lower z-index than normal windows"
    - "Minimized bars are draggable within the workspace"
    - "Maximized window fills entire workspace and hides title bar"
    - "Maximized window canvas resizes to fill available space"
    - "Double-click title bar toggles maximize/restore"
    - "Restore button replaces maximize button when window is maximized"
    - "Close button turns red on hover"
    - "Minimize/maximize buttons get subtle neutral highlight on hover"
    - "Button icons are CSS-drawn using borders and pseudo-elements"
  artifacts:
    - path: "src/components/Workspace/ChildWindow.tsx"
      provides: "Title bar with minimize/maximize/close buttons, double-click maximize, hidden title bar when maximized"
      contains: "window-minimize-btn"
    - path: "src/components/Workspace/MinimizedBar.tsx"
      provides: "Compact minimized window bar with restore and close functionality"
      contains: "minimized-bar"
    - path: "src/components/Workspace/Workspace.tsx"
      provides: "Renders MinimizedBar components for minimized windows, filters minimized from ChildWindow rendering"
      contains: "MinimizedBar"
    - path: "src/components/Workspace/Workspace.css"
      provides: "CSS-drawn button icons, minimized bar styles, maximize styles, hover states"
      contains: "window-minimize-btn"
  key_links:
    - from: "src/components/Workspace/ChildWindow.tsx"
      to: "src/core/editor/slices/windowSlice.ts"
      via: "minimizeWindow, maximizeWindow, unmaximizeWindow store actions"
      pattern: "minimizeWindow|maximizeWindow|unmaximizeWindow"
    - from: "src/components/Workspace/MinimizedBar.tsx"
      to: "src/core/editor/slices/windowSlice.ts"
      via: "restoreWindow store action"
      pattern: "restoreWindow"
    - from: "src/components/Workspace/Workspace.tsx"
      to: "src/components/Workspace/MinimizedBar.tsx"
      via: "MinimizedBar component import"
      pattern: "import.*MinimizedBar"
---

<objective>
Implement the complete UI for MDI window controls: title bar buttons with CSS-drawn icons, minimized bar component, maximize behavior with hidden title bar, and double-click title bar toggle.

Purpose: Gives users full window management controls matching Windows classic MDI conventions. This is the user-facing side of the state foundation built in Plan 01.

Output: Updated ChildWindow with three title bar buttons, new MinimizedBar component, updated Workspace to render minimized bars, all CSS styling for icons/hover states/minimized bars/maximized windows.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-minimize-restore-controls/39-01-SUMMARY.md
@src/components/Workspace/ChildWindow.tsx
@src/components/Workspace/Workspace.tsx
@src/components/Workspace/Workspace.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Title bar buttons + maximize behavior in ChildWindow</name>
  <files>
    src/components/Workspace/ChildWindow.tsx
    src/components/Workspace/Workspace.css
  </files>
  <action>
**ChildWindow.tsx** — Major updates to the title bar and window behavior:

1. **Add store selectors** for the new actions:
   ```typescript
   const minimizeWindow = useEditorStore((state) => state.minimizeWindow);
   const maximizeWindow = useEditorStore((state) => state.maximizeWindow);
   const unmaximizeWindow = useEditorStore((state) => state.unmaximizeWindow);
   ```

2. **Title bar buttons** — Replace the single close button with three buttons in order: minimize, maximize/restore, close.
   - Minimize button: class `window-btn window-minimize-btn`, calls `minimizeWindow(documentId)`, title="Minimize"
   - Maximize/Restore button: conditionally render based on `windowState.isMaximized`:
     - When NOT maximized: class `window-btn window-maximize-btn`, calls `maximizeWindow(documentId)`, title="Maximize"
     - When maximized: class `window-btn window-restore-btn`, calls `unmaximizeWindow(documentId)`, title="Restore"
   - Close button: class `window-btn window-close-btn`, calls `onClose(documentId)`, title="Close"
   - All buttons: `onClick` handlers with `e.stopPropagation()` to prevent title bar drag
   - Button container: wrap all three in `<div className="window-controls">`

3. **Double-click title bar** — Add `onDoubleClick` handler to the title bar div:
   ```typescript
   const handleTitleBarDoubleClick = useCallback(() => {
     if (windowState?.isMaximized) {
       unmaximizeWindow(documentId);
     } else {
       maximizeWindow(documentId);
     }
   }, [documentId, windowState?.isMaximized, maximizeWindow, unmaximizeWindow]);
   ```
   Add `onDoubleClick={handleTitleBarDoubleClick}` to the `.window-title-bar` div.

4. **Hide title bar when maximized** — Conditionally render the title bar:
   ```typescript
   {!windowState.isMaximized && (
     <div className="window-title-bar" ...>...</div>
   )}
   ```

5. **Don't render minimized windows** — Add early return if `windowState.isMinimized`:
   ```typescript
   if (!windowState || windowState.isMinimized) return null;
   ```

6. **Disable drag and resize when maximized** — Update the Rnd props:
   - Set `disableDragging={true}` (already true, using manual drag)
   - For manual drag: in `handleTitleBarMouseDown`, return early if `windowState.isMaximized` (don't allow dragging maximized windows)
   - For resize: add `enableResizing={!windowState.isMaximized}` on the Rnd component (react-rnd accepts enableResizing as boolean)

7. **Update title bar mouse down** to also ignore clicks on minimize and maximize buttons:
   Change the button filter from `.window-close-btn` to `.window-btn`:
   ```typescript
   if (e.button !== 0 || (e.target as HTMLElement).closest('.window-btn')) return;
   ```

**Workspace.css** — Add CSS-drawn button icon styles:

1. **Window controls container:**
   ```css
   .window-controls {
     display: flex;
     align-items: center;
     gap: 2px;
     flex-shrink: 0;
   }
   ```

2. **Base button style** (shared by all three):
   ```css
   .window-btn {
     width: 20px;
     height: 20px;
     display: flex;
     align-items: center;
     justify-content: center;
     border: none;
     background: transparent;
     color: inherit;
     cursor: pointer;
     border-radius: var(--radius-sm);
     position: relative;
     padding: 0;
   }
   ```

3. **Minimize icon** — horizontal dash via ::before:
   ```css
   .window-minimize-btn::before {
     content: '';
     display: block;
     width: 8px;
     height: 1.5px;
     background: currentColor;
   }
   ```

4. **Maximize icon** — square outline via ::before:
   ```css
   .window-maximize-btn::before {
     content: '';
     display: block;
     width: 8px;
     height: 8px;
     border: 1.5px solid currentColor;
   }
   ```

5. **Restore icon** — overlapped squares using ::before and ::after:
   ```css
   .window-restore-btn {
     overflow: hidden;
   }
   .window-restore-btn::before {
     content: '';
     position: absolute;
     width: 6px;
     height: 6px;
     border: 1.5px solid currentColor;
     bottom: 4px;
     left: 4px;
   }
   .window-restore-btn::after {
     content: '';
     position: absolute;
     width: 6px;
     height: 6px;
     border: 1.5px solid currentColor;
     top: 4px;
     right: 4px;
   }
   ```

6. **Close icon** — X via rotated ::before and ::after lines:
   ```css
   .window-close-btn::before,
   .window-close-btn::after {
     content: '';
     position: absolute;
     width: 10px;
     height: 1.5px;
     background: currentColor;
     top: 50%;
     left: 50%;
   }
   .window-close-btn::before {
     transform: translate(-50%, -50%) rotate(45deg);
   }
   .window-close-btn::after {
     transform: translate(-50%, -50%) rotate(-45deg);
   }
   ```
   Remove the `×` text from the close button (now using CSS pseudo-elements).

7. **Hover states** — Per user decision:
   ```css
   /* Close button turns red on hover */
   .child-window.active .window-close-btn:hover {
     background: #dc3545;
     color: white;
   }
   .child-window:not(.active) .window-close-btn:hover {
     background: #dc3545;
     color: white;
   }

   /* Minimize/maximize/restore get subtle neutral highlight */
   .child-window.active .window-minimize-btn:hover,
   .child-window.active .window-maximize-btn:hover,
   .child-window.active .window-restore-btn:hover {
     background: rgba(255, 255, 255, 0.2);
   }
   .child-window:not(.active) .window-minimize-btn:hover,
   .child-window:not(.active) .window-maximize-btn:hover,
   .child-window:not(.active) .window-restore-btn:hover {
     background: var(--bg-hover);
   }
   ```

8. **Maximized window styles:**
   ```css
   .child-window.maximized {
     border: none;
     border-radius: 0;
     box-shadow: none;
   }
   ```

Remove the old `.window-close-btn` styling that set font-size/line-height (no longer needed since we're using CSS pseudo-elements now).
  </action>
  <verify>
Run `npm run typecheck` — zero errors. Run `npm run electron:dev` and verify:
- Three buttons visible in title bar (_, [], X)
- Close button turns red on hover
- Minimize/maximize buttons have subtle hover highlight
- Icons are CSS-drawn (no text characters)
- Double-clicking title bar maximizes window (fills workspace, title bar hidden)
- Minimized windows don't render as child windows
  </verify>
  <done>
ChildWindow has three CSS-drawn title bar buttons (minimize, maximize/restore, close). Double-click title bar toggles maximize. Maximized window hides title bar. Minimized windows return null. Close button turns red on hover. Icons use only CSS pseudo-elements.
  </done>
</task>

<task type="auto">
  <name>Task 2: MinimizedBar component and Workspace integration</name>
  <files>
    src/components/Workspace/MinimizedBar.tsx
    src/components/Workspace/Workspace.tsx
    src/components/Workspace/Workspace.css
  </files>
  <action>
**MinimizedBar.tsx** — Create a new component for minimized window bars:

```typescript
/**
 * MinimizedBar component - Compact bar for minimized MDI windows
 * Renders at top of workspace with document name, restore and close buttons.
 * Draggable within the workspace per user decision.
 */

import React, { useCallback, useRef } from 'react';
import { useEditorStore } from '@core/editor';

interface Props {
  documentId: string;
  onClose: (docId: string) => void;
}

export const MinimizedBar: React.FC<Props> = ({ documentId, onClose }) => {
  const barRef = useRef<HTMLDivElement>(null);
  const dragRef = useRef<{ startX: number; startY: number; origX: number; origY: number } | null>(null);

  const windowState = useEditorStore((state) => state.windowStates.get(documentId));
  const isActive = useEditorStore((state) => state.activeDocumentId === documentId);
  const restoreWindow = useEditorStore((state) => state.restoreWindow);
  const setActiveDocument = useEditorStore((state) => state.setActiveDocument);

  // Compute display title
  const document = useEditorStore((state) => state.documents.get(documentId));
  const displayTitle = React.useMemo(() => {
    if (!document) return 'Untitled';
    const filename = document.filePath
      ? document.filePath.split(/[\\/]/).pop() || 'Untitled'
      : 'Untitled';
    const modified = document.map?.modified ? ' *' : '';
    return `${filename}${modified}`;
  }, [document]);

  // Click title area to restore
  const handleRestore = useCallback(() => {
    restoreWindow(documentId);
  }, [documentId, restoreWindow]);

  // Close button
  const handleClose = useCallback((e: React.MouseEvent) => {
    e.stopPropagation();
    onClose(documentId);
  }, [documentId, onClose]);

  // Click bar to activate (set as active document without restoring)
  const handleBarClick = useCallback(() => {
    if (!isActive) {
      setActiveDocument(documentId);
    }
  }, [documentId, isActive, setActiveDocument]);

  // Draggable bar — manual drag implementation
  const handleBarMouseDown = useCallback((e: React.MouseEvent) => {
    if (e.button !== 0) return;
    if ((e.target as HTMLElement).closest('.window-btn')) return;

    e.preventDefault();
    const bar = barRef.current;
    if (!bar) return;

    const rect = bar.getBoundingClientRect();
    dragRef.current = {
      startX: e.clientX,
      startY: e.clientY,
      origX: bar.offsetLeft,
      origY: bar.offsetTop
    };

    const handleMouseMove = (ev: MouseEvent) => {
      if (!dragRef.current || !barRef.current) return;
      const dx = ev.clientX - dragRef.current.startX;
      const dy = ev.clientY - dragRef.current.startY;
      barRef.current.style.position = 'absolute';
      barRef.current.style.left = `${dragRef.current.origX + dx}px`;
      barRef.current.style.top = `${dragRef.current.origY + dy}px`;
    };

    const handleMouseUp = () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('mouseup', handleMouseUp);
      dragRef.current = null;
    };

    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mouseup', handleMouseUp);
  }, []);

  if (!windowState || !windowState.isMinimized) return null;

  return (
    <div
      ref={barRef}
      className={`minimized-bar ${isActive ? 'active' : ''}`}
      onMouseDown={handleBarMouseDown}
      onClick={handleBarClick}
    >
      <div className="minimized-title" onDoubleClick={handleRestore}>
        {displayTitle}
      </div>
      <div className="minimized-controls">
        <button
          className="window-btn window-restore-btn"
          onClick={(e) => { e.stopPropagation(); handleRestore(); }}
          title="Restore"
        />
        <button
          className="window-btn window-close-btn"
          onClick={handleClose}
          title="Close"
        />
      </div>
    </div>
  );
};
```

Key design points per user decisions:
- Fixed 160px width
- Height matches title bar (~28px)
- Shows document name + restore button + close button (mini title bar style)
- Same styling as child window title bars (active/inactive states)
- Draggable via manual mousedown/move/up handlers
- Double-click title area restores the window
- Lower z-index than normal windows (handled in CSS)

**Workspace.tsx** — Update to render minimized bars:

1. Import MinimizedBar component
2. Separate document IDs into minimized and non-minimized:
   ```typescript
   const minimizedIds = documentIds.filter(id => {
     const ws = useEditorStore.getState().windowStates.get(id);
     return ws?.isMinimized;
   });
   ```

   Actually, for proper reactivity, create a selector for minimized document IDs:
   ```typescript
   const minimizedDocIds = useEditorStore(useShallow((state) =>
     Array.from(state.documents.keys()).filter(id =>
       state.windowStates.get(id)?.isMinimized
     )
   ));
   ```

3. Render minimized bars container at top of workspace:
   ```tsx
   <div className="workspace">
     {minimizedDocIds.length > 0 && (
       <div className="minimized-bars-container">
         {minimizedDocIds.map((id) => (
           <MinimizedBar
             key={id}
             documentId={id}
             onClose={onCloseDocument}
           />
         ))}
       </div>
     )}
     {documentIds.map((id) => (
       <ChildWindow key={id} ... />
     ))}
   </div>
   ```

   Note: ChildWindow already handles `windowState.isMinimized` by returning null, so all documentIds can still be passed to ChildWindow — minimized ones will simply not render.

**Workspace.css** — Add minimized bar styles:

1. **Minimized bars container** — positioned at top of workspace:
   ```css
   .minimized-bars-container {
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     display: flex;
     flex-wrap: wrap;
     gap: 4px;
     padding: 4px;
     z-index: 500;
     pointer-events: none;
   }
   ```
   Note: `pointer-events: none` on container, `pointer-events: auto` on individual bars, so windows underneath can be interacted with between the bars.

2. **Individual minimized bar:**
   ```css
   .minimized-bar {
     width: 160px;
     height: 28px;
     display: flex;
     align-items: center;
     gap: 2px;
     padding: 0 4px 0 8px;
     background: var(--bg-tertiary);
     border: 1px solid var(--border-default);
     border-radius: var(--radius-sm);
     cursor: default;
     user-select: none;
     pointer-events: auto;
     box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
   }

   .minimized-bar.active {
     background: var(--accent-primary);
     color: white;
     border-color: var(--accent-primary);
   }
   ```

3. **Minimized bar title:**
   ```css
   .minimized-title {
     flex: 1;
     overflow: hidden;
     text-overflow: ellipsis;
     white-space: nowrap;
     font-size: var(--font-size-sm);
     font-weight: var(--font-weight-semibold);
     cursor: pointer;
   }
   ```

4. **Minimized bar controls:**
   ```css
   .minimized-controls {
     display: flex;
     align-items: center;
     gap: 2px;
     flex-shrink: 0;
   }
   ```

5. **Minimized bar button hover states** — reuse the same `.window-btn` classes so CSS-drawn icons work automatically. Add minimized-bar-specific hover:
   ```css
   .minimized-bar .window-close-btn:hover {
     background: #dc3545;
     color: white;
   }
   .minimized-bar .window-restore-btn:hover {
     background: rgba(255, 255, 255, 0.2);
   }
   .minimized-bar:not(.active) .window-restore-btn:hover {
     background: var(--bg-hover);
   }
   ```
  </action>
  <verify>
Run `npm run typecheck` — zero errors. Run `npm run electron:dev` and verify:
1. Open 2+ documents
2. Click minimize button — window disappears, compact bar appears at workspace top
3. Bar shows document name, restore and close buttons
4. Click bar title or restore button — window reappears at previous position/size
5. Multiple minimized bars stack horizontally, wrap to second row if needed
6. Bars are draggable
7. Active windows render on top of minimized bars
8. Maximize button fills workspace, hides title bar
9. Double-click title bar restores from maximized
10. Close button on minimized bar closes the document
  </verify>
  <done>
MinimizedBar component renders at workspace top as 160px compact bar with document name, restore and close buttons. Workspace renders minimized bars in flexbox wrapping container. Bars are draggable. All CSS styling matches user decisions: same title bar colors, CSS-drawn icons, red close hover, neutral minimize/restore hover. Minimized bars have z-index 500 (below normal windows at 1000+).
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. Title bar shows three buttons: minimize (_), maximize ([]), close (X) — Windows classic order
3. All button icons are CSS-drawn (pseudo-elements, no text/SVG)
4. Close button turns red on hover; minimize/maximize get neutral highlight
5. Clicking minimize: window disappears, 160px bar appears at workspace top
6. Minimized bar shows document name
7. Multiple bars stack horizontally with flex-wrap
8. Clicking minimized bar restores window to previous position/size
9. Bars are draggable within workspace
10. Bars have lower z-index than normal windows
11. Maximize fills workspace, hides title bar
12. Double-click title bar toggles maximize/restore
13. Restore button replaces maximize button when maximized
14. Maximized window canvas fills available space
</verification>

<success_criteria>
Complete MDI window controls are functional: minimize to compact bars at workspace top, maximize to fill workspace with hidden title bar, restore to previous state from either minimized or maximized. All buttons use CSS-drawn icons. User can manage windows with full minimize/maximize/restore/close controls matching Windows classic MDI conventions.
</success_criteria>

<output>
After completion, create `.planning/phases/39-minimize-restore-controls/39-02-SUMMARY.md`
</output>
