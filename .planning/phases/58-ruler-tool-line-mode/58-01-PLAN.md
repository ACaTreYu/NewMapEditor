---
phase: 58-ruler-tool-line-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/map/types.ts
  - src/components/ToolBar/ToolBar.tsx
  - src/core/editor/slices/globalSlice.ts
  - src/components/MapCanvas/MapCanvas.tsx
  - src/components/StatusBar/StatusBar.tsx
autonomous: true

must_haves:
  truths:
    - "User can activate Ruler tool from toolbar"
    - "User can drag to measure distance between two points"
    - "Status bar shows 'Ruler: DxD (Tiles: N, Dist: X.XX)' during measurement"
    - "Yellow ruler line with crosshairs renders on canvas at all zoom levels"
    - "Escape key clears active measurement but stays in ruler mode"
  artifacts:
    - path: "src/core/map/types.ts"
      provides: "ToolType.RULER enum value"
      exports: ["ToolType"]
    - path: "src/components/ToolBar/ToolBar.tsx"
      provides: "Ruler toolbar button with LuRuler icon"
      min_lines: 5
    - path: "src/core/editor/slices/globalSlice.ts"
      provides: "rulerMeasurement state and setRulerMeasurement action"
      exports: ["GlobalSlice"]
    - path: "src/components/MapCanvas/MapCanvas.tsx"
      provides: "Ruler drag state, mouse handlers, UI overlay rendering"
      min_lines: 100
    - path: "src/components/StatusBar/StatusBar.tsx"
      provides: "Ruler measurement display in status bar"
      min_lines: 10
  key_links:
    - from: "src/components/ToolBar/ToolBar.tsx"
      to: "setTool(ToolType.RULER)"
      via: "toolbar button onClick"
      pattern: "onClick.*setTool.*RULER"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "rulerStateRef"
      via: "mouse handlers update ref"
      pattern: "rulerStateRef\\.current"
    - from: "src/components/MapCanvas/MapCanvas.tsx"
      to: "setRulerMeasurement"
      via: "mousemove updates Zustand"
      pattern: "setRulerMeasurement.*\\{"
    - from: "src/components/StatusBar/StatusBar.tsx"
      to: "rulerMeasurement"
      via: "Zustand subscription"
      pattern: "rulerMeasurement.*useEditorStore"
---

<objective>
Implement ruler tool for measuring straight-line distance between two points in tiles.

Purpose: Enable map designers to accurately measure distances for spawn placement, gameplay balance, and level design verification. Provides both Manhattan (tile-grid) and Euclidean (straight-line) distance metrics in real-time.

Output: Working ruler tool with toolbar activation, click-drag measurement, visual overlay (yellow line + crosshairs), status bar display, and escape cancellation.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-ruler-tool-line-mode/58-CONTEXT.md
@.planning/phases/58-ruler-tool-line-mode/58-RESEARCH.md
@.planning/phases/57-selection-info-enhancement/57-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ruler tool infrastructure (enum, toolbar button, Zustand state)</name>
  <files>
    src/core/map/types.ts
    src/components/ToolBar/ToolBar.tsx
    src/core/editor/slices/globalSlice.ts
  </files>
  <action>
Add RULER = 'ruler' to ToolType enum in types.ts (after PICKER, before game object tools).

In ToolBar.tsx:
- Import LuRuler from 'react-icons/lu' (add to existing Lucide import list at lines 13-21)
- Add 'ruler: LuRuler' to toolIcons mapping (line 26-46)
- Add ruler button to coreTools array (lines 56-61): { tool: ToolType.RULER, label: 'Ruler', icon: 'ruler', shortcut: '' }
- Position after PICKER tool for logical grouping (editing tools together)

In globalSlice.ts:
- Add rulerMeasurement field to GlobalSlice interface:
  ```typescript
  rulerMeasurement: {
    dx: number;
    dy: number;
    manhattan: number;
    euclidean: number;
  } | null;
  ```
- Add setRulerMeasurement action to interface: setRulerMeasurement: (measurement: GlobalSlice['rulerMeasurement']) => void;
- Initialize rulerMeasurement: null in createGlobalSlice initial state (after gridColor field)
- Implement setRulerMeasurement action (after setGridColor): setRulerMeasurement: (measurement) => set({ rulerMeasurement: measurement })

Follow existing patterns: ToolType values are lowercase strings, toolbar buttons use Lucide icons, Zustand state uses simple set() for updates.
  </action>
  <verify>
- grep "RULER = 'ruler'" src/core/map/types.ts
- grep "LuRuler" src/components/ToolBar/ToolBar.tsx
- grep "ruler: LuRuler" src/components/ToolBar/ToolBar.tsx
- grep "rulerMeasurement:" src/core/editor/slices/globalSlice.ts
- npm run typecheck (no errors)
  </verify>
  <done>
- ToolType.RULER enum value exists
- Ruler toolbar button renders with LuRuler icon
- rulerMeasurement state and action defined in GlobalSlice
- TypeScript compilation successful
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement ruler drag behavior and visual overlay</name>
  <files>
    src/components/MapCanvas/MapCanvas.tsx
    src/components/StatusBar/StatusBar.tsx
  </files>
  <action>
In MapCanvas.tsx:

**1. Add ruler state ref** (after lineStateRef at line 55):
```typescript
interface RulerState {
  active: boolean;
  startX: number;
  startY: number;
  endX: number;
  endY: number;
}

const rulerStateRef = useRef<RulerState>({ active: false, startX: 0, startY: 0, endX: 0, endY: 0 });
```

**2. Add ruler mousedown handler** in handleMouseDown (after line tool check around line 700):
```typescript
if (e.button === 0 && currentTool === ToolType.RULER) {
  rulerStateRef.current = {
    active: true,
    startX: x,
    startY: y,
    endX: x,
    endY: y
  };
  requestUiRedraw();
  return;
}
```

**3. Add ruler mousemove handler** in handleMouseMove (after line preview check around line 925):
```typescript
if (rulerStateRef.current.active) {
  const prev = rulerStateRef.current;
  if (prev.endX !== x || prev.endY !== y) {
    rulerStateRef.current = { ...prev, endX: x, endY: y };

    // Update Zustand for status bar
    const dx = Math.abs(x - prev.startX);
    const dy = Math.abs(y - prev.startY);
    const manhattan = dx + dy;
    const euclidean = Math.hypot(dx, dy);
    setRulerMeasurement({ dx, dy, manhattan, euclidean });

    requestUiRedraw();
  }
  return;
}
```

**4. Add ruler rendering** in drawUiLayer function (after selection overlay around line 575):
```typescript
// Ruler overlay (RULER-01)
if (rulerStateRef.current.active && currentTool === ToolType.RULER) {
  const { startX, startY, endX, endY } = rulerStateRef.current;

  const startScreen = tileToScreen(startX, startY, overrideViewport);
  const endScreen = tileToScreen(endX, endY, overrideViewport);

  // Tile centers
  const startCenterX = startScreen.x + tilePixels / 2;
  const startCenterY = startScreen.y + tilePixels / 2;
  const endCenterX = endScreen.x + tilePixels / 2;
  const endCenterY = endScreen.y + tilePixels / 2;

  // Yellow solid line
  ctx.strokeStyle = '#FFD700'; // Gold
  ctx.lineWidth = 2;
  ctx.setLineDash([]);
  ctx.beginPath();
  ctx.moveTo(startCenterX, startCenterY);
  ctx.lineTo(endCenterX, endCenterY);
  ctx.stroke();

  // Crosshairs at endpoints
  const crosshairSize = 8;
  // Start crosshair
  ctx.beginPath();
  ctx.moveTo(startCenterX - crosshairSize, startCenterY);
  ctx.lineTo(startCenterX + crosshairSize, startCenterY);
  ctx.moveTo(startCenterX, startCenterY - crosshairSize);
  ctx.lineTo(startCenterX, startCenterY + crosshairSize);
  ctx.stroke();
  // End crosshair
  ctx.beginPath();
  ctx.moveTo(endCenterX - crosshairSize, endCenterY);
  ctx.lineTo(endCenterX + crosshairSize, endCenterY);
  ctx.moveTo(endCenterX, endCenterY - crosshairSize);
  ctx.lineTo(endCenterX, endCenterY + crosshairSize);
  ctx.stroke();

  // Floating label at midpoint (Phase 57 pattern)
  const dx = Math.abs(endX - startX);
  const dy = Math.abs(endY - startY);
  const manhattan = dx + dy;
  const euclidean = Math.hypot(dx, dy);

  const labelText = `Ruler: ${dx}×${dy} (Tiles: ${manhattan}, Dist: ${euclidean.toFixed(2)})`;
  ctx.font = '13px sans-serif';
  const metrics = ctx.measureText(labelText);
  const textWidth = metrics.width;
  const textHeight = 18;
  const pad = 4;

  // Midpoint position
  let labelX = (startCenterX + endCenterX) / 2 - textWidth / 2;
  let labelY = (startCenterY + endCenterY) / 2;

  // Edge clipping fallbacks
  if (labelX < 0) labelX = 0;
  if (labelY - textHeight < 0) labelY = textHeight;
  if (labelX + textWidth > canvas.width) labelX = canvas.width - textWidth;
  if (labelY > canvas.height) labelY = canvas.height;

  // Background
  ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
  ctx.fillRect(labelX - pad, labelY - textHeight, textWidth + pad * 2, textHeight);

  // Text
  ctx.fillStyle = '#ffffff';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'bottom';
  ctx.fillText(labelText, labelX, labelY);
}
```

**5. Add ruler escape cancellation** in keydown handler (around line 1410):
```typescript
// Cancel ruler measurement
if (rulerStateRef.current.active) {
  e.preventDefault();
  rulerStateRef.current = { active: false, startX: 0, startY: 0, endX: 0, endY: 0 };
  setRulerMeasurement(null);
  requestUiRedraw();
}
```

**6. Add ruler cleanup on tool switch** in currentTool useEffect (around line 1340):
```typescript
// Cancel ruler
if (rulerStateRef.current.active) {
  rulerStateRef.current = { active: false, startX: 0, startY: 0, endX: 0, endY: 0 };
  setRulerMeasurement(null);
  requestUiRedraw();
}
```

In StatusBar.tsx:

Add ruler measurement display in status bar (after selection info around line 80):
```typescript
const rulerMeasurement = useEditorStore((state) => state.rulerMeasurement);

// In return JSX, after selection info:
{rulerMeasurement && (
  <>
    <div className="status-separator">|</div>
    <div className="status-field">
      Ruler: {rulerMeasurement.dx}×{rulerMeasurement.dy} (Tiles: {rulerMeasurement.manhattan}, Dist: {rulerMeasurement.euclidean.toFixed(2)})
    </div>
  </>
)}
```

**Implementation notes:**
- Use `Math.hypot(dx, dy)` for Euclidean distance (built-in, accurate)
- Escape clears measurement but stays in RULER mode (user decision from CONTEXT.md)
- Tool switch clears ruler overlay (prevents visual clutter in other tools)
- Fixed 2px line width and 8px crosshairs for readability at all zoom levels
- Floating label uses Phase 57 pattern: 13px font, dark background, intelligent edge-aware positioning
  </action>
  <verify>
- npm run typecheck (no errors)
- npm run electron:dev
- Manual test: Click ruler tool in toolbar, drag on canvas to measure
- Verify: Yellow line with crosshairs renders during drag
- Verify: Status bar shows "Ruler: 5×3 (Tiles: 8, Dist: 5.83)" format
- Verify: Floating label appears at midpoint with same measurement text
- Verify: Escape clears ruler line but keeps ruler tool active
- Verify: Switching to another tool (e.g., pencil) clears ruler overlay
  </verify>
  <done>
- Ruler tool activates from toolbar
- Click-drag creates yellow ruler line with crosshairs at endpoints
- Status bar displays Manhattan and Euclidean distances in "Ruler: DxD (Tiles: N, Dist: X.XX)" format
- Floating label renders at midpoint with dark background
- Escape key cancels measurement, tool switch clears overlay
- All functionality works at zoom levels 0.25x-4x
  </done>
</task>

</tasks>

<verification>
**Manual Testing:**
1. Launch app: `npm run electron:dev`
2. Click Ruler tool in toolbar (icon should be visible)
3. Click and drag on map canvas
4. Verify yellow line renders with crosshairs at start and end points
5. Verify floating label shows "Ruler: DxD (Tiles: N, Dist: X.XX)" at midpoint
6. Verify status bar shows same measurement text
7. Release mouse, verify ruler line persists
8. Drag again, verify old ruler line clears and new measurement appears
9. Press Escape, verify ruler line clears but Ruler tool stays active
10. Switch to Pencil tool, verify ruler overlay disappears
11. Test at different zoom levels (0.25x, 1x, 4x) - line and crosshairs should be readable at all levels

**Code Checks:**
- grep "RULER = 'ruler'" src/core/map/types.ts (enum exists)
- grep "rulerStateRef" src/components/MapCanvas/MapCanvas.tsx (ref-based state)
- grep "rulerMeasurement" src/components/StatusBar/StatusBar.tsx (status display)
- npm run typecheck (no TypeScript errors)
</verification>

<success_criteria>
**Phase 58 complete when:**
- [x] Ruler tool button visible in toolbar with LuRuler icon
- [x] Clicking ruler button activates RULER tool (button shows active state)
- [x] Click-drag on canvas creates yellow ruler line
- [x] Crosshair markers (8px) render at start and end points
- [x] Status bar shows "Ruler: 5×3 (Tiles: 8, Dist: 5.83)" format during drag
- [x] Floating label appears at midpoint with same measurement text and dark background
- [x] Manhattan distance = |dx| + |dy| (tile-grid movement)
- [x] Euclidean distance = Math.hypot(dx, dy) with 2 decimal precision
- [x] Measurement persists after mouse release
- [x] New drag clears previous measurement
- [x] Escape key clears active measurement but stays in ruler mode
- [x] Switching tools clears ruler overlay
- [x] Ruler line and crosshairs readable at all zoom levels (0.25x-4x)

**Matches requirements:**
- RULER-01: ✅ User can measure straight-line distance between two points (Manhattan + Euclidean in tiles)
</success_criteria>

<output>
After completion, create `.planning/phases/58-ruler-tool-line-mode/58-01-SUMMARY.md`
</output>
