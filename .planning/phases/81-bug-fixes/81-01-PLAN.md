---
phase: 81-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - public/assets/custom.dat
  - src/core/canvas/CanvasEngine.ts
autonomous: true

must_haves:
  truths:
    - "Switch tool places correct 3x3 tile pattern from custom.dat when user clicks on map"
    - "custom.dat loads successfully on app startup (no console errors, no HTTP 404)"
    - "Painting DEFAULT_TILE (280) over an animated tile fully erases it in a single pass"
    - "Painting DEFAULT_TILE over conveyor/spawn/warp removes animation immediately with no residual frames"
  artifacts:
    - path: "public/assets/custom.dat"
      provides: "Binary custom.dat file served by Vite from public directory"
    - path: "src/core/canvas/CanvasEngine.ts"
      provides: "Animated tile transition tracking in clearedAnimatedTiles Set"
      contains: "clearedAnimatedTiles"
  key_links:
    - from: "src/App.tsx"
      to: "public/assets/custom.dat"
      via: "fetch('./assets/custom.dat') served by Vite from public/"
      pattern: "fetch.*assets/custom\\.dat"
    - from: "src/core/canvas/CanvasEngine.ts paintTile()"
      to: "src/core/canvas/CanvasEngine.ts patchAnimatedTiles()"
      via: "clearedAnimatedTiles Set populated during drag, read during animation patch"
      pattern: "clearedAnimatedTiles"
---

<objective>
Fix two bugs: (1) Switch tool fails because custom.dat is not served from Vite's public path, and (2) animated tiles leave residual frames when overwritten with DEFAULT_TILE.

Purpose: BUG-01, BUG-02, BUG-03 — core editing bugs that prevent correct tile placement and erasure.
Output: custom.dat in public/assets/, CanvasEngine with animated tile transition tracking.
</objective>

<execution_context>
@C:\Users\arcje\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\arcje\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-bug-fixes/81-RESEARCH.md
@src/core/canvas/CanvasEngine.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move custom.dat to public/assets/</name>
  <files>public/assets/custom.dat</files>
  <action>
    Move `assets/custom.dat` to `public/assets/custom.dat` using git mv (preserves history).

    This fixes BUG-01 and BUG-02: Vite serves files from `public/` at the root path. The existing fetch in App.tsx line 42 (`fetch('./assets/custom.dat')`) will now resolve correctly in both dev mode (Vite dev server) and production (built into dist/).

    No code changes needed — App.tsx already fetches from `./assets/custom.dat` which maps to `public/assets/custom.dat`.

    Verify the file is no longer at `assets/custom.dat` (old location) and exists at `public/assets/custom.dat` (new location).
  </action>
  <verify>
    Run: `ls -la public/assets/custom.dat` — file exists.
    Run: `ls -la assets/custom.dat 2>/dev/null` — file does NOT exist (moved, not copied).
  </verify>
  <done>custom.dat is in public/assets/ where Vite serves it. App.tsx fetch resolves without HTTP 404.</done>
</task>

<task type="auto">
  <name>Task 2: Track animated-to-non-animated tile transitions in CanvasEngine</name>
  <files>src/core/canvas/CanvasEngine.ts</files>
  <action>
    Add a `private clearedAnimatedTiles: Set<number> | null = null;` property to the CanvasEngine class.

    Modify `beginDrag()`: After existing pendingTiles initialization, initialize/clear the clearedAnimatedTiles Set:
    ```
    if (!this.clearedAnimatedTiles) {
      this.clearedAnimatedTiles = new Set();
    } else {
      this.clearedAnimatedTiles.clear();
    }
    ```

    Modify `paintTile()`: After the bounds check and before the pendingTiles.set() call, detect animated-to-non-animated transitions:
    ```
    const mapIdx = tileY * MAP_WIDTH + tileX;
    const oldTile = this.prevTiles?.[mapIdx] ?? 0;
    const isOldAnimated = (oldTile & 0x8000) !== 0;
    const isNewAnimated = (tile & 0x8000) !== 0;
    if (isOldAnimated && !isNewAnimated) {
      this.clearedAnimatedTiles?.add(mapIdx);
    }
    ```
    Note: the mapIdx calculation already exists implicitly in the pendingTiles.set() call (`tileY * MAP_WIDTH + tileX`). Extract it to a local variable and use it for both the transition check and the pendingTiles.set().

    Modify `patchAnimatedTiles()`: Inside the nested for loop, after computing `const tile = map.tiles[y * MAP_WIDTH + x];`, add a skip check BEFORE the existing `if ((tile & 0x8000) === 0) continue;` line:
    ```
    const mapIdx = y * MAP_WIDTH + x;
    if (this.clearedAnimatedTiles?.has(mapIdx)) continue;
    ```
    This prevents patchAnimatedTiles from re-rendering old animated content for tiles that were just overwritten with a non-animated tile during the current drag.

    Modify `commitDrag()`: After `this.pendingTiles.clear();`, add `this.clearedAnimatedTiles?.clear();`

    Modify `cancelDrag()`: After `this.pendingTiles?.clear();`, add `this.clearedAnimatedTiles?.clear();`

    Root cause context: During a drag, paintTile() patches the buffer with DEFAULT_TILE (280), but patchAnimatedTiles() still reads the old animated tile from Zustand state (not yet committed) and re-renders it over the cleared area, causing ghost frames. The Set tracks which map indices had animated tiles replaced with non-animated ones during the current drag, so patchAnimatedTiles() skips them.
  </action>
  <verify>
    Run: `npm run typecheck` — zero TypeScript errors.
    Grep for `clearedAnimatedTiles` in CanvasEngine.ts — should appear in: property declaration, beginDrag, paintTile, patchAnimatedTiles, commitDrag, cancelDrag (6 locations).
  </verify>
  <done>
    CanvasEngine tracks animated-to-non-animated transitions during drag. patchAnimatedTiles() skips cleared tiles, preventing ghost animation frames. The Set is initialized on beginDrag() and cleared on commitDrag()/cancelDrag().
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `public/assets/custom.dat` exists (file moved from assets/)
3. `clearedAnimatedTiles` property exists in CanvasEngine class
4. paintTile() detects animated-to-non-animated transitions and adds to Set
5. patchAnimatedTiles() skips indices in clearedAnimatedTiles Set
6. commitDrag() and cancelDrag() clear the Set
</verification>

<success_criteria>
- custom.dat served from public/assets/ (Vite-compatible path)
- CanvasEngine prevents ghost animation frames during drag operations
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/81-bug-fixes/81-01-SUMMARY.md`
</output>
