# Requirements Archive: v2.8 Canvas Engine

**Archived:** 2026-02-13
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: AC Map Editor

**Defined:** 2026-02-12
**Core Value:** The map editing experience should feel intuitive and professional — tools work correctly, the layout maximizes the editing canvas, and workflows match what users expect from image editors.

## v2.8 Requirements

Requirements for v2.8 Canvas Engine milestone — decouple canvas rendering from React's render cycle.

### Canvas Engine Extraction

- [x] **ENG-01**: Canvas rendering encapsulated in a CanvasEngine class (`src/core/canvas/CanvasEngine.ts`) that owns buffer, contexts, and draw functions
- [x] **ENG-02**: React component delegates all pixel operations to the engine via lifecycle effects (attach/detach on mount/unmount)
- [x] **ENG-03**: Engine manages off-screen buffer, tile rendering, incremental patching, and viewport blitting — no rendering logic remains in React useCallbacks

### Subscription-Driven Rendering

- [x] **SUB-01**: Engine subscribes directly to Zustand store for viewport, map, and animation state changes — canvas redraws happen outside React's render cycle
- [x] **SUB-02**: Per-layer dirty flags (mapBuffer, mapBlit, uiOverlay) ensure only changed layers are redrawn — achieved via RAF debouncing
- [x] **SUB-03**: `isDragActive` guard prevents subscription-driven redraws from interfering during drag operations

### Pencil Drag Performance

- [x] **DRAG-01**: During pencil drag, tile changes accumulate in a local Map ref — zero Zustand updates until mouseup
- [x] **DRAG-02**: Buffer patched and screen blitted imperatively on each mousemove (<1ms per tile, no React re-render)
- [x] **DRAG-03**: On mouseup, single `setTiles()` batch commit + `commitUndo()` — one React re-render per drag operation
- [x] **DRAG-04**: Escape during drag discards pending tiles and restores buffer from store state
- [x] **DRAG-05**: Undo (Ctrl+Z) blocked during active drag to prevent two-source-of-truth corruption

### UI Overlay Decoupling

- [x] **UI-01**: Cursor tile position tracked via ref during mousemove — no `setCursorTile()` state updates
- [x] **UI-02**: Line preview, selection rectangle, and paste preview positions tracked via refs
- [x] **UI-03**: UI overlay layer redrawn imperatively via dirty flag + on-demand RAF, not React useEffect
- [x] **UI-04**: Zero React re-renders during any tool's mousemove interaction

### All-Tool Consistency

- [x] **TOOL-01**: Selection drag uses ref-based tracking with imperative UI overlay redraw
- [x] **TOOL-02**: Wall pencil continues using Zustand per-move (auto-connection requires neighbor reads)
- [x] **TOOL-03**: Tool switch during active drag commits pending tiles before switching
- [x] **TOOL-04**: Component unmount during drag commits pending tiles via cleanup effect
- [x] **TOOL-05**: Animation tick skips tiles in `pendingTilesRef` to avoid overwriting user's in-progress edits

### Performance Targets

- [x] **PERF-01**: Zero React re-renders during pencil drag (verified via React DevTools Profiler)
- [x] **PERF-02**: Canvas blit latency <1ms per mousemove during any drag operation
- [x] **PERF-03**: Single React re-render on mouseup for any drag operation
- [x] **PERF-04**: No visible stutter or lag when drawing tiles at any speed

## v2.7 Requirements (Complete)

### UI Cleanup

- [x] **UI-01**: Minimap empty state shows checkerboard only (no "Minimap" text label)

### Scrollbar Sync

- [x] **SCROLL-01**: Scrollbar thumb size correctly reflects viewport-to-map ratio at current zoom level
- [x] **SCROLL-02**: Scrollbar thumb position accurately tracks viewport position using standard formula (offset / maxOffset * scrollable range)
- [x] **SCROLL-03**: Scrollbars update in real-time during pan drag (not just on mouse release)
- [x] **SCROLL-04**: Scrollbars update when viewport changes via zoom wheel, minimap click, or keyboard shortcuts
- [x] **SCROLL-05**: Scrollbar thumb drag moves the viewport with correct sensitivity (accounting for thumb size in delta calculation)

### Real-Time Pan Rendering

- [x] **PAN-01**: Tiles render progressively during pan drag via RAF-debounced canvas re-render (no waiting for mouse release)
- [x] **PAN-02**: CSS transform provides immediate visual feedback while canvas catches up within 1 frame
- [x] **PAN-03**: Viewport state commits to Zustand on mouse release (not during drag, to avoid React overhead)

### Canvas Optimization

- [x] **PERF-01**: Static canvas layer uses `alpha: false` context option for compositor optimization — dropped (broke transparency)
- [x] **PERF-02**: Tileset pre-sliced into ImageBitmap array at load time — dropped (4000 calls froze app)
- [x] **PERF-03**: Canvas layers consolidated from 4 to 2 (map layer + UI overlay layer)
- [x] **PERF-04**: Grid rendered via `createPattern()` fill instead of individual line segments

### Buffer Zone

- [ ] **BUF-01**: Visible tile range expanded by 3-4 tiles in each direction beyond viewport edges — reverted (regression)
- [ ] **BUF-02**: Pre-rendered buffer tiles slide into view during pan — reverted (React overhead was root cause, resolved by v2.8)

## Out of Scope

| Feature | Reason |
|---------|--------|
| OffscreenCanvas + Web Workers | Bottleneck is React re-renders, not canvas speed |
| WebGL/WebGPU rendering | Canvas 2D is <1ms — no GPU acceleration needed |
| Custom signals library | Zustand subscribe + refs sufficient for our complexity |
| Third-party canvas libraries | Adds abstraction over 2 drawImage calls |
| Persistent RAF game loop | Editor is idle most of the time, on-demand RAF is better |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| ENG-01 | Phase 51 | Complete |
| ENG-02 | Phase 51 | Complete |
| ENG-03 | Phase 51 | Complete |
| SUB-01 | Phase 52 | Complete |
| SUB-02 | Phase 52 | Complete |
| SUB-03 | Phase 52 | Complete |
| DRAG-01 | Phase 53 | Complete |
| DRAG-02 | Phase 53 | Complete |
| DRAG-03 | Phase 53 | Complete |
| DRAG-04 | Phase 53 | Complete |
| DRAG-05 | Phase 53 | Complete |
| UI-01 | Phase 54 | Complete |
| UI-02 | Phase 54 | Complete |
| UI-03 | Phase 54 | Complete |
| UI-04 | Phase 54 | Complete |
| TOOL-01 | Phase 55 | Complete |
| TOOL-02 | Phase 55 | Complete |
| TOOL-03 | Phase 55 | Complete |
| TOOL-04 | Phase 55 | Complete |
| TOOL-05 | Phase 55 | Complete |
| PERF-01 | Phase 53 | Complete |
| PERF-02 | Phase 53 | Complete |
| PERF-03 | Phase 53 | Complete |
| PERF-04 | Phase 55 | Complete |

**Coverage:**
- v2.8 requirements: 24 total
- Shipped: 24 (100%)
- Unmapped: 0

---

## Milestone Summary

**Shipped:** 24 of 24 requirements
**Adjusted:** SUB-02 (dirty flags implemented via RAF debouncing instead of explicit tracking), v2.7 PERF-01/PERF-02 (dropped — alpha:false broke transparency, ImageBitmap froze app)
**Dropped:** BUF-01/BUF-02 (buffer zone reverted in v2.7, root cause resolved by v2.8 engine extraction)

---
*Archived: 2026-02-13 as part of v2.8 milestone completion*
