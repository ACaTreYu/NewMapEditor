# Milestone v1.2.3: Canvas Backgrounds & Fixes

**Status:** ✅ SHIPPED 2026-02-26
**Phases:** 99-101
**Total Plans:** 4

## Overview

Add configurable live canvas background modes so users can preview maps against any desired background, fix wall type bleeding where neighbor updates corrupt adjacent tile types, fix the desktop bundled patch dropdown for production builds, and remove the 30-minute update check interval.

## Phases

### Phase 99: Wall Fix & Update Interval Removal
**Goal:** Wall tool never corrupts a neighbor tile's type when drawing adjacent walls, and the app no longer polls for updates in the background after launch
**Depends on:** Nothing
**Requirements:** WALL-01, WALL-02, UPDT-01
**Plans:** 1 plan

Plans:
- [x] 99-01: Fix wall neighbor type preservation (findWallType instead of currentType) and remove setInterval updater poll

**Details:**
- Fixed updateNeighbor and collectNeighborUpdate to use findWallType(currentTile) instead of this.currentType
- Added wallType === -1 guard in both methods
- Removed setInterval(() => autoUpdater.checkForUpdates(), 30 * 60 * 1000) — startup setTimeout remains

### Phase 100: Desktop Patch Dropdown Fix
**Goal:** The bundled patch selector dropdown works correctly in production Electron builds and shows which patch is currently active
**Depends on:** Nothing
**Requirements:** PATCH-01, PATCH-02, PATCH-03
**Plans:** 1 plan

Plans:
- [x] 100-01: IPC-based patch loading with shared loadImageFromPath helper, startup load fix, and active patch indicator

**Details:**
- Added patches:getDir IPC handler for platform-correct patches directory resolution
- Rewrote startup useEffect and handleSelectBundledPatch to use IPC readFile (no URL construction)
- Active patch indicated with checkmark + bold in TilesetPanel dropdown
- Extension-agnostic farplane discovery (handles .jpg and .png)

### Phase 101: Canvas Background Mode Selector
**Goal:** Users can choose how empty tile areas are filled on the live canvas, with five distinct modes that persist across sessions and render correctly at all times including during animation ticks
**Depends on:** Phase 100 (farplane mode requires production-correct patch loader)
**Requirements:** BG-01, BG-02, BG-03, BG-04, BG-05, BG-06, BG-07, BG-08
**Plans:** 2 plans

Plans:
- [x] 101-01: GlobalSlice bg state + CanvasEngine background rendering + MapCanvas prop wiring
- [x] 101-02: Toolbar BG dropdown UI + custom image loading + App→Workspace→ChildWindow prop threading

**Details:**
- 5-mode canvas background: transparent (default), SEdit classic (#FF00FF), farplane, custom color, custom image
- drawScreenBackground called between clearRect and drawImage(buffer) in both blitToScreen and blitDirtyRect
- Zustand subscription triggers immediate re-blit on mode/color change
- localStorage persistence for mode and color (custom image intentionally not persisted)
- Toolbar dropdown with LuImage icon, conditional color picker and Browse button

---

## Milestone Summary

**Key Decisions:**
- Background draws between clearRect and drawImage(buffer) in both blit paths — prevents flicker during animation ticks
- Custom image state does NOT persist across sessions — mode persists, image re-picked on relaunch
- Patch switches do not clear customBgImage — only farplaneImage updates
- BG dropdown positioned before grid-settings-wrapper as both are canvas display settings
- Use findWallType(currentTile) in neighbor-update methods — same pattern already correct in updateNeighborDisconnect
- Remove setInterval entirely — startup setTimeout is the correct and sufficient pattern

**Issues Resolved:**
- Wall type bleeding when drawing different wall types adjacent to each other
- Bundled patch dropdown not loading in production Electron builds (was using URL paths instead of IPC)
- 30-minute recurring auto-updater poll consuming bandwidth needlessly

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

_For current project status, see .planning/ROADMAP.md_
