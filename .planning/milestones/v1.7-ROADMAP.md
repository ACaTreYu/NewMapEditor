# Milestone v1.7: Performance & Portability

**Status:** SHIPPED 2026-02-08
**Phases:** 21-26
**Total Plans:** 9

## Overview

Optimized rendering pipeline, state management, and memory usage. Extracted Electron dependencies behind adapter interfaces for portability into the AC web application.

## Phases

### Phase 21: Zustand Store Optimization

**Goal**: Eliminate unnecessary re-renders by adding selectors and fixing store subscription patterns
**Depends on**: Nothing
**Plans**: 2 plans

Plans:
- [x] 21-01: Remove canUndo/canRedo methods + migrate 8 simple components to useShallow selectors
- [x] 21-02: Migrate ToolBar (reactive canUndo/canRedo) + MapCanvas to granular selectors

**Details:**
- Migrated all components from bare useEditorStore() destructuring to granular selectors
- useShallow for 4+ fields, individual selectors for 1-3 fields
- Isolated animationFrame subscriptions to animation components only
- Reactive canUndo/canRedo as selectors (state.undoStack.length > 0), not methods
- ToolBar no longer subscribes to animationFrame (eliminated ~33 re-renders/sec)

### Phase 22: Canvas Rendering Optimization

**Goal**: Reduce MapCanvas draw calls via layered rendering, batched grid, and debounced resize
**Depends on**: Phase 21
**Plans**: 2 plans

Plans:
- [x] 22-01: 4-layer canvas architecture + pixel-perfect rendering + batched grid + RAF resize
- [x] 22-02: Gap closure: fix minimap crash on drag-navigate + fix animation double-tick speed

**Details:**
- 4 stacked canvases: static tiles, animated tiles, overlays, grid
- Static layer draws frame 0 of animated tiles as background
- Grid layer topmost, receives mouse events; other layers pointer-events:none
- Batched grid drawing (1 beginPath + all lines + 1 stroke)
- RAF-debounced resize, showGrid defaults to false
- Fixed minimap crash by eliminating per-tile canvas creation
- Fixed animation double-tick by consolidating animation timers

### Phase 23: Minimap Performance

**Goal**: Replace per-draw DOM canvas creation with pre-computed tile color lookup table
**Depends on**: Nothing (independent)
**Plans**: 1 plan

Plans:
- [x] 23-01: Average-color cache + special tile overrides + debounced redraw

**Details:**
- Three-tier color caching: static tiles (Uint8Array), special overrides (Map), animated tiles (Uint8Array)
- Average all 256 pixels per tile for accurate color representation
- Debounce map tile changes at 150ms to batch rapid operations
- Viewport changes immediate (no debounce) for responsive panning/zooming
- Special tile colors: walls (steel blue-gray), powerups (gold), warps (green), flags (team colors)
- Zero temporary canvas creation during draw loop

### Phase 24: Batch State Operations

**Goal**: Batch tile mutations into single state updates to prevent render cascades
**Depends on**: Phase 21
**Plans**: 1 plan

Plans:
- [x] 24-01: WallSystem.placeWallBatch + batched wall line/rect/pencil operations

**Details:**
- Three-phase batching: collect placements, collect neighbor updates, apply all mutations
- Map<string, number> deduplication with "x,y" string keys
- Wall line/rect operations trigger single state update (10x-76x improvement)
- Wall pencil unchanged (per-tile for immediate visual feedback during drag)

### Phase 25: Undo System Optimization

**Goal**: Switch from full tile array copies to delta-based undo for reduced memory usage
**Depends on**: Phase 24
**Plans**: 1 plan

Plans:
- [x] 25-01: Delta-based undo/redo with TileDelta entries + bounded redo stack + commitUndo pattern

**Details:**
- TileDelta[] stores only changed tiles (position + old/new value)
- Snapshot-commit pattern: pushUndo() snapshots before, commitUndo() computes deltas after
- Memory reduction: 128KB per entry to 12-1200 bytes (100x+ savings)
- Bounded redo stack limited to maxUndoLevels (50)
- Empty operations produce no undo entry
- Drag operations create exactly one undo entry per mousedown-mouseup cycle

### Phase 26: Portability Layer

**Goal**: Extract Electron dependencies behind adapter interfaces for web portability
**Depends on**: Nothing (independent)
**Plans**: 2 plans

Plans:
- [x] 26-01: FileService interface + Electron adapter + React Context DI
- [x] 26-02: MapService extraction + App.tsx refactor + FileServiceProvider wiring

**Details:**
- FileService uses Result types (success/error) instead of throwing exceptions
- Platform-agnostic interfaces in src/core/ with zero external dependencies
- Adapter implementations in src/adapters/{platform}/
- React Context providers in src/contexts/
- MapService extracts all map I/O business logic from components
- MapService uses constructor injection (FileService parameter)
- No direct window.electronAPI calls remain in src/components/ or src/core/

---

## Milestone Summary

**Key Decisions:**

- useShallow for 4+ fields, individual selectors for 1-3 fields (Zustand pattern)
- 4 stacked canvases vs single canvas for independent layer updates
- Batched grid drawing (1 stroke call instead of 60 individual)
- Average all 256 pixels per tile for minimap color (not center pixel)
- Three-phase wall batching algorithm for deduplication
- Delta-based undo with snapshot-commit pattern
- FileService Result types instead of exceptions
- MapService constructor injection pattern

**Issues Resolved:**

- Minimap crash on drag-navigate (eliminated per-tile canvas creation)
- Animation double-tick speed (consolidated timers)
- Unnecessary re-renders from animationFrame (33/sec eliminated from ToolBar)
- Memory bloat from full-array undo copies

**Issues Deferred:**

- None â€” all v1.7 requirements shipped

**Technical Debt Incurred:**

- Some REQUIREMENTS.md checkboxes not updated (PERF-07, PERF-08, PERF-09 still unchecked despite completion)
- Pre-existing TypeScript errors in App.tsx, MapParser.ts, WallSystem.ts not addressed

---

_For current project status, see .planning/MILESTONES.md_
