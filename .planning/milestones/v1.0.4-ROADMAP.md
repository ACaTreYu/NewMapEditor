# Milestone v1.0.4: Settings Overhaul & Image Trace

**Status:** SHIPPED 2026-02-17
**Phases:** 82-85
**Total Plans:** 6

## Overview

Fix all game settings loading/saving bugs, add Format=1.1 prefix compliance, add Save As functionality, enable animations without panel dependency, and add image trace overlay for map recreation workflows.

## Phases

### Phase 82: Settings Format Compliance & Bug Fixes

**Goal**: All 53 game settings serialize with Format=1.1 prefix, load correctly across all tabs, and sliders sync with dropdown values
**Depends on**: Phase 81
**Requirements**: SFMT-01, SFMT-02, SFMT-03, SBUG-01, SBUG-02, SBUG-03, SBUG-04
**Completed**: 2026-02-17

Plans:
- [x] 82-01: Validate GameSettings.ts against AC reference + fix serialization ordering
- [x] 82-02: Fix dropdown-slider sync with reverse mapping + crossfire bug audit

**Details:**
- Fixed 4 settings defaults to match AC reference (RepairRate=2, FRepairRate=2, ElectionTime=50, DominationWin=9999999)
- Added SETTINGS_COUNT constant documenting 53 settings breakdown
- Added findClosestIndex for mapping custom extended setting values to dropdown presets
- Computed dropdown indices from merged extended settings on load, eliminating desync bugs
- Verified dropdown onChange handlers are properly isolated (no crossfire)
- Verified all 53 settings survive save -> reload -> display round-trip

### Phase 83: Save As Implementation

**Goal**: User can save maps under different filenames with proper state synchronization across document and window slices
**Depends on**: Phase 82
**Requirements**: FILE-01, FILE-02, FILE-03
**Completed**: 2026-02-17

Plans:
- [x] 83-01: Save As end-to-end: IPC defaultPath, menu item, state sync, App.tsx handler

**Details:**
- Full Save As workflow with dialog pre-fill, atomic state updates for filePath and window title
- Ctrl+Shift+S keyboard shortcut
- updateFilePathForDocument() atomically updates both DocumentState.filePath and WindowState.title
- DocumentsSlice includes WindowSlice in type signature for cross-slice state updates

### Phase 84: Animation Panel Independence

**Goal**: Animated tiles render on map canvas regardless of animation panel visibility state
**Depends on**: Phase 83
**Requirements**: ANIM-01
**Completed**: 2026-02-17

Plans:
- [x] 84-01: Extract animation RAF loop into useAnimationTimer hook, decouple from AnimationPanel

**Details:**
- Created useAnimationTimer custom hook owning the global animation RAF loop
- Hook runs from App.tsx (never unmounts), uses Page Visibility API, smart-pauses when no animated tiles visible
- AnimationPanel refactored to pure consumer (same pattern as CanvasEngine)
- Animations persist through sidebar collapse/expand cycles

### Phase 85: Image Trace Overlay

**Goal**: User can import reference images as semi-transparent MDI overlay windows for map tracing workflows
**Depends on**: Phase 84
**Requirements**: IMGT-01, IMGT-02, IMGT-03, IMGT-04, IMGT-05, IMGT-06
**Completed**: 2026-02-17

Plans:
- [x] 85-01: IPC image dialog + TraceImageWindowState type + WindowSlice trace window management
- [x] 85-02: TraceImageWindow component + Workspace/App integration

**Details:**
- Electron IPC for image file picker with PNG/JPG/BMP/WebP/SVG/GIF filters
- TraceImageWindowState with separate z-index pool (5000+), 4-window limit, 50% default opacity
- TraceImageWindow component with opacity slider, click-through behavior, manual title bar drag
- Workspace renders trace windows above document windows, supports trace-only mode
- Post-phase fixes: click-through via pointer-events: none on Rnd wrapper, resize handle CSS selector fix

## Milestone Summary

**Key Decisions:**
- Confirmed 53 settings (not 54) â€” HoldingTime is header field, not extended setting
- findClosestIndex for reverse mapping custom extended setting values to dropdown presets
- Atomic state update pattern for Save As (documents + window title in single set() call)
- useAnimationTimer hook in App.tsx (never unmounts, continuous animation loop)
- Trace windows use z-index base 5000 (documents use 1000) for guaranteed overlay ordering
- Default 50% opacity for trace images (immediate usability)
- Maximum 4 trace images enforced
- Click-through via CSS pointer-events: none on Rnd wrapper + image content

**Issues Resolved:**
- Settings defaults corrected against AC reference (4 values fixed)
- Dropdown/slider desync on map load eliminated
- Special/Laser Damage crossfire verified as non-existent
- Animation rendering decoupled from panel visibility
- Trace image click-through working correctly
- Format=1.1 moved to first position in serialized settings
- Max Players hidden from UI, locked at 16

**Technical Debt Incurred:**
- None identified

**Stats:**
- 39 commits
- 53 files changed
- +8,619 / -1,624 lines
- 4 phases, 6 plans
- 1 day (2026-02-17)

**Git range:** `e687c60` -> `46b798b`

---

_For current project status, see .planning/ROADMAP.md_
