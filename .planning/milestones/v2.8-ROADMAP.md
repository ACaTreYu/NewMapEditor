# Milestone v2.8: Canvas Engine

**Status:** SHIPPED 2026-02-13
**Phases:** 51-55
**Total Plans:** 5

## Overview

Decoupled canvas rendering from React's render cycle — zero React re-renders during drag operations, immediate visual feedback via imperative Canvas 2D, batch state commits on mouseup. This milestone also captures v2.7 phases (47-50) which shared the same roadmap lifecycle.

## v2.7 Phases (Rendering & Navigation)

### Phase 47: UI Cleanup + Scrollbar Math Fix
**Goal**: Remove minimap label and establish correct scrollbar thumb size/position/drag behavior
**Depends on**: Phase 46
**Plans**: 1 plan

Plans:
- [x] 47-01: Minimap label removal and scrollbar math overhaul

### Phase 48: Real-Time Pan Rendering
**Goal**: Hybrid CSS transform + RAF progressive re-render enables smooth tile updates during pan drag
**Depends on**: Phase 47
**Plans**: 1 plan

Plans:
- [x] 48-01: RAF progressive render, parameterized draw functions, scrollbar sync, snap-back prevention

### Phase 49: Canvas Optimization
**Goal**: Layer consolidation (4→2), off-screen buffer, and pattern-based grid rendering
**Depends on**: Phase 48
**Plans**: 1 plan

Plans:
- [x] 49-01: Layer consolidation (4→2), off-screen 4096x4096 buffer, pattern grid

### Phase 50: Buffer Zone Over-Rendering
**Goal**: Pre-render tiles beyond viewport edges for smooth panning
**Depends on**: Phase 49
**Plans**: 1 plan

Plans:
- [x] 50-01: Dynamic buffer zone rendering — implemented then reverted (regression)

**Post-milestone fix:** Reduced rendering churn (ResizeObserver stable refs, cursor dedup, drawMapLayer early exit, immediate buffer patch for pencil, direct viewport subscription). Root cause identified: React re-render overhead (~5-10ms) in mouse event hot path. Canvas drawing itself is <1ms. Full fix deferred to v2.8.

## v2.8 Phases (Canvas Engine)

### Phase 51: Extract CanvasEngine Class
**Goal**: Encapsulate buffer management, tile rendering, and viewport blitting in a standalone CanvasEngine class
**Depends on**: Phase 50
**Plans**: 1 plan

Plans:
- [x] 51-01: CanvasEngine class extraction with buffer management, rendering, and MapCanvas rewiring

**Details:**
- Created CanvasEngine class (src/core/canvas/CanvasEngine.ts) with renderTile, drawMapLayer, blitToScreen, patchTile, patchTileBuffer, patchAnimatedTiles methods
- Rewired MapCanvas to delegate all rendering to CanvasEngine via engineRef
- Reused existing Viewport type from editor slice
- Engine owns all buffer/context refs, component only owns engine ref

### Phase 52: Engine Subscribes to Zustand
**Goal**: Drive all canvas rendering via direct Zustand store subscriptions, removing React useEffect from the rendering hot path
**Depends on**: Phase 51
**Plans**: 1 plan

Plans:
- [x] 52-01: Zustand subscriptions in CanvasEngine, React rendering useEffects removed from MapCanvas

**Details:**
- 3 Zustand subscriptions: viewport blit, map patch (drag-guarded), animation tick
- Manual reference equality checks instead of subscribeWithSelector middleware
- Instance field documentId for closure safety in long-lived subscriptions
- isDragActive guard prevents subscription-driven redraws during drag

### Phase 53: Decouple Pencil Drag
**Goal**: Zero React re-renders during pencil drag — accumulate tiles in local ref, patch buffer imperatively, batch commit on mouseup
**Depends on**: Phase 52
**Plans**: 1 plan

Plans:
- [x] 53-01: Engine drag lifecycle (beginDrag/paintTile/commitDrag) + pencil handler rewiring + undo blocking

**Details:**
- Engine drag lifecycle: beginDrag → paintTile (N times) → commitDrag → setTiles batch
- Pending tiles accumulate in Map<number, number>, buffer patched imperatively on each mousemove
- Single setTiles() batch commit + commitUndo() on mouseup
- Escape cancellation with full buffer rebuild from store state
- Undo/redo blocked during active drag via isAnyDragActive() module export

### Phase 54: Decouple Cursor & UI Overlay
**Goal**: Track cursor position, line preview, selection rect via refs — redraw UI overlay imperatively via dirty flag
**Depends on**: Phase 53
**Plans**: 1 plan

Plans:
- [x] 54-01: Ref-based transient UI state + RAF-debounced requestUiRedraw + mouse handler rewiring

**Details:**
- Cursor, line preview, selection drag, paste preview all converted from useState/Zustand to useRef
- RAF-debounced requestUiRedraw() replaces React useEffect-triggered redraws
- Merged line and selection drag Escape handlers into permanent listener
- Zero React re-renders during any tool's mousemove interaction

### Phase 55: All-Tool Drag Consistency
**Goal**: Apply ref-based drag pattern to all remaining tools — selection, rect, wall pencil edge cases, unmount safety
**Depends on**: Phase 54
**Plans**: 1 plan

Plans:
- [x] 55-01: Ref-based rect drag with tool switch/unmount safety, wall pencil documented exception

**Details:**
- Rect drag (bunker/conveyor/wall_rect/bridge/holding_pen) converted from Zustand to ref-based pattern
- Tool switch cleanup via currentTool useEffect: commits pencil, cancels others
- Unmount cleanup: resets all ref-based drag state, cancels pending RAF
- Wall pencil documented as intentional Zustand exception (TOOL-02) — auto-connection requires neighbor reads

---

## Milestone Summary

**Key Decisions:**
- CanvasEngine class pattern for imperative rendering (attach/detach lifecycle)
- Manual reference equality checks instead of subscribeWithSelector middleware
- Instance field documentId avoids stale closure pitfall in long-lived subscriptions
- isDragActive guard prevents double-rendering during drag
- Map<number, number> reused across drags (clear instead of recreate)
- Module-level activeEngine singleton for isAnyDragActive() cross-component checks
- RAF-debounced requestUiRedraw coalesces multiple ref mutations per frame
- Tool switch commits pencil drag (preserves user work), cancels preview drags
- Wall pencil stays on Zustand (auto-connection reads 8 neighbors)
- Off-screen 4096x4096 buffer with single drawImage viewport blit
- 2-layer canvas (map + UI overlay) consolidated from 4 layers
- Pattern-based grid rendering (O(1) fill vs O(N) line strokes)

**Issues Resolved:**
- React re-render overhead (~5-10ms) in mouse event hot path causing jank during drag
- ResizeObserver unstable refs causing rendering churn
- Cursor position updates triggering unnecessary React re-renders
- Multiple Escape listeners added/removed per drag (replaced with permanent listener)

**Issues Deferred:**
- Buffer zone over-rendering (Phase 50 reverted, root cause was React overhead, now resolved by engine extraction)
- Content-aware transform tables (directional tiles may rotate incorrectly)

**Technical Debt Incurred:**
- SUB-02 dirty flags declared but not actively used (RAF debouncing serves equivalent purpose)
- Unused variable warnings (TS6133) for cursorTileRef, immediatePatchTile leftovers
- Wall pencil stays on Zustand during drag (documented exception, not extractable without duplicating map)

---

_For current project status, see .planning/ROADMAP.md_
